var e=Object.defineProperty,s=(s,t,r)=>((s,t,r)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r)(s,"symbol"!=typeof t?t+"":t,r);import{r as t,j as r}from"./react-core-JVqWokWt.js";import{u as n,a,b as i}from"./react-query-DqnBFrGE.js";import{l,f as o,B as c,V as d,W as m,Z as u,$ as h,c as x,C as g,J as p,b as f,L as w,K as j,Y as v,as as b,a1 as y}from"./main-fde3JC90.js";import{a2 as N,b$ as S,am as k,aO as _,ai as L,c0 as A,$ as I,bw as C,aF as P,aT as E,aq as O,bx as $,ap as q,c1 as T,be as F,bW as M,bH as K,a3 as R,a6 as z,a1 as V,ay as D,az as U,c2 as W}from"./vendor-DC2AZkDs.js";import{R as H,a as G}from"./radio-group-rQxajO1F.js";import{ar as J,as as Q,at as Y}from"./radix-ui-Ch8xfAyl.js";import{u as B,b as Z}from"./react-router-WAeXREDX.js";import"./react-dom-DyRXjBRd.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const X=new class{async getLesson(e){l.info("[LessonService] Fetching lesson:",e);const s=await o.get(`/knowledge-graph/lessons/${e}/`);if(!s.success||!s.data){const e=s.error||"Failed to fetch lesson";throw l.error("[LessonService] Get lesson failed:",e),new Error(e)}return l.info("[LessonService] Lesson fetched successfully:",s.data.title),s.data}async getLessonProgress(e,s){l.info("[LessonService] Fetching lesson progress:",{lessonId:e,studentId:s});const t=await o.get(`/knowledge-graph/lessons/${e}/progress/${s}/`);if(!t.success||!t.data){const e=t.error||"Failed to fetch lesson progress";throw l.error("[LessonService] Get lesson progress failed:",e),new Error(e)}return l.info("[LessonService] Lesson progress fetched:",{status:t.data.status,completed:t.data.completed_elements_count,total:t.data.total_elements_count}),t.data}async submitElementAnswer(e,s){l.info("[LessonService] Submitting answer for element:",e);const t=await o.post(`/knowledge-graph/elements/${e}/progress/`,s);if(!t.success||!t.data){const e=t.error||"Failed to submit answer";throw l.error("[LessonService] Submit answer failed:",e),new Error(e)}return l.info("[LessonService] Answer submitted successfully:",{score:t.data.score,status:t.data.status}),t.data}async completeLessonStatus(e,s){l.info("[LessonService] Marking lesson as complete:",{lessonId:e,studentId:s});const t=await o.patch(`/knowledge-graph/lessons/${e}/progress/${s}/update/`,{status:"completed"});if(!t.success){const e=t.error||"Failed to complete lesson";throw l.error("[LessonService] Complete lesson failed:",e),new Error(e)}l.info("[LessonService] Lesson marked as complete")}async checkPrerequisites(e,s){l.info("[LessonService] Checking prerequisites:",{graphId:e,lessonId:s});const t=await o.get(`/knowledge-graph/${e}/lessons/${s}/can-start/`);if(!t.success||!t.data){const e=t.error||"Failed to check prerequisites";throw l.error("[LessonService] Check prerequisites failed:",e),new Error(e)}return l.info("[LessonService] Prerequisites checked:",{canStart:t.data.can_start,missing:t.data.missing_prerequisites.length}),t.data}async getElementProgress(e,s){l.info("[LessonService] Fetching element progress:",{elementId:e,studentId:s});const t=await o.get(`/knowledge-graph/elements/${e}/progress/${s}/`);if(!t.success||!t.data){const e=t.error||"Failed to fetch element progress";throw l.error("[LessonService] Get element progress failed:",e),new Error(e)}return t.data}},ee="kg_offline_answers";const se=new class{constructor(){s(this,"data"),this.data=this.loadFromStorage()}loadFromStorage(){try{const e=localStorage.getItem(ee);if(!e)return{answers:{},lastSync:null};const s=JSON.parse(e);return l.info("[OfflineStorage] Loaded data:",{answerCount:Object.keys(s.answers||{}).length}),s}catch(e){return l.error("[OfflineStorage] Failed to load from localStorage:",e),{answers:{},lastSync:null}}}saveToStorage(){try{localStorage.setItem(ee,JSON.stringify(this.data)),l.info("[OfflineStorage] Data saved to localStorage")}catch(e){l.error("[OfflineStorage] Failed to save to localStorage:",e)}}getAnswerKey(e,s){return`${s}_${e}`}saveAnswer(e){const s=this.getAnswerKey(e.elementId,e.lessonId),t={element_id:e.elementId,answer:e.answer,lesson_id:e.lessonId,graph_id:e.graphId,graph_lesson_id:e.graphLessonId,timestamp:(new Date).toISOString(),attempts:0,status:"pending"};this.data.answers[s]=t,this.saveToStorage(),l.info("[OfflineStorage] Answer saved to cache:",{elementId:e.elementId,lessonId:e.lessonId})}getAnswer(e,s){const t=this.getAnswerKey(e,s);return this.data.answers[t]||null}removeAnswer(e,s){const t=this.getAnswerKey(e,s);delete this.data.answers[t],this.saveToStorage(),l.info("[OfflineStorage] Answer removed from cache:",{elementId:e,lessonId:s})}getPendingAnswers(){return Object.values(this.data.answers).filter(e=>"pending"===e.status||"failed"===e.status)}updateAnswerStatus(e,s,t,r){const n=this.getAnswerKey(e,s),a=this.data.answers[n];a?(a.status=t,a.attempts+=1,r&&(a.error=r),"submitted"===t&&(delete this.data.answers[n],this.data.lastSync=(new Date).toISOString()),a.attempts>=5&&(l.error("[OfflineStorage] Max retry attempts reached, removing answer:",{elementId:e,lessonId:s,attempts:a.attempts}),delete this.data.answers[n]),this.saveToStorage()):l.warn("[OfflineStorage] Answer not found for status update:",{elementId:e,lessonId:s})}getPendingCount(){return this.getPendingAnswers().length}clearAll(){this.data={answers:{},lastSync:null},this.saveToStorage(),l.info("[OfflineStorage] All cached answers cleared")}getLastSyncTime(){return this.data.lastSync}needsSync(){return this.getPendingCount()>0}};const te=new class{constructor(){s(this,"networkStatus",{isOnline:navigator.onLine}),s(this,"syncInProgress",!1),s(this,"listeners",[]),this.initNetworkListeners()}initNetworkListeners(){if("undefined"!=typeof window&&(window.addEventListener("online",()=>{this.updateNetworkStatus(!0),this.autoSyncPendingAnswers()}),window.addEventListener("offline",()=>{this.updateNetworkStatus(!1)}),"connection"in navigator)){navigator.connection.addEventListener("change",()=>{this.updateNetworkStatus(navigator.onLine)})}}updateNetworkStatus(e){const s=navigator.connection;this.networkStatus={isOnline:e,effectiveType:null==s?void 0:s.effectiveType,downlink:null==s?void 0:s.downlink},l.info("[AnswerSubmissionService] Network status updated:",this.networkStatus),this.listeners.forEach(e=>e(this.networkStatus))}onNetworkStatusChange(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(s=>s!==e)}}async checkNetworkConnectivity(){try{const e=new AbortController,s=setTimeout(()=>e.abort(),5e3),t=await fetch("/api/health/",{method:"HEAD",signal:e.signal,cache:"no-cache"});return clearTimeout(s),t.ok}catch(e){return l.warn("[AnswerSubmissionService] Network check failed:",e),!1}}async submitAnswer(e){l.info("[AnswerSubmissionService] Submitting answer:",{elementId:e.elementId,lessonId:e.lessonId});if(!(await this.checkNetworkConnectivity()))return se.saveAnswer(e),l.info("[AnswerSubmissionService] Answer cached for later submission"),{success:!0,cached:!0,error:void 0};try{const s={answer:e.answer,graph_lesson_id:e.graphLessonId},t=await X.submitElementAnswer(e.elementId,s);return l.info("[AnswerSubmissionService] Answer submitted successfully"),se.removeAnswer(e.elementId,e.lessonId),{success:!0,data:t,cached:!1}}catch(s){return l.error("[AnswerSubmissionService] Submit failed:",s),se.saveAnswer(e),se.updateAnswerStatus(e.elementId,e.lessonId,"failed",String(s)),{success:!1,error:s instanceof Error?s.message:"Unknown error",cached:!0}}}async retryFailedSubmissions(){const e=se.getPendingAnswers();if(0===e.length)return l.info("[AnswerSubmissionService] No pending answers to retry"),0;l.info("[AnswerSubmissionService] Retrying failed submissions:",{count:e.length});let s=0;for(const r of e)try{const e={answer:r.answer,graph_lesson_id:r.graph_lesson_id};await X.submitElementAnswer(r.element_id,e),se.updateAnswerStatus(r.element_id,r.lesson_id,"submitted"),s++,l.info("[AnswerSubmissionService] Retry successful:",{elementId:r.element_id})}catch(t){l.error("[AnswerSubmissionService] Retry failed:",t),se.updateAnswerStatus(r.element_id,r.lesson_id,"failed",String(t))}return l.info("[AnswerSubmissionService] Retry complete:",{total:e.length,success:s,failed:e.length-s}),s}async autoSyncPendingAnswers(){if(this.syncInProgress)l.info("[AnswerSubmissionService] Sync already in progress, skipping");else if(se.needsSync()){this.syncInProgress=!0;try{l.info("[AnswerSubmissionService] Auto-sync started"),await this.retryFailedSubmissions(),l.info("[AnswerSubmissionService] Auto-sync completed")}catch(e){l.error("[AnswerSubmissionService] Auto-sync failed:",e)}finally{this.syncInProgress=!1}}else l.info("[AnswerSubmissionService] No pending answers to sync")}getCachedAnswers(){return se.getPendingAnswers()}getPendingCount(){return se.getPendingCount()}clearCache(){se.clearAll()}getNetworkStatus(){return{...this.networkStatus}}hasCachedAnswer(e,s){return null!==se.getAnswer(e,s)}},re=({element:e,progress:s,onSubmit:n,isLoading:a=!1,readOnly:i=!1})=>{const l=e.content,o=null==s?void 0:s.answer,[g,p]=t.useState((null==o?void 0:o.text)||""),[f,w]=t.useState(!1),[j,v]=t.useState(""),b="completed"===(null==s?void 0:s.status),y=a||b||i,N=g.length,k=5e3;t.useEffect(()=>{(null==o?void 0:o.text)&&p(o.text)},[o]);return r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert",children:r.jsx("div",{className:"text-foreground whitespace-pre-wrap",dangerouslySetInnerHTML:{__html:l.problem_text}})}),l.hints&&l.hints.length>0&&r.jsxs("div",{className:"space-y-2",children:[r.jsxs(c,{type:"button",variant:"outline",size:"sm",onClick:()=>w(!f),className:"flex items-center gap-2",children:[r.jsx(S,{className:"h-4 w-4"}),f?"Скрыть подсказки":"Показать подсказки"]}),f&&r.jsx("div",{className:"space-y-2",children:l.hints.map((e,s)=>r.jsx(d,{className:"bg-amber-50 dark:bg-amber-950/30 border-amber-200 dark:border-amber-900",children:r.jsxs(m,{className:"text-sm",children:[r.jsxs("strong",{children:["Подсказка ",s+1,":"]})," ",e]})},s))})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs(u,{htmlFor:"answer",className:"text-sm font-medium",children:["Ваш ответ ",!b&&"*"]}),r.jsxs("span",{className:"text-xs text-muted-foreground",children:[N," / ",k]})]}),r.jsx(h,{id:"answer",value:g,onChange:e=>p(e.target.value),placeholder:"Введите ваш ответ здесь...",rows:8,maxLength:k,disabled:y,className:"resize-none font-mono text-sm"}),b&&null!==(null==s?void 0:s.score)&&r.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[r.jsxs(x,{variant:s.score>=.7*e.max_score?"default":"secondary",children:["Оценка: ",s.score," / ",e.max_score]}),void 0!==s.score_percent&&r.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",s.score_percent,"%)"]})]})]}),j&&r.jsx(d,{variant:"destructive",children:r.jsx(m,{children:j})}),!b&&!i&&r.jsx(c,{type:"button",onClick:async()=>{if(v(""),g.trim())if(g.length>k)v("Ответ слишком длинный (максимум 5000 символов)");else try{await n({text:g.trim()})}catch(e){v("Ошибка при отправке ответа. Попробуйте ещё раз.")}else v("Пожалуйста, введите ответ")},disabled:y||!g.trim(),className:"w-full",children:a?"Отправка...":"Отправить ответ"}),b&&r.jsx(d,{className:"bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-900",children:r.jsx(m,{className:"text-sm text-green-800 dark:text-green-200",children:"Задача выполнена! Ответ сохранён."})})]})},ne=({element:e,progress:s,onSubmit:n,isLoading:a=!1,readOnly:i=!1})=>{const l=e.content,o=null==s?void 0:s.answer,[h,g]=t.useState(void 0!==(null==o?void 0:o.choice)?o.choice:null),[p,f]=t.useState(!1),[w,j]=t.useState(""),v="completed"===(null==s?void 0:s.status),b=a||v||i;t.useEffect(()=>{void 0!==(null==o?void 0:o.choice)&&(g(o.choice),f(v))},[o,v]);return r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert",children:r.jsx("p",{className:"text-lg font-medium text-foreground",children:l.question})}),r.jsx(H,{value:null!==h?h.toString():void 0,onValueChange:e=>g(parseInt(e)),disabled:b,className:"space-y-3",children:l.choices.map((e,s)=>{const t=h===s,n=s===l.correct_answer;const a=p&&n,i=p&&t&&!n;return r.jsxs("div",{className:`flex items-start space-x-3 p-4 border rounded-lg transition-colors ${t?"bg-primary/5 border-primary":"hover:bg-muted/50"} ${a?"bg-green-50 dark:bg-green-950/30 border-green-500":""} ${i?"bg-red-50 dark:bg-red-950/30 border-red-500":""}`,children:[r.jsx(G,{value:s.toString(),id:`choice-${s}`,disabled:b}),r.jsx(u,{htmlFor:`choice-${s}`,className:"flex-1 cursor-pointer text-sm leading-relaxed",children:e}),a&&r.jsx(k,{className:"h-5 w-5 text-green-600 flex-shrink-0"}),i&&r.jsx(_,{className:"h-5 w-5 text-red-600 flex-shrink-0"})]},s)})}),p&&v&&r.jsxs("div",{className:"space-y-2",children:[h===l.correct_answer?r.jsxs(d,{className:"bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-900",children:[r.jsx(k,{className:"h-4 w-4 text-green-600"}),r.jsx(m,{className:"text-sm text-green-800 dark:text-green-200",children:"Правильно! Вы выбрали верный ответ."})]}):r.jsxs(d,{variant:"destructive",children:[r.jsx(_,{className:"h-4 w-4"}),r.jsxs(m,{className:"text-sm",children:["Неправильно. Правильный ответ: ",l.choices[l.correct_answer]]})]}),null!==(null==s?void 0:s.score)&&r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(x,{variant:s.score>=.7*e.max_score?"default":"secondary",children:["Оценка: ",s.score," / ",e.max_score]}),void 0!==s.score_percent&&r.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",s.score_percent,"%)"]})]})]}),w&&r.jsx(d,{variant:"destructive",children:r.jsx(m,{children:w})}),!v&&!i&&r.jsx(c,{type:"button",onClick:async()=>{if(j(""),null!==h)try{await n({choice:h}),f(!0)}catch(e){j("Ошибка при отправке ответа. Попробуйте ещё раз.")}else j("Пожалуйста, выберите ответ")},disabled:b||null===h,className:"w-full",children:a?"Отправка...":"Проверить ответ"})]})},ae=J,ie=Q,le=Y,oe=({element:e,progress:s,onSubmit:n,isLoading:a=!1,readOnly:i=!1})=>{const l=e.content,o=null==s?void 0:s.answer,[u,h]=t.useState((null==o?void 0:o.viewed)||!1),[x,g]=t.useState(new Set),[p,f]=t.useState(""),w="completed"===(null==s?void 0:s.status),j=a||w||i;t.useEffect(()=>{(null==o?void 0:o.viewed)&&h(!0)},[o]),t.useEffect(()=>{if(!u&&!w&&!i){const e=setTimeout(()=>{h(!0)},3e3);return()=>clearTimeout(e)}},[u,w,i]);const v=e=>A.sanitize(e,{ALLOWED_TAGS:["p","br","strong","em","u","h1","h2","h3","h4","h5","h6","ul","ol","li","blockquote","pre","code","a","img","table","thead","tbody","tr","th","td"],ALLOWED_ATTR:["href","src","alt","title","class"]});return r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert bg-muted/30 p-6 rounded-lg",dangerouslySetInnerHTML:{__html:v(l.text)}}),l.sections&&l.sections.length>0&&r.jsxs("div",{className:"space-y-2",children:[r.jsx("h3",{className:"text-sm font-semibold text-foreground mb-2",children:"Дополнительные разделы"}),l.sections.map((e,s)=>r.jsxs(ae,{open:x.has(s),onOpenChange:()=>(e=>{const s=new Set(x);s.has(e)?s.delete(e):s.add(e),g(s)})(s),children:[r.jsx(ie,{asChild:!0,children:r.jsxs(c,{variant:"outline",className:"w-full justify-between text-left font-medium",type:"button",children:[r.jsx("span",{children:e.title}),r.jsx(L,{className:"h-4 w-4 transition-transform "+(x.has(s)?"rotate-180":"")})]})}),r.jsx(le,{className:"mt-2",children:r.jsx("div",{className:"prose prose-sm max-w-none dark:prose-invert bg-muted/20 p-4 rounded-md",dangerouslySetInnerHTML:{__html:v(e.content)}})})]},s))]}),r.jsx("style",{children:"\n        .prose code {\n          background: hsl(var(--muted));\n          padding: 0.2em 0.4em;\n          border-radius: 0.25rem;\n          font-size: 0.875em;\n        }\n        .prose pre {\n          background: hsl(var(--muted));\n          padding: 1rem;\n          border-radius: 0.5rem;\n          overflow-x: auto;\n        }\n        .prose pre code {\n          background: transparent;\n          padding: 0;\n        }\n      "}),u&&!w&&r.jsx(d,{className:"bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-900",children:r.jsx(m,{className:"text-sm text-blue-800 dark:text-blue-200",children:"Материал просмотрен. Вы можете отметить его как изученный."})}),p&&r.jsx(d,{variant:"destructive",children:r.jsx(m,{children:p})}),!w&&!i&&r.jsx(c,{type:"button",onClick:async()=>{if(f(""),u)try{await n({viewed:!0})}catch(e){f("Ошибка при сохранении. Попробуйте ещё раз.")}else f("Пожалуйста, ознакомьтесь с материалом")},disabled:j||!u,className:"w-full",children:a?"Сохранение...":"Отметить как изученное"}),w&&r.jsxs(d,{className:"bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-900",children:[r.jsx(k,{className:"h-4 w-4 text-green-600"}),r.jsx(m,{className:"text-sm text-green-800 dark:text-green-200",children:"Материал изучен!"})]})]})},ce=({element:e,progress:s,onSubmit:n,isLoading:a=!1,readOnly:i=!1})=>{const l=e.content,o=null==s?void 0:s.answer,[u,h]=t.useState((null==o?void 0:o.watched_until)||0),[g,p]=t.useState(!1),[f,w]=t.useState(""),[j,v]=t.useState(""),b=t.useRef(null),y=t.useRef(null),N="completed"===(null==s?void 0:s.status),S=a||N||i;t.useEffect(()=>{(null==o?void 0:o.watched_until)&&h(o.watched_until)},[o]);const _=(L=l.url).includes("youtube.com")||L.includes("youtu.be")?"youtube":L.includes("vimeo.com")?"vimeo":L.match(/\.(mp4|webm|ogg)$/i)?"file":"unknown";var L;const A=()=>{if(b.current){const e=Math.floor(b.current.currentTime);e>u&&h(e)}},C=()=>{if(b.current){const e=Math.floor(b.current.duration);h(e)}};return r.jsxs("div",{className:"space-y-4",children:[l.title&&r.jsxs("div",{children:[r.jsx("h3",{className:"text-lg font-semibold text-foreground",children:l.title}),l.description&&r.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:l.description})]}),j?r.jsxs(d,{variant:"destructive",children:[r.jsx(I,{className:"h-4 w-4"}),r.jsx(m,{children:j})]}):(()=>{switch(_){case"youtube":{const s=(e=>{const s=e.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);return s&&11===s[2].length?s[2]:null})(l.url);return s?r.jsx("div",{className:"relative w-full pb-[56.25%] rounded-lg overflow-hidden bg-black",children:r.jsx("iframe",{ref:y,className:"absolute top-0 left-0 w-full h-full",src:`https://www.youtube.com/embed/${s}?enablejsapi=1`,title:l.title||e.title,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0})}):(v("Некорректный YouTube URL"),null)}case"vimeo":{const s=(e=>{const s=e.match(/vimeo.com\/(\d+)/);return s?s[1]:null})(l.url);return s?r.jsx("div",{className:"relative w-full pb-[56.25%] rounded-lg overflow-hidden bg-black",children:r.jsx("iframe",{ref:y,className:"absolute top-0 left-0 w-full h-full",src:`https://player.vimeo.com/video/${s}`,title:l.title||e.title,allow:"autoplay; fullscreen; picture-in-picture",allowFullScreen:!0})}):(v("Некорректный Vimeo URL"),null)}case"file":return r.jsx("div",{className:"rounded-lg overflow-hidden bg-black",children:r.jsxs("video",{ref:b,className:"w-full",controls:!0,onTimeUpdate:A,onEnded:C,onPlay:()=>p(!0),onPause:()=>p(!1),children:[r.jsx("source",{src:l.url,type:"video/mp4"}),r.jsx("source",{src:l.url,type:"video/webm"}),r.jsx("source",{src:l.url,type:"video/ogg"}),"Ваш браузер не поддерживает воспроизведение видео."]})});default:return v("Неподдерживаемый формат видео"),null}})(),u>0&&!N&&r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-between text-sm",children:[r.jsx("span",{className:"text-muted-foreground",children:"Просмотрено:"}),r.jsxs(x,{variant:"secondary",children:[Math.floor(u/60),":",(u%60).toString().padStart(2,"0"),l.duration_seconds&&` / ${Math.floor(l.duration_seconds/60)}:${(l.duration_seconds%60).toString().padStart(2,"0")}`]})]}),l.duration_seconds&&r.jsx("div",{className:"w-full bg-muted rounded-full h-2",children:r.jsx("div",{className:"bg-primary h-2 rounded-full transition-all",style:{width:`${Math.min(u/l.duration_seconds*100,100)}%`}})})]}),f&&r.jsx(d,{variant:"destructive",children:r.jsx(m,{children:f})}),!N&&!i&&r.jsx(c,{type:"button",onClick:async()=>{w("");const e=l.duration_seconds?.8*l.duration_seconds:0;if(e>0&&u<e)w(`Просмотрите минимум 80% видео для завершения (${Math.floor(e/60)} мин)`);else try{await n({watched_until:u})}catch(s){w("Ошибка при сохранении. Попробуйте ещё раз.")}},disabled:S||0===u,className:"w-full",children:a?"Сохранение...":"Отметить как просмотренное"}),N&&r.jsxs(d,{className:"bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-900",children:[r.jsx(k,{className:"h-4 w-4 text-green-600"}),r.jsx(m,{className:"text-sm text-green-800 dark:text-green-200",children:"Видео просмотрено!"})]})]})},de=({element:e,progress:s,onSubmit:t,onError:n,isLoading:a=!1,readOnly:i=!1})=>{const l=async e=>{try{await t(e)}catch(s){throw n&&n(s),s}};return r.jsxs(g,{className:"w-full shadow-md hover:shadow-lg transition-shadow",children:[r.jsxs(p,{children:[r.jsxs("div",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[r.jsx("div",{className:"mt-1 text-primary",children:(()=>{switch(e.element_type){case"text_problem":default:return r.jsx(O,{className:"h-5 w-5"});case"quick_question":return r.jsx(T,{className:"h-5 w-5"});case"theory":return r.jsx(q,{className:"h-5 w-5"});case"video":return r.jsx($,{className:"h-5 w-5"})}})()}),r.jsxs("div",{className:"flex-1 space-y-1",children:[r.jsx(j,{className:"text-xl",children:e.title}),r.jsx(v,{className:"text-sm",children:e.description})]})]}),r.jsxs("div",{className:"flex flex-col items-end gap-2",children:[(()=>{if(!s)return r.jsx(x,{variant:"secondary",children:"Не начато"});switch(s.status){case"not_started":return r.jsx(x,{variant:"secondary",children:"Не начато"});case"in_progress":return r.jsx(x,{variant:"default",className:"bg-blue-500",children:"В процессе"});case"completed":return r.jsx(x,{variant:"default",className:"bg-green-500",children:"Выполнено"});case"skipped":return r.jsx(x,{variant:"outline",children:"Пропущено"});default:return r.jsx(x,{variant:"secondary",children:"Неизвестно"})}})(),r.jsx(x,{variant:"outline",children:e.element_type_display})]})]}),r.jsxs("div",{className:"flex flex-wrap items-center gap-4 mt-4 text-sm text-muted-foreground",children:[r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx(C,{className:"h-4 w-4 "+(o=e.difficulty,o<=3?"text-green-600 dark:text-green-400":o<=7?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400")}),r.jsxs("span",{children:["Сложность: ",e.difficulty,"/10"]})]}),r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx(P,{className:"h-4 w-4"}),r.jsxs("span",{children:["~",e.estimated_time_minutes," мин"]})]}),r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx(E,{className:"h-4 w-4"}),r.jsxs("span",{children:["Макс. балл: ",e.max_score]})]}),(null==s?void 0:s.attempts)&&s.attempts>0&&r.jsxs(x,{variant:"secondary",className:"text-xs",children:["Попыток: ",s.attempts]})]}),e.tags&&e.tags.length>0&&r.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:e.tags.map((e,s)=>r.jsx(x,{variant:"outline",className:"text-xs",children:e},s))})]}),r.jsx(w,{children:(()=>{switch(e.element_type){case"text_problem":return r.jsx(re,{element:e,progress:s,onSubmit:l,isLoading:a,readOnly:i});case"quick_question":return r.jsx(ne,{element:e,progress:s,onSubmit:l,isLoading:a,readOnly:i});case"theory":return r.jsx(oe,{element:e,progress:s,onSubmit:l,isLoading:a,readOnly:i});case"video":return r.jsx(ce,{element:e,progress:s,onSubmit:l,isLoading:a,readOnly:i});default:return r.jsx(d,{variant:"destructive",children:r.jsxs(m,{children:["Неподдерживаемый тип элемента: ",e.element_type]})})}})()})]});var o},me=()=>r.jsxs(g,{className:"w-full",children:[r.jsxs(p,{children:[r.jsxs("div",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[r.jsx(f,{className:"h-5 w-5 rounded-md"}),r.jsxs("div",{className:"flex-1 space-y-2",children:[r.jsx(f,{className:"h-6 w-3/4"}),r.jsx(f,{className:"h-4 w-full"})]})]}),r.jsx(f,{className:"h-6 w-20"})]}),r.jsxs("div",{className:"flex flex-wrap items-center gap-4 mt-4",children:[r.jsx(f,{className:"h-4 w-24"}),r.jsx(f,{className:"h-4 w-20"}),r.jsx(f,{className:"h-4 w-28"})]})]}),r.jsxs(w,{className:"space-y-4",children:[r.jsx(f,{className:"h-32 w-full rounded-lg"}),r.jsx(f,{className:"h-10 w-full"})]})]}),ue=({lessonId:e,studentId:s,graphId:o,onComplete:u,onError:h})=>{var p,f;const j=B(),v=Z(),{user:S}=b(),_=e||v.lessonId||"",L=s||v.studentId||(null==(p=null==S?void 0:S.id)?void 0:p.toString())||"",A=o||v.graphId,[I,C]=t.useState(0),[P,E]=t.useState(!1),{lesson:O,progress:$,elementsWithProgress:q,isLoading:T,error:H,isUnlocked:G,missingPrerequisites:J,submitAnswer:Q,isSubmitting:Y,completeLesson:ee,getCurrentElementIndex:se,allElementsCompleted:re,getProgressPercent:ne}=(({lessonId:e,studentId:s,graphId:t,onComplete:r})=>{const o=n(),{data:c,isLoading:d,error:m}=a({queryKey:["lesson",e],queryFn:()=>X.getLesson(e),staleTime:3e5,retry:2}),{data:u,isLoading:h,error:x}=a({queryKey:["lesson-progress",e,s],queryFn:()=>X.getLessonProgress(e,s),staleTime:3e4,retry:2,refetchOnMount:!0}),{data:g,isLoading:p}=a({queryKey:["prerequisites",t,e],queryFn:()=>X.checkPrerequisites(t,e),enabled:!!t,staleTime:3e5,retry:1}),f=i({mutationFn:({elementId:e,data:s})=>X.submitElementAnswer(e,s),onSuccess:t=>{null!==t.score&&void 0!==t.score?N.success(`Ответ принят! Получено баллов: ${t.score}/${t.max_score}`):N.success("Ответ принят!"),o.invalidateQueries({queryKey:["lesson-progress",e,s]}),o.invalidateQueries({queryKey:["element-progress"]}),l.info("[useLessonProgress] Answer submitted, queries invalidated")},onError:e=>{l.error("[useLessonProgress] Submit answer error:",e),N.error(`Ошибка отправки ответа: ${e.message}`)}}),w=i({mutationFn:()=>X.completeLessonStatus(e,s),onSuccess:()=>{l.info("[useLessonProgress] Lesson completed"),N.success("Урок завершен! Поздравляем!"),o.invalidateQueries({queryKey:["lesson-progress",e,s]}),r&&r()},onError:e=>{l.error("[useLessonProgress] Complete lesson error:",e),N.error(`Ошибка завершения урока: ${e.message}`)}}),j=d||h||p,v=m||x,b=!g||g.can_start,y=(null==g?void 0:g.missing_prerequisites)||[],S=(null==c?void 0:c.elements.map(e=>{const s=null==u?void 0:u.element_progress.find(s=>s.element.id===e.id);return{...e,progress:s}}))||[];return{lesson:c,progress:u,prerequisiteCheck:g,elementsWithProgress:S,isLoading:j,isLessonLoading:d,isProgressLoading:h,isPrerequisiteLoading:p,error:v,isUnlocked:b,missingPrerequisites:y,submitAnswer:f.mutate,isSubmitting:f.isPending,completeLesson:w.mutate,isCompletingLesson:w.isPending,getCurrentElementIndex:()=>{if(!S.length)return 0;const e=S.findIndex(e=>!e.progress||"completed"!==e.progress.status);return-1!==e?e:0},allElementsCompleted:()=>!!S.length&&S.every(e=>e.progress&&"completed"===e.progress.status),getProgressPercent:()=>u?Math.round(u.completed_elements_count/u.total_elements_count*100):0}})({lessonId:_,studentId:L,graphId:A,onComplete:u}),{submitAnswer:ae,retry:ie,isLoading:le,status:oe,error:ce,pendingCount:ue,isNetworkOnline:he}=(()=>{const[e,s]=t.useState("idle"),[r,n]=t.useState(void 0),[a,i]=t.useState(0),[o,c]=t.useState(te.getNetworkStatus()),[d,m]=t.useState(null),[u,h]=t.useState(null),x=t.useCallback(()=>{const e=te.getPendingCount();i(e)},[]);t.useEffect(()=>{const e=te.onNetworkStatusChange(e=>{c(e),e.isOnline&&a>0&&N.info("Соединение восстановлено. Синхронизация ответов...")});return x(),e},[a,x]);const g=t.useCallback(async e=>{l.info("[useAnswerSubmission] Submit answer called:",{elementId:e.elementId}),s("loading"),n(void 0),m(e);try{const t=await te.submitAnswer(e);h(t),t.cached?(s("offline"),N.info("Вы офлайн. Ответ будет отправлен при подключении к сети.",{duration:4e3})):t.success?(s("success"),setTimeout(()=>{s("idle")},2e3)):(s("error"),n(t.error||"Неизвестная ошибка"),N.error(t.error||"Ошибка отправки ответа",{duration:5e3})),x()}catch(t){const e=t instanceof Error?t.message:"Неизвестная ошибка";s("error"),n(e),h({success:!1,error:e}),l.error("[useAnswerSubmission] Submit error:",t),N.error(`Ошибка: ${e}`,{duration:5e3}),x()}},[x]),p=t.useCallback(async()=>{if(!d)return l.warn("[useAnswerSubmission] No last submission to retry"),void N.warning("Нет ответа для повторной отправки");l.info("[useAnswerSubmission] Retrying last submission"),await g(d)},[d,g]);return{submitAnswer:g,retry:p,isLoading:"loading"===e,status:e,error:r,isCached:"offline"===e,pendingCount:a,isNetworkOnline:o.isOnline,lastSubmissionResult:u}})();t.useEffect(()=>{if(!T&&q.length>0){const e=se();C(e),l.info("[LessonViewer] Initial element index:",e)}},[T,q.length]),t.useEffect(()=>{re()&&"completed"!==(null==$?void 0:$.status)&&(l.info("[LessonViewer] All elements completed, triggering lesson completion"),ge())},[null==$?void 0:$.completed_elements_count]),t.useEffect(()=>{H&&h&&h(H)},[H,h]);const xe=()=>{I<q.length-1&&(C(e=>e+1),E(!1),window.scrollTo({top:0,behavior:"smooth"}))},ge=async()=>{l.info("[LessonViewer] Completing lesson"),W({particleCount:100,spread:70,origin:{y:.6}});try{await ee()}catch(e){l.error("[LessonViewer] Complete lesson error:",e)}},pe=()=>{j(A?`/dashboard/student/knowledge-graph/${A}`:"/dashboard/student")};if(T)return r.jsx("div",{className:"container mx-auto px-4 py-8 max-w-4xl",children:r.jsxs("div",{className:"space-y-6",children:[r.jsx("div",{className:"h-8 w-64 bg-gray-200 dark:bg-gray-700 rounded animate-pulse"}),r.jsx("div",{className:"h-4 w-full bg-gray-200 dark:bg-gray-700 rounded animate-pulse"}),r.jsx(me,{})]})});if(H)return r.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-4xl",children:[r.jsx(d,{variant:"destructive",children:r.jsxs(m,{children:["Ошибка загрузки урока: ",H.message]})}),r.jsxs(c,{onClick:pe,className:"mt-4",variant:"outline",children:[r.jsx(F,{className:"h-4 w-4 mr-2"}),"Вернуться к графу"]})]});if(!G)return r.jsx("div",{className:"container mx-auto px-4 py-8 max-w-4xl",children:r.jsx(g,{children:r.jsxs(w,{className:"pt-6 space-y-6",children:[r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsx(M,{className:"h-12 w-12 text-yellow-600"}),r.jsxs("div",{children:[r.jsx("h2",{className:"text-2xl font-bold",children:"Урок заблокирован"}),r.jsx("p",{className:"text-muted-foreground",children:"Для доступа к этому уроку необходимо завершить предыдущие уроки"})]})]}),J.length>0&&r.jsxs("div",{className:"space-y-2",children:[r.jsx("h3",{className:"font-semibold",children:"Требуется завершить:"}),r.jsx("ul",{className:"list-disc list-inside space-y-1 text-muted-foreground",children:J.map(e=>r.jsx("li",{children:e.title},e.id))})]}),r.jsxs(c,{onClick:pe,variant:"outline",children:[r.jsx(F,{className:"h-4 w-4 mr-2"}),"Вернуться к графу"]})]})})});if(!O||!q.length)return r.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-4xl",children:[r.jsx(d,{children:r.jsx(m,{children:"Урок не содержит элементов"})}),r.jsxs(c,{onClick:pe,className:"mt-4",variant:"outline",children:[r.jsx(F,{className:"h-4 w-4 mr-2"}),"Вернуться к графу"]})]});const fe=q[I],we=ne(),je=I===q.length-1,ve=0===I,be="completed"===(null==(f=fe.progress)?void 0:f.status)||P;return"completed"===(null==$?void 0:$.status)&&re()?r.jsx("div",{className:"container mx-auto px-4 py-8 max-w-4xl",children:r.jsx(g,{children:r.jsxs(w,{className:"pt-6 space-y-6 text-center",children:[r.jsxs("div",{className:"flex flex-col items-center gap-4",children:[r.jsx("div",{className:"h-20 w-20 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center",children:r.jsx(k,{className:"h-12 w-12 text-green-600 dark:text-green-400"})}),r.jsxs("div",{children:[r.jsxs("h2",{className:"text-3xl font-bold flex items-center justify-center gap-2",children:["Урок завершен! ",r.jsx(K,{className:"h-6 w-6 text-yellow-500"})]}),r.jsxs("p",{className:"text-muted-foreground mt-2",children:['Поздравляем! Вы успешно завершили урок "',O.title,'"']})]})]}),$&&r.jsxs("div",{className:"bg-muted/50 rounded-lg p-4 space-y-2",children:[r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsx("span",{children:"Завершено элементов:"}),r.jsxs("span",{className:"font-semibold",children:[$.completed_elements_count," / ",$.total_elements_count]})]}),r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsx("span",{children:"Набрано баллов:"}),r.jsxs("span",{className:"font-semibold",children:[$.total_score," / ",$.max_total_score]})]}),r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsx("span",{children:"Процент выполнения:"}),r.jsxs("span",{className:"font-semibold",children:[$.score_percent,"%"]})]})]}),r.jsx("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:r.jsxs(c,{onClick:pe,size:"lg",children:[r.jsx(F,{className:"h-4 w-4 mr-2"}),"Вернуться к графу"]})})]})})}):r.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-4xl",children:[!he&&r.jsxs(d,{variant:"destructive",className:"mb-4",children:[r.jsx(R,{className:"h-4 w-4"}),r.jsx(m,{children:"Вы офлайн. Ответы будут сохранены локально и отправлены при подключении к сети."})]}),ue>0&&he&&r.jsxs(d,{className:"mb-4 border-blue-500 bg-blue-50 dark:bg-blue-950",children:[r.jsx(z,{className:"h-4 w-4 animate-spin"}),r.jsxs(m,{className:"flex items-center justify-between",children:[r.jsxs("span",{children:["Синхронизация ",ue," ответов..."]}),r.jsxs(c,{size:"sm",variant:"outline",onClick:()=>ie(),className:"ml-4",children:[r.jsx(V,{className:"h-3 w-3 mr-1"}),"Повторить"]})]})]}),r.jsxs("div",{className:"space-y-4 mb-6",children:[r.jsxs(c,{onClick:pe,variant:"ghost",size:"sm",className:"mb-2",children:[r.jsx(F,{className:"h-4 w-4 mr-2"}),"Вернуться к графу"]}),r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:O.title}),r.jsx("p",{className:"text-muted-foreground mt-2",children:O.description})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[r.jsxs("span",{children:["Элемент ",I+1," из ",q.length]}),r.jsxs("span",{children:[we,"% завершено"]})]}),r.jsx(y,{value:we,className:"h-2"})]})]}),r.jsxs("div",{className:"mb-6",children:["loading"===oe&&r.jsxs("div",{className:"mb-4 flex items-center justify-center gap-2 text-sm text-muted-foreground",children:[r.jsx(z,{className:"h-4 w-4 animate-spin"}),r.jsx("span",{children:"Сохранение..."})]}),"success"===oe&&r.jsxs("div",{className:"mb-4 flex items-center justify-center gap-2 text-sm text-green-600 dark:text-green-400",children:[r.jsx(k,{className:"h-4 w-4"}),r.jsx("span",{children:"Сохранено ✓"})]}),"offline"===oe&&r.jsx("div",{className:"mb-4",children:r.jsxs(x,{variant:"outline",className:"w-full justify-center py-2",children:[r.jsx(R,{className:"h-3 w-3 mr-2"}),"Сохранено локально. Будет отправлено при подключении к сети."]})}),"error"===oe&&ce&&r.jsx(d,{variant:"destructive",className:"mb-4",children:r.jsxs(m,{className:"flex items-center justify-between",children:[r.jsxs("span",{children:["Ошибка: ",ce]}),r.jsxs(c,{size:"sm",variant:"outline",onClick:()=>ie(),children:[r.jsx(V,{className:"h-3 w-3 mr-1"}),"Повторить"]})]})}),r.jsx(de,{element:fe,progress:fe.progress,onSubmit:async e=>{if(!(null==$?void 0:$.graph_lesson_id))return void N.error("Не удалось определить урок в графе");const s=q[I];if(s){l.info("[LessonViewer] Submitting answer for element:",s.id);try{await ae({elementId:s.id,answer:e,lessonId:_,graphId:A,graphLessonId:$.graph_lesson_id}),"success"!==oe&&"offline"!==oe||(E(!0),"success"===oe&&await Q({elementId:s.id,data:{answer:e,graph_lesson_id:$.graph_lesson_id}}))}catch(t){l.error("[LessonViewer] Submit answer error:",t)}}else N.error("Элемент не найден")},isLoading:Y||le,readOnly:!1})]}),r.jsxs("div",{className:"flex justify-between items-center gap-4",children:[r.jsxs(c,{onClick:()=>{I>0&&(C(e=>e-1),E(!1),window.scrollTo({top:0,behavior:"smooth"}))},variant:"outline",disabled:ve,className:"flex-1 sm:flex-initial",children:[r.jsx(D,{className:"h-4 w-4 mr-2"}),"Назад"]}),r.jsx("div",{className:"hidden sm:block text-sm text-muted-foreground",children:be&&r.jsxs("span",{className:"flex items-center gap-2 text-green-600",children:[r.jsx(k,{className:"h-4 w-4"}),"Выполнено"]})}),je?r.jsxs(c,{onClick:xe,disabled:!be||le,className:"flex-1 sm:flex-initial",variant:"default",children:[re()?"Завершить урок":"Последний элемент",r.jsx(U,{className:"h-4 w-4 ml-2"})]}):r.jsxs(c,{onClick:xe,disabled:!be||le,className:"flex-1 sm:flex-initial",children:["Далее",r.jsx(U,{className:"h-4 w-4 ml-2"})]})]}),r.jsx("div",{className:"sm:hidden mt-4 text-center text-sm text-muted-foreground",children:be&&r.jsxs("span",{className:"flex items-center justify-center gap-2 text-green-600",children:[r.jsx(k,{className:"h-4 w-4"}),"Элемент выполнен"]})})]})};export{ue as LessonViewer};
