# PgBouncer Connection Pool Configuration
# Manages connections to primary and replica PostgreSQL servers

[databases]
# Database definitions
thebot_db = host=pg-primary port=5432 user=thebot_user password=TheBot123!
thebot_replica = host=pg-replica port=5432 user=thebot_user password=TheBot123!

[pgbouncer]
# Server pools
pool_mode = transaction              # transaction, session, or statement
max_client_conn = 1000              # Maximum client connections
default_pool_size = 25              # Connections per server
min_pool_size = 10                  # Minimum pool size
reserve_pool_size = 5               # Reserved for emergencies
reserve_pool_timeout = 3            # Reserve pool timeout (seconds)
max_db_connections = 100            # Max connections per database
max_user_connections = 100          # Max connections per user
server_lifetime = 3600              # Close connection after this time (seconds)
server_idle_timeout = 600           # Close idle connection after (seconds)

# Connection timeouts
server_connect_timeout = 15         # Connect timeout
server_login_timeout = 15           # Login timeout
client_login_timeout = 60           # Client login timeout
autodb_idle_timeout = 3600          # Auto-created database timeout

# Query timeouts (statement_timeout in PostgreSQL)
query_timeout = 0                   # Query timeout (0 = disabled)
idle_in_transaction_session_timeout = 0

# Network settings
listen_addr = 0.0.0.0               # Listen on all interfaces
listen_port = 6432                  # PgBouncer port (different from PostgreSQL)
unix_socket_dir = /var/run/pgbouncer
unix_socket_mode = 0777

# Authentication
auth_type = scram-sha-256           # Authentication type
auth_file = /etc/pgbouncer/userlist.txt
auth_user = pgbouncer
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

# Logging
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60                   # Statistics update period (seconds)

# Admin interface
admin_users = admin
stats_users = admin,pgbouncer

# Connection checking
check_query = SELECT 1              # Query to check connection health
check_query_interval = 10           # How often to check (seconds)
check_query_timeout = 1             # Check query timeout (seconds)

# Transaction handling
ignore_startup_parameters = extra_float_digits
disable_pqexec = 0
application_name_add_host = 0

# Maintenance
max_overalloc_size = 20MB           # Max allowed to overallocate memory
verbose = 1

# Framed pooling
framed_pooling = 1

# Advanced features
tcp_keepalives = 1
tcp_keepidle = 10
tcp_keepintvl = 30
tcp_keepcnt = 5

# VIP/Virtual IP redirection (for failover)
# When failover happens, connection should redirect to new primary
# This is handled by application connection string or DNS update
