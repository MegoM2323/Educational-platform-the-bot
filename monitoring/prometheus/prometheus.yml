# THE_BOT Platform - Prometheus Configuration
# Comprehensive monitoring for all system components

global:
  scrape_interval: 15s          # Default interval between scrapes
  evaluation_interval: 15s       # Interval for evaluating rules
  external_labels:
    monitor: 'thebot-platform'
    environment: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'alertmanager:9093'

# Load rules once and periodically evaluate them
rule_files:
  - '/etc/prometheus/recording_rules.yml'
  - '/etc/prometheus/alert_rules.yml'

# Scrape configurations
scrape_configs:
  # Django Backend API Metrics (port 8001)
  - job_name: 'django-backend'
    static_configs:
      - targets: ['localhost:8001']
    metrics_path: '/api/system/metrics/prometheus/'
    scrape_interval: 15s
    scrape_timeout: 10s
    honor_timestamps: true
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'django-backend'
    metric_relabel_configs:
      # Keep only useful Django metrics
      - source_labels: [__name__]
        regex: 'django_request_latency_seconds_bucket|django_request_total|django_request_exceptions_total|django_db_execute_total|django_cache_hits_total|django_cache_misses_total'
        action: keep

  # Node.js Frontend Metrics (port 3001)
  - job_name: 'nodejs-frontend'
    static_configs:
      - targets: ['localhost:3001']
    metrics_path: '/metrics'
    scrape_interval: 15s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'nodejs-frontend'
    metric_relabel_configs:
      # Keep frontend specific metrics
      - source_labels: [__name__]
        regex: 'http_request_duration_ms|http_request_total|nodejs_version_info|process_resident_memory_bytes|process_cpu_seconds_total'
        action: keep

  # System Metrics via node_exporter
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
    scrape_interval: 15s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'system-metrics'
    metric_relabel_configs:
      # Keep essential system metrics
      - source_labels: [__name__]
        regex: 'node_cpu_seconds_total|node_memory_MemAvailable_bytes|node_memory_MemTotal_bytes|node_disk_io_reads_completed_total|node_disk_io_writes_completed_total|node_network_receive_bytes_total|node_network_transmit_bytes_total|node_load1|node_load5|node_load15'
        action: keep

  # PostgreSQL Database Metrics (postgres_exporter)
  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['localhost:9187']
    scrape_interval: 15s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'postgresql-db'
    metric_relabel_configs:
      # Keep database performance metrics
      - source_labels: [__name__]
        regex: 'pg_stat_statements_mean_exec_time|pg_stat_statements_calls|pg_stat_user_tables_seq_scan|pg_stat_user_tables_idx_scan|pg_stat_user_tables_live_tuples|pg_connections_available|pg_active_transactions|pg_replication_lag_seconds'
        action: keep

  # Redis Metrics (redis_exporter)
  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['localhost:9121']
    scrape_interval: 15s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'redis-cache'
    metric_relabel_configs:
      # Keep Redis performance metrics
      - source_labels: [__name__]
        regex: 'redis_connected_clients|redis_used_memory|redis_used_memory_peak|redis_keyspace_hits_total|redis_keyspace_misses_total|redis_commands_processed_total|redis_evicted_keys_total|redis_expired_keys_total'
        action: keep

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 15s
    scrape_timeout: 10s
