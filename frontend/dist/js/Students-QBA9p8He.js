import{r as e,j as s}from"./react-core-JVqWokWt.js";import{l as t,u as a,D as r,w as n,x as l,y as i,Z as d,g as c,h as o,i as u,j as m,k as h,_ as x,a7 as j,B as g,f as p,C as b,L as v,b as f,c as _,S as N,a as y,e as S,a3 as A,a4 as w,a5 as C,a6 as D}from"./main-fde3JC90.js";import{T}from"./TutorSidebar-DEiDMEeu.js";import{t as k,a as F,b as $}from"./useTutor-cHjriqfV.js";import{a as O}from"./react-query-DqnBFrGE.js";import{R as E,a as M}from"./radio-group-rQxajO1F.js";import{u as P}from"./useTutorStudentSchedule-WMCU5nXN.js";import{L as I}from"./LessonCard-BUGWm0lu.js";import{ab as q,$ as W,aU as L,aD as R,aE as V,aF as z}from"./vendor-DC2AZkDs.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./react-router-WAeXREDX.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";function B({open:b,onOpenChange:v,studentId:f,onSuccess:_}){const[N,y]=e.useState([]),[S,A]=e.useState([]),[w,C]=e.useState([]),[D,T]=e.useState("existing"),[k,$]=e.useState(""),[O,P]=e.useState(""),[I,q]=e.useState(""),[W,L]=e.useState(!1),[R,V]=e.useState(!1),z=F(f),{toast:B}=a();e.useEffect(()=>{if(!b)return $(""),P(""),q(""),T("existing"),y([]),A([]),void C([]);(async()=>{V(!0);try{t.debug("[AssignSubjectDialog] Loading data..."),t.debug("[AssignSubjectDialog] Making API requests..."),t.debug("[AssignSubjectDialog] Token:",p.getToken()?"EXISTS":"MISSING");const e=p.request("/materials/subjects/"),s=p.request("/tutor/teachers/"),[a,r]=await Promise.all([e,s]);t.debug("[AssignSubjectDialog] API requests completed"),t.debug("[AssignSubjectDialog] Subjects response:",{success:null==a?void 0:a.success,hasData:!!(null==a?void 0:a.data),dataType:typeof(null==a?void 0:a.data),isArray:Array.isArray(null==a?void 0:a.data),error:null==a?void 0:a.error}),t.debug("[AssignSubjectDialog] Teachers response:",{success:null==r?void 0:r.success,hasData:!!(null==r?void 0:r.data),dataType:typeof(null==r?void 0:r.data),isArray:Array.isArray(null==r?void 0:r.data),error:null==r?void 0:r.error,statusCode:null==r?void 0:r.status,fullResponse:r});let n=[];if(a&&!1!==a.success&&void 0!==a.data){const e=a.data;Array.isArray(e)?n=e:e&&"object"==typeof e&&(Array.isArray(e.results)?n=e.results:Array.isArray(e.subjects)?n=e.subjects:Array.isArray(e.data)&&(n=e.data))}let l=[];if(r)if(t.debug("[AssignSubjectDialog] Teachers response:",{success:r.success,hasData:!!r.data,dataType:typeof r.data,isArray:Array.isArray(r.data),error:r.error,fullResponse:r}),r.error)t.error("[AssignSubjectDialog] ✗ Teachers API returned error:",r.error),t.error("[AssignSubjectDialog] Full error response:",r);else{const e=r.data;if(null!=e)if(Array.isArray(e))l=e.filter(e=>e&&e.id&&("teacher"===e.role||void 0===e.role)),t.debug("[AssignSubjectDialog] ✓ Teachers loaded from array:",l.length,"out of",e.length),l.length>0&&t.debug("[AssignSubjectDialog] Sample teacher:",l[0]);else if(e&&"object"==typeof e){t.debug("[AssignSubjectDialog] Teachers data is object, checking nested structures..."),t.debug("[AssignSubjectDialog] Object keys:",Object.keys(e));let s=null;if(Array.isArray(e.results))s=e.results;else if(Array.isArray(e.users))s=e.users;else if(Array.isArray(e.data))s=e.data;else{const t=Object.values(e).find(e=>Array.isArray(e));t&&(s=t)}s?(l=s.filter(e=>e&&e.id&&("teacher"===e.role||void 0===e.role)),t.debug("[AssignSubjectDialog] Teachers extracted from object:",l.length)):(t.warn("[AssignSubjectDialog] ⚠ Teachers data is object but no array found. Keys:",Object.keys(e)),t.warn("[AssignSubjectDialog] Data structure:",JSON.stringify(e,null,2).substring(0,500)))}else t.warn("[AssignSubjectDialog] ⚠ Teachers data is not array or object:",typeof e),t.warn("[AssignSubjectDialog] Data value:",e);else t.warn("[AssignSubjectDialog] ⚠ Teachers response data is undefined or null"),t.warn("[AssignSubjectDialog] Response object:",JSON.stringify(r,null,2).substring(0,500))}else t.error("[AssignSubjectDialog] No teachers response received (t is null/undefined)");t.debug("[AssignSubjectDialog] Parsed subjects:",n.length),t.debug("[AssignSubjectDialog] Parsed teachers:",l.length),l.length>0&&t.debug("[AssignSubjectDialog] First teacher sample:",l[0]),y(n),A(l),l.length>0?(C(l),t.debug("[AssignSubjectDialog] Teachers set as available:",l.length)):(t.warn("[AssignSubjectDialog] No teachers loaded - showing error message to user"),C([]),B({title:"Предупреждение",description:"Не удалось загрузить список преподавателей. Проверьте консоль браузера или обратитесь к администратору.",variant:"destructive"}))}catch(e){t.error("[AssignSubjectDialog] Error loading data:",e),t.error("[AssignSubjectDialog] Error details:",{message:null==e?void 0:e.message,response:null==e?void 0:e.response,stack:null==e?void 0:e.stack}),y([]),A([]),C([]),B({title:"Ошибка",description:(null==e?void 0:e.message)||"Не удалось загрузить данные для назначения предмета",variant:"destructive"})}finally{V(!1)}})()},[b,B]),e.useEffect(()=>{b&&S.length>0?C(S):C([])},[b,S]);return s.jsx(r,{open:b,onOpenChange:e=>{v(e),e||($(""),P(""),q(""),T("existing"))},children:s.jsxs(n,{className:"max-w-2xl",children:[s.jsx(l,{children:s.jsx(i,{children:"Назначить предмет"})}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx(d,{children:"Режим выбора предмета"}),s.jsxs(E,{value:D,onValueChange:e=>{T(e),$(""),P("")},children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(M,{value:"existing",id:"existing"}),s.jsx(d,{htmlFor:"existing",className:"cursor-pointer",children:"Выбрать из существующих"})]}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(M,{value:"custom",id:"custom"}),s.jsx(d,{htmlFor:"custom",className:"cursor-pointer",children:"Создать новый предмет"})]})]})]}),"existing"===D?s.jsxs("div",{children:[s.jsx(d,{children:"Предмет"}),s.jsxs(c,{value:k,onValueChange:e=>{$(e)},children:[s.jsx(o,{"aria-label":"subject-select",children:s.jsx(u,{placeholder:R?"Загрузка...":"Выберите предмет"})}),s.jsx(m,{children:R&&0===N.length?s.jsx(h,{value:"loading",disabled:!0,children:"Загрузка предметов..."}):Array.isArray(N)&&N.length>0?N.map(e=>s.jsx(h,{value:String(e.id),children:e.name},e.id)):s.jsx(h,{value:"none",disabled:!0,children:"Нет доступных предметов"})})]})]}):s.jsxs("div",{children:[s.jsx(d,{children:"Название нового предмета"}),s.jsx(x,{value:O,onChange:e=>P(e.target.value),placeholder:"Например: Математика для 7 класса"}),s.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Будет создан новый предмет с указанным названием"})]}),s.jsxs("div",{children:[s.jsxs(d,{children:["Преподаватель ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsxs(c,{value:I,onValueChange:q,disabled:R,children:[s.jsx(o,{"aria-label":"teacher-select",className:I||R?"":"border-red-500",children:s.jsx(u,{placeholder:R?"Загрузка...":"Выберите преподавателя *"})}),s.jsx(m,{children:(()=>{if(R&&0===S.length&&0===w.length)return s.jsx(h,{value:"loading",disabled:!0,children:"Загрузка преподавателей..."});const e=w.length>0?w:S;return t.debug("[AssignSubjectDialog] Rendering teachers select:",{loading:R,availableTeachersCount:w.length,allTeachersCount:S.length,teachersToShowCount:e.length}),0===e.length?R?s.jsx(h,{value:"loading",disabled:!0,children:"Загрузка преподавателей..."}):s.jsxs(s.Fragment,{children:[s.jsx(h,{value:"none",disabled:!0,children:"Нет доступных преподавателей"}),s.jsx(h,{value:"error",disabled:!0,children:"Проверьте консоль браузера для деталей"})]}):e.map(e=>{const t=e.full_name||`${e.first_name||""} ${e.last_name||""}`.trim()||e.email||`User ${e.id}`;return s.jsx(h,{value:String(e.id),children:t},e.id)})})()})]}),s.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:R?"Загрузка списка преподавателей...":w.length>0?`Доступно преподавателей: ${w.length}. Выберите из списка всех преподавателей из базы данных.`:"Не удалось загрузить список преподавателей. Проверьте консоль браузера для деталей или обратитесь к администратору."})]})]}),s.jsxs(j,{children:[s.jsx(g,{type:"button",variant:"outline",onClick:()=>{$(""),P(""),q(""),T("existing"),v(!1)},children:"Отмена"}),s.jsx(g,{type:"button",onClick:async()=>{try{if("existing"===D&&!k){const e="Пожалуйста, выберите предмет";return t.error(e),void B({title:"Ошибка валидации",description:e,variant:"destructive"})}if("custom"===D&&!O.trim()){const e="Пожалуйста, укажите название предмета";return t.error(e),void B({title:"Ошибка валидации",description:e,variant:"destructive"})}if(!I||""===I){const e="Пожалуйста, выберите преподавателя";return t.error(e),void B({title:"Ошибка валидации",description:e,variant:"destructive"})}const e={};"existing"===D?e.subject_id=Number(k):e.subject_name=O.trim(),e.teacher_id=Number(I),await z.mutateAsync(e),t.debug("[AssignSubjectDialog] Subject assigned successfully"),$(""),P(""),q(""),T("existing"),v(!1),_&&(t.debug("[AssignSubjectDialog] Calling onSuccess callback"),_())}catch(e){t.error("[AssignSubjectDialog] Error submitting:",e)}},disabled:z.isPending||"existing"===D&&!k||"custom"===D&&!O.trim()||!I||""===I,children:"Назначить"})]})]})})}const J=({statusFilter:e,subjectFilter:t,subjects:a,lessonCount:r,onStatusChange:n,onSubjectChange:l})=>s.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 items-start sm:items-center",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(L,{className:"w-4 h-4 text-muted-foreground"}),s.jsx("span",{className:"text-sm font-medium",children:"Фильтры:"})]}),s.jsxs(c,{value:e,onValueChange:n,children:[s.jsx(o,{className:"w-[180px]",children:s.jsx(u,{placeholder:"Статус"})}),s.jsxs(m,{children:[s.jsx(h,{value:"all",children:"Все статусы"}),s.jsx(h,{value:"pending",children:"Ожидание"}),s.jsx(h,{value:"confirmed",children:"Подтверждено"}),s.jsx(h,{value:"completed",children:"Завершено"}),s.jsx(h,{value:"cancelled",children:"Отменено"})]})]}),a.length>0&&s.jsxs(c,{value:t,onValueChange:l,children:[s.jsx(o,{className:"w-[180px]",children:s.jsx(u,{placeholder:"Предмет"})}),s.jsxs(m,{children:[s.jsx(h,{value:"all",children:"Все предметы"}),a.map(e=>s.jsx(h,{value:e,children:e},e))]})]}),s.jsxs(_,{variant:"secondary",children:[r," уроков"]})]}),K=({studentId:t})=>{const[a,r]=e.useState("all"),[n,l]=e.useState("all"),i=(e,s)=>{if(!e||!s)return 0;const t=new Date(`${e}T${s}`);return isNaN(t.getTime())?0:t.getTime()};if(null===t)return s.jsx(b,{children:s.jsxs(v,{className:"p-12 text-center",children:[s.jsx(q,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground opacity-50"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Студент не выбран"}),s.jsx("p",{className:"text-muted-foreground",children:"Выберите студента для просмотра расписания"})]})});const{lessons:d,isLoading:c,error:o}=P(t),u=e.useMemo(()=>{const e=new Map;return d.forEach(s=>{s.subject_name&&e.set(s.subject_name,s.subject_name)}),Array.from(e.values())},[d]),m=e.useMemo(()=>d.filter(e=>("all"===a||e.status===a)&&("all"===n||e.subject_name===n)),[d,a,n]),h=e.useMemo(()=>[...m].sort((e,s)=>i(e.date,e.start_time)-i(s.date,s.start_time)),[m]);return c?s.jsx("div",{className:"space-y-4",children:[...Array(3)].map((e,t)=>s.jsx(b,{className:"overflow-hidden",children:s.jsx(v,{className:"p-6",children:s.jsxs("div",{className:"space-y-3",children:[s.jsx(f,{className:"h-6 w-1/2"}),s.jsx(f,{className:"h-4 w-1/3"}),s.jsx(f,{className:"h-4 w-2/3"})]})})},t))}):o?s.jsx(b,{className:"border-destructive/50 bg-destructive/5",children:s.jsx(v,{className:"p-6",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(W,{className:"w-5 h-5 text-destructive flex-shrink-0"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-semibold text-destructive",children:"Ошибка загрузки расписания"}),s.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:o instanceof Error?o.message:"Неизвестная ошибка"})]})]})})}):0!==h.length||"all"===a&&"all"===n?0===h.length?s.jsx(b,{children:s.jsxs(v,{className:"p-12 text-center",children:[s.jsx(q,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground opacity-50"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Нет запланированных занятий"}),s.jsx("p",{className:"text-muted-foreground",children:"Расписание пусто. Создайте первое занятие в расписании учителя."})]})}):s.jsxs("div",{className:"space-y-4",children:[s.jsx(J,{statusFilter:a,subjectFilter:n,subjects:u,lessonCount:h.length,onStatusChange:r,onSubjectChange:l}),h.map(e=>s.jsx(I,{lesson:e},e.id))]}):s.jsxs("div",{className:"space-y-4",children:[s.jsx(J,{statusFilter:a,subjectFilter:n,subjects:u,lessonCount:h.length,onStatusChange:r,onSubjectChange:l}),s.jsx(b,{children:s.jsxs(v,{className:"p-12 text-center",children:[s.jsx(W,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground opacity-50"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Нет уроков по выбранным фильтрам"}),s.jsx("p",{className:"text-muted-foreground",children:"Попробуйте изменить фильтры"})]})})]})};function U(){const{data:c,isLoading:o}=O({queryKey:["tutor","students","schedule",...Object.values({})],queryFn:async()=>{t.debug("[useTutorStudentsWithSchedule] Fetching students and schedule...");try{const s=await k.listStudents();t.debug("[useTutorStudentsWithSchedule] Basic students:",s.length);let a=[];try{a=await k.getStudentsSchedule(),t.debug("[useTutorStudentsWithSchedule] Schedule students:",a.length)}catch(e){t.warn("[useTutorStudentsWithSchedule] Failed to fetch schedule, using empty data:",e)}const r=new Map;a&&Array.isArray(a)&&a.forEach(e=>{e&&e.id&&r.set(e.id,e)});const n=s.map(e=>{const s=r.get(e.id);return{...e,next_lesson:void 0!==(null==s?void 0:s.next_lesson)?s.next_lesson:null,lessons_count:"number"==typeof(null==s?void 0:s.lessons_count)?s.lessons_count:0}});return t.debug("[useTutorStudentsWithSchedule] Merged students:",n.length),n}catch(e){throw t.error("[useTutorStudentsWithSchedule] Error fetching data:",e),e}},staleTime:3e4,gcTime:6e4,retry:2,refetchOnWindowFocus:!0,refetchOnMount:!0}),u=$(),{toast:m}=a(),[h,p]=e.useState(!1),[v,f]=e.useState(!1),[F,E]=e.useState(null),[M,P]=e.useState(!1),[I,W]=e.useState(null),[L,J]=e.useState(!1),[U,G]=e.useState(null),[X,Z]=e.useState("overview"),[H,Q]=e.useState({});e.useEffect(()=>{if(c){const e=c.reduce((e,s)=>{var t;return e+((null==(t=s.subjects)?void 0:t.length)||0)},0);t.debug(`[TutorStudentsPage] Rendered with ${c.length} students, ${e} total subjects`),c.forEach(e=>{var s,a;const r=(null==(s=e.subjects)?void 0:s.length)||0;t.debug(`[TutorStudentsPage] - Student ${e.id} (${e.full_name}): ${r} subjects`),r>0&&(null==(a=e.subjects)||a.forEach(e=>{t.debug(`    * ${e.name} (teacher: ${e.teacher_name})`)}))})}},[c]);const[Y,ee]=e.useState({first_name:"",last_name:"",grade:"",goal:"",parent_first_name:"",parent_last_name:"",parent_email:"",parent_phone:""}),se=(e,s)=>{if(ee({...Y,[e]:s}),H[e]){const s={...H};delete s[e],Q(s)}},te=e=>{h||v||L||(t.debug("[Students] Opening assign dialog for student:",e),W(e),P(!0))};return s.jsxs(N,{children:[s.jsxs("div",{className:"flex min-h-screen w-full",children:[s.jsx(T,{}),s.jsxs(y,{children:[s.jsxs("header",{className:"sticky top-0 z-10 flex h-16 items-center gap-4 border-b bg-background px-6",children:[s.jsx(S,{}),s.jsx("div",{className:"flex-1"}),s.jsx(g,{type:"button",onClick:()=>{v||M||L||p(!0)},children:"Создать ученика"})]}),s.jsx("main",{className:"p-6",children:s.jsx("div",{className:"space-y-6",children:s.jsxs(b,{className:"p-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("h2",{className:"text-xl font-semibold",children:"Мои ученики"}),s.jsx(_,{variant:"secondary",children:(null==c?void 0:c.length)||0})]}),o?s.jsx("div",{children:"Загрузка..."}):s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:null==c?void 0:c.map(e=>{var t,a;const r=(null==(t=e.subjects)?void 0:t.length)||0,n=null!==e.next_lesson&&void 0!==e.next_lesson;return s.jsxs(b,{className:"p-4 space-y-3 cursor-pointer hover:border-primary transition-colors",onClick:()=>{return s=e,void(h||v||M||(G(s),Z("overview"),J(!0)));var s},children:[s.jsx("div",{className:"font-medium",children:e.full_name||`${e.first_name||""} ${e.last_name||""}`}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:["Класс: ",e.grade||"-"]}),s.jsxs("div",{className:"text-sm text-muted-foreground",children:["Цель: ",e.goal||"-"]}),n&&e.next_lesson?s.jsxs("div",{className:"p-2 bg-blue-50 rounded-md border border-blue-200",children:[s.jsx("div",{className:"text-xs font-semibold text-blue-900 mb-1",children:"Следующий урок:"}),s.jsxs("div",{className:"flex items-center gap-2 text-xs text-blue-800",children:[s.jsx(q,{className:"w-3 h-3"}),s.jsx("span",{children:R(new Date(e.next_lesson.date),"d MMMM",{locale:V})})]}),s.jsxs("div",{className:"flex items-center gap-2 text-xs text-blue-800",children:[s.jsx(z,{className:"w-3 h-3"}),s.jsx("span",{children:e.next_lesson.start_time.slice(0,5)})]}),s.jsxs("div",{className:"text-xs text-blue-700 mt-1",children:["Преподаватель: ",e.next_lesson.teacher]})]}):s.jsx("div",{className:"p-2 bg-muted rounded-md text-xs text-muted-foreground",children:"Нет запланированных уроков"}),r>0?s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"text-sm font-semibold",children:["Назначенные предметы (",r,"):"]}),s.jsx("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:null==(a=e.subjects)?void 0:a.map(e=>s.jsxs("div",{className:"text-sm text-muted-foreground pl-2 border-l-2 border-primary",children:[s.jsx("div",{className:"font-medium",children:e.name}),s.jsxs("div",{className:"text-xs",children:["Преподаватель: ",e.teacher_name||"Не указан"]})]},e.enrollment_id))})]}):s.jsx("div",{className:"text-sm text-muted-foreground italic",children:"Нет назначенных предметов"}),s.jsx("div",{className:"pt-2 flex gap-2",onClick:e=>e.stopPropagation(),children:s.jsx(g,{type:"button",variant:"secondary",size:"sm",onClick:()=>te(e.id),children:"Назначить предмет"})})]},e.id)})})]})})})]})]}),s.jsx(r,{open:h,onOpenChange:e=>{p(e),e||(ee({first_name:"",last_name:"",grade:"",goal:"",parent_first_name:"",parent_last_name:"",parent_email:"",parent_phone:""}),Q({}))},children:s.jsxs(n,{children:[s.jsx(l,{children:s.jsx(i,{children:"Создание ученика"})}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx(d,{htmlFor:"first_name",children:"Имя *"}),s.jsx(x,{id:"first_name",value:Y.first_name,onChange:e=>se("first_name",e.target.value),className:H.first_name?"border-red-500":""}),H.first_name&&s.jsx("p",{className:"text-sm text-red-500 mt-1",children:H.first_name})]}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"last_name",children:"Фамилия *"}),s.jsx(x,{id:"last_name",value:Y.last_name,onChange:e=>se("last_name",e.target.value),className:H.last_name?"border-red-500":""}),H.last_name&&s.jsx("p",{className:"text-sm text-red-500 mt-1",children:H.last_name})]}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"grade",children:"Класс *"}),s.jsx(x,{id:"grade",value:Y.grade,onChange:e=>se("grade",e.target.value),className:H.grade?"border-red-500":"",placeholder:"например, 7Б"}),H.grade&&s.jsx("p",{className:"text-sm text-red-500 mt-1",children:H.grade})]}),s.jsxs("div",{className:"md:col-span-2",children:[s.jsx(d,{htmlFor:"goal",children:"Цель (необязательно)"}),s.jsx(x,{id:"goal",value:Y.goal,onChange:e=>se("goal",e.target.value),placeholder:"Дополнительная информация о целях обучения"})]}),s.jsx("div",{className:"md:col-span-2",children:s.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Данные родителя"})}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"parent_first_name",children:"Имя родителя *"}),s.jsx(x,{id:"parent_first_name",value:Y.parent_first_name,onChange:e=>se("parent_first_name",e.target.value),className:H.parent_first_name?"border-red-500":""}),H.parent_first_name&&s.jsx("p",{className:"text-sm text-red-500 mt-1",children:H.parent_first_name})]}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"parent_last_name",children:"Фамилия родителя *"}),s.jsx(x,{id:"parent_last_name",value:Y.parent_last_name,onChange:e=>se("parent_last_name",e.target.value),className:H.parent_last_name?"border-red-500":""}),H.parent_last_name&&s.jsx("p",{className:"text-sm text-red-500 mt-1",children:H.parent_last_name})]}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"parent_email",children:"Email родителя (необязательно)"}),s.jsx(x,{id:"parent_email",type:"email",value:Y.parent_email,onChange:e=>se("parent_email",e.target.value),placeholder:"parent@example.com"})]}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"parent_phone",children:"Телефон родителя (необязательно)"}),s.jsx(x,{id:"parent_phone",type:"tel",value:Y.parent_phone,onChange:e=>se("parent_phone",e.target.value),placeholder:"+79991234567"})]})]}),s.jsxs(j,{children:[s.jsx(g,{type:"button",variant:"outline",onClick:()=>p(!1),children:"Отмена"}),s.jsx(g,{type:"button",onClick:async()=>{if((()=>{const e={};return Y.first_name.trim()||(e.first_name="Имя обязательно для заполнения"),Y.last_name.trim()||(e.last_name="Фамилия обязательна для заполнения"),Y.grade.trim()||(e.grade="Класс обязателен для заполнения"),Y.parent_first_name.trim()||(e.parent_first_name="Имя родителя обязательно для заполнения"),Y.parent_last_name.trim()||(e.parent_last_name="Фамилия родителя обязательна для заполнения"),Q(e),0===Object.keys(e).length})())try{t.debug("Submitting student creation form:",Y);const e=await u.mutateAsync(Y);t.debug("Student created successfully:",e),E(e.credentials),p(!1),f(!0),ee({first_name:"",last_name:"",grade:"",goal:"",parent_first_name:"",parent_last_name:"",parent_email:"",parent_phone:""}),Q({}),t.debug("[Students] Student created, data should be refreshed automatically")}catch(e){t.error("Error creating student:",e)}else m({title:"Ошибка валидации",description:"Пожалуйста, заполните все обязательные поля",variant:"destructive"})},disabled:u.isPending,children:"Создать"})]})]})}),s.jsx(r,{open:v,onOpenChange:e=>{f(e),e||E(null)},children:s.jsxs(n,{children:[s.jsx(l,{children:s.jsx(i,{children:"Сгенерированные учетные данные"})}),F?s.jsxs("div",{className:"space-y-3",children:[s.jsxs(b,{className:"p-3",children:[s.jsx("div",{className:"font-semibold mb-2",children:"Ученик"}),s.jsxs("div",{className:"text-sm",children:["Логин: ",F.student.username]}),s.jsxs("div",{className:"text-sm",children:["Пароль: ",F.student.password]})]}),s.jsxs(b,{className:"p-3",children:[s.jsx("div",{className:"font-semibold mb-2",children:"Родитель"}),s.jsxs("div",{className:"text-sm",children:["Логин: ",F.parent.username]}),s.jsxs("div",{className:"text-sm",children:["Пароль: ",F.parent.password]})]})]}):null,s.jsx(j,{children:s.jsx(g,{type:"button",onClick:()=>f(!1),children:"Закрыть"})})]})}),null!==I&&s.jsx(B,{open:M,onOpenChange:e=>{P(e),e||W(null)},studentId:I}),s.jsx(r,{open:L,onOpenChange:e=>{J(e),e||(G(null),Z("overview"))},children:s.jsxs(n,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[s.jsx(l,{children:s.jsx(i,{children:(null==U?void 0:U.full_name)||`${(null==U?void 0:U.first_name)||""} ${(null==U?void 0:U.last_name)||""}`})}),U&&s.jsxs(A,{value:X,onValueChange:e=>Z(e),children:[s.jsxs(w,{className:"grid w-full grid-cols-2",children:[s.jsx(C,{value:"overview",children:"Обзор"}),s.jsx(C,{value:"schedule",children:"Расписание"})]}),s.jsx(D,{value:"overview",className:"space-y-4",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"text-sm font-semibold text-muted-foreground",children:"Класс"}),s.jsx("p",{className:"text-base font-medium",children:U.grade||"-"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"text-sm font-semibold text-muted-foreground",children:"Цель обучения"}),s.jsx("p",{className:"text-base font-medium",children:U.goal||"-"})]})]}),U.subjects&&U.subjects.length>0?s.jsxs("div",{className:"space-y-2",children:[s.jsxs("label",{className:"text-sm font-semibold text-muted-foreground",children:["Назначенные предметы (",U.subjects.length,")"]}),s.jsx("div",{className:"space-y-2",children:U.subjects.map(e=>s.jsxs(b,{className:"p-3",children:[s.jsx("div",{className:"font-medium text-sm",children:e.name}),s.jsxs("div",{className:"text-xs text-muted-foreground",children:["Преподаватель: ",e.teacher_name||"Не указан"]})]},e.enrollment_id))})]}):s.jsx("div",{className:"p-4 bg-muted rounded-lg text-center text-sm text-muted-foreground",children:"Нет назначенных предметов"}),s.jsx(g,{type:"button",variant:"secondary",className:"w-full",onClick:()=>te(U.id),children:"Назначить новый предмет"})]})}),s.jsx(D,{value:"schedule",children:s.jsx(K,{studentId:U.id.toString()})})]}),s.jsx(j,{children:s.jsx(g,{type:"button",variant:"outline",onClick:()=>J(!1),children:"Закрыть"})})]})})]})}export{U as default};
