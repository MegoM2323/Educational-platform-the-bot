# THE BOT Platform - Advanced API Gateway Configuration
# Extends load-balancer.conf with request/response transformation and API versioning
#
# Features:
# - Request ID injection (X-Request-ID) for distributed tracing
# - Request/response logging at gateway level
# - API versioning support (/api/v1/, /api/v2/)
# - Rate limiting per API key (not just per IP)
# - Request validation (content-type, size limits)
# - Response transformation (CORS headers, security headers)
# - Circuit breaker pattern with fallback responses
# - Request/response transformation (header injection, body rewriting)
#
# Installation:
#   1. Include this file in main nginx.conf: include nginx/api-gateway.conf;
#   2. Ensure load-balancer.conf is also included
#   3. Test: sudo nginx -t
#   4. Reload: sudo systemctl reload nginx

# ============================================
# 1. REQUEST/RESPONSE LOGGING
# ============================================

# Extended log format for API gateway with request ID tracing
log_format api_gateway_detailed '$remote_addr - $remote_user [$time_local] '
                               '"$request" $status $body_bytes_sent '
                               'req_id=$http_x_request_id '
                               'api_version=$http_x_api_version '
                               'api_key=$http_x_api_key '
                               'method=$request_method path=$request_uri '
                               'rt=$request_time '
                               'uct=$upstream_connect_time '
                               'uht=$upstream_header_time '
                               'urt=$upstream_response_time '
                               'upstream=$upstream_addr '
                               'cf_ray=$http_cf_ray '
                               'user_agent=$http_user_agent '
                               'referer=$http_referer';

# Log format for API metrics export
log_format api_metrics_json escape=json
{
    "timestamp": "$time_iso8601",
    "request_id": "$http_x_request_id",
    "remote_addr": "$remote_addr",
    "method": "$request_method",
    "path": "$request_uri",
    "api_version": "$http_x_api_version",
    "api_key": "$http_x_api_key",
    "status": $status,
    "response_time": $request_time,
    "upstream_time": $upstream_response_time,
    "bytes_sent": $body_bytes_sent,
    "bytes_received": $content_length,
    "upstream_addr": "$upstream_addr",
    "user_agent": "$http_user_agent"
};

# ============================================
# 2. REQUEST ID GENERATION & INJECTION
# ============================================

# Generate unique request ID if not provided
map $http_x_request_id $request_id {
    default $http_x_request_id;
    "" $msec-$pid;
}

# Generate correlation ID for request tracing
map $request_id $correlation_id {
    default $request_id;
}

# ============================================
# 3. API VERSIONING SUPPORT
# ============================================

# Extract API version from request path
map $request_uri $api_version {
    ~^/api/v(?<ver>\d+)/ $ver;
    default "1";  # Default to v1 if not specified
}

# Route to different backends based on API version
# v1: Current production API (legacy)
# v2: New API with breaking changes
map $api_version $api_backend {
    "1" "backend_api_v1";
    "2" "backend_api_v2";
    default "backend_api";
}

# ============================================
# 4. API KEY EXTRACTION & VALIDATION
# ============================================

# Extract API key from headers (try multiple sources)
map $http_authorization $api_key {
    # Extract from Authorization: Bearer <token>
    ~^Bearer\s(?<key>.*) $key;
    default $http_x_api_key;  # Fallback to X-API-Key header
}

# Hash API key for rate limiting (don't expose raw key in logs)
map $api_key $api_key_hash {
    default $api_key;
}

# ============================================
# 5. RATE LIMITING - PER API KEY
# ============================================

# Rate limiting zones based on API key
limit_req_zone $api_key_hash zone=api_key_limit:50m rate=100r/s;
limit_req_zone $api_key_hash zone=api_key_strict_limit:50m rate=10r/s;

# Per-IP rate limiting (fallback if no API key)
limit_req_zone $binary_remote_addr zone=ip_limit:10m rate=50r/s;
limit_req_zone $binary_remote_addr zone=ip_strict_limit:10m rate=5r/s;

# ============================================
# 6. CONTENT-TYPE VALIDATION
# ============================================

# Allowed content types for POST/PUT/PATCH
map $request_method $allowed_content_types {
    POST 1;
    PUT 1;
    PATCH 1;
    default 0;
}

# Content-type validation (simplified - detailed validation in app)
map $content_type $valid_content_type {
    ~^application/json 1;
    ~^multipart/form-data 1;
    ~^application/x-www-form-urlencoded 1;
    "" 1;  # Allow GET requests without content-type
    default 0;
}

# ============================================
# 7. CIRCUIT BREAKER STATUS
# ============================================

# Circuit breaker state (requires lua module for dynamic state)
# For now, use simple upstream health checks
# Production: Use ngx_http_upstream_module with health checks

# Fallback response for circuit breaker (502/503)
map $status $backend_status {
    200 "OK";
    201 "Created";
    204 "No Content";
    400 "Bad Request";
    401 "Unauthorized";
    403 "Forbidden";
    404 "Not Found";
    429 "Too Many Requests";
    500 "Internal Server Error";
    502 "Bad Gateway";
    503 "Service Unavailable";
    default "Unknown";
}

# ============================================
# 8. UPSTREAM BACKENDS - API VERSIONING
# ============================================

# Backend API v1 (legacy)
upstream backend_api_v1 {
    least_conn;
    keepalive 32;
    keepalive_timeout 60s;
    keepalive_requests 100;

    server backend-1.internal:8000 weight=1 max_fails=3 fail_timeout=30s;
    server backend-2.internal:8000 weight=1 max_fails=3 fail_timeout=30s;
    server backend-3.internal:8000 weight=1 max_fails=3 fail_timeout=30s;
    server backup-backend.internal:8000 backup max_fails=3 fail_timeout=30s;
}

# Backend API v2 (future breaking changes)
upstream backend_api_v2 {
    least_conn;
    keepalive 32;
    keepalive_timeout 60s;
    keepalive_requests 100;

    server backend-1.internal:8002 weight=1 max_fails=3 fail_timeout=30s;
    server backend-2.internal:8002 weight=1 max_fails=3 fail_timeout=30s;
    server backend-3.internal:8002 weight=1 max_fails=3 fail_timeout=30s;
    server backup-backend.internal:8002 backup max_fails=3 fail_timeout=30s;
}

# ============================================
# 9. API GATEWAY SERVER BLOCK
# ============================================

server {
    listen 8443 ssl http2;
    listen [::]:8443 ssl http2;
    server_name api.the-bot.ru;

    # SSL Configuration (same as main server)
    ssl_certificate /etc/letsencrypt/live/the-bot.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/the-bot.ru/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;

    # Logging
    access_log /var/log/nginx/api-gateway-access.log api_gateway_detailed;
    access_log /var/log/nginx/api-gateway-metrics.log api_metrics_json;
    error_log /var/log/nginx/api-gateway-error.log warn;

    # ============================================
    # API GATEWAY ENDPOINTS
    # ============================================

    # Health check endpoint
    location /health {
        access_log off;
        add_header Content-Type application/json;
        add_header X-Request-ID $request_id;
        return 200 '{"status":"healthy","timestamp":"$time_iso8601","gateway":"api-gateway"}';
    }

    # Metrics endpoint (for monitoring)
    location /metrics {
        access_log off;
        add_header Content-Type text/plain;
        add_header X-Request-ID $request_id;
        return 200 "# API Gateway Metrics\nrequest_id=$request_id\napi_version=$api_version\nstatus=active\n";
    }

    # API version info endpoint
    location /api/versions {
        access_log on;
        add_header Content-Type application/json;
        add_header X-Request-ID $request_id;
        add_header X-API-Version "1.0";

        return 200 '{
            "supported_versions": ["v1", "v2"],
            "current_version": "v1",
            "deprecated_versions": [],
            "gateway_version": "1.0.0",
            "timestamp": "$time_iso8601"
        }';
    }

    # ============================================
    # API v1 ENDPOINTS (DEFAULT)
    # ============================================

    location ~ ^/api/v1(?<path>/.*)$ {
        # Request ID injection
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header X-Correlation-ID $correlation_id;

        # API version headers
        proxy_set_header X-API-Version "1";
        proxy_set_header X-API-Endpoint $request_uri;
        proxy_set_header X-API-Key $api_key_hash;

        # Rate limiting per API key
        limit_req zone=api_key_limit burst=20 nodelay;

        # Request validation
        if ($allowed_content_types = 1) {
            if ($valid_content_type = 0) {
                add_header X-Request-ID $request_id always;
                add_header Content-Type application/json always;
                return 415 '{"error":"Unsupported Media Type","request_id":"$request_id"}';
            }
        }

        # Proxy settings
        proxy_pass http://backend_api_v1$path$is_args$args;
        proxy_http_version 1.1;

        # Headers forwarding
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        # Connection management
        proxy_set_header Connection "";
        proxy_buffering off;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # Error handling & circuit breaker
        proxy_intercept_errors on;
        error_page 502 503 504 = @circuit_breaker;

        # Retry on upstream errors
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 5s;
    }

    # ============================================
    # API v2 ENDPOINTS (FUTURE)
    # ============================================

    location ~ ^/api/v2(?<path>/.*)$ {
        # Request ID injection
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header X-Correlation-ID $correlation_id;

        # API version headers
        proxy_set_header X-API-Version "2";
        proxy_set_header X-API-Endpoint $request_uri;
        proxy_set_header X-API-Key $api_key_hash;

        # Rate limiting per API key (stricter for v2)
        limit_req zone=api_key_strict_limit burst=10 nodelay;

        # Request validation
        if ($allowed_content_types = 1) {
            if ($valid_content_type = 0) {
                add_header X-Request-ID $request_id always;
                add_header Content-Type application/json always;
                return 415 '{"error":"Unsupported Media Type","request_id":"$request_id"}';
            }
        }

        # Proxy settings
        proxy_pass http://backend_api_v2$path$is_args$args;
        proxy_http_version 1.1;

        # Headers forwarding
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        # Connection management
        proxy_set_header Connection "";
        proxy_buffering off;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # Error handling & circuit breaker
        proxy_intercept_errors on;
        error_page 502 503 504 = @circuit_breaker;

        # Retry on upstream errors
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 5s;
    }

    # ============================================
    # CIRCUIT BREAKER - FALLBACK RESPONSE
    # ============================================

    location @circuit_breaker {
        add_header X-Request-ID $request_id always;
        add_header X-Circuit-Breaker "OPEN" always;
        add_header Content-Type application/json always;
        add_header Retry-After "30" always;

        default_type application/json;
        return 503 '{
            "error": "Service Temporarily Unavailable",
            "message": "The API gateway is currently unable to process requests",
            "status": 503,
            "request_id": "$request_id",
            "timestamp": "$time_iso8601",
            "retry_after": 30
        }';
    }

    # ============================================
    # RESPONSE TRANSFORMATION
    # ============================================

    # Add CORS headers to all responses
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key, X-Request-ID" always;
    add_header Access-Control-Max-Age "3600" always;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # API-specific headers
    add_header X-API-Gateway "THE-BOT-API-GW/1.0" always;
    add_header X-Request-ID $request_id always;
    add_header X-Response-Time $request_time always;

    # ============================================
    # OPTIONS (CORS PREFLIGHT)
    # ============================================

    location ~ ^/api {
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key, X-Request-ID" always;
            add_header Access-Control-Max-Age "3600" always;
            add_header Content-Length "0" always;
            add_header Content-Type "text/plain" always;
            return 204;
        }
    }

    # ============================================
    # DENY SENSITIVE FILES
    # ============================================

    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ \.env {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================
# HTTP REDIRECT (API GATEWAY)
# ============================================

server {
    listen 8080;
    listen [::]:8080;
    server_name api.the-bot.ru;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ============================================
# CONFIGURATION NOTES
# ============================================

# REQUEST ID TRACING:
# - All requests get unique ID (X-Request-ID header)
# - Used for distributed tracing across services
# - Format: timestamp-pid for uniqueness
# - Included in all logs for request correlation

# API VERSIONING:
# - /api/v1/ → backend_api_v1 (port 8000)
# - /api/v2/ → backend_api_v2 (port 8002)
# - Default to v1 if version not specified
# - Allows parallel maintenance of versions

# RATE LIMITING:
# - Per API key: 100 req/s (burst 20)
# - Strict mode: 10 req/s (burst 10)
# - Fallback to IP if no API key provided
# - Circuit breaker on 502/503/504

# CONTENT VALIDATION:
# - Validates Content-Type for POST/PUT/PATCH
# - Allowed: application/json, multipart/form-data, application/x-www-form-urlencoded
# - Returns 415 Unsupported Media Type if invalid
# - Size limits enforced (see client_max_body_size)

# SECURITY HEADERS:
# - CORS headers for cross-origin requests
# - X-Content-Type-Options: nosniff (prevent MIME sniffing)
# - X-Frame-Options: DENY (prevent clickjacking)
# - Strict-Transport-Security (HSTS)

# CIRCUIT BREAKER:
# - Returns 503 Service Unavailable when backend is down
# - Includes Retry-After header
# - Graceful degradation with fallback JSON response

# LOGGING:
# - api_gateway_detailed: Full request/response details
# - api_metrics_json: Machine-readable metrics for monitoring
# - Includes request ID for tracing
# - Includes API version, key hash for debugging

# TESTING:
# Test API gateway:
#   curl -H "X-Request-ID: test-123" https://api.the-bot.ru/api/v1/users/
#
# Test request ID:
#   curl -v https://api.the-bot.ru/health | grep X-Request-ID
#
# Test rate limiting:
#   for i in {1..150}; do curl https://api.the-bot.ru/api/v1/users/; done
#
# Test circuit breaker:
#   # Stop all backends, then:
#   curl https://api.the-bot.ru/api/v1/users/
#   # Returns 503 with fallback response

# SEE ALSO:
# - nginx/load-balancer.conf: Base load balancer configuration
# - nginx/the-bot.ru.conf: Main server configuration
# - backend/middleware/api_gateway.py: Django middleware for gateway
# - docs/API_GATEWAY.md: API gateway documentation
