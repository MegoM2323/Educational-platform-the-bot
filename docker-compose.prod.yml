version: '3.9'

# THE_BOT Platform - Production Docker Compose Configuration
# ===========================================================
# Production-grade setup with:
#  - Nginx reverse proxy (HTTP/HTTPS)
#  - Django backend (Daphne ASGI)
#  - PostgreSQL (production-ready)
#  - Redis (cluster-ready)
#  - Celery workers (scaled)
#  - Celery beat scheduler
#
# Usage:
#   docker-compose -f docker-compose.prod.yml build
#   docker-compose -f docker-compose.prod.yml up -d
#   docker-compose -f docker-compose.prod.yml logs -f
#   docker-compose -f docker-compose.prod.yml down
#
# Security:
#  - All services run as non-root users
#  - Network isolation enabled
#  - Resource limits enforced
#  - Health checks on all services
#  - Read-only filesystems where possible
#
# Scaling:
#  - Run multiple Celery workers: docker-compose up -d --scale celery-worker=3
#  - Behind load balancer (nginx) for multiple backend instances

services:
  # ============================================================================
  # DATABASE: PostgreSQL 15 - Production Ready
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: thebot-postgres-prod
    hostname: postgres

    ports:
      - "5432:5432"

    environment:
      # Database configuration
      POSTGRES_DB: ${DB_NAME:-thebot_db}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}

      # Performance tuning
      POSTGRES_INITDB_ARGS: |
        --encoding=UTF8
        --locale=C
        --max_connections=200
        --shared_buffers=256MB
        --effective_cache_size=1GB
        --maintenance_work_mem=64MB
        --work_mem=16MB
        --random_page_cost=1.1

      # Replication settings (for HA setup)
      POSTGRES_REPLICATION_MODE: master
      POSTGRES_REPLICATION_USER: ${REPLICATION_USER:-replicator}
      POSTGRES_REPLICATION_PASSWORD: ${REPLICATION_PASSWORD:-replicator}

    volumes:
      # Data persistence
      - postgres_data:/var/lib/postgresql/data

      # Initialization scripts
      - ./database/init-scripts:/docker-entrypoint-initdb.d:ro

      # Backup directory (mounted from host)
      - ./database/backups:/backups

      # Temporary files

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "PGPASSWORD=${DB_PASSWORD:-postgres} pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-thebot_db} -h localhost"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

    restart: unless-stopped

    networks:
      - thebot-internal

    # Security
    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /tmp
      - /var/run/postgresql

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 2G
        reservations:
          cpus: '0.3'
          memory: 1G

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres"

  # ============================================================================
  # CACHE & MESSAGE BROKER: Redis 7 - Cluster Ready
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: thebot-redis-prod
    hostname: redis

    ports:
      - "6379:6379"

    # Use Redis cluster config or single instance with replication
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --requirepass ${REDIS_PASSWORD:-redis}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
      --databases 16

    volumes:
      # Data persistence (AOF)
      - redis_data:/data

      # Configuration
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro

      # Temporary files

    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

    restart: unless-stopped

    networks:
      - thebot-internal

    # Security
    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /tmp

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 512M

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=redis"

  # ============================================================================
  # BACKEND: Django/DRF API - Daphne ASGI
  # ============================================================================
  backend:
    image: thebot-backend:latest
    container_name: thebot-backend-prod
    hostname: backend

    ports:
      - "8000:8000"

    environment:
      # Django Settings
      ENVIRONMENT: production
      DEBUG: ${DEBUG:-False}
      SECRET_KEY: ${SECRET_KEY}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1}
      DJANGO_SETTINGS_MODULE: config.settings

      # Database
      DB_ENGINE: postgresql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-thebot_db}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_SSLMODE: disable

      # Redis Cache & Celery Broker
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/0
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis}
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/1
      CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD:-redis}@redis:6379/2

      # Frontend
      FRONTEND_URL: ${FRONTEND_URL:-https://localhost}

      # API Configuration
      API_URL: ${API_URL:-https://the-bot.ru/api}
      API_KEY: ${API_KEY}

      # External Services
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      PACHCA_API_TOKEN: ${PACHCA_API_TOKEN}
      PACHCA_FORUM_API_TOKEN: ${PACHCA_FORUM_API_TOKEN}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}

      # Email Configuration
      EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD}
      EMAIL_USE_TLS: ${EMAIL_USE_TLS:-True}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # Sentry / Monitoring
      SENTRY_DSN: ${SENTRY_DSN}

    volumes:
      # Application code (copy only, not volume)
      - ./backend:/app/backend:ro

      # Writable directories
      - backend_static:/app/static
      - backend_media:/app/media
      - backend_logs:/app/logs

      # Temporary files

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    restart: unless-stopped

    networks:
      - thebot-internal
      - thebot-external

    # Security
    security_opt:
      - no-new-privileges:true

    # Can't use read-only for Django (migrations, static files)
    tmpfs:
      - /tmp

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.35'
          memory: 2G
        reservations:
          cpus: '0.35'
          memory: 1G

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=backend"

  # ============================================================================
  # FRONTEND: React/Vite + Nginx
  # ============================================================================
  frontend:
    image: thebot-frontend:latest
    container_name: thebot-frontend-prod
    hostname: frontend

    ports:
      - "3000:3000"
      - "80:80"

    environment:
      NODE_ENV: production
      VITE_API_URL: ${API_URL:-https://localhost/api}
      VITE_WS_URL: ${WS_URL:-wss://localhost/ws}
      VITE_APP_NAME: ${APP_NAME:-THE_BOT}

    volumes:
      # Static content - built dist directory from Dockerfile
      - frontend_dist:/usr/share/nginx/html:ro

      # Nginx configuration
      - ./frontend/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/nginx-default.conf:/etc/nginx/conf.d/default.conf:ro

      # Cache and logs (writable)
      - frontend_logs:/var/log/nginx

      # Temporary files

    depends_on:
      - backend

    restart: unless-stopped

    networks:
      - thebot-external

    # Security
    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /tmp
      - /var/run/nginx

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 256M

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=frontend"

  # ============================================================================
  # REVERSE PROXY: Nginx - HTTPS/HTTP Gateway
  # ============================================================================
  nginx:
    image: nginx:1.27-alpine
    container_name: thebot-nginx-prod
    hostname: nginx

    ports:
      - "80:80"
      - "443:443"

    volumes:
      # Nginx configuration
      - ./docker/nginx.prod.conf:/etc/nginx/nginx.conf:ro

      # SSL certificates (mount from host or use Docker secrets)
      - ./docker/ssl:/etc/nginx/ssl:ro

      # Static content from backend and frontend
      - backend_static:/var/www/backend/static:ro
      - frontend_dist:/usr/share/nginx/html:ro

      # Cache and logs
      - nginx_logs:/var/log/nginx

      # Temporary files

    depends_on:
      - backend
      - frontend

    restart: unless-stopped

    networks:
      - thebot-external
      - thebot-internal

    # Security
    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /tmp
      - /var/run/nginx
      - /var/cache/nginx

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=nginx"

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # TASK QUEUE: Celery Worker - Main
  # ============================================================================
  celery-worker:
    image: thebot-backend:latest
    container_name: thebot-celery-worker-prod
    hostname: celery-worker

    command: >
      celery -A config worker
      --loglevel=info
      --concurrency=4
      --prefetch-multiplier=4
      --max-tasks-per-child=1000
      --worker-log-format="[%(asctime)s: %(levelname)s/%(processName)s] %(message)s"

    environment:
      # Django Settings
      ENVIRONMENT: production
      DEBUG: ${DEBUG:-False}
      SECRET_KEY: ${SECRET_KEY}
      DJANGO_SETTINGS_MODULE: config.settings

      # Database
      DB_ENGINE: postgresql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-thebot_db}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_SSLMODE: disable

      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/0
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/1
      CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD:-redis}@redis:6379/2

      # Email
      EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD}

      # External Services
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      PACHCA_API_TOKEN: ${PACHCA_API_TOKEN}
      PACHCA_FORUM_API_TOKEN: ${PACHCA_FORUM_API_TOKEN}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

    volumes:
      - ./backend:/app/backend:ro
      - backend_media:/app/media
      - backend_logs:/app/logs

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    restart: unless-stopped

    networks:
      - thebot-internal

    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /tmp

    # Resource limits (for 1 worker - scale up as needed)
    deploy:
      resources:
        limits:
          cpus: '0.35'
          memory: 1G
        reservations:
          cpus: '0.35'
          memory: 512M

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=celery-worker"

  # ============================================================================
  # TASK SCHEDULER: Celery Beat - Scheduled Tasks
  # ============================================================================
  celery-beat:
    image: thebot-backend:latest
    container_name: thebot-celery-beat-prod
    hostname: celery-beat

    command: >
      celery -A config beat
      --loglevel=info
      --scheduler django_celery_beat.schedulers:DatabaseScheduler
      --worker-log-format="[%(asctime)s: %(levelname)s] %(message)s"

    environment:
      # Django Settings
      ENVIRONMENT: production
      DEBUG: ${DEBUG:-False}
      SECRET_KEY: ${SECRET_KEY}
      DJANGO_SETTINGS_MODULE: config.settings

      # Database
      DB_ENGINE: postgresql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-thebot_db}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_SSLMODE: disable

      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/0
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD:-redis}@redis:6379/1
      CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD:-redis}@redis:6379/2

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

    volumes:
      - ./backend:/app/backend:ro
      - celery_beat_schedule:/app/celery_schedule
      - backend_logs:/app/logs

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    restart: unless-stopped

    networks:
      - thebot-internal

    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /tmp

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 256M

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=celery-beat"

# ============================================================================
# VOLUMES - Data Persistence
# ============================================================================
volumes:
  # Database
  postgres_data:
    driver: local
  postgres_temp:
    driver: local

  # Cache
  redis_data:
    driver: local
  redis_temp:
    driver: local

  # Backend static/media
  backend_static:
    driver: local
  backend_media:
    driver: local
  backend_logs:
    driver: local
  backend_temp:
    driver: local

  # Frontend
  frontend_dist:
    driver: local
  frontend_cache:
    driver: local
  frontend_logs:
    driver: local
  frontend_temp:
    driver: local

  # Nginx
  nginx_cache:
    driver: local
  nginx_logs:
    driver: local
  nginx_temp:
    driver: local

  # Celery
  celery_beat_schedule:
    driver: local
  celery_temp:
    driver: local
  celery_beat_temp:
    driver: local

# ============================================================================
# NETWORKS - Service Communication Isolation
# ============================================================================
networks:
  # Internal network: database, cache, workers (no external access)
  thebot-internal:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450
    ipam:
      config:
        - subnet: 172.20.0.0/16

  # External network: frontend, nginx (exposed to internet)
  thebot-external:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450
    ipam:
      config:
        - subnet: 172.21.0.0/16
