# Helm values for HashiCorp Vault
# Install with: helm repo add hashicorp https://helm.releases.hashicorp.com
# helm install vault hashicorp/vault -f values.yaml -n vault --create-namespace

global:
  tlsDisable: false

injector:
  enabled: true
  metrics:
    enabled: true

server:
  # High Availability configuration
  ha:
    enabled: true
    replicas: 3
    config: |
      ui = true
      listener "tcp" {
        tls_disable = false
        tls_cert_file = "/vault/userconfig/tls/tls.crt"
        tls_key_file  = "/vault/userconfig/tls/tls.key"
        address = "[::]:8200"
        api_addr = "https://127.0.0.1:8200"
        cluster_addr = "https://127.0.0.1:8201"
      }
      # PostgreSQL backend for high availability
      storage "postgresql" {
        connection_url = "postgres://vault:VaultPassword123!@postgres.thebot.svc.cluster.local:5432/vault?sslmode=require"
        ha_enabled = true
      }
      # Telemetry and logging
      telemetry {
        prometheus_retention_time = "30s"
      }
      # Seal configuration (Cloud KMS recommended for production)
      seal "awskms" {
        region = "us-east-1"
        kms_key_id = "arn:aws:kms:us-east-1:ACCOUNT_ID:key/KEY_ID"
      }

  # Resource requests and limits
  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  # Data persistence
  dataStorage:
    enabled: true
    size: 10Gi
    storageClass: "fast-ssd"

  # Audit logging
  auditStorage:
    enabled: true
    size: 10Gi

  # TLS configuration
  tlsCert: |
    # Insert TLS certificate here
  tlsKey: |
    # Insert TLS key here

  # Service configuration
  service:
    enabled: true
    type: ClusterIP
    port: 8200
    targetPort: 8200

  # Ingress for external access
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - host: "vault.the-bot.ru"
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: vault-tls
        hosts:
          - vault.the-bot.ru

  # Network policy
  networkPolicy:
    enabled: true
    ingress:
      - from:
        - namespaceSelector:
            matchLabels:
              name: thebot
        - namespaceSelector:
            matchLabels:
              name: external-secrets

# UI and metrics
ui:
  enabled: true
  replicas: 1
  service:
    type: ClusterIP

# Prometheus metrics
prometheus:
  enabled: true
  scrapeInterval: "10s"

# RBAC configuration
serviceAccount:
  create: true
  name: vault

rbac:
  create: true

# Pod security and network policies
podSecurityPolicy:
  enabled: true
  name: "vault"

securityContext:
  runAsNonRoot: true
  runAsUser: 100
  fsGroup: 1000

# Node affinity (prefer specific nodes)
affinity: |
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchExpressions:
        - key: app.kubernetes.io/name
          operator: In
          values:
          - vault
      topologyKey: kubernetes.io/hostname

# Auto-unseal configuration (AWS KMS recommended)
autoUnseal:
  enabled: false  # Set to true with KMS configuration
