# Synthetic Checks Configuration for THE_BOT Platform
# Detailed HTTP endpoint checks with request/response validation, performance thresholds

version: "1.0"
timestamp: "2025-12-27T00:00:00Z"

# Environment variables for checks (can be overridden at runtime)
environment:
  API_BASE_URL: "{{ env:API_BASE_URL | default:http://localhost:8000 }}"
  FRONTEND_URL: "{{ env:FRONTEND_URL | default:http://localhost:8080 }}"
  MONITORING_USER: "monitoring@thebot.local"
  MONITORING_PASSWORD: "{{ env:MONITORING_PASSWORD }}"
  AUTH_TOKEN: "{{ env:AUTH_TOKEN }}"
  WEBSOCKET_URL: "{{ env:WEBSOCKET_URL | default:ws://localhost:8000/ws }}"

# Global settings for all checks
globals:
  timeout: 10s
  retry_attempts: 2
  retry_interval: 2s
  # Follow redirects
  follow_redirects: true
  max_redirects: 5
  # TLS verification
  verify_tls: true
  # Default headers
  headers:
    User-Agent: "THE_BOT-Uptime-Monitor/1.0"
    Accept: "application/json"
    Accept-Encoding: "gzip, deflate"

# Critical Service Checks (30-second interval)
critical:
  name: "Critical Service Checks"
  description: "Essential platform functionality"
  interval: 30s
  timeout: 5s

  checks:
    # 1. API Root Endpoint
    - id: "api_root"
      name: "API Root"
      description: "Check basic API availability"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/"
        follow_redirects: true
      validation:
        status_code: 200
        headers:
          Content-Type: "application/json"
        body:
          type: "json"
          contains_any:
            - "version"
            - "status"
      performance:
        target_ms: 200
        warn_threshold_ms: 300
        critical_threshold_ms: 500
      alert:
        enabled: true
        severity: "critical"
        message: "API root endpoint unavailable"
      metadata:
        component: "backend"
        service: "api"
        team: "backend-team"
        runbook: "https://wiki.thebot.local/runbooks/api-root"

    # 2. Health Check Endpoint
    - id: "api_health"
      name: "API Health"
      description: "Check overall API health status"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/system/health/"
      validation:
        status_code: 200
        body:
          type: "json"
          json_path: "$.status"
          expected_value: "healthy"
      performance:
        target_ms: 100
        warn_threshold_ms: 150
        critical_threshold_ms: 300
      alert:
        enabled: true
        severity: "critical"
        message: "API health check failed"
      tags:
        - "health"
        - "critical"

    # 3. Readiness Check (Database, Redis, Celery)
    - id: "api_readiness"
      name: "API Readiness"
      description: "Check if API is ready to serve requests"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/system/readiness/"
      validation:
        status_code: 200
        body:
          type: "json"
          all_of:
            - json_path: "$.status"
              expected_value: "healthy"
            - json_path: "$.components.database.status"
              expected_value: "healthy"
            - json_path: "$.components.redis.status"
              expected_value: "healthy"
      performance:
        target_ms: 150
        warn_threshold_ms: 250
        critical_threshold_ms: 500
      alert:
        enabled: true
        severity: "critical"
        message: "API readiness check failed - components unhealthy"
      tags:
        - "readiness"
        - "critical"
        - "dependencies"

    # 4. Authentication Endpoint
    - id: "auth_login"
      name: "Authentication Service"
      description: "Verify authentication system is functional"
      endpoint:
        method: POST
        url: "{{ API_BASE_URL }}/api/auth/login/"
        headers:
          Content-Type: "application/json"
        body:
          type: "json"
          content:
            email: "monitoring@thebot.local"
            password: "{{ MONITORING_PASSWORD }}"
      validation:
        status_code: 200
        body:
          type: "json"
          all_of:
            - json_path: "$.token"
              type: "string"
            - json_path: "$.user.id"
              type: "number"
      performance:
        target_ms: 500
        warn_threshold_ms: 750
        critical_threshold_ms: 1500
      alert:
        enabled: true
        severity: "critical"
        message: "Authentication service failed"
      auth_capture:
        # Capture token for use in other checks
        enabled: true
        token_path: "$.token"
        store_as: "AUTH_TOKEN"
      tags:
        - "auth"
        - "critical"

    # 5. Frontend Root
    - id: "frontend_root"
      name: "Frontend Root"
      description: "Check frontend application is accessible"
      endpoint:
        method: GET
        url: "{{ FRONTEND_URL }}/"
      validation:
        status_code: 200
        body:
          type: "html"
          contains:
            - "<html"
            - "THE_BOT"
      performance:
        target_ms: 2000
        warn_threshold_ms: 3000
        critical_threshold_ms: 5000
      alert:
        enabled: true
        severity: "warning"
        message: "Frontend UI unavailable"
      tags:
        - "frontend"
        - "ui"

# API Endpoint Checks (1-minute interval)
api_endpoints:
  name: "API Endpoints"
  description: "API functionality and features"
  interval: 60s
  timeout: 5s

  checks:
    # User Profile Endpoint
    - id: "user_profile"
      name: "User Profile API"
      description: "Get current user profile"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/accounts/profile/"
        headers:
          Authorization: "Bearer {{ AUTH_TOKEN }}"
      validation:
        status_code: 200
        body:
          type: "json"
          contains_any:
            - "id"
            - "email"
            - "first_name"
      performance:
        target_ms: 300
        warn_threshold_ms: 500
        critical_threshold_ms: 1000
      alert:
        enabled: true
        severity: "warning"
      tags:
        - "user"
        - "api"

    # Materials Endpoint
    - id: "materials_list"
      name: "Materials API"
      description: "List available educational materials"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/materials/?limit=10"
      validation:
        status_code: 200
        body:
          type: "json"
          json_path: "$.results"
          type: "array"
      performance:
        target_ms: 500
        warn_threshold_ms: 800
        critical_threshold_ms: 1500
      alert:
        enabled: true
        severity: "warning"
      tags:
        - "materials"
        - "api"

    # Chat Rooms Endpoint
    - id: "chat_rooms"
      name: "Chat Rooms API"
      description: "List available chat rooms"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/chat/rooms/"
        headers:
          Authorization: "Bearer {{ AUTH_TOKEN }}"
      validation:
        status_code: 200
        body:
          type: "json"
          json_path: "$.results"
          type: "array"
      performance:
        target_ms: 300
        warn_threshold_ms: 500
        critical_threshold_ms: 1000
      alert:
        enabled: true
        severity: "warning"
      tags:
        - "chat"
        - "api"

    # Knowledge Graph Endpoint
    - id: "knowledge_graph"
      name: "Knowledge Graph API"
      description: "Fetch knowledge graph lessons"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/knowledge-graph/lessons/"
      validation:
        status_code: 200
        body:
          type: "json"
          json_path: "$.results"
          type: "array"
      performance:
        target_ms: 500
        warn_threshold_ms: 800
        critical_threshold_ms: 1500
      alert:
        enabled: true
        severity: "warning"
      tags:
        - "knowledge_graph"
        - "api"

    # Assignments Endpoint
    - id: "assignments_list"
      name: "Assignments API"
      description: "List student assignments"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/assignments/?limit=10"
        headers:
          Authorization: "Bearer {{ AUTH_TOKEN }}"
      validation:
        status_code: 200
        body:
          type: "json"
          contains: "results"
      performance:
        target_ms: 400
        warn_threshold_ms: 600
        critical_threshold_ms: 1200
      alert:
        enabled: true
        severity: "warning"
      tags:
        - "assignments"
        - "api"

    # Reports Endpoint
    - id: "reports_list"
      name: "Reports API"
      description: "List available reports"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/reports/"
        headers:
          Authorization: "Bearer {{ AUTH_TOKEN }}"
      validation:
        status_code: 200
        body:
          type: "json"
          contains: "results"
      performance:
        target_ms: 400
        warn_threshold_ms: 600
        critical_threshold_ms: 1200
      alert:
        enabled: true
        severity: "warning"
      tags:
        - "reports"
        - "api"

# Performance Checks (2-minute interval)
performance:
  name: "Performance Checks"
  description: "Verify API performance is within SLA"
  interval: 120s
  timeout: 10s

  checks:
    # Concurrent request stress
    - id: "concurrent_requests"
      name: "Concurrent Request Handling"
      description: "Verify API handles concurrent requests"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/"
        concurrent_requests: 10
      validation:
        all_requests_succeed: true
        max_response_time_ms: 1000
      performance:
        target_ms: 500
        warn_threshold_ms: 800
        critical_threshold_ms: 1500
      alert:
        enabled: true
        severity: "warning"
        message: "API has performance issues under load"
      tags:
        - "performance"
        - "load"

    # Large response handling
    - id: "large_response"
      name: "Large Response Handling"
      description: "Verify API handles large responses"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/materials/?limit=1000"
      validation:
        status_code: 200
        body:
          type: "json"
          min_size_bytes: 100000
      performance:
        target_ms: 2000
        warn_threshold_ms: 3000
        critical_threshold_ms: 5000
      alert:
        enabled: true
        severity: "warning"
      tags:
        - "performance"
        - "response_size"

# Database Checks (5-minute interval)
database:
  name: "Database Health"
  description: "Database and data consistency"
  interval: 300s
  timeout: 10s

  checks:
    # Database connectivity
    - id: "database_connection"
      name: "Database Connection"
      description: "Test database connectivity"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/system/readiness/"
      validation:
        status_code: 200
        body:
          type: "json"
          json_path: "$.components.database.status"
          expected_value: "healthy"
      performance:
        target_ms: 100
        warn_threshold_ms: 200
        critical_threshold_ms: 500
      alert:
        enabled: true
        severity: "critical"
        message: "Database connection failed"
      tags:
        - "database"
        - "critical"

    # Database query performance
    - id: "database_performance"
      name: "Database Query Performance"
      description: "Verify database query performance"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/system/readiness/"
      validation:
        status_code: 200
        body:
          type: "json"
          json_path: "$.components.database.response_time_ms"
          less_than: 100
      performance:
        target_ms: 50
        warn_threshold_ms: 100
        critical_threshold_ms: 200
      alert:
        enabled: true
        severity: "warning"
        message: "Database queries are slow"
      tags:
        - "database"
        - "performance"

# Cache Checks (5-minute interval)
cache:
  name: "Cache Health"
  description: "Redis cache and caching performance"
  interval: 300s
  timeout: 10s

  checks:
    # Redis connectivity
    - id: "redis_connection"
      name: "Redis Connection"
      description: "Test Redis connectivity"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/system/readiness/"
      validation:
        status_code: 200
        body:
          type: "json"
          json_path: "$.components.redis.status"
          expected_value: "healthy"
      performance:
        target_ms: 100
        warn_threshold_ms: 200
        critical_threshold_ms: 500
      alert:
        enabled: true
        severity: "warning"
        message: "Redis connection failed"
      tags:
        - "cache"
        - "redis"

    # Cache memory usage
    - id: "redis_memory"
      name: "Redis Memory Usage"
      description: "Check Redis memory usage"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/system/readiness/"
      validation:
        status_code: 200
        body:
          type: "json"
          json_path: "$.components.redis.memory_mb"
          less_than: 1024  # Less than 1GB
      alert:
        enabled: true
        severity: "warning"
        message: "Redis memory usage is high"
      tags:
        - "cache"
        - "memory"

# WebSocket Checks (1-minute interval)
websocket:
  name: "WebSocket Health"
  description: "Real-time communication checks"
  interval: 60s
  timeout: 10s

  checks:
    # WebSocket health endpoint
    - id: "websocket_health"
      name: "WebSocket Health"
      description: "Check WebSocket service health"
      endpoint:
        method: GET
        url: "{{ API_BASE_URL }}/api/system/websocket-health/"
      validation:
        status_code: 200
        body:
          type: "json"
          json_path: "$.status"
          expected_value: "healthy"
      performance:
        target_ms: 200
        warn_threshold_ms: 300
        critical_threshold_ms: 500
      alert:
        enabled: true
        severity: "warning"
        message: "WebSocket service unhealthy"
      tags:
        - "websocket"
        - "realtime"

# Frontend Checks (1-minute interval)
frontend:
  name: "Frontend UI"
  description: "Frontend application checks"
  interval: 60s
  timeout: 5s

  checks:
    # Frontend root
    - id: "frontend_root"
      name: "Frontend Root"
      description: "Check frontend is accessible"
      endpoint:
        method: GET
        url: "{{ FRONTEND_URL }}/"
      validation:
        status_code: 200
        body:
          type: "html"
          contains:
            - "<!DOCTYPE html"
            - "THE_BOT"
      performance:
        target_ms: 2000
        warn_threshold_ms: 3000
        critical_threshold_ms: 5000
      alert:
        enabled: true
        severity: "warning"
      tags:
        - "frontend"
        - "ui"

    # Login page
    - id: "frontend_login"
      name: "Frontend Login Page"
      description: "Check login page loads"
      endpoint:
        method: GET
        url: "{{ FRONTEND_URL }}/login"
      validation:
        status_code: 200
        body:
          type: "html"
          contains:
            - "login"
            - "password"
      performance:
        target_ms: 2000
        warn_threshold_ms: 3000
        critical_threshold_ms: 5000
      alert:
        enabled: true
        severity: "warning"
      tags:
        - "frontend"
        - "ui"

# Scheduled Checks Configuration
schedule:
  # Check execution timing
  timezone: "UTC"
  # Business hours checks (more frequent during business hours)
  business_hours:
    enabled: true
    start_time: "08:00"
    end_time: "18:00"
    interval_critical: 30s
    interval_api: 60s
  # Off-hours checks (less frequent)
  off_hours:
    enabled: true
    interval_critical: 120s
    interval_api: 300s

# Alerts and Notifications
alerts:
  # Alert delivery
  delivery:
    slack: true
    email: true
    pagerduty: true
  # Alert grouping
  grouping:
    enabled: true
    window: 5m  # Group alerts within 5 minutes
  # Alert deduplication
  deduplication:
    enabled: true
    window: 30m  # Don't resend same alert within 30 minutes
