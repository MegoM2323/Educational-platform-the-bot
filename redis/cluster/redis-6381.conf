# Redis Cluster Node 1 (Master 1)
# Port: 6381
# Address: 127.0.0.1:6381
# Role: Primary Master

################################## NETWORK #####################################

port 6381
bind 0.0.0.0
protected-mode yes
tcp-backlog 511

################################# GENERAL #######################################

# Daemonize: no (managed by Docker)
daemonize no

# PID file (not used in Docker)
pidfile /var/run/redis_6381.pid

# Log level: notice, verbose, debug
loglevel notice

# Database count
databases 16

################################ CLUSTER #########################################

# Enable cluster mode - REQUIRED FOR CLUSTER OPERATION
cluster-enabled yes

# Cluster configuration file
cluster-config-file /data/nodes-6381.conf

# Cluster node timeout (milliseconds)
# 15000ms = 15 seconds for node failure detection
cluster-node-timeout 15000

# Cluster replica validation factor (1-100)
# Prevents replicas from failing over if master is still reachable
cluster-replica-validity-factor 10

# Cluster requires all slots to be served to accept writes
# false = partially unavailable clusters can still serve requests
cluster-require-full-coverage no

# Minimum number of replicas per master for failover
cluster-migration-barrier 1

################################ PERSISTENCE #####################################

# Save snapshots - RDB format for fast loading
save 900 1       # After 900 seconds (15 minutes) if at least 1 key changed
save 300 10      # After 300 seconds (5 minutes) if at least 10 keys changed
save 60 10000    # After 60 seconds if at least 10000 keys changed

# Enable AOF (Append Only File) for durability
# Important: For production persistence, use AOF
appendonly yes
appendfilename "appendonly-6381.aof"

# AOF fsync policy
# - always: fsync after every write (safest, slowest)
# - everysec: fsync every second (recommended)
# - no: let OS fsync (fastest, least safe)
appendfsync everysec

# Allow writes during AOF rewrite
no-appendfsync-on-rewrite no

# Rewrite AOF file when it's 64MB and at least 100% growth
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Handle corrupted AOF
aof-load-truncated yes

# RDB compression
rdbcompression yes

# RDB checksum validation
rdbchecksum yes

# RDB file name
dbfilename dump-6381.rdb

# RDB directory
dir /data

################################## MEMORY #######################################

# Max memory: 512MB for single node
# Adjust based on available resources
# In production: set to ~80% of available RAM per node
maxmemory 512mb

# Memory eviction policy when max memory is reached
# Options:
# - noeviction: return error on memory limit (default)
# - allkeys-lru: evict any key using LRU (recommended for cache)
# - allkeys-lfu: evict any key using LFU (better than LRU)
# - allkeys-random: evict random keys
# - volatile-lru: evict keys with TTL using LRU
# - volatile-lfu: evict keys with TTL using LFU
# - volatile-random: evict random keys with TTL
# - volatile-ttl: evict keys with TTL, prefer less time to live
maxmemory-policy allkeys-lru

# LRU sample size (default 5, higher = more accurate, slower)
maxmemory-samples 5

# Lazyfree eviction (faster background)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

################################# CLIENTS #######################################

# Max number of connected clients
maxclients 10000

################################### HEAP SETTINGS ###############################

# Active defragmentation of heap memory (experimental)
activerehashing yes

################################## SLOW LOG ####################################

# Slow log: operations taking longer than this (microseconds)
# 0 = log all
# -1 = disable
slowlog-log-slower-than 10000

# Maximum slow log entries
slowlog-max-len 128

################################ LATENCY MONITOR ##############################

# Enable latency monitoring
latency-monitor-threshold 0

#################################### ACL #########################################

# ACL configuration file (optional)
# aclfile /etc/redis/users.acl

# Default user password (for basic auth)
# requirepass yourpassword
requirepass ""

#################################### REPLICATION ###############################

# Replica read-only (recommended for replicas)
replica-read-only yes

# Replication backlog size (in bytes)
# Larger backlog = better partial resynchronization
repl-backlog-size 1mb

# Replication backlog TTL (seconds)
repl-backlog-ttl 3600

# Master minimum replicas to write
# Requires N replicas to acknowledge writes
# min-replicas-to-write 1
# min-replicas-max-lag 10

################################## LIMITS ON MEMORY ############################

# Hash table parameters
hash-max-listpack-entries 512
hash-max-listpack-value 64

# List parameters
list-max-listpack-size -2
list-compress-depth 0

# Set parameters
set-max-intset-entries 512

# Sorted set parameters
zset-max-listpack-entries 128
zset-max-listpack-value 64

# HyperLogLog
hll-sparse-max-bytes 3000

# Streams
stream-node-max-bytes 4096
stream-node-max-entries 100

################################## SORT #########################################

# Sort command limits
sort-buffer-limit 32mb

################################ LUA SCRIPTING ###############################

# Lua script timeout (milliseconds)
lua-time-limit 5000

################################ REDIS MODULE SUPPORT #########################

# loadmodule /path/to/module.so

################################## THREAD IO ########################################

# Multi-threading I/O (experimental)
# io-threads 4
# io-threads-do-reads no

################################ KERNEL SETTINGS #############################

# TCP keepalive for client connections
tcp-keepalive 300

# TCP listen backlog
tcp-backlog 511

################################## MONITORING ##################################

# Enable stats monitoring
# stats-monitoring-enabled yes

################################## INCLUDE ####################################

# Include additional configuration files
# include /path/to/local.conf
# include /path/to/other.conf
