name: CI Pipeline Lint

on:
  push:
    branches: [ main, develop, "feature/**" ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  CACHE_VERSION: v1

jobs:
  # ============================================================================
  # PYTHON LINTING (flake8, black, isort, pylint, mypy)
  # ============================================================================
  python-lint:
    name: Python Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Cache pip dependencies
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ env.CACHE_VERSION }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-${{ env.CACHE_VERSION }}-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install flake8 black isort pylint mypy pytest

      - name: Run Flake8 - Critical errors
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "Checking for critical errors (E9, F63, F7, F82)..."
          flake8 . --select=E9,F63,F7,F82 --show-source --statistics --format=json > flake8-critical.json || true
          cat flake8-critical.json

      - name: Run Flake8 - Style violations
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "Checking for style violations (E, W, F)..."
          flake8 . --max-complexity=10 --max-line-length=127 --statistics \
            --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' \
            --exclude=migrations,__pycache__,.venv \
            > flake8-report.txt 2>&1 || true
          if [ -s flake8-report.txt ]; then
            echo "=== Flake8 Issues Found ==="
            cat flake8-report.txt
          fi

      - name: Check Black formatting
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "Checking Black code formatting..."
          black --check --diff --line-length=127 . 2>&1 | tee black-report.txt || true

      - name: Check isort import sorting
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "Checking isort import ordering..."
          isort --check-only --diff --profile=black . 2>&1 | tee isort-report.txt || true

      - name: Run mypy type checking
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "Running mypy type checking..."
          mypy . --ignore-missing-imports --no-strict-optional --warn-unused-ignores \
            --format=short 2>&1 | tee mypy-report.txt || true

      - name: Run pylint
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "Running pylint..."
          find . -type f -name "*.py" -not -path "*/migrations/*" -not -path "*/__pycache__/*" \
            -not -path "*/venv/*" -not -path "*/.venv/*" | head -50 | \
            xargs pylint --disable=C0114,C0115,C0116,R0903 --exit-zero \
            > pylint-report.txt 2>&1 || true
          if [ -s pylint-report.txt ]; then
            head -30 pylint-report.txt
          fi

      - name: Upload Python lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-lint-reports
          path: backend/*-report.txt
          retention-days: 30

  # ============================================================================
  # JAVASCRIPT/TYPESCRIPT LINTING (ESLint, TypeScript, Prettier)
  # ============================================================================
  javascript-lint:
    name: JavaScript/TypeScript Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Cache npm dependencies
        id: cache-npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-lint-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-lint-${{ env.CACHE_VERSION }}-

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci --prefer-offline

      - name: Run ESLint
        working-directory: ./frontend
        continue-on-error: true
        run: |
          echo "Running ESLint..."
          npm run lint -- --format json > eslint-report.json 2>&1 || true
          npm run lint -- --format stylish 2>&1 | tee eslint-report.txt || true

      - name: TypeScript type checking
        working-directory: ./frontend
        continue-on-error: true
        run: |
          echo "Running TypeScript type checking..."
          npm run type-check 2>&1 | tee typescript-report.txt || true

      - name: Check Prettier formatting
        working-directory: ./frontend
        continue-on-error: true
        run: |
          echo "Checking code formatting with Prettier..."
          npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css}" \
            --write --list-different 2>&1 | tee prettier-report.txt || true

      - name: Upload JavaScript lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: javascript-lint-reports
          path: frontend/*-report.*
          retention-days: 30

  # ============================================================================
  # YAML VALIDATION (yamllint)
  # ============================================================================
  yaml-lint:
    name: YAML Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            .github/
            backend/
            frontend/
          config_data: |
            {
              extends: default,
              rules: {
                line-length: {max: 120, level: warning},
                indentation: {spaces: 2},
                comments: {min-spaces-from-content: 1},
                comments-indentation: {},
                truthy: {allowed: ['true', 'false', 'yes', 'no']}
              }
            }
          format: parsable

  # ============================================================================
  # JSON VALIDATION
  # ============================================================================
  json-lint:
    name: JSON Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install jq for JSON validation
        run: sudo apt-get install -y jq

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          find . -name "*.json" \
            -not -path "*/node_modules/*" \
            -not -path "*/.venv/*" \
            -not -path "*/venv/*" \
            -not -path "*/.git/*" \
            -type f | while read file; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "ERROR: Invalid JSON in $file"
              exit 1
            fi
          done
          echo "All JSON files are valid"

  # ============================================================================
  # MARKDOWN LINTING
  # ============================================================================
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run markdownlint
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: .
          config_file: .markdownlint.json

  # ============================================================================
  # DEPENDENCY SECURITY SCANNING
  # ============================================================================
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Scan Python dependencies
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "Scanning Python dependencies with pip-audit..."
          python -m pip install pip-audit
          pip-audit --desc 2>&1 | tee pip-audit-report.txt || true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Scan JavaScript dependencies
        working-directory: ./frontend
        continue-on-error: true
        run: |
          echo "Scanning JavaScript dependencies with npm audit..."
          npm ci
          npm audit --audit-level=moderate 2>&1 | tee npm-audit-report.txt || true

      - name: Upload dependency scan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-reports
          path: |
            backend/pip-audit-report.txt
            frontend/npm-audit-report.txt
          retention-days: 30

  # ============================================================================
  # LINT SUMMARY & REPORTING
  # ============================================================================
  lint-summary:
    name: Lint Summary & Report
    runs-on: ubuntu-latest
    needs: [python-lint, javascript-lint, yaml-lint, json-lint, markdown-lint, dependency-scan]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all lint reports
        uses: actions/download-artifact@v4
        with:
          path: lint-reports

      - name: Generate lint summary
        run: |
          echo "=== LINTING SUMMARY ===" > lint-summary.md
          echo "" >> lint-summary.md
          echo "**Workflow Date**: $(date -u)" >> lint-summary.md
          echo "**Commit**: ${{ github.sha }}" >> lint-summary.md
          echo "**Branch**: ${{ github.ref_name }}" >> lint-summary.md
          echo "" >> lint-summary.md

          echo "## Lint Reports Generated" >> lint-summary.md
          echo "" >> lint-summary.md
          if [ -d "lint-reports" ]; then
            find lint-reports -type f -name "*.txt" -o -name "*.json" | while read file; do
              echo "- $file" >> lint-summary.md
            done
          fi

          echo "" >> lint-summary.md
          echo "## Job Status" >> lint-summary.md
          echo "" >> lint-summary.md
          echo "- Python Lint: ${{ needs.python-lint.result }}" >> lint-summary.md
          echo "- JavaScript Lint: ${{ needs.javascript-lint.result }}" >> lint-summary.md
          echo "- YAML Lint: ${{ needs.yaml-lint.result }}" >> lint-summary.md
          echo "- JSON Lint: ${{ needs.json-lint.result }}" >> lint-summary.md
          echo "- Markdown Lint: ${{ needs.markdown-lint.result }}" >> lint-summary.md
          echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> lint-summary.md

          cat lint-summary.md

      - name: Upload lint summary
        uses: actions/upload-artifact@v4
        with:
          name: lint-summary
          path: lint-summary.md
          retention-days: 30

      - name: Comment on PR with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.existsSync('lint-summary.md')
              ? fs.readFileSync('lint-summary.md', 'utf8')
              : 'Lint summary unavailable';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Lint & Code Quality Report\n\n${summary}`
            });

      - name: Exit with failure if any critical job failed
        if: |
          needs.python-lint.result == 'failure' ||
          needs.javascript-lint.result == 'failure' ||
          needs.yaml-lint.result == 'failure' ||
          needs.json-lint.result == 'failure' ||
          needs.markdown-lint.result == 'failure'
        run: |
          echo "Lint checks failed!"
          exit 1
