# OpenTelemetry Collector Configuration
# For distributed tracing with Jaeger backend
#
# Features:
# - OTLP receiver (port 4317 for gRPC, 4318 for HTTP)
# - Batch processing for efficient export
# - Jaeger exporter for trace storage
# - Prometheus exporter for metrics
# - Resource detection and span processors

receivers:
  # OTLP gRPC Receiver (primary)
  # Applications send traces via gRPC on port 4317
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Prometheus Receiver (optional, for scraping metrics)
  prometheus:
    config:
      scrape_configs:
        - job_name: 'django-app'
          static_configs:
            - targets: ['localhost:8001']
          scrape_interval: 15s

processors:
  # Batch processor for efficient export
  # Collects spans and sends them in batches
  batch:
    send_batch_size: 512
    timeout: 5s
    send_batch_max_size: 2048

  # Resource processor to add environment metadata
  resource:
    attributes:
      add:
        service.name: "thebot-platform"
        service.version: "1.0.0"
        environment: "${ENVIRONMENT:-development}"
        deployment.environment: "${ENVIRONMENT:-development}"

  # Memory limiter to prevent OOM
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

  # Span processor for sampling configuration
  # Default 10% sampling (configurable per environment)
  sampling:
    sampling_percentage: ${TRACING_SAMPLE_PERCENTAGE:-10}

  # Attributes processor to add custom attributes
  attributes:
    actions:
      - key: http.client_ip
        action: insert
      - key: correlation_id
        action: insert

exporters:
  # Jaeger exporter for distributed tracing
  jaeger:
    endpoint: "http://jaeger:14250"
    tls:
      insecure: true
    compression: gzip

  # Prometheus exporter for metrics
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: "otel"

  # Logging exporter for debugging (development only)
  logging:
    loglevel: debug

  # Otlp exporter as fallback
  otlp:
    client:
      endpoint: jaeger:4317
      tls:
        insecure: true

extensions:
  # Health check extension
  health_check:
    endpoint: 0.0.0.0:13133

  # Performance profiler (optional)
  pprof:
    endpoint: 0.0.0.0:1777

  # zpages for debugging
  zpages:
    endpoint: 0.0.0.0:55679

service:
  extensions:
    - health_check
    - pprof
    - zpages

  pipelines:
    # Traces pipeline
    traces:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - sampling
        - resource
        - attributes
        - batch
      exporters:
        - jaeger

    # Metrics pipeline
    metrics:
      receivers:
        - otlp
        - prometheus
      processors:
        - memory_limiter
        - resource
        - batch
      exporters:
        - prometheus
        - logging

    # Logs pipeline
    logs:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - resource
        - batch
      exporters:
        - logging
