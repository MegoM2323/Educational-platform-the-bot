# Uptime Monitoring Configuration for THE_BOT Platform
# Comprehensive monitoring with synthetic checks, alerting, and status page integration

# Global Configuration
global:
  # Check execution timeouts
  check_timeout: 10s

  # Default check interval (can be overridden per check)
  default_interval: 30s

  # Data retention
  history_days: 90
  metrics_retention: 180d

  # SLA Configuration
  sla:
    default_target: 99.9  # 99.9% uptime SLA (43 minutes downtime per month)
    warning_threshold: 99.5  # Alert warning at 99.5%
    critical_threshold: 99.0  # Alert critical at 99%

  # Alert Configuration
  alerting:
    enabled: true
    # Alert manager endpoint for integration
    alertmanager_url: "http://alertmanager:9093"
    # Enable sending alerts to external systems
    external_alerts: true
    # Alert history retention
    alert_history_days: 30

# Synthetic Checks Configuration
checks:
  # Check Groups for logical organization
  groups:

    # Critical Service Endpoints
    - name: critical_services
      description: "Critical service availability checks"
      interval: 10s  # Check every 10 seconds for critical services
      timeout: 5s
      retry_attempts: 2
      retry_interval: 2s

      endpoints:
        # Main API health endpoint
        - name: api_health
          url: "{{ API_BASE_URL }}/api/system/health/"
          method: GET
          expected_status: 200
          expected_body_contains:
            - '"status":"healthy"'
            - '"components"'
          timeout: 5s
          alert_on_failure: true
          alert_severity: critical
          metadata:
            component: backend
            service: api
            criticality: critical

        # Authentication endpoint (JWT login)
        - name: auth_login
          url: "{{ API_BASE_URL }}/api/auth/login/"
          method: POST
          headers:
            Content-Type: "application/json"
          body: >
            {
              "email": "monitoring@thebot.local",
              "password": "{{ MONITORING_PASSWORD }}"
            }
          expected_status: 200
          expected_body_contains:
            - '"token"'
            - '"user"'
          timeout: 5s
          alert_on_failure: true
          alert_severity: critical
          metadata:
            component: backend
            service: auth
            criticality: critical

        # Database health
        - name: database_health
          url: "{{ API_BASE_URL }}/api/system/readiness/"
          method: GET
          expected_status: 200
          expected_body_contains:
            - '"database"'
            - '"status":"healthy"'
          timeout: 5s
          alert_on_failure: true
          alert_severity: critical
          metadata:
            component: database
            service: postgres
            criticality: critical

        # Redis/Cache health
        - name: redis_health
          url: "{{ API_BASE_URL }}/api/system/readiness/"
          method: GET
          expected_status: 200
          expected_body_contains:
            - '"redis"'
            - '"status":"healthy"'
          timeout: 5s
          alert_on_failure: true
          alert_severity: warning
          metadata:
            component: cache
            service: redis
            criticality: high

    # Main API Endpoints
    - name: api_endpoints
      description: "API endpoint functionality checks"
      interval: 30s  # Check every 30 seconds
      timeout: 5s
      retry_attempts: 1
      retry_interval: 1s

      endpoints:
        # Root API endpoint
        - name: api_root
          url: "{{ API_BASE_URL }}/api/"
          method: GET
          expected_status: 200
          timeout: 5s
          alert_on_failure: true
          alert_severity: warning
          metadata:
            component: backend
            service: api
            criticality: high

        # User profile endpoint
        - name: user_profile
          url: "{{ API_BASE_URL }}/api/accounts/profile/"
          method: GET
          headers:
            Authorization: "Bearer {{ AUTH_TOKEN }}"
          expected_status: 200
          timeout: 5s
          alert_on_failure: true
          alert_severity: warning
          metadata:
            component: backend
            service: user_management
            criticality: high

        # Materials endpoint
        - name: materials_list
          url: "{{ API_BASE_URL }}/api/materials/?limit=10"
          method: GET
          expected_status: 200
          expected_body_contains:
            - '"results"'
          timeout: 5s
          alert_on_failure: true
          alert_severity: warning
          metadata:
            component: backend
            service: materials
            criticality: medium

        # Chat endpoint
        - name: chat_rooms
          url: "{{ API_BASE_URL }}/api/chat/rooms/"
          method: GET
          headers:
            Authorization: "Bearer {{ AUTH_TOKEN }}"
          expected_status: 200
          timeout: 5s
          alert_on_failure: true
          alert_severity: warning
          metadata:
            component: backend
            service: chat
            criticality: medium

        # Knowledge Graph endpoint
        - name: knowledge_graph
          url: "{{ API_BASE_URL }}/api/knowledge-graph/lessons/"
          method: GET
          expected_status: 200
          timeout: 5s
          alert_on_failure: true
          alert_severity: warning
          metadata:
            component: backend
            service: knowledge_graph
            criticality: medium

    # Frontend Endpoints
    - name: frontend
      description: "Frontend UI availability checks"
      interval: 30s
      timeout: 5s
      retry_attempts: 1
      retry_interval: 1s

      endpoints:
        # Main frontend page
        - name: frontend_root
          url: "{{ FRONTEND_URL }}/"
          method: GET
          expected_status: 200
          expected_body_contains:
            - '<html'
            - 'THE_BOT'
          timeout: 5s
          alert_on_failure: true
          alert_severity: warning
          metadata:
            component: frontend
            service: ui
            criticality: high

        # Login page
        - name: frontend_login
          url: "{{ FRONTEND_URL }}/login"
          method: GET
          expected_status: 200
          timeout: 5s
          alert_on_failure: true
          alert_severity: warning
          metadata:
            component: frontend
            service: ui
            criticality: high

    # WebSocket Endpoint
    - name: websocket
      description: "WebSocket real-time communication checks"
      interval: 30s
      timeout: 10s
      retry_attempts: 1
      retry_interval: 2s

      endpoints:
        # WebSocket health endpoint (via HTTP)
        - name: websocket_health
          url: "{{ API_BASE_URL }}/api/system/websocket-health/"
          method: GET
          expected_status: 200
          expected_body_contains:
            - '"status":"healthy"'
            - '"connections"'
          timeout: 5s
          alert_on_failure: true
          alert_severity: warning
          metadata:
            component: backend
            service: websocket
            criticality: medium

# Response Time Thresholds
performance:
  # Response time targets
  targets:
    api_health: 100ms  # Health check should be fast
    auth_login: 500ms   # Auth might be slower due to crypto
    database_health: 100ms
    redis_health: 100ms
    api_root: 200ms
    user_profile: 300ms
    materials_list: 500ms
    chat_rooms: 300ms
    knowledge_graph: 500ms
    frontend_root: 2000ms  # Frontend can be slower
    frontend_login: 2000ms
    websocket_health: 200ms

  # Response time alert thresholds (percentage of target)
  warn_threshold_percent: 80  # Warn if response time > 80% of target
  critical_threshold_percent: 120  # Critical if > 120% of target

# Alerting Rules
alerting:
  # Service Down Alert
  - name: ServiceDown
    condition: "status == 'down' for 2m"
    severity: critical
    component: any
    message: "Service {{ component }} is down"
    action: "page_oncall"

  # Service Degraded Alert
  - name: ServiceDegraded
    condition: "status == 'degraded' for 5m"
    severity: warning
    component: any
    message: "Service {{ component }} is degraded"
    action: "slack_notify"

  # High Response Time Alert
  - name: HighResponseTime
    condition: "response_time > warn_threshold for 5m"
    severity: warning
    component: api_endpoints
    message: "High response time detected"
    action: "slack_notify"

  # Uptime SLA Breach Warning
  - name: UptimeSLAWarning
    condition: "uptime < 99.5% over 24h"
    severity: warning
    component: any
    message: "Uptime SLA warning threshold breached"
    action: "slack_notify"

  # Uptime SLA Breach Critical
  - name: UptimeSLACritical
    condition: "uptime < 99.0% over 24h"
    severity: critical
    component: any
    message: "Uptime SLA critical threshold breached"
    action: "page_oncall"

  # Multiple Services Down
  - name: MultipleServicesDown
    condition: "count(status == 'down') >= 2 for 2m"
    severity: critical
    component: any
    message: "Multiple services are down - possible infrastructure failure"
    action: "page_oncall escalate_to_manager"

# Storage Configuration
storage:
  # Database backend for check results
  backend: "postgresql"
  connection_string: "{{ DATABASE_URL }}"

  # Results table configuration
  results_table: "uptime_check_results"
  create_table: true

  # Indexes for performance
  indexes:
    - "component"
    - "service"
    - "timestamp"
    - "status"

  # Query optimization
  batch_insert: true
  batch_size: 100
  batch_timeout: 5s

# Metrics Export
metrics:
  # Prometheus metrics export
  prometheus:
    enabled: true
    port: 9090
    path: "/metrics"
    metrics:
      - uptime_check_duration_seconds
      - uptime_check_status
      - uptime_sla_percent
      - uptime_alert_count

  # Custom metrics
  custom:
    - name: "uptime_response_time_ms"
      type: "gauge"
      help: "Response time in milliseconds"

    - name: "uptime_availability_percent"
      type: "gauge"
      help: "Component availability percentage"

    - name: "uptime_sla_breaches_total"
      type: "counter"
      help: "Total SLA breaches"

# Notifications
notifications:
  # Slack integration
  slack:
    enabled: true
    webhook_url: "{{ SLACK_WEBHOOK_URL }}"
    channels:
      - name: "#platform-status"
        severity: ["critical", "warning"]
      - name: "#critical-alerts"
        severity: ["critical"]

  # PagerDuty integration
  pagerduty:
    enabled: true
    integration_key: "{{ PAGERDUTY_KEY }}"
    severity_mapping:
      critical: "critical"
      warning: "warning"

  # Email notifications
  email:
    enabled: true
    smtp_host: "{{ SMTP_HOST }}"
    smtp_port: 587
    from_address: "monitoring@thebot.local"
    recipients:
      critical:
        - "oncall@thebot.local"
        - "devops-team@thebot.local"
      warning:
        - "ops-team@thebot.local"

# Logging Configuration
logging:
  level: "INFO"
  format: "json"
  outputs:
    - type: "file"
      path: "/var/log/uptime-monitoring.log"
      rotation:
        max_size_mb: 100
        max_backups: 10
        max_age_days: 30

    - type: "stdout"
      format: "json"

    - type: "syslog"
      host: "localhost"
      port: 514
      facility: "LOCAL0"

# Web UI Configuration
ui:
  enabled: true
  port: 8888
  bind_address: "0.0.0.0"
  # Status page refresh interval
  refresh_interval_seconds: 30
  # Show component details
  show_details: true
  # Enable drill-down analytics
  enable_analytics: true

# Health Check Execution
execution:
  # Maximum concurrent checks
  max_concurrent: 10
  # Queue size for pending checks
  queue_size: 100
  # Worker threads
  worker_threads: 5
  # Check execution history
  keep_execution_history: true
  execution_history_days: 7
