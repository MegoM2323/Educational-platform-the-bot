var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{r as s,j as a}from"./react-core-JVqWokWt.js";import{C as r,_ as n,ax as i,b as c,r as l,A as o,v as d,c as h,B as u,u as m,D as x,w as g,x as p,y as f,z as b,g as j,h as v,i as y,j as w,k as N,l as C,f as k,aT as S,ar as _}from"./main-fde3JC90.js";import{at as E,aS as M,aa as I,$,bW as T,a5 as L,a3 as U,a6 as q,ac as O,bY as D,aq as F,X as z,bO as A,ad as R,aU as K,aA as W,ao as H,a2 as J}from"./vendor-DC2AZkDs.js";import{u as P,a as Q,b as B}from"./react-query-DqnBFrGE.js";import{f as G}from"./forumAPI-CXsZ6fyy.js";const V=({chat:e,selected:t,onClick:s,currentUserId:r})=>{var n,i;const c=e.participants.filter(e=>e.id!==r).map(e=>e.full_name.charAt(0)).join("").toUpperCase()||"C",u=e.participants.filter(e=>e.id!==r).map(e=>e.full_name).join(", "),m=e.name||u||"Чат",x=(null==(n=e.last_message)?void 0:n.content)||"Нет сообщений",g=(null==(i=e.last_message)?void 0:i.created_at)?new Date(e.last_message.created_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}):"";return a.jsx("div",{onClick:s,role:"button",tabIndex:0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),s())},"aria-selected":t,"aria-label":`Чат с ${m}`,className:l("p-3 rounded-lg cursor-pointer transition-colors border",t?"bg-primary/10 border-primary":"border-transparent hover:bg-muted"),children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(o,{className:"w-10 h-10 flex-shrink-0",children:a.jsx(d,{className:"gradient-primary text-primary-foreground text-xs font-semibold",children:c})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("div",{className:"font-medium truncate text-sm",children:m}),e.unread_count>0&&a.jsx(h,{variant:"destructive",className:"ml-2 text-xs flex-shrink-0",children:e.unread_count})]}),e.subject&&a.jsx("p",{className:"text-xs text-muted-foreground mb-1 truncate",children:e.subject.name}),a.jsx("p",{className:"text-xs text-muted-foreground truncate",children:x}),g&&a.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:g})]})]})})},Y=({chats:e,selectedChat:t,onSelectChat:l,searchQuery:o,onSearchChange:d,isLoading:h,currentUserId:u})=>{const m=s.useMemo(()=>{if(!o)return e;const t=o.toLowerCase();return e.filter(e=>{var s,a;return e.name.toLowerCase().includes(t)||(null==(a=null==(s=e.subject)?void 0:s.name)?void 0:a.toLowerCase().includes(t))||e.participants.some(e=>e.full_name.toLowerCase().includes(t))})},[e,o]);return a.jsxs(r,{className:"p-4 md:col-span-1 flex flex-col h-full overflow-hidden","data-testid":"chat-list",children:[a.jsxs("div",{className:"relative mb-4 flex-shrink-0",children:[a.jsx(E,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),a.jsx(n,{placeholder:"Поиск чатов...",className:"pl-10 text-sm",value:o,onChange:e=>d(e.target.value),"aria-label":"Поиск чатов по названию или участнику","data-testid":"chat-search"})]}),a.jsx(i,{className:"flex-1 min-h-0",children:a.jsx("div",{className:"space-y-2 pr-4",children:h?a.jsxs(a.Fragment,{children:[a.jsx(c,{className:"h-20 rounded-lg","data-testid":"chat-list-skeleton"}),a.jsx(c,{className:"h-20 rounded-lg","data-testid":"chat-list-skeleton"}),a.jsx(c,{className:"h-20 rounded-lg","data-testid":"chat-list-skeleton"})]}):0===m.length?a.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center","data-testid":"no-chats-message",children:[a.jsx(M,{className:"h-12 w-12 text-gray-400 mb-4"}),a.jsx("h3",{className:"text-lg font-medium",children:"Нет чатов"}),a.jsx("p",{className:"text-gray-500",children:o?"Чатов не найдено":"У вас пока нет доступных чатов. Начните общение!"})]}):a.jsx("div",{role:"listbox",className:"space-y-2",children:m.map(e=>a.jsx(V,{chat:e,selected:(null==t?void 0:t.id)===e.id,onClick:()=>l(e),currentUserId:u},e.id))})})})]})},X=({message:e,isOwn:t,currentUserId:s})=>a.jsx("div",{className:"flex "+(t?"justify-end":"justify-start"),children:a.jsxs("div",{className:l("max-w-[70%] p-3 rounded-lg",t?"bg-primary text-primary-foreground":"bg-muted"),children:[!t&&a.jsx("p",{className:"text-xs font-medium mb-1 opacity-75",children:e.sender.full_name}),a.jsx("p",{className:"text-sm break-words",children:e.content}),a.jsx("div",{className:l("text-xs mt-1",t?"text-primary-foreground/70":"text-muted-foreground"),children:new Date(e.created_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})})]})}),Z=({chat:e,messages:t,isLoadingMessages:n,isSending:i,onSendMessage:h,isConnected:m,typingUsers:x=[],error:g=null,onRetryConnection:p,currentUserId:f,currentUserRole:b="",isSwitchingChat:j=!1,renderMessageInput:v,renderHeader:y})=>{const w=s.useRef(null),N=s.useRef(null),C=s.useRef(!0),k=s.useCallback(()=>{var e;C.current&&(null==(e=N.current)||e.scrollIntoView({behavior:"smooth"}))},[]);s.useEffect(()=>{k()},[t,k]);const S=s.useCallback(e=>{const t=e.target,s=t.scrollHeight-t.scrollTop-t.clientHeight<100;C.current=s},[]),_="admin"===b,E=e&&!e.is_active,M=s.useMemo(()=>e?e.participants.filter(e=>e.id!==f).map(e=>e.full_name).join(", "):"",[e,f]),D=s.useMemo(()=>e?e.name||M||"Чат":"",[e,M]);return e?a.jsxs(r,{className:"p-6 md:col-span-2 flex flex-col h-full overflow-hidden","data-testid":"chat-window",children:[g&&a.jsxs("div",{className:"mb-4 p-3 bg-destructive/10 border border-destructive/20 rounded-lg flex items-center gap-3 flex-shrink-0",children:[a.jsx($,{className:"w-5 h-5 text-destructive flex-shrink-0"}),a.jsx("div",{className:"flex-1 min-w-0",children:a.jsx("p",{className:"text-sm text-destructive font-medium",children:g})}),p&&a.jsx(u,{type:"button",size:"sm",variant:"outline",onClick:p,className:"text-xs flex-shrink-0",children:"Повторить"})]}),y?y(e):a.jsxs("div",{className:"flex items-center gap-3 pb-4 border-b flex-shrink-0","data-testid":"chat-header",children:[a.jsx(o,{className:"w-10 h-10",children:a.jsx(d,{className:"gradient-primary text-primary-foreground text-xs font-semibold",children:e.participants.filter(e=>e.id!==f).map(e=>e.full_name.charAt(0)).join("").toUpperCase()||"C"})}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx("div",{className:"font-bold text-sm",children:D}),E&&a.jsxs("div",{className:"flex items-center gap-1 px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800",children:[a.jsx(T,{className:"w-3 h-3"}),a.jsx("span",{className:"text-xs",children:"Заблокирован"})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[m?a.jsx(L,{className:"w-3 h-3 text-green-500"}):a.jsx(U,{className:"w-3 h-3 text-red-500"}),a.jsx("span",{className:l("text-xs px-2 py-0.5 rounded-full",m?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:m?"Онлайн":"Оффлайн"})]})]}),e.subject&&a.jsx("div",{className:"text-xs text-muted-foreground",children:e.subject.name}),e.participants.length>1&&a.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.participants.filter(e=>e.id!==f).length," участник(и)"]})]})]}),a.jsx("div",{ref:w,className:"flex-1 overflow-y-auto py-4 pr-4 min-h-0",onScroll:S,role:"log","aria-live":"polite","aria-label":"Сообщения чата",children:a.jsxs("div",{className:"space-y-4",children:[j||n?a.jsxs("div",{className:"space-y-4","data-testid":"messages-loading",children:[a.jsx(c,{className:"h-12 rounded w-[70%]"}),a.jsx(c,{className:"h-12 rounded w-[70%] ml-auto"}),a.jsx(c,{className:"h-12 rounded w-[70%]"}),a.jsxs("div",{className:"flex items-center justify-center py-4",children:[a.jsx(q,{className:"w-4 h-4 animate-spin text-muted-foreground mr-2"}),a.jsx("span",{className:"text-sm text-muted-foreground",children:j?"Переключение чата...":"Загрузка сообщений..."})]})]}):0===t.length?a.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center",children:[a.jsx(O,{className:"h-12 w-12 text-gray-400 mb-4"}),a.jsx("h3",{className:"text-lg font-medium",children:"Нет сообщений"}),a.jsx("p",{className:"text-gray-500",children:"Напишите первое сообщение в этом чате!"})]}):t.map(e=>{const t=e.sender.id===f;return a.jsx(X,{message:e,isOwn:t,currentUserId:f},e.id)}),x.length>0&&a.jsx("div",{className:"flex gap-2 items-center text-xs text-muted-foreground italic",children:a.jsxs("span",{children:[x.map(e=>e.first_name).join(", ")," печатает..."]})}),a.jsx("div",{ref:N})]})}),a.jsx("div",{className:"pt-4 border-t flex-shrink-0",children:_||E?a.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg border border-muted-foreground/20 flex items-center justify-center gap-2",children:[a.jsx(T,{className:"w-4 h-4 text-muted-foreground flex-shrink-0"}),a.jsx("span",{className:"text-sm text-muted-foreground",children:E?"Чат заблокирован модератором":"Доступ только для чтения"})]}):v?v():a.jsx("div",{className:"text-sm text-muted-foreground text-center p-2",children:"Передайте renderMessageInput проп для отображения ввода сообщения"})})]}):a.jsxs(r,{className:"p-6 md:col-span-2 flex flex-col items-center justify-center h-full overflow-hidden","data-testid":"chat-window-empty",children:[a.jsx(I,{className:"h-12 w-12 text-gray-400 mb-4"}),a.jsx("h3",{className:"text-lg font-medium",children:"Выберите чат"}),a.jsx("p",{className:"text-gray-500",children:"Выберите чат из списка слева для начала общения"})]})},ee=10485760,te=e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB",se=({value:e,onChange:t,onSend:r,isLoading:i=!1,disabled:c=!1,maxLength:o=1e3,onFileSelect:d,selectedFile:h,onRemoveFile:x,placeholder:g="Введите сообщение..."})=>{const p=s.useRef(null),{toast:f}=m(),[b,j]=s.useState(0),v=s.useCallback(e=>{e.length<=o&&(t(e),j(e.length))},[t,o]),y=s.useCallback(e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];s&&(s.size>ee?f({variant:"destructive",title:"Файл слишком большой",description:`Максимальный размер файла: ${te(ee)}`}):d&&d(s))},[d,f]),w=s.useCallback(()=>{p.current&&(p.current.value=""),x&&x()},[x]),N=s.useCallback(t=>{"Enter"===t.key&&!t.shiftKey&&e.trim()&&(t.preventDefault(),r())},[e,r]),C=!(!e.trim()&&!h)&&!i;return a.jsxs("div",{className:"space-y-2",children:[h&&a.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-lg border",children:[h.type.startsWith("image/")?a.jsx(D,{className:"w-4 h-4 text-muted-foreground flex-shrink-0"}):a.jsx(F,{className:"w-4 h-4 text-muted-foreground flex-shrink-0"}),a.jsxs("span",{className:"text-sm flex-1 truncate",title:h.name,children:[h.name," (",te(h.size),")"]}),a.jsx(u,{type:"button",variant:"ghost",size:"sm",onClick:w,className:"h-6 w-6 p-0","aria-label":"Удалить файл",disabled:i,children:a.jsx(z,{className:"w-4 h-4"})})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("input",{type:"file",ref:p,onChange:y,accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.zip",style:{display:"none"},"data-testid":"file-input-hidden","aria-label":"Выберите файл для отправки",disabled:i||c}),a.jsx(u,{type:"button",variant:"ghost",size:"sm",onClick:()=>{var e;return null==(e=p.current)?void 0:e.click()},disabled:i||c,className:"shrink-0","data-testid":"file-attach-button","aria-label":"Прикрепить файл",children:a.jsx(A,{className:"w-4 h-4"})}),a.jsxs("div",{className:"relative flex-1",children:[a.jsx(n,{placeholder:g,value:e,onChange:e=>v(e.target.value),onKeyPress:N,disabled:i||c,className:"text-sm pr-12","aria-label":"Текст сообщения","data-testid":"message-input",maxLength:o}),o>0&&a.jsxs("span",{className:l("absolute right-3 top-1/2 -translate-y-1/2 text-xs",b>.8*o?"text-orange-500":"text-muted-foreground"),"aria-live":"polite",children:[b,"/",o]})]}),a.jsx(u,{type:"button",onClick:r,disabled:!C,className:"gradient-primary shrink-0","data-testid":"send-button","aria-label":"Отправить сообщение",children:i?a.jsx(q,{className:"w-4 h-4 animate-spin"}):a.jsx(R,{className:"w-4 h-4"})})]})]})},ae=e=>{switch(e){case"teacher":return"default";case"tutor":return"secondary";default:return"outline"}},re=e=>{switch(e){case"teacher":return"Преподаватель";case"tutor":return"Тьютор";case"student":return"Студент";case"parent":return"Родитель";default:return e}},ne=({contact:e,isLoading:t,onSelect:s})=>{const r=`${e.first_name.charAt(0)}${e.last_name.charAt(0)}`.toUpperCase(),n=`${e.first_name} ${e.last_name}`.trim();return a.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 hover:border-primary/50 transition-all duration-200 group","data-testid":"contact-item",role:"option","aria-selected":!1,children:[a.jsx(o,{className:"w-10 h-10 ring-2 ring-transparent group-hover:ring-primary/20 transition-all flex-shrink-0",children:a.jsx(d,{className:"gradient-primary text-primary-foreground font-semibold text-sm",children:r})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx("p",{className:"font-medium text-sm truncate",children:n}),a.jsx(h,{variant:ae(e.role),className:"text-xs shrink-0",children:re(e.role)}),e.has_active_chat&&a.jsx(W,{className:"w-3 h-3 text-green-500 shrink-0",title:"Активный чат"})]}),a.jsx("p",{className:"text-xs text-muted-foreground truncate mb-0.5",children:e.email}),e.subject&&a.jsxs("p",{className:"text-xs text-muted-foreground truncate flex items-center gap-1",children:[a.jsx("span",{className:"inline-block w-1.5 h-1.5 rounded-full bg-primary/50"}),e.subject.name]})]}),a.jsx(u,{type:"button",size:"sm",variant:e.has_active_chat?"default":"outline",onClick:()=>s(e),disabled:t,className:l("shrink-0 transition-all duration-200",e.has_active_chat?"bg-primary text-primary-foreground hover:bg-primary/90":"hover:bg-primary hover:text-primary-foreground"),"aria-label":e.has_active_chat?`Продолжить чат с ${n}`:`Начать чат с ${n}`,children:t?a.jsx(q,{className:"w-4 h-4 animate-spin"}):e.has_active_chat?a.jsxs(a.Fragment,{children:[a.jsx(O,{className:"w-4 h-4 mr-1"}),"Продолжить"]}):a.jsxs(a.Fragment,{children:[a.jsx(H,{className:"w-4 h-4 mr-1"}),"Начать чат"]})})]})},ie=({isOpen:e,onClose:t,onChatInitiated:r})=>{const[l,o]=s.useState(""),[d,h]=s.useState("all"),{toast:k}=m(),S=P(),{data:_=[],isLoading:M,error:I,refetch:T}=Q({queryKey:["available-contacts"],queryFn:G.getAvailableContacts,enabled:e,retry:2}),L=B({mutationFn:({contactUserId:e,subjectId:t})=>G.initiateChat(e,t),onSuccess:e=>{C.debug("[ContactSelector] Chat initiated successfully:",e),S.invalidateQueries({queryKey:["forum","chats"]}),k({title:e.created?"Чат создан":"Чат найден",description:e.created?"Новый чат успешно создан":"Вы перешли к существующему чату"}),r&&r(e.chat.id),t()},onError:e=>{C.error("[ContactSelector] Error initiating chat:",e);const t=e.message||"Ошибка при создании чата";k({title:"Ошибка",description:t,variant:"destructive"})}}),U=s.useMemo(()=>{let e=_;if("all"!==d&&(e=e.filter(e=>e.role===d)),l.trim()){const t=l.toLowerCase();e=e.filter(e=>e.first_name.toLowerCase().includes(t)||e.last_name.toLowerCase().includes(t)||e.email.toLowerCase().includes(t))}return e},[_,l,d]),D=s.useCallback(e=>{var s,a;if(e.has_active_chat&&e.chat_id)return r&&r(e.chat_id),void t();"teacher"!==e.role||(null==(s=e.subject)?void 0:s.id)?L.mutate({contactUserId:e.id,subjectId:null==(a=e.subject)?void 0:a.id}):k({title:"Ошибка",description:"Не удалось создать чат: предмет не найден",variant:"destructive"})},[r,t,k,L]);s.useEffect(()=>{e&&(o(""),h("all"))},[e]);const F=s.useMemo(()=>{const e=new Set(_.map(e=>e.role));return Array.from(e)},[_]);return a.jsx(x,{open:e,onOpenChange:t,children:a.jsxs(g,{className:"max-w-2xl max-h-[80vh] flex flex-col",children:[a.jsxs(p,{children:[a.jsx(f,{children:"Начать новый чат"}),a.jsx(b,{children:"Выберите пользователя для начала общения"})]}),a.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[a.jsxs("div",{className:"relative flex-1",children:[a.jsx(E,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),a.jsx(n,{placeholder:"Поиск по имени или email...",className:"pl-10",value:l,onChange:e=>o(e.target.value),autoFocus:!0,"aria-label":"Поиск контактов","data-testid":"contact-search"})]}),a.jsx("div",{className:"w-full sm:w-[200px]",children:a.jsxs(j,{value:d,onValueChange:h,children:[a.jsx(v,{className:"w-full","aria-label":"Фильтр по роли",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(K,{className:"w-4 h-4 text-muted-foreground"}),a.jsx(y,{placeholder:"Все роли"})]})}),a.jsxs(w,{children:[a.jsx(N,{value:"all",children:"Все роли"}),F.includes("student")&&a.jsx(N,{value:"student",children:"Студенты"}),F.includes("teacher")&&a.jsx(N,{value:"teacher",children:"Преподаватели"}),F.includes("tutor")&&a.jsx(N,{value:"tutor",children:"Тьюторы"}),F.includes("parent")&&a.jsx(N,{value:"parent",children:"Родители"})]})]})})]}),a.jsx(i,{className:"flex-1 pr-4 mt-4",children:M?a.jsx("div",{className:"space-y-3","data-testid":"contacts-skeleton",children:[...Array(5)].map((e,t)=>a.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg border animate-pulse",children:[a.jsx(c,{className:"w-10 h-10 rounded-full"}),a.jsxs("div",{className:"flex-1 space-y-2",children:[a.jsx(c,{className:"h-4 w-32"}),a.jsx(c,{className:"h-3 w-48"}),a.jsx(c,{className:"h-3 w-24"})]}),a.jsx(c,{className:"h-8 w-24 rounded"})]},`contact-skeleton-${t}`))}):I?a.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center","data-testid":"contacts-error",children:[a.jsx($,{className:"w-12 h-12 text-destructive mb-3"}),a.jsx("p",{className:"text-sm font-medium text-foreground mb-2",children:"Не удалось загрузить контакты"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-4",children:"Проверьте подключение к интернету"}),a.jsxs(u,{type:"button",variant:"outline",size:"sm",onClick:()=>T(),className:"gap-2",children:[a.jsx(q,{className:"w-4 h-4"}),"Повторить попытку"]})]}):0===U.length?a.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center","data-testid":"contacts-empty",children:[a.jsx(O,{className:"w-12 h-12 text-muted-foreground mb-3"}),a.jsx("p",{className:"text-sm font-medium text-foreground mb-1",children:l||"all"!==d?"Контактов не найдено":"Нет доступных контактов"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:l||"all"!==d?"Попробуйте изменить фильтры поиска":"У вас пока нет контактов для общения"})]}):a.jsx("div",{className:"space-y-2","data-testid":"contacts-list",role:"listbox",children:U.map(e=>a.jsx(ne,{contact:e,isLoading:L.isPending,onSelect:D},e.id))})})]})})},ce={getGeneralChat:async()=>{const e=await k.getGeneralChat();if(e.error)throw new Error(e.error);return e.data},getGeneralMessages:async(e=1,t=50)=>{const s=await k.getGeneralMessages(e,t);if(s.error)throw new Error(s.error);return s.data},sendMessage:async e=>{const t=await k.sendMessage(e);if(t.error)throw new Error(t.error);return t.data},createThread:async(e,t)=>{const s=await k.request(`/chat/general/thread/${e}/`,{method:"POST",body:JSON.stringify(t)});if(s.error)throw new Error(s.error);return s.data},getThreads:async e=>{const t=await k.request(`/chat/general/threads/?parent_message_id=${e}`);if(t.error)throw new Error(t.error);return t.data},getThreadMessages:async e=>{const t=await k.request(`/chat/general/threads/${e}/messages/`);if(t.error)throw new Error(t.error);return t.data},updateMessage:async(e,t)=>{const s=await k.request(`/chat/messages/${e}/`,{method:"PATCH",body:JSON.stringify({content:t})});if(s.error)throw new Error(s.error);return s.data},deleteMessage:async e=>{const t=await k.request(`/chat/messages/${e}/`,{method:"DELETE"});if(t.error)throw new Error(t.error)},getChatRooms:async()=>{const e=await k.request("/chat/rooms/");if(e.error)throw new Error(e.error);return e.data},getRoomMessages:async e=>{const t=await k.request(`/chat/rooms/${e}/messages/`);if(t.error)throw new Error(t.error);return t.data}};class le extends S{constructor(e){super({url:e,reconnectInterval:1e3,maxReconnectAttempts:10,heartbeatInterval:3e4,messageQueueSize:100}),t(this,"chatSubscriptions",new Map),t(this,"globalSubscriptions",new Map),t(this,"typingTimeouts",new Map),t(this,"connectionCallbacks",[])}async connect(e,t){try{const s=t||_.getToken();if(!s)throw C.warn("[ChatSocket] No auth token available"),new Error("Требуется аутентификация");const a=e?`${this.getCurrentUrl(e)}?token=${s}`:`${this.getCurrentUrl()}?token=${s}`;C.info("[ChatSocket] Connecting with token",{roomId:e}),await super.connect(a),this.setupEventHandlers()}catch(s){throw C.error("[ChatSocket] Connection failed:",s),s}}setupEventHandlers(){this.onConnectionChange(e=>{e?(C.info("[ChatSocket] Connected"),this.broadcastConnectionEvent("connection_established")):(C.warn("[ChatSocket] Disconnected"),this.broadcastConnectionEvent("connection_lost"))}),this.subscribe("chat_message",e=>{this.handleChatMessage(e)}),this.subscribe("chat_event",e=>{this.handleChatEvent(e)})}handleChatMessage(e){if(!e.data)return;const t=e.data,s={type:"message_received",chat_id:t.chat_id,message:t.message};this.broadcastChatMessage(s)}handleChatEvent(e){if(!e.data)return;const t=e.data,s={type:t.type,chat_id:t.chat_id,message_id:t.message_id,user_id:t.user_id,user_name:t.user_name,is_typing:t.is_typing,is_online:t.is_online};this.broadcastChatMessage(s)}send(e,t){if(!t.trim())return void C.warn("[ChatSocket] Attempt to send empty message");const s={type:"chat_message",data:{chat_id:e,content:t,timestamp:(new Date).toISOString()}};this.sendMessage(JSON.stringify(s)),C.debug("[ChatSocket] Message sent:",{chatId:e})}subscribeToChat(e,t){this.chatSubscriptions.has(e)||this.chatSubscriptions.set(e,new Set);const s=this.chatSubscriptions.get(e);return s.add(t),C.debug("[ChatSocket] Subscribed to chat:",{chatId:e,count:s.size}),()=>{s.delete(t),0===s.size&&(this.chatSubscriptions.delete(e),C.debug("[ChatSocket] Unsubscribed from chat:",{chatId:e}))}}subscribeToEvent(e,t){this.globalSubscriptions.has(e)||this.globalSubscriptions.set(e,new Set);const s=this.globalSubscriptions.get(e);return s.add(t),C.debug("[ChatSocket] Subscribed to event:",{event:e,count:s.size}),()=>{s.delete(t),0===s.size&&this.globalSubscriptions.delete(e)}}broadcastChatMessage(e){if(e.chat_id&&this.chatSubscriptions.has(e.chat_id)){this.chatSubscriptions.get(e.chat_id).forEach(t=>{try{t(e)}catch(s){C.error("[ChatSocket] Callback error:",s)}})}if(this.globalSubscriptions.has(e.type)){this.globalSubscriptions.get(e.type).forEach(t=>{try{t(e)}catch(s){C.error("[ChatSocket] Callback error:",s)}})}}broadcastConnectionEvent(e){this.connectionCallbacks.forEach(t=>{try{t("connection_established"===e)}catch(s){C.error("[ChatSocket] Connection callback error:",s)}})}onConnectionChange(e){return this.connectionCallbacks.push(e),()=>{this.connectionCallbacks=this.connectionCallbacks.filter(t=>t!==e)}}sendTypingIndicator(e,t){const s={type:"user_event",data:{chat_id:e,event_type:"typing",is_typing:t,timestamp:(new Date).toISOString()}};this.sendMessage(JSON.stringify(s))}sendOnlineStatus(e){const t={type:"user_event",data:{event_type:"online_status",is_online:e,timestamp:(new Date).toISOString()}};this.sendMessage(JSON.stringify(t))}isConnected(){return super.isConnected()}getConnectionStatus(){return this.isConnected()?"connected":"disconnected"}getCurrentUrl(e){if("undefined"!=typeof window){const t=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws/chat`;return e?`${t}/${e}/`:t}const t="ws://localhost:8003/ws/chat";return e?`${t}/${e}/`:t}disconnect(){this.chatSubscriptions.clear(),this.globalSubscriptions.clear(),this.typingTimeouts.forEach(e=>clearTimeout(e)),this.typingTimeouts.clear(),super.disconnect(),C.info("[ChatSocket] Disconnected")}sendMessage(e){if(this.isConnected())try{this.send(e)}catch(t){C.error("[ChatSocket] Failed to send message:",t)}else C.warn("[ChatSocket] Cannot send message - not connected")}subscribe(e,t){const s={type:"subscribe",channel:e};this.sendMessage(JSON.stringify(s))}}let oe=null;function de(e){if(!oe){const e=function(){if("undefined"!=typeof window){return`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws/chat`}return"ws://localhost:8003/ws/chat"}();oe=new le(e)}return oe}const he=(e=1,t=20)=>Q({queryKey:["chat-list",e,t],queryFn:()=>ce.getChatList(e,t),staleTime:6e4,retry:2,placeholderData:{count:0,results:[]}}),ue=(e,t=1,s=50)=>Q({queryKey:["chat-messages",e,t,s],queryFn:()=>ce.getChatMessages(e,t,s),enabled:!!e,staleTime:3e4,retry:2,placeholderData:{count:0,results:[]}}),me=()=>{const e=P();return B({mutationFn:({chatId:e,data:t})=>ce.sendMessage(e,t),onSuccess:(t,{chatId:s})=>{e.invalidateQueries({queryKey:["chat-messages",s]}),e.invalidateQueries({queryKey:["chat-list"]})},onError:e=>{J.error(`Ошибка отправки сообщения: ${e.message}`)}})},xe=(e,t=!0)=>{const[a,r]=s.useState(!1),[n,i]=s.useState(null),c=s.useRef(null);s.useEffect(()=>{if(!t||!e)return;return(async()=>{try{const t=de();c.current=t,t.onConnectionChange(t=>{r(t),t&&(i(null),C.info("[useWebSocketChat] Connected to socket",{chatId:e}))}),t.isConnected()&&(t.disconnect(),C.info("[useWebSocketChat] Disconnecting from previous room")),await t.connect(e),C.info("[useWebSocketChat] Connected to room",{chatId:e})}catch(t){const e=t instanceof Error?t.message:"Ошибка подключения WebSocket";i(e),C.error("[useWebSocketChat] Setup error:",t)}})(),()=>{c.current&&(c.current.disconnect(),c.current=null)}},[e,t]);return{isConnected:a,error:n,subscribe:s.useCallback(t=>c.current?c.current.subscribeToChat(e,t):()=>{},[e]),send:s.useCallback(t=>{c.current?c.current.send(e,t):i("WebSocket не подключен")},[e])}},ge=e=>{const{data:t}=he();return(null==t?void 0:t.results.reduce((e,t)=>e+t.unread_count,0))||0};export{Y as C,se as M,ue as a,me as b,ge as c,xe as d,Z as e,ie as f,he as u};
