import{r as e,j as s}from"./react-core-JVqWokWt.js";import{b as a,C as t,g as i,h as n,i as r,j as d,k as o,T as c,m as l,n as u,o as m,q as x,r as v,s as h,A as g,t as p,v as j,B as y,c as f,D as b,w as N,x as w,y as P,z as I,E as _,u as k,l as S,F as C,S as D,P as q,a as K,e as L,G as U,H as F}from"./main-fde3JC90.js";import{u as M,e as Q}from"./react-router-WAeXREDX.js";import{b9 as V,ab as O,$ as T,av as A,aq as E,am as W,aF as R,ac as z,be as $}from"./vendor-DC2AZkDs.js";import{u as B,a as G,b as H}from"./react-query-DqnBFrGE.js";import{i as Y,u as J}from"./useInvoiceWebSocket-CjPcUPzy.js";import{P as X,a as Z,b as ee,c as se,d as ae,e as te,f as ie}from"./pagination-C0J-iX43.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const ne=(e,a)=>{if(a&&new Date(a)<new Date&&"paid"!==e)return s.jsxs(f,{variant:"destructive",className:"bg-orange-600 hover:bg-orange-700",children:[s.jsx(T,{className:"w-3 h-3 mr-1"}),"Overdue"]});switch(e){case"paid":return s.jsx(f,{variant:"default",className:"bg-green-600 hover:bg-green-700",children:"Paid"});case"viewed":return s.jsx(f,{variant:"secondary",className:"bg-yellow-600 hover:bg-yellow-700",children:"Viewed"});case"sent":return s.jsx(f,{variant:"outline",className:"border-blue-600 text-blue-600",children:"Waiting"});case"draft":return s.jsx(f,{variant:"outline",children:"Draft"});case"cancelled":return s.jsx(f,{variant:"secondary",children:"Cancelled"});default:return s.jsx(f,{variant:"outline",children:e})}},re=({invoices:b,isLoading:N,onInvoiceClick:w,onFilterChange:P,summary:I})=>{const _=e.useMemo(()=>[...b].sort((e,s)=>{const a=new Date(e.due_date)<new Date&&"paid"!==e.status,t=new Date(s.due_date)<new Date&&"paid"!==s.status;return a&&!t?-1:!a&&t?1:new Date(s.created_at).getTime()-new Date(e.created_at).getTime()}),[b]);return N?s.jsxs("div",{className:"space-y-4",children:[s.jsx(a,{className:"h-32 w-full"}),s.jsx(a,{className:"h-64 w-full"})]}):s.jsxs("div",{className:"space-y-6",children:[I&&s.jsxs(t,{className:"p-6",children:[s.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Summary"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[s.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[s.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Unpaid"}),s.jsxs("div",{className:"text-2xl font-bold text-orange-600",children:[I.total_unpaid_amount.toLocaleString("en-US")," RUB"]})]}),s.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[s.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Overdue"}),s.jsx("div",{className:"text-2xl font-bold text-destructive",children:I.overdue_count})]}),s.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[s.jsx("div",{className:"text-sm text-muted-foreground mb-1",children:"Upcoming (7 days)"}),s.jsx("div",{className:"text-2xl font-bold text-blue-600",children:I.upcoming_count})]})]})]}),P&&s.jsx("div",{className:"flex items-center gap-4",children:s.jsxs(i,{onValueChange:e=>{P("all"===e?void 0:[e])},children:[s.jsx(n,{className:"w-48",children:s.jsx(r,{placeholder:"All invoices"})}),s.jsxs(d,{children:[s.jsx(o,{value:"all",children:"All invoices"}),s.jsx(o,{value:"sent",children:"Waiting for payment"}),s.jsx(o,{value:"viewed",children:"Viewed"}),s.jsx(o,{value:"paid",children:"Paid"})]})]})}),s.jsx(t,{children:0===_.length?s.jsxs("div",{className:"p-12 text-center",children:[s.jsx(V,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No invoices"}),s.jsx("p",{className:"text-muted-foreground",children:"You have no issued invoices yet"})]}):s.jsxs(c,{children:[s.jsx(l,{children:s.jsxs(u,{children:[s.jsx(m,{children:"Child"}),s.jsx(m,{children:"Amount"}),s.jsx(m,{children:"Status"}),s.jsx(m,{children:"Due Date"}),s.jsx(m,{className:"text-right",children:"Actions"})]})}),s.jsx(x,{children:_.map(e=>{const{days:a,isOverdue:t}=(e=>{const s=new Date(e),a=new Date,t=s.getTime()-a.getTime(),i=Math.ceil(t/864e5);return{days:Math.abs(i),isOverdue:i<0}})(e.due_date),i="paid"===e.status,n=!i&&("sent"===e.status||"viewed"===e.status);return s.jsxs(u,{className:v("cursor-pointer hover:bg-muted/50 transition-colors",t&&!i&&"bg-orange-50 dark:bg-orange-950/20"),onClick:()=>w(e),children:[s.jsx(h,{children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs(g,{className:"h-10 w-10",children:[s.jsx(p,{src:e.student.avatar}),s.jsx(j,{className:"gradient-primary text-primary-foreground",children:e.student.full_name.split(" ").map(e=>e[0]).join("")})]}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium",children:e.student.full_name}),e.enrollment&&s.jsx("div",{className:"text-sm text-muted-foreground",children:e.enrollment.subject_name})]})]})}),s.jsx(h,{children:s.jsxs("div",{className:"font-semibold text-lg",children:[parseFloat(e.amount).toLocaleString("en-US")," RUB"]})}),s.jsx(h,{children:ne(e.status,e.due_date)}),s.jsx(h,{children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(O,{className:"h-4 w-4 text-muted-foreground"}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium",children:new Date(e.due_date).toLocaleDateString("en-US")}),s.jsx("div",{className:v("text-xs",t&&!i?"text-destructive font-medium":"text-muted-foreground"),children:i?"Paid":t?`Overdue by ${a} days`:`${a} days left`})]})]})}),s.jsxs(h,{className:"text-right",children:[n&&s.jsxs(y,{type:"button",size:"sm",variant:t?"default":"outline",className:v(t&&"bg-orange-600 hover:bg-orange-700 text-white font-semibold"),onClick:s=>{s.stopPropagation(),w(e)},children:[s.jsx(V,{className:"w-4 h-4 mr-1"}),"Pay"]}),i&&s.jsx(f,{variant:"default",className:"bg-green-600",children:"Paid"})]})]},e.id)})})]})})]})},de=e=>{switch(e){case"paid":return"bg-green-600 hover:bg-green-700";case"viewed":return"bg-yellow-600 hover:bg-yellow-700";case"sent":return"border-blue-600 text-blue-600";case"cancelled":return"bg-gray-600 hover:bg-gray-700";default:return""}},oe=({invoice:a,open:t,onOpenChange:i,onPayClick:n,onMarkAsViewed:r,isPaymentLoading:d})=>{if(e.useEffect(()=>{a&&t&&"sent"===a.status&&r&&r(a.id)},[a,t,r]),!a)return null;const o="paid"===a.status,c=new Date(a.due_date),l=new Date,u=c<l&&!o,m=c.getTime()-l.getTime(),x=Math.ceil(m/864e5),h=u?Math.abs(x):0;return s.jsx(b,{open:t,onOpenChange:i,children:s.jsxs(N,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[s.jsxs(w,{children:[s.jsx(P,{className:"text-2xl",children:"Invoice for Payment"}),s.jsxs(I,{children:["Details for invoice #",a.id]})]}),s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs(g,{className:"h-16 w-16",children:[s.jsx(p,{src:a.student.avatar}),s.jsx(j,{className:"gradient-primary text-primary-foreground text-lg",children:a.student.full_name.split(" ").map(e=>e[0]).join("")})]}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(A,{className:"h-4 w-4 text-muted-foreground"}),s.jsx("div",{className:"font-semibold text-lg",children:a.student.full_name})]}),a.enrollment&&s.jsx("div",{className:"text-sm text-muted-foreground",children:a.enrollment.subject_name})]})]}),s.jsx(_,{}),s.jsx("div",{className:"p-6 bg-gradient-to-br from-primary/10 to-primary/5 rounded-lg border-2 border-primary/20",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-sm text-muted-foreground mb-2",children:"Amount to pay"}),s.jsxs("div",{className:"text-4xl font-bold text-primary mb-2",children:[parseFloat(a.amount).toLocaleString("en-US")," RUB"]}),s.jsxs(f,{variant:"paid"===a.status?"default":"outline",className:v(de(a.status)),children:["paid"===a.status&&"✓ ","paid"===a.status?"Paid":"viewed"===a.status?"Viewed":"sent"===a.status?"Waiting":a.status]})]})}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx(E,{className:"h-4 w-4 text-muted-foreground"}),s.jsx("h4",{className:"font-semibold",children:"Description"})]}),s.jsx("p",{className:"text-sm text-muted-foreground bg-muted p-4 rounded-lg",children:a.description})]}),s.jsx("div",{className:v("p-4 rounded-lg border-2",u?"bg-orange-50 border-orange-400 dark:bg-orange-950/20 dark:border-orange-800":o?"bg-green-50 border-green-400 dark:bg-green-950/20 dark:border-green-800":"bg-blue-50 border-blue-400 dark:bg-blue-950/20 dark:border-blue-800"),children:s.jsxs("div",{className:"flex items-center gap-3",children:[u&&!o?s.jsx(T,{className:"h-5 w-5 text-orange-600"}):o?s.jsx(W,{className:"h-5 w-5 text-green-600"}):s.jsx(R,{className:"h-5 w-5 text-blue-600"}),s.jsxs("div",{className:"flex-1",children:[s.jsx("div",{className:"font-medium",children:o?"Invoice paid":u?"Payment overdue":"Due date"}),s.jsx("div",{className:"text-sm",children:o?s.jsxs(s.Fragment,{children:["Paid on"," ",a.paid_at&&new Date(a.paid_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})]}):s.jsxs(s.Fragment,{children:[c.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),u?s.jsxs("span",{className:"ml-2 font-medium text-orange-700 dark:text-orange-400",children:["(overdue by ",h," days)"]}):s.jsxs("span",{className:"ml-2 text-blue-600",children:["(",x," days left)"]})]})})]})]})}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-semibold mb-3",children:"Invoice history"}),s.jsx("div",{className:"space-y-3",children:[{label:"Created",completed:!0,date:a.created_at},{label:"Sent",completed:!!a.sent_at,date:a.sent_at},{label:"Viewed",completed:!!a.viewed_at,date:a.viewed_at},{label:"Paid",completed:!!a.paid_at,date:a.paid_at}].map((e,a)=>s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:v("w-8 h-8 rounded-full flex items-center justify-center border-2",e.completed?"bg-primary border-primary text-primary-foreground":"bg-muted border-muted-foreground/30 text-muted-foreground"),children:e.completed?s.jsx(W,{className:"w-4 h-4"}):s.jsx("div",{className:"w-2 h-2 rounded-full bg-muted-foreground/30"})}),s.jsxs("div",{className:"flex-1 pt-1",children:[s.jsx("div",{className:v("font-medium",e.completed?"text-foreground":"text-muted-foreground"),children:e.label}),e.date&&s.jsx("div",{className:"text-xs text-muted-foreground",children:new Date(e.date).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]},a))})]}),s.jsx(_,{}),s.jsxs("div",{className:"flex gap-3",children:[!o&&s.jsxs(s.Fragment,{children:[s.jsxs(y,{type:"button",onClick:()=>n(a),disabled:d,className:v("flex-1",u&&"bg-orange-600 hover:bg-orange-700 text-white font-semibold shadow-lg"),children:[s.jsx(V,{className:"w-4 h-4 mr-2"}),d?"Processing...":"Pay Now"]}),s.jsxs(y,{type:"button",variant:"outline",className:"flex-1",children:[s.jsx(z,{className:"w-4 h-4 mr-2"}),"Contact Tutor"]})]}),o&&s.jsxs(y,{type:"button",variant:"outline",className:"w-full",disabled:!0,children:[s.jsx(W,{className:"w-4 h-4 mr-2"}),"Invoice Paid"]})]}),s.jsxs("div",{className:"text-xs text-muted-foreground text-center",children:["Created"," ",new Date(a.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]})})},ce=()=>{const e=B(),{toast:s}=k();return H({mutationFn:async e=>{S.debug("[useMarkInvoiceViewed] Marking invoice as viewed:",e);const s=await C.markInvoiceViewed(e);return S.debug("[useMarkInvoiceViewed] Marked:",s),s},onMutate:async s=>{await e.cancelQueries({queryKey:["invoices","parent"]});const a=e.getQueriesData({queryKey:["invoices","parent"]});return e.setQueriesData({queryKey:["invoices","parent"]},e=>e?{...e,results:e.results.map(e=>e.id===s?{...e,viewed_at:(new Date).toISOString(),status:"viewed"}:e)}:e),{previousLists:a}},onError:(a,t,i)=>{(null==i?void 0:i.previousLists)&&i.previousLists.forEach(([s,a])=>{e.setQueryData(s,a)}),S.error("[useMarkInvoiceViewed] Error:",a),s({title:"Ошибка",description:a.message||"Не удалось отметить счёт как просмотренный",variant:"destructive"})},onSuccess:()=>{e.invalidateQueries({queryKey:["invoices","parent"]}),e.invalidateQueries({queryKey:["invoices","parent","summary"]})}})},le=()=>{const e=B(),{toast:s}=k();return H({mutationFn:async e=>{S.debug("[useInitiateInvoicePayment] Initiating payment:",e);const s=await C.initiateInvoicePayment(e);return S.debug("[useInitiateInvoicePayment] Payment initiated:",s),s},onSuccess:a=>{const t=a.confirmation_url||a.payment_url;t?(S.debug("[useInitiateInvoicePayment] Redirecting to:",t),window.location.href=t):(S.error("[useInitiateInvoicePayment] No payment URL in response"),s({title:"Ошибка",description:"Не удалось получить ссылку на оплату",variant:"destructive"})),e.invalidateQueries({queryKey:["invoices","parent"]}),e.invalidateQueries({queryKey:["invoices","parent","summary"]}),e.invalidateQueries({queryKey:["invoices","parent","unpaid-count"]})},onError:e=>{S.error("[useInitiateInvoicePayment] Error:",e),s({title:"Ошибка оплаты",description:e.message||"Не удалось инициировать оплату",variant:"destructive"})}})},ue=()=>{const a=M(),{toast:t}=k(),[i,n]=Q(),[r,d]=e.useState(null),[o,c]=e.useState(!1),{on:l,off:u}=J(),m=B(),{invoices:x,totalCount:v,totalPages:h,currentPage:g,hasNext:p,hasPrevious:j,summary:f,isLoading:b,error:N,setStatus:w,setPage:P,markAsViewed:I,initiatePayment:_,refetch:V,isInitiatingPayment:O}=(s=>{const a=B(),{toast:t}=k(),i=null==s?void 0:s.initialPageSize,[n,r]=e.useState({page:1}),d=e.useCallback(()=>({status:n.status,ordering:"-created_at",limit:i,offset:(n.page-1)*i}),[n,i]),{data:o,isLoading:c,error:l,refetch:u}=G({queryKey:["invoices","parent",n],queryFn:async()=>{S.debug("[useParentInvoices] Fetching invoices:",n);const e=await C.getParentInvoices(d());return S.debug("[useParentInvoices] Received:",e),e},staleTime:6e4,refetchOnMount:!0,refetchOnWindowFocus:!1,refetchInterval:null==s?void 0:s.refetchInterval}),{data:m,isLoading:x}=G({queryKey:["invoices","parent","summary"],queryFn:async()=>{try{const e=await C.getInvoiceSummary();return S.debug("[useParentInvoices] Summary:",e),e}catch(e){return S.error("[useParentInvoices] Failed to fetch summary:",e),{total_unpaid_amount:0,overdue_count:0,upcoming_count:0}}},staleTime:6e4}),{data:v,isLoading:h}=G({queryKey:["invoices","parent","unpaid-count"],queryFn:async()=>{try{const e=await C.getUnpaidInvoiceCount();return S.debug("[useParentInvoices] Unpaid count:",e),e}catch(e){return S.error("[useParentInvoices] Failed to fetch unpaid count:",e),0}},staleTime:6e4}),g=ce(),p=le();e.useEffect(()=>(S.debug("[useParentInvoices] Connecting to invoice WebSocket"),Y.connect({onInvoiceCreated:e=>{S.info("[useParentInvoices] New invoice created:",e.invoice_id),a.invalidateQueries({queryKey:["invoices","parent"]}),a.invalidateQueries({queryKey:["invoices","parent","summary"]}),a.invalidateQueries({queryKey:["invoices","parent","unpaid-count"]})},onStatusUpdate:e=>{S.info("[useParentInvoices] Invoice status updated:",e.invoice_id,e.old_status,"→",e.new_status),a.invalidateQueries({queryKey:["invoices","parent"]}),a.invalidateQueries({queryKey:["invoices","parent","summary"]}),a.invalidateQueries({queryKey:["invoices","parent","unpaid-count"]})},onInvoicePaid:e=>{S.info("[useParentInvoices] Invoice paid:",e.invoice_id),a.invalidateQueries({queryKey:["invoices","parent"]}),a.invalidateQueries({queryKey:["invoices","parent","summary"]}),a.invalidateQueries({queryKey:["invoices","parent","unpaid-count"]}),t({title:"Счёт оплачен",description:"Платёж успешно обработан"})},onError:e=>{S.error("[useParentInvoices] WebSocket error:",e)}}),()=>{S.debug("[useParentInvoices] Disconnecting from invoice WebSocket"),Y.disconnect()}),[a,t]);const j=e.useMemo(()=>(null==o?void 0:o.results)||[],[o]),y=(null==o?void 0:o.count)||0,f=Math.ceil(y/i),b=!!(null==o?void 0:o.next),N=!!(null==o?void 0:o.previous),w=e.useCallback(e=>{r(s=>({...s,status:e,page:1}))},[]),P=e.useCallback(e=>{r(s=>({...s,childId:e,page:1}))},[]),I=e.useCallback(e=>{r(s=>({...s,overdue:e,page:1}))},[]),_=e.useCallback(e=>{r(s=>({...s,page:e}))},[]),D=e.useCallback(()=>{r({page:1})},[]);return{invoices:j,totalCount:y,totalPages:f,currentPage:n.page,hasNext:b,hasPrevious:N,summary:m,unpaidCount:v,isLoading:c,isSummaryLoading:x,isUnpaidCountLoading:h,error:(null==l?void 0:l.message)||null,activeFilters:n,setStatus:w,setChild:P,setOverdueOnly:I,setPage:_,resetFilters:D,refetch:u,markAsViewed:g.mutate,isMarkingViewed:g.isPending,initiatePayment:p.mutate,isInitiatingPayment:p.isPending}})({initialPageSize:20});e.useEffect(()=>{const e=i.get("payment");i.get("invoice_id"),"success"===e?(t({title:"Payment successful",description:"Invoice was successfully paid. Thank you!",variant:"default"}),V(),n({})):"failed"===e&&(t({title:"Payment failed",description:"Unable to complete payment. Please try again.",variant:"destructive"}),n({}))},[i,n,t,V]),e.useEffect(()=>{const e=e=>{m.invalidateQueries({queryKey:["invoices"]}),t({title:"Новый счёт",description:`Получен новый счёт #${e.invoice_id}`})},s=e=>{m.invalidateQueries({queryKey:["invoices"]}),"sent"===e.new_status&&t({title:"Счёт отправлен",description:`Счёт #${e.invoice_id} готов к оплате`})},a=e=>{m.invalidateQueries({queryKey:["invoices"]}),t({title:"Счёт оплачен!",description:`Счёт #${e.invoice_id} успешно оплачен`})};return l("onInvoiceCreated",e),l("onStatusUpdate",s),l("onInvoicePaid",a),()=>{u("onInvoiceCreated",e),u("onStatusUpdate",s),u("onInvoicePaid",a)}},[l,u,m,t]);const T=e=>{P(e),window.scrollTo({top:0,behavior:"smooth"})};return s.jsxs(D,{children:[s.jsxs("div",{className:"flex min-h-screen w-full",children:[s.jsx(q,{}),s.jsxs(K,{children:[s.jsxs("header",{className:"sticky top-0 z-10 flex h-16 items-center gap-4 border-b bg-background px-6",children:[s.jsx(L,{}),s.jsx("div",{className:"flex-1"})]}),s.jsx("main",{className:"p-6",children:s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx(y,{type:"button",variant:"ghost",size:"icon",onClick:()=>a("/dashboard/parent"),children:s.jsx($,{className:"h-4 w-4"})}),s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold",children:"Invoices"}),s.jsx("p",{className:"text-muted-foreground",children:"Manage invoices for your children's education"})]})]}),N&&s.jsx(U,{error:N,onRetry:()=>V()}),b&&s.jsx(F,{}),!b&&!N&&s.jsxs(s.Fragment,{children:[s.jsx(re,{invoices:x,isLoading:b,onInvoiceClick:e=>{d(e),c(!0)},onFilterChange:w,summary:f}),h>1&&s.jsx("div",{className:"mt-6",children:s.jsx(X,{children:s.jsxs(Z,{children:[s.jsx(ee,{children:s.jsx(se,{onClick:()=>j&&T(g-1),className:j?"cursor-pointer":"pointer-events-none opacity-50"})}),(()=>{const e=[];if(h<=5)for(let s=1;s<=h;s++)e.push(s);else{e.push(1),g>3&&e.push("ellipsis");const s=Math.max(2,g-1),a=Math.min(h-1,g+1);for(let t=s;t<=a;t++)e.push(t);g<h-2&&e.push("ellipsis"),h>1&&e.push(h)}return e})().map((e,a)=>s.jsx(ee,{children:"ellipsis"===e?s.jsx(ae,{}):s.jsx(te,{onClick:()=>T(e),isActive:g===e,className:"cursor-pointer",children:e})},a)),s.jsx(ee,{children:s.jsx(ie,{onClick:()=>p&&T(g+1),className:p?"cursor-pointer":"pointer-events-none opacity-50"})})]})})}),x.length>0&&s.jsxs("div",{className:"text-sm text-muted-foreground text-center",children:["Showing ",20*(g-1)+1,"-",Math.min(20*g,v)," of ",v," invoices"]})]})]})})]})]}),s.jsx(oe,{invoice:r,open:o,onOpenChange:c,onPayClick:e=>{_(e.id)},onMarkAsViewed:I,isPaymentLoading:O})]})};export{ue as default};
