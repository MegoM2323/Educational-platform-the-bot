import{a as t,j as e,r as s}from"./react-core-JVqWokWt.js";import{a3 as r,a4 as a,a5 as n,a6 as l,a7 as i,a8 as o,a9 as c,aa as d,ab as u}from"./d3-lib-BmB4v4DK.js";import{C as p,r as h,B as f,c as m}from"./main-fde3JC90.js";import{ai as x,aj as g,X as b,$ as j,c5 as y,c6 as w,c7 as v}from"./vendor-DC2AZkDs.js";const N={not_started:"#94a3b8",in_progress:"#3b82f6",completed:"#22c55e",locked:"#ef4444"},k={not_started:"#cbd5e1",in_progress:"#60a5fa",completed:"#4ade80",locked:"#f87171"},z=30,L=40,C=6,_=2,$=4,M=.5,S=3,B=-400,D=150,E=40,T=.05,A=(t,e=!1)=>e?k[t]:N[t],G=t=>"locked"===t?.5:1,P={not_started:"#94a3b8",in_progress:"#3b82f6",completed:"#22c55e",locked:"#ef4444"},R={not_started:"#cbd5e1",in_progress:"#60a5fa",completed:"#4ade80",locked:"#f87171"},H=(t,e,s=!1)=>(s?R:P)[t],V=t=>t?.5:1,q=t=>{switch(t){case"not_started":return"Не начат";case"in_progress":return"В процессе";case"completed":return"Завершен";case"locked":return"Заблокирован";default:return"Неизвестно"}},W=({progressData:s,visible:r=!0,onVisibilityChange:a,position:n="bottom-left",showStats:l=!0,collapsible:i=!1,className:o=""})=>{const[c,d]=t.useState(!1);if(!r)return null;const u=s?(t=>{const e=Object.values(t),s=e.length;return 0===s?{totalLessons:0,completedLessons:0,inProgressLessons:0,notStartedLessons:0,averageCompletion:0}:{totalLessons:s,completedLessons:e.filter(t=>"completed"===t.status).length,inProgressLessons:e.filter(t=>"in_progress"===t.status).length,notStartedLessons:e.filter(t=>"not_started"===t.status).length,averageCompletion:e.reduce((t,e)=>t+e.percentage,0)/s}})(s):null;return e.jsxs(p,{className:h("absolute z-10 bg-white/95 backdrop-blur-sm shadow-lg rounded-lg p-3 min-w-[200px]",{"top-left":"top-4 left-4","top-right":"top-4 right-4","bottom-left":"bottom-4 left-4","bottom-right":"bottom-4 right-4"}[n],o),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-700",children:l&&u?"Прогресс":"Статусы уроков"}),e.jsxs("div",{className:"flex items-center gap-1",children:[i&&e.jsx(f,{type:"button",variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:()=>{d(!c)},title:c?"Развернуть":"Свернуть",children:c?e.jsx(x,{className:"h-3 w-3"}):e.jsx(g,{className:"h-3 w-3"})}),a&&e.jsx(f,{type:"button",variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:()=>{null==a||a(!1)},title:"Скрыть легенду",children:e.jsx(b,{className:"h-3 w-3"})})]})]}),!c&&e.jsxs(e.Fragment,{children:[l&&u&&e.jsx("div",{className:"mb-3 pb-2 border-b border-gray-200",children:e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Всего уроков:"}),e.jsx(m,{variant:"outline",className:"text-xs font-medium",children:u.totalLessons})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Завершено:"}),e.jsx(m,{variant:"outline",className:"text-xs font-medium bg-green-50 text-green-700 border-green-200",children:u.completedLessons})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"В процессе:"}),e.jsx(m,{variant:"outline",className:"text-xs font-medium bg-blue-50 text-blue-700 border-blue-200",children:u.inProgressLessons})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Средний прогресс:"}),e.jsxs(m,{variant:"outline",className:"text-xs font-medium",children:[Math.round(u.averageCompletion),"%"]})]})]})}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:"Статусы:"}),["not_started","in_progress","completed","locked"].map(t=>e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("div",{className:h("w-3 h-3 rounded-full flex-shrink-0","locked"===t&&"opacity-50"),style:{backgroundColor:P[t]},"aria-label":`Цвет статуса: ${q(t)}`}),e.jsx("span",{className:"text-gray-700",children:q(t)})]},t))]}),e.jsx("div",{className:"mt-3 pt-2 border-t border-gray-200",children:e.jsxs("div",{className:"text-xs text-gray-500 space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-amber-400 animate-pulse"}),e.jsx("span",{children:"Текущий урок"})]}),e.jsx("div",{className:"text-[10px] text-gray-400 mt-1",children:"Кликните по узлу для деталей"})]})})]})]})},I=({data:t,progressData:h,currentLessonId:m,onNodeClick:x,onNodeHover:g,onNodeDrag:b,onDependencyDelete:N,isEditable:k=!1,width:P,height:R,className:q="",showLegend:I=!0,animationDuration:X=500})=>{const Y=s.useRef(null),F=s.useRef(null),[K,O]=s.useState({width:800,height:600}),[J,Q]=s.useState(null),[U,Z]=s.useState(null),tt=s.useRef(null),et=s.useRef(null);s.useEffect(()=>{const t=()=>{if(F.current){const t=F.current.getBoundingClientRect(),e=t.width>0?t.width:800,s=t.height>0?t.height:600;O({width:null!=P?P:e,height:null!=R?R:s})}else O({width:null!=P?P:800,height:null!=R?R:600})};t();const e=setTimeout(t,100),s=function(t,e){let s=null;return function(...r){const a=()=>{s=null,t(...r)};s&&clearTimeout(s),s=setTimeout(a,e)}}(t,250);return window.addEventListener("resize",s),()=>{clearTimeout(e),window.removeEventListener("resize",s)}},[P,R]),s.useEffect(()=>{if(Y.current&&0!==t.nodes.length){Z(null);try{let e=function(){Z.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),st&&st.attr("transform",t=>`translate(${(t.source.x+t.target.x)/2},${(t.source.y+t.target.y)/2})`),at.attr("transform",t=>`translate(${t.x},${t.y})`)},s=function(t,e){Q(e.id),null==g||g(e.id);const s=h&&h[e.id]?H(h[e.id].status,h[e.id].percentage,!0):A(e.status,!0);r(t.currentTarget).attr("fill",s).attr("stroke-width",$);const a=((t,e)=>{const s=new Set;return e.forEach(e=>{const r="object"==typeof e.source?e.source.id:e.source,a="object"==typeof e.target?e.target.id:e.target;r===t&&s.add(a),a===t&&s.add(r)}),s})(e.id,P);at.selectAll("circle").attr("opacity",t=>t.id===e.id||a.has(t.id)?h&&h[t.id]?V("locked"===h[t.id].status):G(t.status):.3),Z.attr("opacity",t=>{const s=t.source.id,r=t.target.id;return s===e.id||r===e.id?.8:.1})},u=function(t,e){Q(null),null==g||g(null);const s=h&&h[e.id]?H(h[e.id].status,h[e.id].percentage,!1):A(e.status,!1),a=m&&e.id===m?2*_:_;r(t.currentTarget).attr("fill",s).attr("stroke-width",a),at.selectAll("circle").attr("opacity",t=>h&&h[t.id]?V("locked"===h[t.id].status):G(t.status)),Z.attr("opacity",.6)},p=function(t,e){t.stopPropagation(),null==x||x(e.id)},f=function(t){return a().on("start",function(e){e.active||t.alphaTarget(.3).restart(),e.subject.fx=e.subject.x,e.subject.fy=e.subject.y}).on("drag",function(t){t.subject.fx=t.x,t.subject.fy=t.y}).on("end",function(e){if(e.active||t.alphaTarget(0),k){const t=e.subject.x,s=e.subject.y;e.subject.fx=t,e.subject.fy=s,null==b||b(e.subject.id,t,s)}else e.subject.fx=null,e.subject.fy=null})};const j=r(Y.current);let{width:y,height:w}=K;0===y&&(console.warn("[GraphVisualization] Width is zero, using default 800"),y=800),0===w&&(console.warn("[GraphVisualization] Height is zero, using default 600"),w=600),j.selectAll("*").remove();const{nodes:v,links:P}=(t=>{const e=t.nodes.map((e,s)=>{var r,a;let n=e.x,l=e.y;if(null==n||null==l){const e=s/t.nodes.length*2*Math.PI,r=200;n=400+r*Math.cos(e),l=300+r*Math.sin(e)}return{...e,x:n,y:l,fx:null!=(r=e.fx)?r:null,fy:null!=(a=e.fy)?a:null}}),s=new Map;return e.forEach(t=>s.set(t.id,t)),{nodes:e,links:t.links.map(t=>{const e="string"==typeof t.source?s.get(t.source):t.source,r="string"==typeof t.target?s.get(t.target):t.target;return e&&r?{...t,source:e,target:r}:(console.warn("Link references non-existent node:",t),null)}).filter(t=>null!==t)}})(t),R=j.append("g").attr("class","graph-container"),q=n().scaleExtent([M,S]).on("zoom",t=>{R.attr("transform",t.transform)});j.call(q),et.current=q;const W=j.append("defs");W.append("marker").attr("id","arrowhead-prerequisite").attr("viewBox","0 -5 10 10").attr("refX",z+5).attr("refY",0).attr("markerWidth",C).attr("markerHeight",C).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("fill","#64748b"),W.append("marker").attr("id","arrowhead-suggested").attr("viewBox","0 -5 10 10").attr("refX",z+5).attr("refY",0).attr("markerWidth",C).attr("markerHeight",C).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("fill","#94a3b8");const I={color:"#fbbf24",blur:8,spread:2,animation:"pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite"},F=W.append("filter").attr("id","glow").attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%");F.append("feGaussianBlur").attr("stdDeviation",I.blur).attr("result","coloredBlur");const O=F.append("feMerge");O.append("feMergeNode").attr("in","coloredBlur"),O.append("feMergeNode").attr("in","SourceGraphic");const J=l(v).force("link",i(P).id(t=>t.id).distance(D)).force("charge",o().strength(B)).force("center",c(y/2,w/2).strength(T)).force("collide",d().radius(E)).on("tick",e);tt.current=J;const U=R.append("g").attr("class","links"),Z=U.selectAll("line").data(P).join("line").attr("stroke",t=>"prerequisite"===t.type?"#64748b":"#94a3b8").attr("stroke-width",_).attr("stroke-dasharray",t=>{const e="locked"===t.source.status;return((t,e)=>e?"5,5":"prerequisite"===t?"":"2,2")(t.type,e)}).attr("opacity",.6).attr("marker-end",t=>`url(#arrowhead-${t.type})`);let st=null,rt=null;k&&N&&(st=U.selectAll(".link-delete-group").data(P.filter(t=>void 0!==t.id)).join("g").attr("class","link-delete-group").attr("cursor","pointer").attr("pointer-events","auto").on("mouseenter",function(){r(this).select("circle").attr("r",11),r(this).select("text").attr("font-size","16px")}).on("mouseleave",function(){r(this).select("circle").attr("r",10),r(this).select("text").attr("font-size","14px")}).on("click",function(t,e){t.stopPropagation(),void 0!==e.id&&N(e.id)}),st.append("circle").attr("r",10).attr("fill","white").attr("stroke","#ef4444").attr("stroke-width",2),rt=st.append("text").attr("class","link-delete-icon").attr("text-anchor","middle").attr("dominant-baseline","middle").attr("font-size","14px").attr("fill","#ef4444").attr("font-weight","bold").style("user-select","none").text("✖"));const at=R.append("g").attr("class","nodes").selectAll("g").data(v).join("g").attr("class","node").call(f(J));return at.append("circle").attr("r",z).attr("fill",t=>{if(h&&h[t.id]){const e=h[t.id];return H(e.status,e.percentage,!1)}return A(t.status,!1)}).attr("opacity",t=>{if(h&&h[t.id]){const e=h[t.id];return V("locked"===e.status)}return G(t.status)}).attr("stroke",t=>m&&t.id===m?"#fbbf24":"#fff").attr("stroke-width",t=>m&&t.id===m?2*_:_).attr("cursor","pointer").attr("filter",t=>m&&t.id===m?"url(#glow)":"none").style("transition",`all ${X}ms ease-in-out`).on("mouseenter",s).on("mouseleave",u).on("click",p),at.append("text").attr("dy",L).attr("text-anchor","middle").attr("font-size","12px").attr("font-weight","500").attr("fill","#1e293b").attr("pointer-events","none").text(t=>((t,e=20)=>t.length<=e?t:t.slice(0,e-3)+"...")(t.title,15)).append("title").text(t=>t.title),h&&at.append("text").attr("dy",5).attr("text-anchor","middle").attr("font-size","11px").attr("font-weight","600").attr("fill","#fff").attr("pointer-events","none").text(t=>{const e=h[t.id];return e&&e.percentage>0&&e.percentage<100?(s=e.percentage,`${Math.round(s)}%`):"";var s}).style("text-shadow","0 1px 2px rgba(0,0,0,0.3)"),()=>{J.stop()}}catch(e){console.error("[GraphVisualization] D3 render error:",e),Z(e)}}},[t,K,k,x,g,b,N,h,m,X]);const st=s.useCallback(()=>{Y.current&&et.current&&r(Y.current).transition().duration(300).call(et.current.scaleBy,1.3)},[]),rt=s.useCallback(()=>{Y.current&&et.current&&r(Y.current).transition().duration(300).call(et.current.scaleBy,.7)},[]),at=s.useCallback(()=>{Y.current&&et.current&&r(Y.current).transition().duration(500).call(et.current.transform,u)},[]);return U?e.jsx(p,{className:`p-8 ${q}`,children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-center h-96",children:[e.jsx(j,{className:"w-12 h-12 text-destructive mb-4"}),e.jsx("p",{className:"text-destructive font-medium",children:"Ошибка отображения графа"}),e.jsx("p",{className:"text-muted-foreground text-sm mt-2 max-w-md",children:U.message}),e.jsx(f,{type:"button",variant:"outline",onClick:()=>Z(null),className:"mt-4",children:"Повторить"})]})}):0===t.nodes.length?e.jsx(p,{className:`p-8 ${q}`,children:e.jsx("div",{className:"flex flex-col items-center justify-center text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Нет данных для отображения графа"})})}):e.jsx(p,{className:`relative ${q}`,children:e.jsxs("div",{ref:F,className:"relative w-full min-h-[600px]",style:{width:null!=P?P:"100%",height:null!=R?R:600},children:[e.jsx("svg",{ref:Y,width:K.width,height:K.height,className:"w-full h-full",style:{display:"block"},role:"img","aria-label":"Knowledge graph visualization"}),e.jsxs("div",{className:"absolute top-4 right-4 flex flex-col gap-2",children:[e.jsx(f,{type:"button",variant:"outline",size:"icon",onClick:st,title:"Увеличить",className:"bg-white/90 backdrop-blur",children:e.jsx(y,{className:"h-4 w-4"})}),e.jsx(f,{type:"button",variant:"outline",size:"icon",onClick:rt,title:"Уменьшить",className:"bg-white/90 backdrop-blur",children:e.jsx(w,{className:"h-4 w-4"})}),e.jsx(f,{type:"button",variant:"outline",size:"icon",onClick:at,title:"Сбросить зум",className:"bg-white/90 backdrop-blur",children:e.jsx(v,{className:"h-4 w-4"})})]}),I&&e.jsx(W,{progressData:h,visible:!0,position:"bottom-left",showStats:!!h,collapsible:!0})]})})};export{I as G};
