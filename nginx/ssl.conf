# SSL/TLS Configuration for THE BOT Platform
# Modern security configuration achieving A+ rating on SSL Labs
#
# This configuration is included in the main nginx config for SSL/TLS
# Supports: TLS 1.2 and TLS 1.3 only
# Weak protocols disabled: SSLv3, TLS 1.0, TLS 1.1

# Paths to Let's Encrypt certificates
# These are symlinks to the latest certificates managed by certbot
ssl_certificate /etc/letsencrypt/live/the-bot.ru/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/the-bot.ru/privkey.pem;
ssl_trusted_certificate /etc/letsencrypt/live/the-bot.ru/chain.pem;

# ============================================
# Protocol Configuration
# ============================================

# Enforce TLS 1.2 and TLS 1.3 only
# SSLv3, TLS 1.0, TLS 1.1 are disabled (vulnerable to attacks)
ssl_protocols TLSv1.2 TLSv1.3;

# Minimum TLS version (fail early if client doesn't support TLS 1.2+)
ssl_conf_command MinProtocol TLSv1.2;
ssl_conf_command MaxProtocol TLSv1.3;

# ============================================
# Cipher Configuration (Modern & Secure)
# ============================================

# Cipher suite order:
# 1. TLS 1.3 ciphers (automatically handled by OpenSSL)
# 2. ECDHE ciphers (Elliptic Curve Diffie-Hellman - forward secrecy)
# 3. AEAD ciphers (Authenticated Encryption with Associated Data - GCM/POLY1305)
# 4. SHA256/384 authentication
# 5. Fallback to DHE if ECDHE unavailable
#
# Removed: RC4, DES, MD5, aNULL, eNULL (weak/broken)
# Removed: 3DES, NULL (legacy compatibility)
# Removed: !aNull, !eNull (anonymous - no authentication)
#
# SSL Labs A+ requirements met:
# - ECDHE for forward secrecy
# - GCM/POLY1305 for authenticated encryption
# - 128/256-bit keys
# - No weak ciphers
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

# Enforce server-side cipher preference
# Server chooses cipher from list, not client
# Ensures strongest cipher is used
ssl_prefer_server_ciphers on;

# ============================================
# Session Management & Performance
# ============================================

# Session cache - speeds up SSL handshakes for repeated connections
# Shared: all worker processes access same cache
# 40m: 40 megabyte cache (stores ~50k sessions)
# Default session size: ~512 bytes
ssl_session_cache shared:SSL:40m;

# Session timeout - how long session is valid in cache
# 1d = 1 day (standard for long-term connections)
ssl_session_timeout 1d;

# Disable session tickets - use session cache instead
# Tickets would be another vector for session recovery attacks
# Cache-based sessions are more secure
ssl_session_tickets off;

# ============================================
# OCSP Stapling (Certificate Validation)
# ============================================

# Enable OCSP stapling - server provides certificate status
# Client doesn't need to contact CA for validation
# Faster validation + better privacy (CA doesn't see all client accesses)
ssl_stapling on;

# Verify OCSP response before stapling
# Ensures we only send valid OCSP responses
ssl_stapling_verify on;

# OCSP responder for Let's Encrypt
# ocsp.letsencrypt.org provides up-to-date certificate status
ssl_stapling_responder http://ocsp.letsencrypt.org;

# DNS resolver for OCSP stapling queries
# Uses Google Public DNS (reliable & fast)
# valid=300s: Cache DNS results for 5 minutes
resolver 8.8.8.8 8.8.4.4 valid=300s;

# Timeout for DNS queries
resolver_timeout 5s;

# ============================================
# Elliptic Curve Configuration (TLS 1.3+)
# ============================================

# Prefer curves for ECDHE key exchange in TLS 1.2 and TLS 1.3
# Modern curves with good security properties
# X25519: Newest, fastest (recommended by many cryptographers)
# secp384r1: 384-bit security level
# secp256r1: 256-bit security level (most common)
# prime256v1: Same as secp256r1 (alternate name)
ssl_ecdh_curve X25519:secp384r1:secp256r1;

# ============================================
# SSL/TLS Optimization
# ============================================

# Buffer size for SSL handshake
# Reduced from default 16k to 4k for most clients
# Some older clients may need 16k
ssl_buffer_size 4k;

# ============================================
# Certificate Pinning (Optional - CAREFUL!)
# ============================================

# IMPORTANT: Certificate pinning is commented out by default
# Only enable if you understand the implications!
#
# Public Key Pinning Extension (HPKP) adds trust-on-first-use (TOFU)
# verification. If pin fails, browser cannot connect even with valid cert.
#
# RISKS:
# - Can lock users out if certificate is replaced
# - Requires careful backup key management
# - 6 month+ validity recommended
# - Wrong implementation = DoS vector
#
# ONLY uncomment after:
# 1. Extract pin from current certificate
# 2. Generate backup pin from certificate
# 3. Test with 'includeSubDomains' disabled first
# 4. Use strict policy (no-cache)
#
# To generate pins:
# openssl x509 -in /etc/letsencrypt/live/the-bot.ru/cert.pem -pubkey -noout | \
#   openssl pkey -pubin -outform DER | openssl dgst -sha256 -binary | \
#   openssl enc -base64
#
# Example (DO NOT USE - generate your own pins):
# add_header Public-Key-Pins 'pin-sha256="AAAA..."; pin-sha256="BBBB..."; max-age=2592000; includeSubDomains' always;

# ============================================
# Logging
# ============================================

# Log SSL handshake errors and certificate issues
# Useful for monitoring certificate expiration and client compatibility
ssl_log_session_cache off;  # Don't log individual session cache operations

# Note: Access/error logs configured in main server block
