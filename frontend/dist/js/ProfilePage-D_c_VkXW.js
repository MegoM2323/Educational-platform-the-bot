import{r as e,j as r}from"./react-core-JVqWokWt.js";import{C as a,J as s,K as t,L as i,az as l,aC as n,aD as o,aA as d,aE as c,_ as u,aF as m,$ as h,B as x,r as p,u as f,l as j,M as g,aV as v}from"./main-fde3JC90.js";import{aW as b,aY as y,b6 as w,b3 as P,a_ as N,a$ as S,a2 as E,ak as X,bA as F,X as _,ay as U,ax as A}from"./vendor-DC2AZkDs.js";import{T,p as D}from"./profileAPI-mpI8UVp9.js";import{a as k,u as L,b as C}from"./react-query-DqnBFrGE.js";import{u as R}from"./react-router-WAeXREDX.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const Q=/^[+]?[\d\s\-()]+$/,q=b({first_name:y().min(1,"Имя обязательно").max(150,"Имя не должно превышать 150 символов"),last_name:y().min(1,"Фамилия обязательна").max(150,"Фамилия не должна превышать 150 символов"),phone:y().refine(e=>!e||Q.test(e),"Некорректный формат телефона").optional().or(w(""))}),z=q.extend({grade:y().refine(e=>!e||/^\d{1,2}$/.test(e),"Класс должен быть числом от 1 до 12").optional().or(w("")),goal:y().max(1e3,"Цель не должна превышать 1000 символов").optional().or(w(""))}),K=q.extend({bio:y().max(1e3,"Биография не должна превышать 1000 символов").optional().or(w("")),subject:y().max(100,"Предмет не должен превышать 100 символов").optional().or(w("")),experience_years:P().int("Опыт должен быть целым числом").min(0,"Опыт не может быть отрицательным").max(80,"Опыт не может превышать 80 лет").optional()}),M=q.extend({bio:y().max(1e3,"Биография не должна превышать 1000 символов").optional().or(w("")),specialization:y().max(200,"Специализация не должна превышать 200 символов").optional().or(w("")),experience_years:P().int("Опыт должен быть целым числом").min(0,"Опыт не может быть отрицательным").max(80,"Опыт не может превышать 80 лет").optional()}),B=q.extend({}),I=({initialData:p,onSubmit:f,isLoading:j=!1,autoSave:g=!1,onAutoSave:v,isTelegramLinked:b=!1,telegramUsername:y})=>{const[w,P]=e.useState(!1),[X,F]=e.useState(!1),[_,U]=e.useState(0),A={first_name:(null==p?void 0:p.first_name)||"",last_name:(null==p?void 0:p.last_name)||"",phone:(null==p?void 0:p.phone)||"",grade:(null==p?void 0:p.grade)||void 0,goal:(null==p?void 0:p.goal)||""},D=N({resolver:S(z),mode:"onBlur",defaultValues:A});e.useEffect(()=>{if(!g||!v)return;const e=D.watch(()=>{P(!0)});return()=>e.unsubscribe()},[D,g,v]);return r.jsxs(a,{className:"w-full",children:[r.jsx(s,{children:r.jsx(t,{children:"Профиль студента"})}),r.jsx(i,{children:r.jsx(l,{...D,children:r.jsxs("form",{onSubmit:D.handleSubmit(async e=>{try{const r={};Object.keys(e).forEach(a=>{const s=a,t=e[s];t!==A[s]&&(r[a]=t)}),await f(r),P(!1),E.success("Профиль успешно сохранен")}catch(r){const e=r instanceof Error?r.message:"Ошибка при сохранении профиля";E.error(e)}}),className:"space-y-6",children:[r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsx(n,{control:D.control,name:"first_name",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"first_name",children:"Имя"}),r.jsx(c,{children:r.jsx(u,{id:"first_name",placeholder:"Ваше имя",...e,"aria-label":"Имя студента",disabled:j})}),r.jsx(m,{})]})}),r.jsx(n,{control:D.control,name:"last_name",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"last_name",children:"Фамилия"}),r.jsx(c,{children:r.jsx(u,{id:"last_name",placeholder:"Ваша фамилия",...e,"aria-label":"Фамилия студента",disabled:j})}),r.jsx(m,{})]})})]}),r.jsx(n,{control:D.control,name:"phone",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"phone",children:"Телефон"}),r.jsx(c,{children:r.jsx(u,{id:"phone",placeholder:"+7 (XXX) XXX-XX-XX",type:"tel",...e,"aria-label":"Номер телефона","aria-describedby":"phone-hint",disabled:j})}),r.jsx("p",{id:"phone-hint",className:"text-xs text-gray-500",children:"Формат: +7 (XXX) XXX-XX-XX или подобный"}),r.jsx(m,{})]})}),r.jsx(n,{control:D.control,name:"grade",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"grade",children:"Класс"}),r.jsx(c,{children:r.jsx(u,{id:"grade",placeholder:"Введите номер класса",type:"number",min:"1",max:"12",...e,value:e.value?String(e.value):"",onChange:r=>{if(""===r.target.value)e.onChange(void 0);else{const a=parseInt(r.target.value,10);isNaN(a)||e.onChange(a)}},"aria-label":"Класс студента",disabled:j})}),r.jsx(m,{})]})}),r.jsx(n,{control:D.control,name:"goal",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"goal",children:"Цель обучения"}),r.jsx(c,{children:r.jsx(h,{id:"goal",placeholder:"Опишите вашу цель обучения...",...e,"aria-label":"Цель обучения студента",disabled:j,className:"resize-none",rows:4})}),r.jsx("p",{className:"text-xs text-gray-500",children:"Максимум 1000 символов"}),r.jsx(m,{})]})}),r.jsxs("div",{className:"pt-4 border-t",children:[r.jsx("h3",{className:"text-sm font-semibold mb-3",children:"Интеграции"}),r.jsx(T,{isLinked:b,telegramUsername:y,onStatusChange:()=>U(e=>e+1)},_)]}),r.jsxs("div",{className:"flex gap-2 pt-4",children:[r.jsx(x,{type:"submit",disabled:j||X,"aria-label":"Сохранить профиль",children:j||X?"Сохранение...":"Сохранить профиль"}),w&&g&&r.jsxs("div",{className:"text-sm text-orange-600 flex items-center",children:[r.jsx("span",{className:"inline-block w-2 h-2 bg-orange-600 rounded-full mr-2"}),"Есть несохраненные изменения"]})]})]})})})]})},W=({initialData:p,onSubmit:f,isLoading:j=!1,autoSave:g=!1,onAutoSave:v,isTelegramLinked:b=!1,telegramUsername:y})=>{const[w,P]=e.useState(!1),[X,F]=e.useState(!1),[_,U]=e.useState(0),A=N({resolver:S(K),mode:"onBlur",defaultValues:{first_name:(null==p?void 0:p.first_name)||"",last_name:(null==p?void 0:p.last_name)||"",phone:(null==p?void 0:p.phone)||"",bio:(null==p?void 0:p.bio)||"",subject:(null==p?void 0:p.subject)||"",experience_years:(null==p?void 0:p.experience_years)||void 0}});e.useEffect(()=>{if(!g||!v)return;const e=A.watch(()=>{P(!0)});return()=>e.unsubscribe()},[A,g,v]);return r.jsxs(a,{className:"w-full",children:[r.jsx(s,{children:r.jsx(t,{children:"Профиль учителя"})}),r.jsx(i,{children:r.jsx(l,{...A,children:r.jsxs("form",{onSubmit:A.handleSubmit(async e=>{try{await f(e),P(!1),E.success("Профиль успешно сохранен")}catch(r){const e=r instanceof Error?r.message:"Ошибка при сохранении профиля";E.error(e)}}),className:"space-y-6",children:[r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsx(n,{control:A.control,name:"first_name",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"first_name",children:"Имя"}),r.jsx(c,{children:r.jsx(u,{id:"first_name",placeholder:"Ваше имя",...e,"aria-label":"Имя учителя",disabled:j})}),r.jsx(m,{})]})}),r.jsx(n,{control:A.control,name:"last_name",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"last_name",children:"Фамилия"}),r.jsx(c,{children:r.jsx(u,{id:"last_name",placeholder:"Ваша фамилия",...e,"aria-label":"Фамилия учителя",disabled:j})}),r.jsx(m,{})]})})]}),r.jsx(n,{control:A.control,name:"phone",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"phone",children:"Телефон"}),r.jsx(c,{children:r.jsx(u,{id:"phone",placeholder:"+7 (XXX) XXX-XX-XX",type:"tel",...e,"aria-label":"Номер телефона","aria-describedby":"phone-hint",disabled:j})}),r.jsx("p",{id:"phone-hint",className:"text-xs text-gray-500",children:"Формат: +7 (XXX) XXX-XX-XX или подобный"}),r.jsx(m,{})]})}),r.jsx(n,{control:A.control,name:"bio",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"bio",children:"Биография"}),r.jsx(c,{children:r.jsx(h,{id:"bio",placeholder:"Расскажите о себе...",...e,"aria-label":"Биография учителя",disabled:j,className:"resize-none",rows:4})}),r.jsx("p",{className:"text-xs text-gray-500",children:"Максимум 1000 символов"}),r.jsx(m,{})]})}),r.jsx(n,{control:A.control,name:"subject",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"subject",children:"Предмет"}),r.jsx(c,{children:r.jsx(u,{id:"subject",placeholder:"Ваш предмет",...e,"aria-label":"Предмет учителя",disabled:j})}),r.jsx("p",{className:"text-xs text-gray-500",children:"Максимум 100 символов"}),r.jsx(m,{})]})}),r.jsx(n,{control:A.control,name:"experience_years",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"experience_years",children:"Опыт работы (лет)"}),r.jsx(c,{children:r.jsx(u,{id:"experience_years",placeholder:"0",type:"number",min:"0",max:"80",...e,value:e.value||"",onChange:r=>{const a=r.target.value?parseInt(r.target.value):void 0;e.onChange(a)},"aria-label":"Опыт работы учителя",disabled:j})}),r.jsx(m,{})]})}),r.jsxs("div",{className:"pt-4 border-t",children:[r.jsx("h3",{className:"text-sm font-semibold mb-3",children:"Интеграции"}),r.jsx(T,{isLinked:b,telegramUsername:y,onStatusChange:()=>U(e=>e+1)},_)]}),r.jsxs("div",{className:"flex gap-2 pt-4",children:[r.jsx(x,{type:"submit",disabled:j||X,"aria-label":"Сохранить профиль",children:j||X?"Сохранение...":"Сохранить профиль"}),w&&g&&r.jsxs("div",{className:"text-sm text-orange-600 flex items-center",children:[r.jsx("span",{className:"inline-block w-2 h-2 bg-orange-600 rounded-full mr-2"}),"Есть несохраненные изменения"]})]})]})})})]})},O=({initialData:p,onSubmit:f,isLoading:j=!1,autoSave:g=!1,onAutoSave:v,isTelegramLinked:b=!1,telegramUsername:y})=>{const[w,P]=e.useState(!1),[X,F]=e.useState(!1),[_,U]=e.useState(0),A=N({resolver:S(M),mode:"onBlur",defaultValues:{first_name:(null==p?void 0:p.first_name)||"",last_name:(null==p?void 0:p.last_name)||"",phone:(null==p?void 0:p.phone)||"",bio:(null==p?void 0:p.bio)||"",specialization:(null==p?void 0:p.specialization)||"",experience_years:(null==p?void 0:p.experience_years)||void 0}});e.useEffect(()=>{if(!g||!v)return;const e=A.watch(()=>{P(!0)});return()=>e.unsubscribe()},[A,g,v]);return r.jsxs(a,{className:"w-full",children:[r.jsx(s,{children:r.jsx(t,{children:"Профиль репетитора"})}),r.jsx(i,{children:r.jsx(l,{...A,children:r.jsxs("form",{onSubmit:A.handleSubmit(async e=>{try{await f(e),P(!1),E.success("Профиль успешно сохранен")}catch(r){const e=r instanceof Error?r.message:"Ошибка при сохранении профиля";E.error(e)}}),className:"space-y-6",children:[r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsx(n,{control:A.control,name:"first_name",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"first_name",children:"Имя"}),r.jsx(c,{children:r.jsx(u,{id:"first_name",placeholder:"Ваше имя",...e,"aria-label":"Имя репетитора",disabled:j})}),r.jsx(m,{})]})}),r.jsx(n,{control:A.control,name:"last_name",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"last_name",children:"Фамилия"}),r.jsx(c,{children:r.jsx(u,{id:"last_name",placeholder:"Ваша фамилия",...e,"aria-label":"Фамилия репетитора",disabled:j})}),r.jsx(m,{})]})})]}),r.jsx(n,{control:A.control,name:"phone",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"phone",children:"Телефон"}),r.jsx(c,{children:r.jsx(u,{id:"phone",placeholder:"+7 (XXX) XXX-XX-XX",type:"tel",...e,"aria-label":"Номер телефона","aria-describedby":"phone-hint",disabled:j})}),r.jsx("p",{id:"phone-hint",className:"text-xs text-gray-500",children:"Формат: +7 (XXX) XXX-XX-XX или подобный"}),r.jsx(m,{})]})}),r.jsx(n,{control:A.control,name:"bio",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"bio",children:"Биография"}),r.jsx(c,{children:r.jsx(h,{id:"bio",placeholder:"Расскажите о себе...",...e,"aria-label":"Биография репетитора",disabled:j,className:"resize-none",rows:4})}),r.jsx("p",{className:"text-xs text-gray-500",children:"Максимум 1000 символов"}),r.jsx(m,{})]})}),r.jsx(n,{control:A.control,name:"specialization",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"specialization",children:"Специализация"}),r.jsx(c,{children:r.jsx(u,{id:"specialization",placeholder:"Ваша специализация",...e,"aria-label":"Специализация репетитора",disabled:j})}),r.jsx("p",{className:"text-xs text-gray-500",children:"Максимум 200 символов"}),r.jsx(m,{})]})}),r.jsx(n,{control:A.control,name:"experience_years",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"experience_years",children:"Опыт работы (лет)"}),r.jsx(c,{children:r.jsx(u,{id:"experience_years",placeholder:"0",type:"number",min:"0",max:"80",...e,value:e.value||"",onChange:r=>{const a=r.target.value?parseInt(r.target.value):void 0;e.onChange(a)},"aria-label":"Опыт работы репетитора",disabled:j})}),r.jsx(m,{})]})}),r.jsxs("div",{className:"pt-4 border-t",children:[r.jsx("h3",{className:"text-sm font-semibold mb-3",children:"Интеграции"}),r.jsx(T,{isLinked:b,telegramUsername:y,onStatusChange:()=>U(e=>e+1)},_)]}),r.jsxs("div",{className:"flex gap-2 pt-4",children:[r.jsx(x,{type:"submit",disabled:j||X,"aria-label":"Сохранить профиль",children:j||X?"Сохранение...":"Сохранить профиль"}),w&&g&&r.jsxs("div",{className:"text-sm text-orange-600 flex items-center",children:[r.jsx("span",{className:"inline-block w-2 h-2 bg-orange-600 rounded-full mr-2"}),"Есть несохраненные изменения"]})]})]})})})]})},V=({initialData:h,onSubmit:p,isLoading:f=!1,autoSave:j=!1,onAutoSave:g,isTelegramLinked:v=!1,telegramUsername:b})=>{const[y,w]=e.useState(!1),[P,X]=e.useState(!1),[F,_]=e.useState(0),U=N({resolver:S(B),mode:"onBlur",defaultValues:{first_name:(null==h?void 0:h.first_name)||"",last_name:(null==h?void 0:h.last_name)||"",phone:(null==h?void 0:h.phone)||""}});e.useEffect(()=>{if(!j||!g)return;const e=U.watch(()=>{w(!0)});return()=>e.unsubscribe()},[U,j,g]);return r.jsxs(a,{className:"w-full",children:[r.jsx(s,{children:r.jsx(t,{children:"Профиль родителя"})}),r.jsx(i,{children:r.jsx(l,{...U,children:r.jsxs("form",{onSubmit:U.handleSubmit(async e=>{try{await p(e),w(!1),E.success("Профиль успешно сохранен")}catch(r){const e=r instanceof Error?r.message:"Ошибка при сохранении профиля";E.error(e)}}),className:"space-y-6",children:[r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsx(n,{control:U.control,name:"first_name",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"first_name",children:"Имя"}),r.jsx(c,{children:r.jsx(u,{id:"first_name",placeholder:"Ваше имя",...e,"aria-label":"Имя родителя",disabled:f})}),r.jsx(m,{})]})}),r.jsx(n,{control:U.control,name:"last_name",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"last_name",children:"Фамилия"}),r.jsx(c,{children:r.jsx(u,{id:"last_name",placeholder:"Ваша фамилия",...e,"aria-label":"Фамилия родителя",disabled:f})}),r.jsx(m,{})]})})]}),r.jsx(n,{control:U.control,name:"phone",render:({field:e})=>r.jsxs(o,{children:[r.jsx(d,{htmlFor:"phone",children:"Телефон"}),r.jsx(c,{children:r.jsx(u,{id:"phone",placeholder:"+7 (XXX) XXX-XX-XX",type:"tel",...e,"aria-label":"Номер телефона","aria-describedby":"phone-hint",disabled:f})}),r.jsx("p",{id:"phone-hint",className:"text-xs text-gray-500",children:"Формат: +7 (XXX) XXX-XX-XX или подобный"}),r.jsx(m,{})]})}),r.jsxs("div",{className:"pt-4 border-t",children:[r.jsx("h3",{className:"text-sm font-semibold mb-3",children:"Интеграции"}),r.jsx(T,{isLinked:v,telegramUsername:b,onStatusChange:()=>_(e=>e+1)},F)]}),r.jsxs("div",{className:"flex gap-2 pt-4",children:[r.jsx(x,{type:"submit",disabled:f||P,"aria-label":"Сохранить профиль",children:f||P?"Сохранение...":"Сохранить профиль"}),y&&j&&r.jsxs("div",{className:"text-sm text-orange-600 flex items-center",children:[r.jsx("span",{className:"inline-block w-2 h-2 bg-orange-600 rounded-full mr-2"}),"Есть несохраненные изменения"]})]})]})})})]})},$=({currentAvatar:s,onAvatarUpload:t,isLoading:l=!1,fallbackInitials:n="АА"})=>{const[o,d]=e.useState(null),[c,u]=e.useState(!1),[m,h]=e.useState(null),f=e.useRef(null),j=["image/jpeg","image/png","image/webp"],g=e.useCallback(e=>j.includes(e.type)?e.size>5242880?"Размер файла не должен превышать 5MB":null:"Разрешены только JPEG, PNG и WebP файлы",[]),v=e.useCallback(async e=>{h(null);const r=g(e);if(r)return h(r),void E.error(r);try{const r=new FileReader;r.onload=e=>{var r;d(null==(r=e.target)?void 0:r.result)},r.readAsDataURL(e),await t(e),E.success("Аватар успешно загружен"),d(null)}catch(a){const e=a instanceof Error?a.message:"Ошибка при загрузке аватара";h(e),E.error(e),d(null)}},[t,g]),b=()=>{var e;null==(e=f.current)||e.click()},y=o||s,w=!y;return r.jsx(a,{className:"w-full",children:r.jsx(i,{className:"pt-6",children:r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"flex justify-center",children:w?r.jsx("div",{className:"w-48 h-48 rounded-full bg-gradient-to-br from-blue-400 to-purple-500\n                  flex items-center justify-center text-white text-4xl font-bold shadow-lg",role:"img","aria-label":`Аватар с инициалами ${n}`,children:n}):r.jsxs("div",{className:"relative",children:[r.jsx("img",{src:y,alt:"Аватар",className:"w-48 h-48 rounded-full object-cover shadow-lg border-4 border-gray-100"}),o&&r.jsx("div",{className:"absolute inset-0 rounded-full bg-black/20 flex items-center justify-center","aria-live":"polite",children:r.jsx(X,{className:"w-12 h-12 text-white"})})]})}),r.jsxs("div",{onDragOver:e=>{e.preventDefault(),u(!0)},onDragLeave:()=>{u(!1)},onDrop:e=>{var r;e.preventDefault(),u(!1);const a=null==(r=e.dataTransfer.files)?void 0:r[0];a&&v(a)},onClick:b,className:p("border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors",c?"border-blue-500 bg-blue-50":m?"border-red-300 bg-red-50":"border-gray-300 hover:border-gray-400 bg-gray-50 hover:bg-gray-100"),role:"button",tabIndex:0,"aria-label":"Зона для загрузки изображения","aria-describedby":m?"avatar-error":void 0,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||b()},children:[r.jsx(F,{className:"w-8 h-8 mx-auto mb-2 text-gray-500"}),r.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Перетащите изображение сюда или нажмите для выбора"}),r.jsx("p",{className:"text-xs text-gray-500",children:"JPG, PNG, WebP (макс. 5MB)"})]}),m&&r.jsx("div",{id:"avatar-error",className:"text-sm text-red-600 bg-red-50 p-3 rounded-md",role:"alert",children:m}),r.jsxs("div",{className:"flex gap-2 justify-center",children:[r.jsxs(x,{type:"button",onClick:b,disabled:l,"aria-label":"Загрузить аватар",children:[r.jsx(F,{className:"w-4 h-4 mr-2"}),l?"Загрузка...":"Выбрать файл"]}),o&&r.jsxs(x,{type:"button",variant:"outline",onClick:()=>{d(null),h(null)},disabled:l,"aria-label":"Отменить выбор аватара",children:[r.jsx(_,{className:"w-4 h-4 mr-2"}),"Отменить"]})]}),r.jsx("input",{ref:f,type:"file",accept:"image/jpeg,image/png,image/webp",onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];a&&v(a)},className:"hidden","aria-label":"Выбор файла аватара",disabled:l}),r.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Загруженное изображение будет обрезано квадратом (1:1)"})]})})})},G={staleTime:3e5,gcTime:6e5,retry:2,refetchOnWindowFocus:!1,refetchOnMount:!0,refetchOnReconnect:!0},J=()=>{const e=L(),{toast:r}=f();return C({mutationFn:async()=>{j.debug("[useReactivateProfile] Reactivating profile...");const e=await D.reactivateProfile();if(!e.success)throw new Error(e.error||"Failed to reactivate profile");if(!e.data)throw new Error("No response data");return j.debug("[useReactivateProfile] Profile reactivated successfully"),e.data},onSuccess:a=>{j.debug("[useReactivateProfile] Invalidating profile cache"),e.invalidateQueries({queryKey:["studentProfile"]}),e.invalidateQueries({queryKey:["teacherProfile"]}),e.invalidateQueries({queryKey:["tutorProfile"]}),e.invalidateQueries({queryKey:["parentProfile"]}),e.setQueryData(["studentProfile"],a),e.setQueryData(["teacherProfile"],a),e.setQueryData(["tutorProfile"],a),e.setQueryData(["parentProfile"],a),r({title:"Success",description:"Profile reactivated successfully"})},onError:e=>{j.error("[useReactivateProfile] Error:",e),r({title:"Error",description:e.message||"Failed to reactivate profile",variant:"destructive"})}})},Y=()=>{const e=R(),{user:a,isLoading:s,isAuthenticated:t}=g();return s?r.jsx("div",{className:"flex items-center justify-center min-h-screen",children:r.jsx(v,{})}):t&&a?r.jsx(H,{userRole:a.role}):(e("/auth"),null)},H=({userRole:e})=>{R();const{user:a}=g();switch(e){case"student":return r.jsx(Z,{});case"teacher":return r.jsx(ee,{});case"tutor":return r.jsx(re,{});case"parent":return r.jsx(ae,{});default:return null}},Z=()=>{const e=R(),{user:a}=g(),{data:s,isLoading:t}=k({queryKey:["studentProfile"],queryFn:async()=>{j.debug("[useStudentProfile] Fetching student profile...");try{const e=await D.getMyStudentProfile();if(!e.success)throw new Error(e.error||"Failed to fetch student profile");if(!e.data)throw new Error("No student profile data returned");return j.debug("[useStudentProfile] Student profile loaded successfully"),e.data}catch(e){throw j.error("[useStudentProfile] Error:",e),e}},...G}),{mutate:i}=(()=>{const e=L(),{toast:r}=f();return C({mutationFn:async e=>{j.debug("[useUpdateStudentProfile] Updating student profile...");const r=await D.updateStudentProfile(e);if(!r.success)throw new Error(r.error||"Failed to update student profile");if(!r.data)throw new Error("No response data");return j.debug("[useUpdateStudentProfile] Student profile updated successfully"),r.data},onSuccess:a=>{e.invalidateQueries({queryKey:["studentProfile"]}),e.setQueryData(["studentProfile"],a),r({title:"Success",description:"Student profile updated successfully"})},onError:e=>{j.error("[useUpdateStudentProfile] Error:",e),r({title:"Error",description:e.message||"Failed to update student profile",variant:"destructive"})}})})(),{mutate:l}=(()=>{const e=L(),{toast:r}=f();return C({mutationFn:async e=>{if(j.debug("[useUploadStudentAvatar] Uploading avatar..."),!e.type.startsWith("image/"))throw new Error("Please upload an image file");if(e.size>5242880)throw new Error("File size must be less than 5MB");const r=await D.uploadStudentAvatar(e);if(!r.success)throw new Error(r.error||"Failed to upload avatar");if(!r.data)throw new Error("No response data");return j.debug("[useUploadStudentAvatar] Avatar uploaded successfully"),r.data},onSuccess:a=>{e.invalidateQueries({queryKey:["studentProfile"]}),e.setQueryData(["studentProfile"],a),r({title:"Success",description:"Avatar uploaded successfully"})},onError:e=>{j.error("[useUploadStudentAvatar] Error:",e),r({title:"Error",description:e.message||"Failed to upload avatar",variant:"destructive"})}})})(),{mutate:n,isPending:o}=J();return r.jsx(se,{profileData:s,isLoading:t,user:a,navigate:e,onSubmit:async e=>new Promise((r,a)=>{i(e,{onSuccess:()=>{r()},onError:e=>{a(e)}})}),onAvatarUpload:async e=>new Promise((r,a)=>{l(e,{onSuccess:()=>{r()},onError:e=>{a(e)}})}),FormComponent:I,onReactivate:()=>{n(void 0)},isReactivating:o})},ee=()=>{const e=R(),{user:a}=g(),{data:s,isLoading:t}=k({queryKey:["teacherProfile"],queryFn:async()=>{j.debug("[useTeacherProfile] Fetching teacher profile...");try{const e=await D.getMyTeacherProfile();if(!e.success)throw new Error(e.error||"Failed to fetch teacher profile");if(!e.data)throw new Error("No teacher profile data returned");return j.debug("[useTeacherProfile] Teacher profile loaded successfully"),e.data}catch(e){throw j.error("[useTeacherProfile] Error:",e),e}},...G}),{mutate:i}=(()=>{const e=L(),{toast:r}=f();return C({mutationFn:async e=>{j.debug("[useUpdateTeacherProfile] Updating teacher profile...");const r=await D.updateTeacherProfile(e);if(!r.success)throw new Error(r.error||"Failed to update teacher profile");if(!r.data)throw new Error("No response data");return j.debug("[useUpdateTeacherProfile] Teacher profile updated successfully"),r.data},onSuccess:a=>{e.invalidateQueries({queryKey:["teacherProfile"]}),e.setQueryData(["teacherProfile"],a),r({title:"Success",description:"Teacher profile updated successfully"})},onError:e=>{j.error("[useUpdateTeacherProfile] Error:",e),r({title:"Error",description:e.message||"Failed to update teacher profile",variant:"destructive"})}})})(),{mutate:l}=(()=>{const e=L(),{toast:r}=f();return C({mutationFn:async e=>{if(j.debug("[useUploadTeacherAvatar] Uploading avatar..."),!e.type.startsWith("image/"))throw new Error("Please upload an image file");if(e.size>5242880)throw new Error("File size must be less than 5MB");const r=await D.uploadTeacherAvatar(e);if(!r.success)throw new Error(r.error||"Failed to upload avatar");if(!r.data)throw new Error("No response data");return j.debug("[useUploadTeacherAvatar] Avatar uploaded successfully"),r.data},onSuccess:a=>{e.invalidateQueries({queryKey:["teacherProfile"]}),e.setQueryData(["teacherProfile"],a),r({title:"Success",description:"Avatar uploaded successfully"})},onError:e=>{j.error("[useUploadTeacherAvatar] Error:",e),r({title:"Error",description:e.message||"Failed to upload avatar",variant:"destructive"})}})})(),{mutate:n,isPending:o}=J();return r.jsx(se,{profileData:s,isLoading:t,user:a,navigate:e,onSubmit:async e=>new Promise((r,a)=>{i(e,{onSuccess:()=>{r()},onError:e=>{a(e)}})}),onAvatarUpload:async e=>new Promise((r,a)=>{l(e,{onSuccess:()=>{r()},onError:e=>{a(e)}})}),FormComponent:W,onReactivate:()=>{n(void 0)},isReactivating:o})},re=()=>{const e=R(),{user:a}=g(),{data:s,isLoading:t}=k({queryKey:["tutorProfile"],queryFn:async()=>{j.debug("[useTutorProfile] Fetching tutor profile...");try{const e=await D.getMyTutorProfile();if(!e.success)throw new Error(e.error||"Failed to fetch tutor profile");if(!e.data)throw new Error("No tutor profile data returned");return j.debug("[useTutorProfile] Tutor profile loaded successfully"),e.data}catch(e){throw j.error("[useTutorProfile] Error:",e),e}},...G}),{mutate:i}=(()=>{const e=L(),{toast:r}=f();return C({mutationFn:async e=>{j.debug("[useUpdateTutorProfile] Updating tutor profile...");const r=await D.updateTutorProfile(e);if(!r.success)throw new Error(r.error||"Failed to update tutor profile");if(!r.data)throw new Error("No response data");return j.debug("[useUpdateTutorProfile] Tutor profile updated successfully"),r.data},onSuccess:a=>{e.invalidateQueries({queryKey:["tutorProfile"]}),e.setQueryData(["tutorProfile"],a),r({title:"Success",description:"Tutor profile updated successfully"})},onError:e=>{j.error("[useUpdateTutorProfile] Error:",e),r({title:"Error",description:e.message||"Failed to update tutor profile",variant:"destructive"})}})})(),{mutate:l}=(()=>{const e=L(),{toast:r}=f();return C({mutationFn:async e=>{if(j.debug("[useUploadTutorAvatar] Uploading avatar..."),!e.type.startsWith("image/"))throw new Error("Please upload an image file");if(e.size>5242880)throw new Error("File size must be less than 5MB");const r=await D.uploadTutorAvatar(e);if(!r.success)throw new Error(r.error||"Failed to upload avatar");if(!r.data)throw new Error("No response data");return j.debug("[useUploadTutorAvatar] Avatar uploaded successfully"),r.data},onSuccess:a=>{e.invalidateQueries({queryKey:["tutorProfile"]}),e.setQueryData(["tutorProfile"],a),r({title:"Success",description:"Avatar uploaded successfully"})},onError:e=>{j.error("[useUploadTutorAvatar] Error:",e),r({title:"Error",description:e.message||"Failed to upload avatar",variant:"destructive"})}})})(),{mutate:n,isPending:o}=J();return r.jsx(se,{profileData:s,isLoading:t,user:a,navigate:e,onSubmit:async e=>new Promise((r,a)=>{i(e,{onSuccess:()=>{r()},onError:e=>{a(e)}})}),onAvatarUpload:async e=>new Promise((r,a)=>{l(e,{onSuccess:()=>{r()},onError:e=>{a(e)}})}),FormComponent:O,onReactivate:()=>{n(void 0)},isReactivating:o})},ae=()=>{const e=R(),{user:a}=g(),{data:s,isLoading:t}=k({queryKey:["parentProfile"],queryFn:async()=>{j.debug("[useParentProfile] Fetching parent profile...");try{const e=await D.getMyParentProfile();if(!e.success)throw new Error(e.error||"Failed to fetch parent profile");if(!e.data)throw new Error("No parent profile data returned");return j.debug("[useParentProfile] Parent profile loaded successfully"),e.data}catch(e){throw j.error("[useParentProfile] Error:",e),e}},...G}),{mutate:i}=(()=>{const e=L(),{toast:r}=f();return C({mutationFn:async e=>{j.debug("[useUpdateParentProfile] Updating parent profile...");const r=await D.updateParentProfile(e);if(!r.success)throw new Error(r.error||"Failed to update parent profile");if(!r.data)throw new Error("No response data");return j.debug("[useUpdateParentProfile] Parent profile updated successfully"),r.data},onSuccess:a=>{e.invalidateQueries({queryKey:["parentProfile"]}),e.setQueryData(["parentProfile"],a),r({title:"Success",description:"Parent profile updated successfully"})},onError:e=>{j.error("[useUpdateParentProfile] Error:",e),r({title:"Error",description:e.message||"Failed to update parent profile",variant:"destructive"})}})})(),{mutate:l}=(()=>{const e=L(),{toast:r}=f();return C({mutationFn:async e=>{if(j.debug("[useUploadParentAvatar] Uploading avatar..."),!e.type.startsWith("image/"))throw new Error("Please upload an image file");if(e.size>5242880)throw new Error("File size must be less than 5MB");const r=await D.uploadParentAvatar(e);if(!r.success)throw new Error(r.error||"Failed to upload avatar");if(!r.data)throw new Error("No response data");return j.debug("[useUploadParentAvatar] Avatar uploaded successfully"),r.data},onSuccess:a=>{e.invalidateQueries({queryKey:["parentProfile"]}),e.setQueryData(["parentProfile"],a),r({title:"Success",description:"Avatar uploaded successfully"})},onError:e=>{j.error("[useUploadParentAvatar] Error:",e),r({title:"Error",description:e.message||"Failed to upload avatar",variant:"destructive"})}})})(),{mutate:n,isPending:o}=J();return r.jsx(se,{profileData:s,isLoading:t,user:a,navigate:e,onSubmit:async e=>new Promise((r,a)=>{i(e,{onSuccess:()=>{r()},onError:e=>{a(e)}})}),onAvatarUpload:async e=>new Promise((r,a)=>{l(e,{onSuccess:()=>{r()},onError:e=>{a(e)}})}),FormComponent:V,onReactivate:()=>{n(void 0)},isReactivating:o})},se=({profileData:e,isLoading:a,user:s,navigate:t,onSubmit:i,onAvatarUpload:l,FormComponent:n,onReactivate:o,isReactivating:d})=>{var c,u,m,h;const p=(null==s?void 0:s.first_name)||"",f=(null==s?void 0:s.last_name)||"",j=(p[0]+f[0]).toUpperCase(),g=null==(c=null==e?void 0:e.user)?void 0:c.avatar_url,b=!1===(null==(u=null==e?void 0:e.user)?void 0:u.is_active),y=(e=>{if(!e)return null;const{user:r,profile:a}=e;return r?{first_name:r.first_name||"",last_name:r.last_name||"",phone:r.phone||"",telegram:r.telegram||"",...a}:null})(e);return r.jsx("div",{className:"min-h-screen bg-gray-50 py-8 px-4",children:r.jsxs("div",{className:"max-w-7xl mx-auto",children:[r.jsxs("div",{className:"mb-6 flex items-center gap-4",children:[r.jsxs(x,{type:"button",variant:"outline",size:"sm",onClick:()=>t(-1),"aria-label":"Вернуться на предыдущую страницу",children:[r.jsx(U,{className:"w-4 h-4 mr-2"}),"Назад"]}),r.jsxs("nav",{className:"flex items-center gap-2 text-sm text-gray-600",children:[r.jsx("span",{children:"Профиль"}),r.jsx("span",{children:"/"}),r.jsxs("span",{className:"text-gray-900 font-medium",children:[p," ",f]})]}),b&&o&&r.jsxs(x,{type:"button",variant:"outline",size:"sm",onClick:o,disabled:d,className:"ml-auto","aria-label":"Reactivate profile",children:[r.jsx(A,{className:"w-4 h-4 mr-2"}),d?"Reactivating...":"Reactivate"]})]}),r.jsxs("div",{className:"mb-6",children:[r.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Мой профиль"}),r.jsx("p",{className:"text-gray-600",children:"Здесь вы можете редактировать информацию о себе"}),b&&r.jsx("div",{className:"mt-2 p-3 bg-red-50 border border-red-200 rounded-md text-sm text-red-700",children:'Ваш профиль неактивен. Нажмите кнопку "Reactivate" в навигации, чтобы активировать профиль.'})]}),r.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[r.jsx("div",{className:"lg:col-span-1",children:r.jsx("div",{className:"sticky top-4",children:r.jsx($,{currentAvatar:g,onAvatarUpload:l,isLoading:a,fallbackInitials:j})})}),r.jsx("div",{className:"lg:col-span-2",children:a&&!y?r.jsx("div",{className:"flex items-center justify-center h-96",children:r.jsx(v,{})}):y?r.jsx(n,{initialData:y,onSubmit:i,isLoading:a,isTelegramLinked:!!(null==(m=null==e?void 0:e.user)?void 0:m.telegram_id),telegramUsername:null==(h=null==e?void 0:e.user)?void 0:h.telegram_username}):r.jsx("div",{className:"flex items-center justify-center h-96",children:r.jsx("p",{className:"text-gray-600",children:"Ошибка: не удалось загрузить профиль"})})})]}),r.jsx("div",{className:"lg:hidden mt-8 pt-8 border-t border-gray-200",children:r.jsx("p",{className:"text-xs text-gray-500 text-center",children:"На мобильном устройстве аватар и форма расположены вертикально"})})]})})};export{Y as ProfilePage,Y as default};
