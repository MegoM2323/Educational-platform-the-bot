import{r as e,j as s}from"./react-core-JVqWokWt.js";import{as as a,aV as l,B as r,C as t,L as n,A as i,t as d,v as o,r as c,J as m,K as h,Y as u,Z as x,_ as p,g,h as j,i as f,j as v,k as N,$ as b,aU as y,l as w}from"./main-fde3JC90.js";import{u as _,a as F,b as P}from"./react-query-DqnBFrGE.js";import{p as S,T as C}from"./profileAPI-mpI8UVp9.js";import{a2 as E,ay as L,bA as k,X as q}from"./vendor-DC2AZkDs.js";import{u as A}from"./react-router-WAeXREDX.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const T=()=>{var T,U,$;const z=A(),{user:D}=a(),{profile:G,isLoading:K,updateProfile:M,isUpdating:B,refetch:J}=(()=>{const e=_(),{data:s,isLoading:a,error:l,refetch:r}=F({queryKey:["studentProfile"],queryFn:async()=>{const e=await S.getMyStudentProfile();if(!e.success||!e.data)throw new Error(e.error||"Failed to fetch student profile");return e.data},staleTime:3e5,gcTime:6e5,refetchOnMount:!0,refetchOnWindowFocus:!1}),t=P({mutationFn:async e=>{const s=await S.updateStudentProfile(e);if(!s.success||!s.data)throw new Error(s.error||"Failed to update student profile");return s.data},onSuccess:()=>{e.invalidateQueries({queryKey:["studentProfile"]}),e.invalidateQueries({queryKey:["profile"]}),E.success("Профиль успешно обновлен")},onError:e=>{const s=e instanceof Error?e.message:"Ошибка при обновлении профиля";E.error(s)}});return{profile:s,isLoading:a,error:l,refetch:r,updateProfile:t.mutateAsync,isUpdating:t.isPending}})(),[O,V]=e.useState({first_name:"",last_name:"",phone:"",grade:"",goal:""}),[W,Q]=e.useState({first_name:"",last_name:"",phone:"",grade:"",goal:""}),[R,I]=e.useState(null),[Y,Z]=e.useState(null),[H,X]=e.useState(!1),[ee,se]=e.useState(0);e.useEffect(()=>{var e,s,a,l,r,t,n;if(G){const i={first_name:(null==(e=G.user)?void 0:e.first_name)||"",last_name:(null==(s=G.user)?void 0:s.last_name)||"",phone:(null==(a=G.user)?void 0:a.phone)||"",grade:(null==(l=G.profile)?void 0:l.grade)||"",goal:(null==(r=G.profile)?void 0:r.goal)||""};V(i),Q(i),se((null==(n=null==(t=G.profile)?void 0:t.goal)?void 0:n.length)||0)}},[G]),e.useEffect(()=>{const e=e=>{H&&(e.preventDefault(),e.returnValue="")};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[H]);const ae=(e,s)=>{V(a=>{const l={...a,[e]:s},r=Object.keys(l).some(e=>l[e]!==W[e]);return X(r),l}),"goal"===e&&se(s.length)};if(!D)return null;if(K)return s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsx(l,{})});const le=`${O.first_name[0]||""}${O.last_name[0]||""}`.toUpperCase(),re=Y||(null==(T=null==G?void 0:G.user)?void 0:T.avatar);return s.jsx("div",{className:"min-h-screen bg-[hsl(240,20%,99%)] py-8 px-4",children:s.jsxs("div",{className:"max-w-7xl mx-auto",children:[s.jsx("div",{className:"mb-6 flex items-center gap-4",children:s.jsxs(r,{type:"button",variant:"outline",size:"sm",onClick:()=>z(-1),"aria-label":"Вернуться на предыдущую страницу",children:[s.jsx(L,{className:"w-4 h-4 mr-2"}),"Назад"]})}),s.jsxs("div",{className:"mb-6",children:[s.jsx("h1",{className:"text-3xl font-bold text-[hsl(240,10%,15%)] mb-2",children:"Мой профиль"}),s.jsx("p",{className:"text-[hsl(240,5%,45%)]",children:"Здесь вы можете редактировать информацию о себе"})]}),s.jsx("form",{onSubmit:async e=>{e.preventDefault();const s=new FormData;O.first_name!==W.first_name&&s.append("first_name",O.first_name),O.last_name!==W.last_name&&s.append("last_name",O.last_name),O.phone!==W.phone&&s.append("phone",O.phone),O.grade!==W.grade&&(O.grade?s.append("grade",O.grade):s.append("grade","")),O.goal!==W.goal&&s.append("goal",O.goal),R&&s.append("avatar",R);try{await M(s),X(!1),I(null),Z(null)}catch(a){w.error("Failed to update profile:",a)}},children:s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[s.jsx("div",{className:"lg:col-span-1",children:s.jsx("div",{className:"sticky top-4",children:s.jsx(t,{className:"shadow-md",children:s.jsxs(n,{className:"p-6 flex flex-col items-center gap-4",children:[s.jsxs(i,{className:"w-48 h-48 shadow-lg border-4 border-[hsl(0,0%,96%)]",children:[s.jsx(d,{src:re,alt:`${O.first_name} ${O.last_name}`}),s.jsx(o,{className:"text-6xl font-bold text-white",style:{background:"linear-gradient(135deg, hsl(250, 70%, 60%), hsl(270, 80%, 70%))"},children:le})]}),s.jsxs("div",{className:"w-full",children:[s.jsxs("label",{htmlFor:"avatar-upload",className:c("flex flex-col items-center justify-center w-full p-6 border-2 border-dashed rounded-lg cursor-pointer transition-all","border-[hsl(240,10%,90%)] bg-[hsl(240,10%,98%)]","hover:border-[hsl(250,70%,60%)] hover:bg-[hsl(250,70%,98%)]"),children:[s.jsx(k,{className:"w-8 h-8 mb-2 text-[hsl(240,5%,45%)]"}),s.jsx("span",{className:"text-sm text-[hsl(240,5%,45%)]",children:R?R.name:"Загрузить фото"}),s.jsx("span",{className:"text-xs text-[hsl(240,5%,60%)] mt-1",children:"JPG, PNG, WebP (макс. 5MB)"}),s.jsx("input",{id:"avatar-upload",type:"file",className:"hidden",accept:"image/jpeg,image/png,image/webp",onChange:e=>{var s;const a=null==(s=e.target.files)?void 0:s[0];if(!a)return;if(a.size>5242880)return void E.error("Файл слишком большой. Максимум 5MB");if(!["image/jpeg","image/png","image/webp"].includes(a.type))return void E.error("Неподдерживаемый формат. Используйте JPG, PNG или WebP");I(a);const l=new FileReader;l.onloadend=()=>{Z(l.result)},l.readAsDataURL(a),X(!0)}})]}),Y&&s.jsxs(r,{type:"button",variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>{var e;I(null),Z(null),(null==(e=null==G?void 0:G.user)?void 0:e.avatar)&&X(!0)},children:[s.jsx(q,{className:"w-4 h-4 mr-2"}),"Отменить"]})]})]})})})}),s.jsx("div",{className:"lg:col-span-2",children:s.jsxs(t,{className:"shadow-md",children:[s.jsxs(m,{children:[s.jsx(h,{className:"text-2xl",children:"Профиль студента"}),s.jsx(u,{children:"Обновите вашу персональную информацию"})]}),s.jsxs(n,{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs(x,{htmlFor:"first_name",className:"text-sm font-medium",children:["Имя ",s.jsx("span",{className:"text-[hsl(0,84%,60%)]",children:"*"})]}),s.jsx(p,{id:"first_name",value:O.first_name,onChange:e=>ae("first_name",e.target.value),required:!0,className:"h-10"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(x,{htmlFor:"last_name",className:"text-sm font-medium",children:["Фамилия ",s.jsx("span",{className:"text-[hsl(0,84%,60%)]",children:"*"})]}),s.jsx(p,{id:"last_name",value:O.last_name,onChange:e=>ae("last_name",e.target.value),required:!0,className:"h-10"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"email",className:"text-sm font-medium",children:"Email"}),s.jsx(p,{id:"email",type:"email",value:(null==(U=null==G?void 0:G.user)?void 0:U.email)||"",disabled:!0,className:"h-10 bg-[hsl(240,10%,96%)] opacity-50 cursor-not-allowed"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)]",children:"Email нельзя изменить"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"phone",className:"text-sm font-medium",children:"Телефон"}),s.jsx(p,{id:"phone",type:"tel",value:O.phone,onChange:e=>ae("phone",e.target.value),placeholder:"+7 (999) 123-45-67",className:"h-10"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(x,{htmlFor:"grade",className:"text-sm font-medium",children:["Класс ",s.jsx("span",{className:"text-[hsl(0,84%,60%)]",children:"*"})]}),s.jsxs(g,{value:O.grade,onValueChange:e=>ae("grade",e),children:[s.jsx(j,{className:"h-10",children:s.jsx(f,{placeholder:"Выберите класс"})}),s.jsx(v,{children:Array.from({length:12},(e,s)=>s+1).map(e=>s.jsxs(N,{value:String(e),children:[e," класс"]},e))})]}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)]",children:"Введите номер класса (1-12)"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"goal",className:"text-sm font-medium",children:"Цель обучения"}),s.jsx(b,{id:"goal",value:O.goal,onChange:e=>ae("goal",e.target.value),placeholder:"Опишите свои цели в обучении...",className:"min-h-24 resize-none",maxLength:500,rows:4}),s.jsxs("p",{className:"text-xs text-[hsl(240,5%,55%)] text-right",children:["Осталось: ",500-ee," символов"]})]}),s.jsxs("div",{className:"space-y-2 pt-4 border-t",children:[s.jsx(x,{className:"text-sm font-medium",children:"Привязка Telegram"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)] mb-2",children:"Привяжите аккаунт Telegram для получения уведомлений"}),s.jsx(C,{isLinked:!!(null==($=null==G?void 0:G.user)?void 0:$.telegram_id),onStatusChange:J})]})]}),s.jsxs(y,{className:"flex items-center justify-between border-t pt-6",children:[s.jsx("div",{className:"flex items-center gap-2",children:H&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-2 h-2 bg-[hsl(30,95%,60%)] rounded-full animate-pulse"}),s.jsx("span",{className:"text-sm text-[hsl(240,5%,45%)]",children:"Несохраненные изменения"})]})}),s.jsx(r,{type:"submit",disabled:B,className:"bg-[hsl(250,70%,60%)] hover:bg-[hsl(250,70%,55%)] text-white shadow-sm hover:shadow-md transition-all",children:B?s.jsxs(s.Fragment,{children:[s.jsx(l,{className:"w-4 h-4 mr-2"}),"Сохранение..."]}):"Сохранить"})]})]})})]})})]})})};export{T as StudentProfilePage,T as default};
