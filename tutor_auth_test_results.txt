============================= test session starts ==============================
platform linux -- Python 3.13.7, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python
cachedir: .pytest_cache
django: version: 4.2.7
rootdir: /home/mego/Python Projects/THE_BOT_platform
plugins: django-4.7.0, xdist-3.8.0, Faker-20.1.0, mock-3.12.0, anyio-3.7.1, cov-4.1.0, asyncio-0.21.1, env-1.2.0
asyncio: mode=Mode.STRICT
collecting ... collected 14 items

backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_login_success FAILED [  7%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_login_invalid_credentials PASSED [ 14%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_login_nonexistent_user PASSED [ 21%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_login_inactive_teacher FAILED [ 28%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_login_with_email FAILED [ 35%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_token_generation PASSED [ 42%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_token_contains_user_info PASSED [ 50%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_token_validation_on_protected_endpoint FAILED [ 57%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_access_without_token PASSED [ 64%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_access_with_invalid_token PASSED [ 71%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_refresh_token_generation PASSED [ 78%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_token_refresh_endpoint FAILED [ 85%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_student_cannot_login_as_teacher FAILED [ 92%]
backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_multiple_login_attempts FAILED [100%]

=================================== FAILURES ===================================
_________________ TestTeacherAuthentication.test_login_success _________________
backend/tests/teacher_dashboard/test_authentication.py:25: in test_login_success
    assert "token" in response.data or "access" in response.data
E   assert ('token' in {'data': {'message': 'Вход выполнен успешно', 'token': '623606d60d87a058dd4f34781f7f2e64504c60bf', 'user': {'id': 479, 'email': 'teacher1@test.com', 'first_name': 'John', 'last_name': 'Teacher', 'role': 'teacher', 'role_display': 'Преподаватель', 'phone': '', 'avatar': None, 'is_verified': False, 'is_active': True, 'is_staff': False, 'date_joined': '2026-01-06T22:15:42.586540Z', 'full_name': 'John Teacher'}}, 'success': True} or 'access' in {'data': {'message': 'Вход выполнен успешно', 'token': '623606d60d87a058dd4f34781f7f2e64504c60bf', 'user': {'id': 479, 'email': 'teacher1@test.com', 'first_name': 'John', 'last_name': 'Teacher', 'role': 'teacher', 'role_display': 'Преподаватель', 'phone': '', 'avatar': None, 'is_verified': False, 'is_active': True, 'is_staff': False, 'date_joined': '2026-01-06T22:15:42.586540Z', 'full_name': 'John Teacher'}}, 'success': True})
E    +  where {'data': {'message': 'Вход выполнен успешно', 'token': '623606d60d87a058dd4f34781f7f2e64504c60bf', 'user': {'id': 479, 'email': 'teacher1@test.com', 'first_name': 'John', 'last_name': 'Teacher', 'role': 'teacher', 'role_display': 'Преподаватель', 'phone': '', 'avatar': None, 'is_verified': False, 'is_active': True, 'is_staff': False, 'date_joined': '2026-01-06T22:15:42.586540Z', 'full_name': 'John Teacher'}}, 'success': True} = <Response status_code=200, "application/json">.data
E    +  and   {'data': {'message': 'Вход выполнен успешно', 'token': '623606d60d87a058dd4f34781f7f2e64504c60bf', 'user': {'id': 479, 'email': 'teacher1@test.com', 'first_name': 'John', 'last_name': 'Teacher', 'role': 'teacher', 'role_display': 'Преподаватель', 'phone': '', 'avatar': None, 'is_verified': False, 'is_active': True, 'is_staff': False, 'date_joined': '2026-01-06T22:15:42.586540Z', 'full_name': 'John Teacher'}}, 'success': True} = <Response status_code=200, "application/json">.data
---------------------------- Captured stderr setup -----------------------------
[INFO] 2026-01-06 22:15:42 audit log_user_creation_or_update:379 - action=create_user user_id=479 email=teacher1@test.com role=teacher first_name=John last_name=Teacher is_active=True is_staff=False
[INFO] 2026-01-06 22:15:42 audit log_teacher_profile_creation:743 - action=create_profile type=TeacherProfile user_id=479 email=teacher1@test.com subject=Mathematics experience_years=5 bio=Experienced math teacher
[DEBUG] 2026-01-06 22:15:42 accounts.signals log_teacher_profile_creation:744 - [Signal] TeacherProfile created for user 479
----------------------------- Captured stderr call -----------------------------
[INFO] 2026-01-06 22:15:42 accounts.views login_view:94 - [login] Attempt - identifier: teacher1, ip: 127.0.0.1, timestamp: 2026-01-06 22:15:42
[INFO] 2026-01-06 22:15:43 accounts.views login_view:146 - [login] SUCCESS - email: teacher1@test.com, role: teacher, ip: 127.0.0.1, timestamp: 2026-01-06 22:15:42
____________ TestTeacherAuthentication.test_login_inactive_teacher _____________
backend/tests/teacher_dashboard/test_authentication.py:70: in test_login_inactive_teacher
    assert response.status_code in [
E   assert 403 in [401, 400]
E    +  where 403 = <Response status_code=403, "application/json">.status_code
---------------------------- Captured stderr setup -----------------------------
[INFO] 2026-01-06 22:15:43 audit log_user_creation_or_update:379 - action=create_user user_id=481 email=inactive@test.com role=teacher first_name=Inactive last_name=Teacher is_active=False is_staff=False
[INFO] 2026-01-06 22:15:43 audit log_teacher_profile_creation:743 - action=create_profile type=TeacherProfile user_id=481 email=inactive@test.com subject=Physics experience_years=1 bio=N/A
[DEBUG] 2026-01-06 22:15:43 accounts.signals log_teacher_profile_creation:744 - [Signal] TeacherProfile created for user 481
----------------------------- Captured stderr call -----------------------------
[INFO] 2026-01-06 22:15:43 accounts.views login_view:94 - [login] Attempt - identifier: inactive_teacher, ip: 127.0.0.1, timestamp: 2026-01-06 22:15:43
[WARNING] 2026-01-06 22:15:43 accounts.views login_view:196 - [login] FAILED - identifier: inactive@test.com, reason: user_inactive, ip: 127.0.0.1, timestamp: 2026-01-06 22:15:43
_______________ TestTeacherAuthentication.test_login_with_email ________________
backend/tests/teacher_dashboard/test_authentication.py:86: in test_login_with_email
    assert response.status_code == status.HTTP_200_OK
E   assert 401 == 200
E    +  where 401 = <Response status_code=401, "application/json">.status_code
E    +  and   200 = status.HTTP_200_OK
---------------------------- Captured stderr setup -----------------------------
[INFO] 2026-01-06 22:15:43 audit log_user_creation_or_update:379 - action=create_user user_id=482 email=teacher1@test.com role=teacher first_name=John last_name=Teacher is_active=True is_staff=False
[INFO] 2026-01-06 22:15:43 audit log_teacher_profile_creation:743 - action=create_profile type=TeacherProfile user_id=482 email=teacher1@test.com subject=Mathematics experience_years=5 bio=Experienced math teacher
[DEBUG] 2026-01-06 22:15:43 accounts.signals log_teacher_profile_creation:744 - [Signal] TeacherProfile created for user 482
----------------------------- Captured stderr call -----------------------------
[INFO] 2026-01-06 22:15:43 accounts.views login_view:94 - [login] Attempt - identifier: teacher1@test.com, ip: 127.0.0.1, timestamp: 2026-01-06 22:15:43
[WARNING] 2026-01-06 22:15:43 accounts.views login_view:120 - [login] FAILED - identifier: teacher1@test.com, reason: user_not_found, ip: 127.0.0.1, timestamp: 2026-01-06 22:15:43
____ TestTeacherAuthentication.test_token_validation_on_protected_endpoint _____
backend/tests/teacher_dashboard/test_authentication.py:117: in test_token_validation_on_protected_endpoint
    assert response.status_code != status.HTTP_401_UNAUTHORIZED
E   assert 401 != 401
E    +  where 401 = <Response status_code=401, "application/json">.status_code
E    +  and   401 = status.HTTP_401_UNAUTHORIZED
---------------------------- Captured stderr setup -----------------------------
[INFO] 2026-01-06 22:15:44 audit log_user_creation_or_update:379 - action=create_user user_id=485 email=teacher1@test.com role=teacher first_name=John last_name=Teacher is_active=True is_staff=False
[INFO] 2026-01-06 22:15:44 audit log_teacher_profile_creation:743 - action=create_profile type=TeacherProfile user_id=485 email=teacher1@test.com subject=Mathematics experience_years=5 bio=Experienced math teacher
[DEBUG] 2026-01-06 22:15:44 accounts.signals log_teacher_profile_creation:744 - [Signal] TeacherProfile created for user 485
____________ TestTeacherAuthentication.test_token_refresh_endpoint _____________
backend/tests/teacher_dashboard/test_authentication.py:150: in test_token_refresh_endpoint
    assert response.status_code == status.HTTP_200_OK
E   assert 401 == 200
E    +  where 401 = <Response status_code=401, "application/json">.status_code
E    +  and   200 = status.HTTP_200_OK
---------------------------- Captured stderr setup -----------------------------
[INFO] 2026-01-06 22:15:44 audit log_user_creation_or_update:379 - action=create_user user_id=487 email=teacher1@test.com role=teacher first_name=John last_name=Teacher is_active=True is_staff=False
[INFO] 2026-01-06 22:15:44 audit log_teacher_profile_creation:743 - action=create_profile type=TeacherProfile user_id=487 email=teacher1@test.com subject=Mathematics experience_years=5 bio=Experienced math teacher
[DEBUG] 2026-01-06 22:15:44 accounts.signals log_teacher_profile_creation:744 - [Signal] TeacherProfile created for user 487
________ TestTeacherAuthentication.test_student_cannot_login_as_teacher ________
backend/tests/teacher_dashboard/test_authentication.py:165: in test_student_cannot_login_as_teacher
    assert response.status_code == status.HTTP_200_OK
E   assert 403 == 200
E    +  where 403 = <HttpResponseForbidden status_code=403, "text/html; charset=utf-8">.status_code
E    +  and   200 = status.HTTP_200_OK
---------------------------- Captured stderr setup -----------------------------
[INFO] 2026-01-06 22:15:44 audit log_user_creation_or_update:379 - action=create_user user_id=488 email=student1@test.com role=student first_name=Alice last_name=Student is_active=True is_staff=False
[INFO] 2026-01-06 22:15:44 materials.cache_utils invalidate_student_enrollments:143 - Invalidated student enrollments cache for student_id=488
[INFO] 2026-01-06 22:15:44 materials.cache_utils invalidate_student_teachers:157 - Invalidated student teachers cache for student_id=488
[INFO] 2026-01-06 22:15:44 audit log_student_profile_creation:450 - action=create_profile type=StudentProfile user_id=488 email=student1@test.com grade=10 goal=Pass the exam tutor_id=None parent_id=None
[DEBUG] 2026-01-06 22:15:44 accounts.signals log_student_profile_creation:451 - [Signal] StudentProfile created for user 488
------------------------------ Captured log setup ------------------------------
INFO     materials.cache_utils:cache_utils.py:143 Invalidated student enrollments cache for student_id=488
INFO     materials.cache_utils:cache_utils.py:157 Invalidated student teachers cache for student_id=488
____________ TestTeacherAuthentication.test_multiple_login_attempts ____________
backend/tests/teacher_dashboard/test_authentication.py:178: in test_multiple_login_attempts
    assert response.status_code == status.HTTP_200_OK
E   assert 403 == 200
E    +  where 403 = <HttpResponseForbidden status_code=403, "text/html; charset=utf-8">.status_code
E    +  and   200 = status.HTTP_200_OK
---------------------------- Captured stderr setup -----------------------------
[INFO] 2026-01-06 22:15:44 audit log_user_creation_or_update:379 - action=create_user user_id=489 email=teacher1@test.com role=teacher first_name=John last_name=Teacher is_active=True is_staff=False
[INFO] 2026-01-06 22:15:44 audit log_teacher_profile_creation:743 - action=create_profile type=TeacherProfile user_id=489 email=teacher1@test.com subject=Mathematics experience_years=5 bio=Experienced math teacher
[DEBUG] 2026-01-06 22:15:44 accounts.signals log_teacher_profile_creation:744 - [Signal] TeacherProfile created for user 489
=============================== warnings summary ===============================
../../.local/lib/python3.13/site-packages/pytz/tzinfo.py:27
  /home/mego/.local/lib/python3.13/site-packages/pytz/tzinfo.py:27: DeprecationWarning: datetime.datetime.utcfromtimestamp() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.fromtimestamp(timestamp, datetime.UTC).
    _epoch = datetime.utcfromtimestamp(0)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_login_success
FAILED backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_login_inactive_teacher
FAILED backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_login_with_email
FAILED backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_token_validation_on_protected_endpoint
FAILED backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_token_refresh_endpoint
FAILED backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_student_cannot_login_as_teacher
FAILED backend/tests/teacher_dashboard/test_authentication.py::TestTeacherAuthentication::test_multiple_login_attempts
==================== 7 failed, 7 passed, 1 warning in 2.03s ====================
