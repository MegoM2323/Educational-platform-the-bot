# Environment Configuration Summary

**Date**: December 27, 2025
**Platform**: THE_BOT Educational Platform v1.0.0
**Generated by**: DevOps Engineer (T_VERIFY_007)

---

## Overview

This document provides a comprehensive summary of environment configuration across all deployment stages (development, staging, production) and validates that all configurations are properly implemented.

---

## 1. Configuration Management Overview

### Configuration Sources

1. **Primary**: `.env` file (environment variables)
2. **Secondary**: `backend/config/settings.py` (Django settings)
3. **Tertiary**: `docker-compose.yml` (Docker environment)
4. **Quaternary**: Application defaults (fallback values)

### Configuration Priority

```
Environment Variables (highest priority)
↓
.env file
↓
Docker Compose environment
↓
Django settings defaults
↓
Application hardcoded defaults (lowest priority)
```

---

## 2. Development Environment Configuration

### Current Development Setup

**File**: `.env` (committed in development)

```
ENVIRONMENT=development
DEBUG=True
SECRET_KEY=!xgb17dv+gjj28a5wl0kbtah#ixs1yflrf@k+v39=h_-=b!qm#
ADMIN_SECRET_URL=super-secret-admin-url-12345/
DATABASE_URL=
FRONTEND_URL=http://localhost:3000
YOOKASSA_SHOP_ID=test
YOOKASSA_SECRET_KEY=test
OPENROUTER_API_KEY=test
PACHCA_FORUM_API_TOKEN=test
TELEGRAM_BOT_TOKEN=test
REDIS_URL=redis://localhost:6380/0
EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
ALLOWED_HOSTS=localhost,127.0.0.1
```

### Development Database Configuration

**Type**: SQLite
**Location**: `backend/db.sqlite3`
**Isolation**: No Supabase access

**Implementation** (settings.py lines 338-342):
```python
def _build_development_db_config() -> dict:
    database_url = os.getenv('DATABASE_URL', '')

    # Protection: Prevent Supabase in development
    if 'supabase' in database_url.lower():
        raise ImproperlyConfigured(
            "Cannot use production database in development!"
        )

    return {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
        'ATOMIC_REQUESTS': True,
    }
```

### Development Cache Configuration

**Type**: Local memory (LocMemCache)
**No Redis required**: Development can run without Redis

**Configuration** (settings.py lines 702-715):
```python
if USE_REDIS_CACHE:
    # Production: Use Redis
else:
    # Development: Use local memory
    CACHES = {
        'default': {
            'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
            'LOCATION': 'unique-snowflake',
        },
        ...
    }
```

### Development Logging

**Console Output**: All logs to stdout
**No File Logging**: Keep development clean

**Log Handlers**:
- Console output for immediate feedback
- Color-coded by level (DEBUG, INFO, WARNING, ERROR)

---

## 3. Test Environment Configuration

### Test Setup (pytest)

**Environment Variable**: `ENVIRONMENT=test`
**Database**: SQLite in-memory (`:memory:`)
**Cache**: Local memory (LocMemCache)
**Isolation**: Complete separation from other environments

### Test Database Configuration

**Type**: SQLite in-memory
**Persistence**: None (fresh DB per test session)
**Speed**: Fast (all in RAM)

**Implementation** (settings.py lines 385-392):
```python
def _build_test_db_config() -> dict:
    """SQLite in-memory for testing - complete isolation"""

    database_url = os.getenv('DATABASE_URL', '')

    # Safety check: Prevent Supabase in tests
    if 'supabase' in database_url.lower():
        raise ImproperlyConfigured(
            "CRITICAL ERROR: Tests cannot use production database!"
        )

    return {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': ':memory:',
        'ATOMIC_REQUESTS': True,
    }
```

### Test Fixture Configuration

**conftest.py** (verified):
```python
# ENVIRONMENT=test (set via pytest-env)
# Uses in-memory SQLite
# No external service dependencies
```

### Test Coverage

```bash
# Run all tests
ENVIRONMENT=test pytest tests/ -v

# Run specific test file
ENVIRONMENT=test pytest tests/test_auth.py -v

# Run with coverage
ENVIRONMENT=test pytest tests/ --cov=backend
```

---

## 4. Production Environment Configuration

### Production Configuration Strategy

**Philosophy**: Strict validation, fail-fast, no shortcuts

**Key Principles**:
1. All critical values must be explicitly configured
2. No hardcoded secrets
3. Environment-based separation
4. Validation at startup
5. Security-first defaults

### Production Required Variables

#### Core Configuration

```
ENVIRONMENT=production
DEBUG=False
SECRET_KEY=<50+ character random string>
ADMIN_SECRET_URL=<custom-secret-url-not-admin>
```

**Validation**:
- SECRET_KEY length >= 50 characters (enforced at startup)
- SECRET_KEY cannot use default "django-insecure-" prefix
- DEBUG must be False (enforced)
- ADMIN_SECRET_URL must be customized

#### Database Configuration

```
# Option 1: PostgreSQL URI
DATABASE_URL=postgresql://user:password@host:5432/database

# Option 2: Individual parameters
SUPABASE_DB_NAME=database_name
SUPABASE_DB_USER=user
SUPABASE_DB_PASSWORD=password
SUPABASE_DB_HOST=host.supabase.co
SUPABASE_DB_PORT=6543
```

**Connection Settings**:
```
DB_CONNECT_TIMEOUT=60              # 60 seconds
DB_SSLMODE=require                 # Enforce SSL
CONN_MAX_AGE=0                      # Disable pooling (avoid stale connections)
```

**Validation** (settings.py lines 229-297):
- One of: DATABASE_URL or all SUPABASE_DB_* variables required
- Database engine must be PostgreSQL
- SSL mode: require
- Connection timeout: >= 10 seconds

#### Redis Configuration

```
REDIS_URL=redis://:password@host:6379/0
REDIS_PASSWORD=<strong-password>
USE_REDIS_CACHE=True
```

**Production Default**: Use Redis automatically when DEBUG=False

**Configuration** (settings.py line 673):
```python
USE_REDIS_CACHE = os.getenv('USE_REDIS_CACHE', str(not DEBUG)).lower() == 'true'
```

#### Web Server Configuration

```
FRONTEND_URL=https://thebot.example.com
ALLOWED_HOSTS=thebot.example.com,www.thebot.example.com
API_URL=https://api.thebot.example.com
WS_URL=wss://api.thebot.example.com/ws
```

**Validation** (settings.py lines 977-991):
- ALLOWED_HOSTS must not be empty in production
- Cannot contain "localhost" or "127.0.0.1"
- Must match actual domain(s)

#### CORS Configuration

```
CORS_ALLOWED_ORIGINS=https://thebot.example.com,https://www.thebot.example.com
```

**Validation**:
- Cannot be empty in production
- Cannot contain localhost
- Only whitelisted origins allowed

#### External Services

```
# Payments
YOOKASSA_SHOP_ID=<actual-shop-id>
YOOKASSA_SECRET_KEY=<actual-secret>
YOOKASSA_WEBHOOK_URL=https://api.thebot.example.com/yookassa-webhook/

# AI/ML
OPENROUTER_API_KEY=<actual-key>

# Forum
PACHCA_FORUM_API_TOKEN=<actual-token>

# Notifications
TELEGRAM_BOT_TOKEN=<actual-token>
TELEGRAM_CHAT_ID=<actual-chat-id>
TELEGRAM_PUBLIC_CHAT_ID=<actual-chat-id>
TELEGRAM_LOG_CHAT_ID=<actual-chat-id>
```

#### Email Configuration

```
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=<app-specific-password>
EMAIL_USE_TLS=True
```

#### Error Tracking

```
SENTRY_DSN=https://key@sentry.io/project-id
```

#### Logging

```
LOG_LEVEL=INFO
```

---

## 5. Security Configuration

### Authentication & Authorization

#### Default Permission Classes

```python
'DEFAULT_PERMISSION_CLASSES': [
    'rest_framework.permissions.IsAuthenticated',
]
```

**Effect**: All endpoints require authentication by default

#### Available Authentication Methods

1. **Token Authentication**
   - Header: `Authorization: Token <token>`
   - Persistence: Permanent (no expiration)
   - Use case: API clients, mobile apps

2. **Session Authentication**
   - Mechanism: Secure cookies
   - Duration: 24 hours (configurable)
   - Use case: Browser-based clients

3. **Rate Limiting**
   - Login attempts: 5/minute per IP
   - API calls: 500/hour (authenticated users)
   - Burst: 10/second (global)

### Password Security

#### Password Validators

```python
AUTH_PASSWORD_VALIDATORS = [
    'UserAttributeSimilarityValidator',
    'MinimumLengthValidator',
    'CommonPasswordValidator',
    'NumericPasswordValidator',
]
```

**Minimum Requirements**:
- Length: 8+ characters (Django default)
- Not in common password list
- Not similar to username/email

### Cookie Security

#### Session Cookies

```python
SESSION_COOKIE_SECURE = True          # HTTPS only (production)
SESSION_COOKIE_HTTPONLY = True        # JavaScript cannot access
SESSION_COOKIE_SAMESITE = 'Lax'       # CSRF protection
SESSION_COOKIE_AGE = 86400            # 24 hours
SESSION_SAVE_EVERY_REQUEST = True     # Update on each request
```

#### CSRF Cookies

```python
CSRF_COOKIE_SECURE = True             # HTTPS only (production)
CSRF_COOKIE_HTTPONLY = False          # JavaScript can read (needed for form)
CSRF_COOKIE_SAMESITE = 'Lax'          # YooKassa payment compatibility
```

### Security Headers (Production Only)

**When DEBUG=False**:

```python
# HSTS (HTTP Strict Transport Security)
SECURE_HSTS_SECONDS = 31536000        # 1 year
SECURE_HSTS_INCLUDE_SUBDOMAINS = True # All subdomains
SECURE_HSTS_PRELOAD = True            # Include in preload list

# SSL/HTTPS
SECURE_SSL_REDIRECT = True             # Redirect HTTP to HTTPS

# Content Security
SECURE_BROWSER_XSS_FILTER = True      # Enable XSS filter
SECURE_CONTENT_TYPE_NOSNIFF = True    # Prevent MIME sniffing
X_FRAME_OPTIONS = 'DENY'              # Deny iframe embedding
```

### Proxy Configuration

**For reverse proxy with SSL termination**:

```python
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
USE_X_FORWARDED_HOST = True
USE_X_FORWARDED_PORT = True
```

**Required headers from proxy**:
- `X-Forwarded-Proto: https`
- `X-Forwarded-For: client-ip`
- `X-Forwarded-Host: thebot.example.com`

---

## 6. Logging & Monitoring Configuration

### Logging Setup

**File**: `backend/config/settings.py` (lines 1021-1117)

**Handlers**:
1. Console (immediate feedback)
2. Audit log (rotating file, 10MB, 10 backups)
3. Admin log (rotating file, 10MB, 10 backups)
4. Celery log (rotating file, 10MB, 10 backups)

**Log Levels**:
- DEBUG: Development (verbose output)
- INFO: Audit events, task completion
- WARNING: Database backends (slow queries)
- ERROR: Application errors
- CRITICAL: System failures

### Monitoring Endpoints

```
GET /api/system/health/live/         # Liveness (container health)
GET /api/system/readiness/           # Readiness (dependencies ready)
GET /api/system/health/              # Overall health
GET /api/system/metrics/             # System metrics
GET /api/system/analytics/           # Analytics dashboard
GET /api/system/health-extended/     # Comprehensive health
```

### Health Check Implementation

**Liveness Check**: Basic "is service running" check
**Readiness Check**: Database, Redis, and service dependencies
**Full Health**: Component status, performance metrics

---

## 7. Caching Configuration

### Cache Backends

#### Production (Redis)

```python
USE_REDIS_CACHE = True  # Set automatically when DEBUG=False

CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': os.getenv('REDIS_URL'),
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    },
    'dashboard': {          # Separate index for dashboard
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': '<redis_url>/2',
    },
    'chat': {              # Separate index for chat
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': '<redis_url>/3',
    }
}
```

#### Development (Local Memory)

```python
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
        'LOCATION': 'unique-snowflake',
    },
    ...
}
```

### Cache TTLs

```python
CACHE_TIMEOUTS = {
    'default': 300,                # 5 minutes
    'materials_list': 1800,        # 30 minutes
    'material_detail': 3600,       # 1 hour
    'reports': 300,                # 5 minutes
    'analytics': 1800,             # 30 minutes
    'notifications': 60,           # 1 minute
    'user_profile': 600,           # 10 minutes
    'dashboard': 300,              # 5 minutes
}
```

---

## 8. Rate Limiting Configuration

### Global Throttle

```python
'DEFAULT_THROTTLE_CLASSES': [
    'config.throttling.BurstThrottle',  # 10 req/sec globally
]
```

### Tiered Rate Limits

```python
'DEFAULT_THROTTLE_RATES': {
    'anon': '50/h',                    # Anonymous users
    'user': '500/h',                   # Authenticated users
    'student': '1000/h',               # Student accounts
    'admin': '10000/h',                # Admin accounts
    'burst': '10/s',                   # Burst protection
}
```

### Endpoint-Specific Limits

```python
'ENDPOINTS': {
    'login': '5/m',                    # 5 login attempts/minute/IP
    'upload': '10/h',                  # 10 uploads/hour/user
    'search': '30/m',                  # 30 searches/minute/user
    'chat_message': '60/m',            # 60 messages/minute/user
    'chat_room': '5/h',                # 5 room creations/hour/user
}
```

---

## 9. CORS Configuration

### Dynamic CORS Setup

**File**: `backend/core/environment.py`

```python
def get_cors_allowed_origins(self):
    if self.is_production:
        # Only frontend domain
        return [self.frontend_url]
    elif self.is_staging:
        # Staging frontend
        return ['https://staging.thebot.example.com']
    else:
        # Development: Allow local origins
        return ['http://localhost:3000', 'http://localhost:8000']
```

### Production CORS Validation

**Enforced when DEBUG=False**:
- CORS_ALLOWED_ORIGINS must be configured
- Cannot contain localhost
- Cannot be empty
- Only whitelisted origins allowed

### CORS Headers

```python
CORS_ALLOW_CREDENTIALS = True
CORS_ALLOW_HEADERS = [
    'accept', 'accept-encoding', 'authorization',
    'content-type', 'dnt', 'origin', 'user-agent',
    'x-csrftoken', 'x-requested-with',
]
CORS_ALLOW_METHODS = ['DELETE', 'GET', 'OPTIONS', 'PATCH', 'POST', 'PUT']
```

---

## 10. Configuration Validation Summary

### Startup Validation

**When Django starts**, the following checks run:

#### 1. Debug Mode Check

```python
if environment == 'test':
    DEBUG = True  # Always True for tests
else:
    DEBUG = os.getenv("DEBUG", "True").lower() == "true"
```

#### 2. Production Security Check

```python
if not DEBUG:
    # SECRET_KEY validation
    if len(SECRET_KEY) < 50:
        raise ImproperlyConfigured("SECRET_KEY too short")

    # ALLOWED_HOSTS validation
    if not ALLOWED_HOSTS:
        raise ImproperlyConfigured("ALLOWED_HOSTS must be set")

    # Default key check
    if SECRET_KEY.startswith('django-insecure-'):
        raise ImproperlyConfigured("Using default key in production")
```

#### 3. Database Protection Check

```python
# If testing
if 'pytest' in sys.modules:
    if current_environment != 'test':
        raise ImproperlyConfigured("Tests must use ENVIRONMENT=test")

    if 'postgresql' in db_engine:
        raise ImproperlyConfigured("Tests cannot use PostgreSQL")

# If developing
if current_environment == 'development' and 'supabase' in db_host:
    import warnings
    warnings.warn("WARNING: Development using production database!")
```

#### 4. CORS Validation Check

```python
if not DEBUG:
    # CORS must be configured
    if not CORS_ALLOWED_ORIGINS:
        raise ImproperlyConfigured("CORS_ALLOWED_ORIGINS required")

    # No localhost in production
    for origin in CORS_ALLOWED_ORIGINS:
        if 'localhost' in origin:
            raise ImproperlyConfigured("localhost not allowed in production")
```

---

## 11. Configuration Comparison Table

| Setting | Development | Test | Production |
|---------|-------------|------|-----------|
| ENVIRONMENT | development | test | production |
| DEBUG | True | True | False |
| Database | SQLite | SQLite (:memory:) | PostgreSQL |
| Cache | LocMemCache | LocMemCache | Redis |
| HTTPS | False | False | True |
| Secret Key | Dev key | Dev key | Strong (50+ chars) |
| ALLOWED_HOSTS | localhost | testserver | Domain(s) |
| CORS | Development origins | testserver | Production domain |
| Logging | Console | Console | File + Console |
| Session Cookie Secure | False | False | True |
| CSRF Cookie Secure | False | False | True |

---

## 12. Common Configuration Errors & Solutions

### Error: "SECRET_KEY must be at least 50 characters"

**Cause**: Using default or short key in production
**Solution**:
```bash
python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'
```

### Error: "ALLOWED_HOSTS must be set in production"

**Cause**: ALLOWED_HOSTS empty or not configured
**Solution**:
```
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com
```

### Error: "Cannot use Supabase in development"

**Cause**: DATABASE_URL with Supabase while ENVIRONMENT=development
**Solution**: Either remove DATABASE_URL or set ENVIRONMENT=production

### Error: "CORS_ALLOWED_ORIGINS contains localhost in production"

**Cause**: localhost in CORS origins for production
**Solution**: Set CORS_ALLOWED_ORIGINS to actual domain:
```
CORS_ALLOWED_ORIGINS=https://yourdomain.com
```

---

## 13. Environment-Specific Tips

### Development

- Use SQLite (no setup required)
- Redis is optional (fallback to local memory)
- DEBUG=True (verbose error pages)
- Console logging sufficient
- Use test credentials

### Staging

- Use production-like setup
- PostgreSQL + Redis (same as production)
- DEBUG=False (like production)
- Staging domain for ALLOWED_HOSTS/CORS
- Test with production data (anonymized)

### Production

- PostgreSQL with backups
- Redis for caching
- DEBUG=False (enforced)
- Strong SECRET_KEY
- HTTPS/SSL enforced
- Production domain configuration
- Monitoring and alerting
- Regular backups

---

## 14. Quick Reference

### Set Up Development

```bash
# Clone repository
git clone <repo>
cd THE_BOT_platform

# Create virtual environment
python -m venv venv
source venv/bin/activate

# Install dependencies
pip install -r backend/requirements.txt
cd frontend && npm install

# Configure development .env
cp .env.example .env

# Run migrations
python manage.py migrate

# Create superuser
python manage.py createsuperuser

# Start servers
python manage.py runserver &
cd frontend && npm run dev
```

### Deploy to Production

1. **Prepare environment**:
   - Generate SECRET_KEY
   - Configure DATABASE_URL
   - Set up Redis URL
   - Set ALLOWED_HOSTS
   - Set CORS_ALLOWED_ORIGINS

2. **Build images**:
   ```bash
   docker-compose build
   ```

3. **Deploy**:
   ```bash
   docker-compose up -d
   ```

4. **Initialize**:
   ```bash
   docker-compose exec backend python manage.py migrate
   docker-compose exec backend python manage.py createsuperuser
   docker-compose exec backend python manage.py collectstatic --noinput
   ```

5. **Verify**:
   ```bash
   curl https://api.yourdomain.com/api/system/health/live/
   ```

---

## Appendix: Environment Variable Reference

| Variable | Development | Staging | Production | Required |
|----------|-------------|---------|-----------|----------|
| ENVIRONMENT | development | staging | production | Yes |
| DEBUG | True | False | False | Yes |
| SECRET_KEY | dev | strong | strong | Yes |
| DATABASE_URL | empty | postgres | postgres | Production only |
| REDIS_URL | localhost | redis.host | redis.host | Production only |
| ALLOWED_HOSTS | localhost | staging.dom | prod.dom | Production only |
| CORS_ALLOWED_ORIGINS | local | staging | prod domain | Yes |
| FRONTEND_URL | localhost:3000 | staging | prod domain | Yes |
| API_URL | localhost:8000 | staging | prod domain | Yes |
| WS_URL | localhost:8000 | staging | prod domain | Yes |

---

**Document Status**: COMPLETE
**Last Updated**: December 27, 2025
**Version**: 1.0
**For Questions**: Refer to DEPLOYMENT.md and CLAUDE.md
