# Unit-тесты для приложения core

Комплексные unit-тесты для критических компонентов приложения `core` в THE_BOT_platform.

## Структура тестов

### test_celery_tasks.py (21 тест)
Тесты для Celery задач системного мониторинга и обработки платежей:

- **TestCreateDailyBackup** (4 теста)
  - Успешное создание бэкапа
  - Неудачное создание бэкапа
  - Обработка исключений
  - Логирование событий

- **TestCleanupOldBackups** (3 теста)
  - Успешная очистка старых бэкапов
  - Отсутствие бэкапов для удаления
  - Обработка исключений

- **TestCheckSystemHealthTask** (4 теста)
  - Проверка здоровья системы в норме
  - Проверка с предупреждениями
  - Проверка с критическими предупреждениями
  - Обработка исключений

- **TestVerifyDataIntegrityTask** (3 теста)
  - Проверка целостности данных в норме
  - Обнаружение проблем целостности
  - Обработка исключений

- **TestLogSystemMetrics** (3 теста)
  - Успешное логирование метрик
  - Логирование с отсутствующими данными
  - Обработка исключений

- **TestProcessSubscriptionPayments** (3 теста)
  - Успешная обработка платежей
  - Обработка исключений
  - Логирование событий

- **TestCeleryTaskRetry** (1 тест)
  - Обработка временных ошибок

### test_media_views.py (32 теста)
Тесты для аутентифицированной раздачи медиа-файлов:

- **TestCheckFileAccessPermission** (5 тестов)
  - Доступ администратора ко всем файлам
  - Доступ staff пользователей
  - Доступ к аватарам
  - Запрет неизвестных типов файлов
  - Делегирование проверки доступа

- **TestCheckMaterialFileAccess** (8 тестов)
  - Доступ автора материала
  - Доступ назначенного пользователя
  - Доступ к публичным материалам
  - Доступ зачисленного студента
  - Доступ тьютора к материалам студентов
  - Доступ родителя к материалам ребенка
  - Материал не найден
  - Запрет доступа к приватным материалам

- **TestCheckStudyPlanFileAccess** (7 тестов)
  - Доступ преподавателя
  - Доступ студента
  - Доступ тьютора
  - Доступ родителя
  - Файл плана не найден
  - Запрет доступа к планам других студентов

- **TestServeMediaFile** (6 тестов)
  - Успешная раздача файла
  - Отказ в доступе
  - Файл не найден
  - Защита от path traversal
  - Удаление префикса /media/
  - Правильный Content-Type

- **TestServeMediaFileDownload** (4 теста)
  - Успешное скачивание
  - Отказ в скачивании
  - Файл не найден
  - Защита от path traversal

- **TestMediaViewsPerformance** (1 тест)
  - Оптимизация запросов с select_related

### test_monitoring.py (44 теста)
Тесты для системы мониторинга состояния платформы:

- **TestSystemMonitorInit** (1 тест)
  - Правильная инициализация монитора

- **TestGetSystemMetrics** (3 теста)
  - Возврат всех компонентов метрик
  - Кэширование метрик
  - Обработка исключений

- **TestGetCpuMetrics** (4 теста)
  - CPU в здоровом состоянии
  - CPU в состоянии предупреждения
  - CPU в критическом состоянии
  - Обработка исключений

- **TestGetMemoryMetrics** (3 теста)
  - Память в здоровом состоянии
  - Память в состоянии предупреждения
  - Память в критическом состоянии

- **TestGetDiskMetrics** (3 теста)
  - Диск в здоровом состоянии
  - Диск в состоянии предупреждения
  - Диск в критическом состоянии

- **TestGetDatabaseMetrics** (2 теста)
  - БД в здоровом состоянии
  - БД с медленным ответом

- **TestGetCacheMetrics** (2 теста)
  - Кэш в здоровом состоянии
  - Кэш не работает

- **TestGetExternalServicesMetrics** (1 тест)
  - Получение метрик всех сервисов

- **TestCheckTelegramService** (3 теста)
  - Telegram в здоровом состоянии
  - Telegram не настроен
  - Ошибка при проверке Telegram

- **TestCheckYooKassaService** (2 теста)
  - YooKassa в здоровом состоянии
  - YooKassa не настроен

- **TestCheckSupabaseService** (2 теста)
  - Supabase в здоровом состоянии
  - 401 от Supabase считается нормальным

- **TestGetHealthStatus** (3 теста)
  - Здоровый общий статус
  - Общий статус с предупреждениями
  - Критический общий статус

- **TestGetPerformanceAlerts** (5 тестов)
  - Критическое предупреждение CPU
  - Предупреждение о памяти
  - Критическое предупреждение диска
  - Предупреждение о медленной БД
  - Множественные предупреждения

- **TestLogSystemEvent** (6 тестов)
  - Логирование информационного события
  - Логирование предупреждения
  - Логирование ошибки
  - Логирование критического события
  - Логирование с метаданными
  - Логирование с user_id

- **TestCheckSystemHealth** (3 теста)
  - Успешная проверка здоровья
  - Проверка с предупреждениями
  - Обработка исключений

- **TestSystemMonitorGlobal** (1 тест)
  - Глобальный экземпляр монитора

## Запуск тестов

### Все unit-тесты core
```bash
pytest tests/unit/core/ -v -m unit
```

### Только Celery тесты
```bash
pytest tests/unit/core/test_celery_tasks.py -v -m "unit and celery"
```

### Только тесты media views
```bash
pytest tests/unit/core/test_media_views.py -v -m unit
```

### Только тесты monitoring
```bash
pytest tests/unit/core/test_monitoring.py -v -m unit
```

### С покрытием кода
```bash
pytest tests/unit/core/ -v -m unit --cov=core --cov-report=html
```

## Маркеры

- `@pytest.mark.unit` - unit-тесты
- `@pytest.mark.celery` - тесты Celery задач
- `@pytest.mark.django_db` - тесты требующие БД

## Fixtures

Используемые fixtures из `backend/tests/conftest.py`:
- `admin_user` - Администратор/суперпользователь
- `student_user` - Студент с профилем
- `teacher_user` - Преподаватель с профилем
- `parent_user` - Родитель с профилем
- `tutor_user` - Тьютор
- `other_student_user` - Другой студент (для контроля доступа)
- `subject` - Предмет
- `enrollment` - Зачисление студента
- `sample_material` - Материал с файлом
- `sample_study_plan` - План занятий
- `sample_study_plan_file` - Файл плана занятий
- `sample_enrollment` - Зачисление

И специальные fixtures из `backend/tests/fixtures/celery.py`:
- `celery_eager_mode` (autouse) - Синхронное выполнение задач
- `mock_celery_task` - Mock для Celery задач
- `run_task_sync` - Синхронный запуск задач

## Покрытие

Целевое покрытие: **>85%**

### Покрываемые модули
- `core/tasks.py` - Celery задачи
- `core/media_views.py` - Аутентифицированная раздача файлов
- `core/monitoring.py` - Система мониторинга
- `core/backup_utils.py` - Утилиты резервного копирования

## Технические детали

### Mock'и для Celery
Все Celery задачи тестируются с `CELERY_TASK_ALWAYS_EAGER = True`, что заставляет задачи выполняться синхронно без реального Celery worker.

### Mock'и для внешних API
- YooKassa API мокируется через `mock_yookassa_payment_create`
- Telegram Bot API мокируется через `patch('requests.post')`
- File system операции мокируются через `tmpdir` fixture

### Безопасность
Тесты проверяют критические аспекты безопасности:
- Path traversal protection
- Аутентификацию и авторизацию
- Проверку прав доступа к файлам
- Валидацию входных данных

## Известные ограничения

1. Некоторые тесты могут падать в зависимости от реального состояния системы (CPU, память, кэш)
2. Тесты Celery работают в eager mode, не проверяя реальную асинхронность
3. Тесты используют DummyCache вместо Redis для упрощения
4. Модель StudyPlan может иметь другие поля в продакшене - нужна адаптация fixture

## Статистика

**Всего тестов: 97**
- test_celery_tasks.py: 21 тест
- test_media_views.py: 32 теста
- test_monitoring.py: 44 теста

**Успешно работающих: ~70-76 тестов** (в зависимости от окружения)

## Дополнительные улучшения

Для достижения 100% прохождения тестов рекомендуется:
1. Настроить правильную модель StudyPlan в fixtures
2. Использовать pytest-mock для более надежных mock'ов
3. Добавить интеграционные тесты с реальным Redis
4. Добавить тесты для edge cases
5. Улучшить покрытие обработки ошибок
