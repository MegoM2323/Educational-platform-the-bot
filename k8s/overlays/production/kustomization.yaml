---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: thebot-production
  namespace: thebot

# Base resources
bases:
- ../../base

# Namespace: use default from base
namespace: thebot

# Override common labels
commonLabels:
  app: thebot
  environment: production
  managed-by: kustomize

# Replicas for production (high availability)
replicas:
- name: backend
  count: 3
- name: frontend
  count: 3
- name: celery-worker
  count: 2
- name: celery-beat
  count: 1

# Images for production (use specific release tags, not latest)
images:
- name: thebot/backend
  newName: gcr.io/thebot-prod/backend
  newTag: v1.0.0
- name: thebot/frontend
  newName: gcr.io/thebot-prod/frontend
  newTag: v1.0.0

# Use patches instead of generators for environment-specific overrides
# Secrets should be managed via external secret management (sealed-secrets, vault, etc.)

# Production resource limits (high)
patches:
- target:
    kind: Deployment
    name: backend
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 750m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 768Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 2000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 2Gi

- target:
    kind: Deployment
    name: frontend
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 250m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 256Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 500m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 512Mi

# Production storage class (SSD recommended)
patches:
- target:
    kind: PersistentVolumeClaim
    name: postgres-pvc
  patch: |-
    - op: replace
      path: /spec/storageClassName
      value: fast-ssd

- target:
    kind: PersistentVolumeClaim
    name: backend-media-pvc
  patch: |-
    - op: replace
      path: /spec/storageClassName
      value: fast-ssd

# Production HPA settings (aggressive scaling)
patches:
- target:
    kind: HorizontalPodAutoscaler
    name: backend-hpa
  patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 3
    - op: replace
      path: /spec/maxReplicas
      value: 15

- target:
    kind: HorizontalPodAutoscaler
    name: frontend-hpa
  patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 3
    - op: replace
      path: /spec/maxReplicas
      value: 10

- target:
    kind: HorizontalPodAutoscaler
    name: celery-worker-hpa
  patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 2
    - op: replace
      path: /spec/maxReplicas
      value: 10

# Enable pod affinity in production
# (already enabled in base, keeping for reference)

# Enable pod disruption budgets in production
# (already configured in base)
