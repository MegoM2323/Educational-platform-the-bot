import{r as e,j as s}from"./react-core-JVqWokWt.js";import{u as t,C as a,J as l,K as i,Y as r,L as n,Z as d,_ as c,$ as o,g as m,h as x,i as u,j as h,k as p,B as j,a9 as v,f,l as g,S as b,a as N,e as y}from"./main-fde3JC90.js";import{T as w}from"./TeacherSidebar-Bwv8PTW2.js";import{a_ as _,a$ as S,bB as C,$ as F,bC as k,au as $,b2 as E,an as z,aA as B,bA as M,aW as q,aY as L,aX as V,b3 as A,b4 as D,b6 as I,aq as T,be as K}from"./vendor-DC2AZkDs.js";import{u as W}from"./react-router-WAeXREDX.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./react-query-DqnBFrGE.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const Y=q({title:L().min(1,"Название материала обязательно").max(200,"Название не может быть длиннее 200 символов").trim(),description:L().max(5e3,"Описание не может быть длиннее 5000 символов").optional().default(""),content:L().min(1,"Содержание материала обязательно").max(5e4,"Содержание не может быть длиннее 50000 символов"),subject:L().min(1,"Выберите предмет"),type:D(["lesson","homework","test","document"],{errorMap:()=>({message:"Выберите тип материала"})}),status:D(["draft","active"],{errorMap:()=>({message:"Выберите статус"})}).optional().default("draft"),difficulty_level:A().min(1,"Выберите уровень сложности").max(5,"Уровень сложности должен быть от 1 до 5").optional().default(1),is_public:V().optional().default(!1),tags:L().max(500,"Теги не могут быть длиннее 500 символов").optional().default(""),video_url:L().url("Некорректный URL видео").optional().or(I(""))}),J=({onSubmit:b,onCancel:N,initialData:y,isEditing:w=!1,isLoading:q=!1})=>{var L;const{toast:V}=t(),[A,D]=e.useState([]),[I,T]=e.useState(!0),[K,W]=e.useState(null),[J,O]=e.useState(null),[P,R]=e.useState(null),[U,X]=e.useState(!1),Z=10485760,G=["pdf","doc","docx","ppt","pptx","txt","jpg","jpeg","png"],{register:H,control:Q,handleSubmit:ee,watch:se,formState:{errors:te,isSubmitting:ae},reset:le,setError:ie}=_({resolver:S(Y),mode:"onChange",defaultValues:{title:(null==y?void 0:y.title)||"",description:(null==y?void 0:y.description)||"",content:(null==y?void 0:y.content)||"",subject:(null==(L=null==y?void 0:y.subject)?void 0:L.toString())||"",type:(null==y?void 0:y.type)||"lesson",status:(null==y?void 0:y.status)||"draft",difficulty_level:(null==y?void 0:y.difficulty_level)||1,is_public:(null==y?void 0:y.is_public)||!1,tags:(null==y?void 0:y.tags)||"",video_url:(null==y?void 0:y.video_url)||""}}),re=se("title"),ne=se("description"),de=se("content");e.useEffect(()=>{(async()=>{var e;try{T(!0);const s=await f.request("/materials/subjects/"),t=Array.isArray(s.data)?s.data:(null==(e=s.data)?void 0:e.results)||[];D(t)}catch(s){g.error("Error loading subjects:",s),V({title:"Ошибка",description:"Не удалось загрузить список предметов",variant:"destructive"})}finally{T(!1)}})()},[V]);return s.jsxs(a,{className:"w-full",children:[s.jsxs(l,{children:[s.jsxs(i,{className:"flex items-center gap-2",children:[s.jsx(C,{className:"w-5 h-5"}),w?"Редактирование материала":"Создание материала"]}),s.jsxs(r,{children:["Заполните форму для ",w?"редактирования":"создания"," учебного материала"]})]}),s.jsx(n,{children:s.jsxs("form",{onSubmit:ee(async e=>{try{await b(e,K)}catch(s){if(g.error("Form submission error:",s),s instanceof Error){const e=s.message;e.includes("title")?ie("title",{type:"server",message:"Название: "+e}):e.includes("description")?ie("description",{type:"server",message:"Описание: "+e}):e.includes("content")?ie("content",{type:"server",message:"Содержание: "+e}):e.includes("file")?O("Файл: "+e):V({title:"Ошибка",description:e,variant:"destructive"})}}}),className:"space-y-6",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(d,{htmlFor:"title",className:"text-sm font-medium",children:"Название материала *"}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:[re.length,"/200"]})]}),s.jsx(c,{id:"title",placeholder:"Например: Введение в алгебру",...H("title"),className:te.title?"border-destructive":"",disabled:ae||q}),te.title&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[s.jsx(F,{className:"w-4 h-4"}),te.title.message]}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"Введите четкое название материала (максимум 200 символов)"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(d,{htmlFor:"description",className:"text-sm font-medium",children:"Краткое описание"}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:[ne.length,"/5000"]})]}),s.jsx(o,{id:"description",placeholder:"Опишите содержание и цели материала",...H("description"),rows:3,className:te.description?"border-destructive resize-none":"resize-none",disabled:ae||q}),te.description&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[s.jsx(F,{className:"w-4 h-4"}),te.description.message]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(d,{htmlFor:"content",className:"text-sm font-medium",children:"Содержание материала *"}),s.jsx("button",{type:"button",onClick:()=>X(!U),className:"flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors",children:U?s.jsxs(s.Fragment,{children:[s.jsx(k,{className:"w-4 h-4"}),"Скрыть"]}):s.jsxs(s.Fragment,{children:[s.jsx($,{className:"w-4 h-4"}),"Показать"]})})]}),s.jsxs("div",{className:"relative",children:[s.jsx(o,{id:"content",placeholder:"Введите полное содержание материала",...H("content"),rows:U?8:4,className:"resize-none transition-all "+(te.content?"border-destructive":""),disabled:ae||q}),s.jsxs("div",{className:"absolute top-2 right-2 text-xs text-muted-foreground bg-background px-2 py-1 rounded",children:[de.length,"/50000"]})]}),te.content&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[s.jsx(F,{className:"w-4 h-4"}),te.content.message]}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"Полный текст материала (максимум 50000 символов)"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(d,{htmlFor:"subject",className:"text-sm font-medium",children:"Предмет *"}),s.jsx(E,{name:"subject",control:Q,render:({field:e})=>s.jsxs(m,{value:e.value,onValueChange:e.onChange,disabled:I||ae||q,children:[s.jsx(x,{className:te.subject?"border-destructive":"",children:s.jsx(u,{placeholder:"Выберите предмет"})}),s.jsx(h,{children:A.map(e=>s.jsx(p,{value:e.id.toString(),children:e.name},e.id))})]})}),te.subject&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[s.jsx(F,{className:"w-4 h-4"}),te.subject.message]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(d,{htmlFor:"type",className:"text-sm font-medium",children:"Тип материала *"}),s.jsx(E,{name:"type",control:Q,render:({field:e})=>s.jsxs(m,{value:e.value,onValueChange:e.onChange,children:[s.jsx(x,{className:te.type?"border-destructive":"",children:s.jsx(u,{placeholder:"Выберите тип"})}),s.jsxs(h,{children:[s.jsx(p,{value:"lesson",children:"Урок"}),s.jsx(p,{value:"homework",children:"Домашнее задание"}),s.jsx(p,{value:"test",children:"Тест"}),s.jsx(p,{value:"document",children:"Документ"})]})]})}),te.type&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[s.jsx(F,{className:"w-4 h-4"}),te.type.message]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(d,{htmlFor:"status",className:"text-sm font-medium",children:"Статус"}),s.jsx(E,{name:"status",control:Q,render:({field:e})=>s.jsxs(m,{value:e.value,onValueChange:e.onChange,children:[s.jsx(x,{children:s.jsx(u,{placeholder:"Выберите статус"})}),s.jsxs(h,{children:[s.jsx(p,{value:"draft",children:"Черновик"}),s.jsx(p,{value:"active",children:"Активно"})]})]})})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(d,{htmlFor:"difficulty_level",className:"text-sm font-medium",children:"Уровень сложности"}),s.jsx(E,{name:"difficulty_level",control:Q,render:({field:e})=>{var t;return s.jsxs(m,{value:null==(t=e.value)?void 0:t.toString(),onValueChange:s=>e.onChange(parseInt(s)),children:[s.jsx(x,{children:s.jsx(u,{placeholder:"Выберите уровень"})}),s.jsx(h,{children:[1,2,3,4,5].map(e=>s.jsxs(p,{value:e.toString(),children:["Уровень ",e]},e))})]})}})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(d,{htmlFor:"tags",className:"text-sm font-medium",children:"Теги (опционально)"}),s.jsx(c,{id:"tags",placeholder:"Например: математика, алгебра, уравнения",...H("tags"),disabled:ae||q}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"Разделяйте теги запятыми для лучшего поиска"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(d,{htmlFor:"video_url",className:"text-sm font-medium",children:"Ссылка на видео (опционально)"}),s.jsx(c,{id:"video_url",type:"url",placeholder:"https://youtube.com/watch?v=...",...H("video_url"),className:te.video_url?"border-destructive":"",disabled:ae||q}),te.video_url&&s.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive",children:[s.jsx(F,{className:"w-4 h-4"}),te.video_url.message]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(d,{htmlFor:"material-file",className:"text-sm font-medium",children:"Прикрепить файл материала (опционально)"}),s.jsxs("div",{className:"flex flex-col gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(c,{id:"material-file",type:"file",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&((e=>{var s;if(e.size>Z)return O(`Размер файла не должен превышать 10MB. Ваш файл: ${(e.size/1048576).toFixed(2)}MB`),!1;const t=null==(s=e.name.split(".").pop())?void 0:s.toLowerCase();return t&&G.includes(t)?(O(null),!0):(O(`Неподдерживаемый тип файла "${t}". Разрешенные форматы: ${G.join(", ")}`),!1)})(t)?(W(t),R(`${t.name} (${(t.size/1024).toFixed(2)}KB)`)):e.target.value="")},accept:G.map(e=>`.${e}`).join(","),className:"flex-1",disabled:ae||q}),K&&s.jsx(j,{type:"button",variant:"outline",size:"sm",onClick:()=>{W(null),R(null),O(null);const e=document.getElementById("material-file");e&&(e.value="")},disabled:ae||q,children:s.jsx(z,{className:"w-4 h-4"})})]}),P&&s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-success/10 border border-success/30 rounded-md",children:[s.jsx(B,{className:"w-5 h-5 text-success"}),s.jsx("span",{className:"text-sm text-foreground",children:P})]}),J&&s.jsxs("div",{className:"flex items-start gap-2 p-3 bg-destructive/10 border border-destructive/30 rounded-md",children:[s.jsx(F,{className:"w-5 h-5 text-destructive flex-shrink-0 mt-0.5"}),s.jsx("span",{className:"text-sm text-destructive",children:J})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["Максимальный размер: ",10,"MB. Поддерживаемые форматы: ",G.join(", ")]})]})]}),s.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted rounded-md",children:[s.jsx(E,{name:"is_public",control:Q,render:({field:e})=>s.jsx(v,{id:"is_public",checked:e.value,onCheckedChange:e.onChange,disabled:ae||q})}),s.jsxs(d,{htmlFor:"is_public",className:"text-sm font-normal cursor-pointer flex-1",children:["Публичный материал",s.jsx("span",{className:"block text-xs text-muted-foreground font-normal mt-1",children:"Если отмечено, материал будет доступен всем студентам"})]})]}),s.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[N&&s.jsx(j,{type:"button",variant:"outline",onClick:N,disabled:ae||q,children:"Отмена"}),s.jsx(j,{type:"submit",disabled:ae||q,className:"gap-2",children:ae||q?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),w?"Сохранение...":"Создание..."]}):s.jsxs(s.Fragment,{children:[s.jsx(M,{className:"w-4 h-4"}),w?"Сохранить":"Создать материал"]})})]})]})})]})},O=()=>{const l=W(),{toast:i}=t(),[r,n]=e.useState([]),[d,c]=e.useState(!1),[o,m]=e.useState(!1),[x,u]=e.useState([]);e.useEffect(()=>{(async()=>{var e;try{c(!0);const s=await f.request("/materials/teacher/all-students/");if(g.debug("[CreateMaterial] Students response:",s),null==(e=s.data)?void 0:e.students){const e=s.data.students.filter(e=>"student"===e.role);n(e.map(e=>({id:e.id,first_name:e.first_name||"",last_name:e.last_name||"",email:e.email||"",name:e.name||e.username||`${e.first_name} ${e.last_name}`.trim()||`ID: ${e.id}`})))}}catch(s){g.error("Error fetching students:",s),i({title:"Ошибка загрузки данных",description:"Не удалось загрузить список студентов",variant:"destructive"})}finally{c(!1)}})()},[i]);return s.jsx(b,{children:s.jsxs("div",{className:"flex min-h-screen w-full",children:[s.jsx(w,{}),s.jsxs(N,{children:[s.jsxs("header",{className:"flex h-16 shrink-0 items-center gap-2 border-b px-4",children:[s.jsx(y,{}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(T,{className:"h-5 w-5"}),s.jsx("h1",{className:"text-lg font-semibold",children:"Создание материала"})]})]}),s.jsxs("main",{className:"flex flex-1 flex-col gap-4 p-4 max-w-4xl mx-auto w-full",children:[s.jsx("div",{className:"flex items-center gap-4",children:s.jsxs(j,{type:"button",variant:"outline",size:"sm",onClick:()=>l("/dashboard/teacher/materials"),children:[s.jsx(K,{className:"h-4 w-4 mr-2"}),"Назад к материалам"]})}),s.jsx(J,{onSubmit:async(e,s)=>{try{m(!0);const t=new FormData;t.append("title",e.title),t.append("description",e.description),t.append("content",e.content),t.append("subject",e.subject),t.append("type",e.type),t.append("status",e.status||"draft"),t.append("is_public",(e.is_public||!1).toString()),t.append("tags",e.tags),t.append("difficulty_level",(e.difficulty_level||1).toString()),t.append("video_url",e.video_url),x.forEach(e=>{t.append("assigned_to",e.toString())}),s&&t.append("file",s);const a=await f.request("/materials/",{method:"POST",body:t});if(!a.data)throw new Error(a.error||"Ошибка создания материала");i({title:"Материал создан",description:"Материал успешно создан и сохранен"}),l("/dashboard/teacher/materials")}catch(t){throw g.error("Error creating material:",t),t}finally{m(!1)}},onCancel:()=>l("/dashboard/teacher/materials"),isLoading:o}),r.length>0&&s.jsxs(a,{className:"p-6",children:[s.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Назначить студентам"}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex gap-2",children:[s.jsx(j,{type:"button",variant:"outline",size:"sm",onClick:()=>u(r.map(e=>e.id)),children:"Выбрать всех"}),s.jsx(j,{type:"button",variant:"outline",size:"sm",onClick:()=>u([]),children:"Снять всех"})]}),s.jsx("div",{className:"flex flex-wrap gap-2 p-3 border rounded-md max-h-40 overflow-y-auto",children:r.map(e=>s.jsx(Badge,{variant:x.includes(e.id)?"default":"outline",className:"cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>{return s=e.id,void u(e=>e.includes(s)?e.filter(e=>e!==s):[...e,s]);var s},children:e.name},e.id))}),x.length>0&&s.jsxs("p",{className:"text-xs text-muted-foreground",children:["Выбрано: ",x.length," из ",r.length," студентов"]})]})]})]})]})]})})};export{O as default};
