# Nginx Cache Configuration
# Edge caching and microcache setup for THE_BOT Platform
#
# This configuration provides:
# - Microcache for dynamic content (1-5 seconds)
# - Cache key generation with user awareness
# - Edge caching headers (Cache-Control, ETag, Last-Modified)
# - Cache bypass rules (authenticated, POST requests, etc.)
# - Logging and monitoring

# Cache zones definition
proxy_cache_path /var/cache/nginx/microcache levels=1:2 keys_zone=microcache:10m max_size=1g inactive=1h use_temp_path=off;
proxy_cache_path /var/cache/nginx/edge_cache levels=1:2 keys_zone=edge_cache:50m max_size=10g inactive=24h use_temp_path=off;

# Cache key template
# By default, Nginx uses $scheme$proxy_host$request_uri as cache key
# We're overriding to include user awareness
map $http_authorization $cache_bypass_auth {
    default 0;
    ~*^Bearer 1;       # Bypass for token-based auth
}

map $request_method $cache_bypass_method {
    default 0;
    GET 1;              # Cache GET only
    HEAD 1;             # Cache HEAD only
}

# ============================================================================
# API Caching Configuration
# ============================================================================

# Microcache configuration for API responses
# TTL: 1-5 seconds (configurable per endpoint)
server {
    listen 8000;
    server_name localhost;

    # Upstream to Django backend
    upstream backend {
        server django:8000;
        keepalive 32;
    }

    # Cache bypass conditions
    # Don't cache if:
    # - Authorization header is present (authenticated requests)
    # - Custom cache-control header is no-cache
    # - Request method is not GET/HEAD
    set $skip_cache 0;

    if ($http_authorization) {
        set $skip_cache 1;
    }

    if ($http_cache_control = "no-cache") {
        set $skip_cache 1;
    }

    if ($request_method !~ ^(GET|HEAD)$) {
        set $skip_cache 1;
    }

    # ========================================================================
    # Popular API Endpoints - Microcache (1-5 seconds)
    # ========================================================================

    # Materials endpoint - 5 second microcache
    location ~ ^/api/materials/?$ {
        proxy_pass http://backend;

        # Microcache configuration
        proxy_cache microcache;
        proxy_cache_key "$scheme$proxy_host$request_uri";
        proxy_cache_valid 200 5s;      # Cache successful responses for 5 seconds
        proxy_cache_valid 404 1s;      # Cache 404s for 1 second
        proxy_cache_bypass $skip_cache;
        proxy_no_cache $skip_cache;

        # Cache metadata
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Cache-Key $scheme$proxy_host$request_uri;

        # Upstream settings
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Subjects endpoint - 5 second microcache
    location ~ ^/api/subjects/?$ {
        proxy_pass http://backend;

        proxy_cache microcache;
        proxy_cache_key "$scheme$proxy_host$request_uri";
        proxy_cache_valid 200 5s;
        proxy_cache_valid 404 1s;
        proxy_cache_bypass $skip_cache;
        proxy_no_cache $skip_cache;

        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Dashboard endpoint - 2 second microcache
    location ~ ^/api/dashboard/?$ {
        proxy_pass http://backend;

        proxy_cache microcache;
        proxy_cache_key "$scheme$proxy_host$request_uri$http_authorization";
        proxy_cache_valid 200 2s;      # Shorter TTL for dashboard
        proxy_cache_valid 404 1s;
        proxy_cache_bypass $skip_cache;
        proxy_no_cache $skip_cache;

        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Reports/Analytics endpoint - 5 second microcache
    location ~ ^/api/reports/?$ {
        proxy_pass http://backend;

        proxy_cache microcache;
        proxy_cache_key "$scheme$proxy_host$request_uri$http_authorization";
        proxy_cache_valid 200 5s;
        proxy_cache_valid 404 1s;
        proxy_cache_bypass $skip_cache;
        proxy_no_cache $skip_cache;

        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Default proxy (non-cached)
    location / {
        proxy_pass http://backend;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable caching for general requests
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }

    # Cache purge endpoint (admin only)
    location ~ ^/api/cache/purge/?$ {
        proxy_pass http://backend;

        # Don't cache purge requests
        proxy_cache_bypass 1;
        proxy_no_cache 1;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# ============================================================================
# Frontend Caching Configuration (Static Assets)
# ============================================================================

server {
    listen 8080;
    server_name localhost;

    # Static file serving with long TTL
    location ~* \.(js|css|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        root /app/frontend/dist;

        # Long expiration for versioned assets
        expires 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header ETag "";

        # Gzip compression
        gzip on;
        gzip_types text/css application/javascript;
    }

    # HTML files - short cache
    location ~* \.html?$ {
        root /app/frontend/dist;

        # Short expiration for HTML (revalidate frequently)
        expires 1h;
        add_header Cache-Control "public, max-age=3600, must-revalidate";

        # Gzip compression
        gzip on;
        gzip_types text/html;
    }

    # Root - index.html
    location / {
        root /app/frontend/dist;
        try_files $uri $uri/ /index.html;

        # Short expiration for SPA root
        expires 1h;
        add_header Cache-Control "public, max-age=3600, must-revalidate";
    }
}

# ============================================================================
# Cache Status Logging
# ============================================================================

# Log format with cache status
log_format cache_log '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'Cache: $upstream_cache_status '
                      'Time: ${upstream_response_time}s';

# ============================================================================
# Cache Control Headers (sent from Django)
# ============================================================================

# These headers should be set by Django and will be respected by Nginx:
#
# For cacheable responses:
# Cache-Control: public, max-age=300
# ETag: "abc123"
# Last-Modified: Mon, 27 Dec 2025 10:00:00 GMT
#
# For non-cacheable responses:
# Cache-Control: private, no-cache, no-store, max-age=0
#
# For authentication-aware responses:
# Cache-Control: private, max-age=300
# Vary: Authorization, Accept

# ============================================================================
# Performance Tuning
# ============================================================================

# Connection timeout (prevent slow client attacks)
proxy_connect_timeout 10s;
proxy_send_timeout 30s;
proxy_read_timeout 30s;

# Buffer sizes (prevent excessive memory usage)
proxy_buffer_size 4k;
proxy_buffers 8 4k;
proxy_busy_buffers_size 8k;

# Compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript
           application/x-javascript application/xml+rss
           application/javascript application/json;

# ============================================================================
# Monitoring & Metrics
# ============================================================================

# Cache hit rate can be monitored via:
# - X-Cache-Status header (HIT, MISS, BYPASS, etc.)
# - Prometheus metrics endpoint
# - Nginx access logs with cache_log format

# Example monitoring queries:
# Hit rate: (HIT requests) / (total requests)
# Miss rate: (MISS requests) / (total requests)
# Bypass rate: (BYPASS requests) / (total requests)
