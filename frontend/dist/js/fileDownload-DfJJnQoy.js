async function e(e,t,o,r=!0){if(e.preventDefault(),function(e){if(!e)return!1;if(e.startsWith("/media/"))return!0;try{const t=new URL(e,window.location.origin),o=window.location.host;return t.host===o&&t.pathname.includes("/media/")}catch{return e.includes("/media/")}}(t))try{await async function(e,t,o=!0){try{let n=localStorage.getItem("authToken");if(!n){const e=localStorage.getItem("bot_platform_auth_token");if(e)try{const t=JSON.parse(e);n=(null==t?void 0:t.data)||null}catch(r){logger.warn("[fileDownload] Failed to parse secure storage token")}}if(logger.debug("[fileDownload] Token check:",n?"Found":"NOT FOUND"),logger.debug("[fileDownload] localStorage keys:",Object.keys(localStorage)),!n)throw new Error("Токен авторизации не найден. Пожалуйста, войдите в систему.");let a=e;"https:"===window.location.protocol&&e.startsWith("http://")&&(a=e.replace("http://","https://"),logger.debug("[fileDownload] Fixed Mixed Content:",e,"→",a)),logger.debug("[fileDownload] Fetching:",a),logger.debug("[fileDownload] Token:",n?`${n.substring(0,10)}...`:"MISSING");const i=await fetch(a,{method:"GET",headers:{Authorization:`Token ${n}`},credentials:"include"});if(logger.debug("[fileDownload] Response status:",i.status,i.statusText),logger.debug("[fileDownload] Response headers:",Object.fromEntries(i.headers.entries())),!i.ok){if(401===i.status)throw new Error("Необходима авторизация для доступа к файлу. Попробуйте выйти и войти заново.");if(403===i.status)throw new Error("Доступ к файлу запрещен. Проверьте права доступа или попробуйте выйти и войти заново.");if(404===i.status)throw new Error("Файл не найден на сервере");{const e=await i.text().catch(()=>i.statusText);throw logger.error("[fileDownload] Error response:",e),new Error(`Ошибка загрузки файла (${i.status}): ${i.statusText}`)}}const l=await i.blob();let s=t;if(!s){const t=i.headers.get("Content-Disposition");if(t){const e=t.match(/filename="?([^"]+)"?/);e&&(s=e[1])}if(!s){const t=e.split("/");s=t[t.length-1]}}const c=window.URL.createObjectURL(l);if(o)window.open(c,"_blank"),setTimeout(()=>{window.URL.revokeObjectURL(c)},1e3);else{const e=document.createElement("a");e.href=c,e.download=s||"download",document.body.appendChild(e),e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(c)}}catch(n){throw logger.error("Error downloading protected file:",n),n}}(t,o,r)}catch(n){logger.error("Failed to open protected file:",n),alert(n.message||"Ошибка при открытии файла")}else window.open(t,"_blank")}export{e as h};
