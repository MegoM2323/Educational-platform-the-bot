---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: thebot-dev
  namespace: thebot-dev

# Base resources
bases:
- ../../base

# Namespace override
namespace: thebot-dev

# Override common labels
commonLabels:
  app: thebot
  environment: dev
  managed-by: kustomize

# Replicas for dev environment (minimal)
replicas:
- name: backend
  count: 1
- name: frontend
  count: 1
- name: celery-worker
  count: 1
- name: celery-beat
  count: 1

# Images for dev (local registry or development tags)
images:
- name: thebot/backend
  newName: localhost:5000/thebot/backend
  newTag: dev
- name: thebot/frontend
  newName: localhost:5000/thebot/frontend
  newTag: dev

# ConfigMap patches for dev environment
configMapGenerator:
- name: django-config
  namespace: thebot-dev
  behavior: merge
  literals:
  - ENVIRONMENT=development
  - DEBUG=True
  - LOG_LEVEL=DEBUG
  - ALLOWED_HOSTS=localhost,127.0.0.1,*.thebot.local

# Secret overrides for dev
secretGenerator:
- name: django-secrets
  namespace: thebot-dev
  behavior: merge
  literals:
  - SECRET_KEY=dev-secret-key-not-for-production
  - DB_PASSWORD=dev-db-password
  - REDIS_PASSWORD=dev-redis-password

# Resource limits for dev (lower than production)
patches:
- target:
    kind: Deployment
    name: backend
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 100m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 128Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 500m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 512Mi

- target:
    kind: Deployment
    name: frontend
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 50m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 64Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 250m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 256Mi

# PVC size for dev (smaller)
patches:
- target:
    kind: PersistentVolumeClaim
    name: postgres-pvc
  patch: |-
    - op: replace
      path: /spec/resources/requests/storage
      value: 10Gi

- target:
    kind: PersistentVolumeClaim
    name: backend-media-pvc
  patch: |-
    - op: replace
      path: /spec/resources/requests/storage
      value: 5Gi

# Storage class for dev
patches:
- target:
    kind: PersistentVolumeClaim
  patch: |-
    - op: replace
      path: /spec/storageClassName
      value: standard

# Disable pod affinity in dev
patches:
- target:
    kind: Deployment
  patch: |-
    - op: remove
      path: /spec/template/spec/affinity/podAntiAffinity

# Disable pod disruption budgets in dev
patchesStrategicMerge: []
patchesJson6902: []

# Sort options
sortOptions:
  order: legacy
