import{u as t,b as e,a as r}from"./react-query-DqnBFrGE.js";import{l as s,f as u,u as n,aj as a}from"./main-fde3JC90.js";const o={listStudents:async()=>{s.debug("[tutorAPI.listStudents] Starting request");const t=u.getToken();if(s.debug("[tutorAPI.listStudents] Current token:",t?"EXISTS":"MISSING"),!t)throw s.error("[tutorAPI.listStudents] No token available!"),new Error("Authentication required. Please login again.");const e=await u.request("/tutor/my-students/");if(s.debug("[tutorAPI.listStudents] Response status:",e.success),s.debug("[tutorAPI.listStudents] Response data:",e.data),e.error)throw s.error("[tutorAPI.listStudents] Error:",e.error),new Error(e.error);if(e.data){if(Array.isArray(e.data))return e.data;if(e.data.data&&Array.isArray(e.data.data))return e.data.data;if(Array.isArray(e.data.results))return e.data.results}return[]},createStudent:async t=>{s.debug("[tutorAPI.createStudent] Starting request with data:",t);const e=u.getToken();if(s.debug("[tutorAPI.createStudent] Current token:",e?"EXISTS":"MISSING"),!e)throw s.error("[tutorAPI.createStudent] No token available!"),new Error("HTTP 403: Forbidden - Authentication required");const r=await u.request("/tutor/my-students/",{method:"POST",body:JSON.stringify(t)});if(s.debug("[tutorAPI.createStudent] Response success:",r.success),s.debug("[tutorAPI.createStudent] Response error:",r.error),s.debug("[tutorAPI.createStudent] Full response:",JSON.stringify(r,null,2)),r.error){if(s.error("[tutorAPI.createStudent] Error:",r.error),r.error.includes("403")||r.error.includes("Forbidden"))throw new Error("HTTP 403: Forbidden");throw new Error(r.error)}return r.data},getStudent:async t=>{const e=await u.request(`/tutor/students/${t}/`);if(e.error)throw new Error(e.error);return e.data},assignSubject:async(t,e)=>{var r;try{s.debug("[tutorAPI.assignSubject] Starting request:",{studentId:t,data:e});const n=await u.request(`/tutor/students/${t}/subjects/`,{method:"POST",body:JSON.stringify(e)});if(s.debug("[tutorAPI.assignSubject] Response:",{success:n.success,error:n.error,data:n.data,hasData:!!n.data,statusCode:n.statusCode}),!n.success||n.error){const t=n.error||(null==(r=n.data)?void 0:r.detail)||"Не удалось назначить предмет";throw s.error("[tutorAPI.assignSubject] Error:",t),new Error(t)}return void s.debug("[tutorAPI.assignSubject] Subject assigned successfully, statusCode:",n.statusCode||"OK")}catch(n){if(s.error("[tutorAPI.assignSubject] Exception:",n),n instanceof Error)throw n;throw new Error((null==n?void 0:n.message)||"Не удалось назначить предмет")}},removeSubject:async(t,e)=>{const r=await u.request(`/tutor/students/${t}/subjects/${e}/`,{method:"DELETE"});if(r.error)throw new Error(r.error)},getStudentsSchedule:async()=>{s.debug("[tutorAPI.getStudentsSchedule] Starting request");const t=await u.request("/scheduling/tutor/schedule/");if(s.debug("[tutorAPI.getStudentsSchedule] Response:",t.data),t.error)throw s.error("[tutorAPI.getStudentsSchedule] Error:",t.error),new Error(t.error);return t.data&&t.data.students?t.data.students:[]}},d=()=>r({queryKey:["tutor-students"],queryFn:async()=>{s.debug("[useTutorStudents] Fetching students list...");const t=await o.listStudents();return s.debug("[useTutorStudents] Fetched",t.length,"students"),t.forEach(t=>{var e,r;const u=(null==(e=t.subjects)?void 0:e.length)||0;s.debug(`[useTutorStudents] Student ${t.id} (${t.full_name}) has ${u} subjects`),u>0&&(null==(r=t.subjects)||r.forEach(t=>{s.debug(`  - ${t.name} (teacher: ${t.teacher_name}, enrollment_id: ${t.enrollment_id})`)}))}),t},staleTime:0,gcTime:0,retry:2,refetchOnWindowFocus:!0,refetchOnMount:!0,refetchOnReconnect:!0,refetchInterval:!1}),i=()=>{const r=t(),{toast:u}=n();return e({mutationFn:async t=>{s.debug("[useCreateTutorStudent] Creating student with data:",t);const e=await o.createStudent(t);return s.debug("[useCreateTutorStudent] Student created successfully:",e),e},onSuccess:async t=>{s.debug("[useCreateTutorStudent] onSuccess called, invalidating and refetching..."),a.delete("/tutor/students/"),r.invalidateQueries({queryKey:["tutor-students"]}),await r.refetchQueries({queryKey:["tutor-students"],type:"active"}),s.debug("[useCreateTutorStudent] Data refreshed successfully"),u({title:"Успешно",description:"Ученик и родитель успешно созданы"})},onError:t=>{s.error("[useCreateTutorStudent] Error:",t);const e=(null==t?void 0:t.message)||"Не удалось создать ученика";u({title:"Ошибка",description:e,variant:"destructive"})}})},c=r=>{const u=t(),{toast:d}=n();return e({mutationFn:async t=>{s.debug("[useAssignSubject] Starting mutation for student:",r,"data:",t),await o.assignSubject(r,t),s.debug("[useAssignSubject] Mutation completed successfully")},onSuccess:async()=>{s.debug("[useAssignSubject] onSuccess called, invalidating cache..."),a.delete("/tutor/students/"),u.invalidateQueries({queryKey:["tutor-students"]}),u.invalidateQueries({queryKey:["tutor-student",r]}),await u.refetchQueries({queryKey:["tutor-students"],type:"active"}),s.debug("[useAssignSubject] Cache invalidated and data refreshed"),d({title:"Успешно",description:"Предмет успешно назначен ученику"})},onError:t=>{var e,r;const u=(null==t?void 0:t.message)||(null==(r=null==(e=null==t?void 0:t.response)?void 0:e.data)?void 0:r.detail)||"Не удалось назначить предмет";s.error("[useAssignSubject] Error:",u),d({title:"Ошибка",description:u,variant:"destructive"})}})};export{c as a,i as b,o as t,d as u};
