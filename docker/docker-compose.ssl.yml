# Docker Compose Configuration with SSL/TLS Support
#
# This configuration adds automatic SSL certificate management using certbot
# and Let's Encrypt for the THE BOT platform.
#
# Usage:
#   docker-compose -f docker-compose.ssl.yml up -d
#
# Features:
# - Automatic Let's Encrypt certificate provisioning
# - Automatic certificate renewal (30 days before expiration)
# - Nginx with modern SSL/TLS configuration
# - Volume sharing for certificates between containers
#
# Volumes:
# - certbot_certs: /etc/letsencrypt (Let's Encrypt certificates)
# - certbot_www: /var/www/certbot (ACME challenges)
# - nginx_config: Nginx configuration files

version: '3.9'

volumes:
  certbot_certs:
    driver: local
  certbot_www:
    driver: local

services:
  nginx:
    image: nginx:latest
    container_name: thebot-nginx-ssl
    restart: always
    ports:
      - "80:80"      # HTTP (redirects to HTTPS)
      - "443:443"    # HTTPS (TLS 1.2+)
    volumes:
      # Nginx configuration
      - ./nginx/the-bot.ru.conf:/etc/nginx/sites-available/the-bot.ru:ro
      - ./nginx/ssl.conf:/etc/nginx/ssl.conf:ro
      # Frontend static files
      - ./frontend/dist:/var/www/frontend:ro
      # Let's Encrypt certificates
      - certbot_certs:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
      # Logs
      - nginx_logs:/var/log/nginx
    environment:
      - TZ=UTC
    depends_on:
      - daphne
    networks:
      - thebot-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  certbot:
    image: certbot/certbot:latest
    container_name: thebot-certbot
    restart: unless-stopped
    volumes:
      # Let's Encrypt certificates and configuration
      - certbot_certs:/etc/letsencrypt
      - certbot_www:/var/www/certbot
      # Renewal hooks
      - ./scripts/certbot-post-renewal.sh:/etc/letsencrypt/renewal-hooks/post/nginx.sh:ro
      - ./scripts/certbot-pre-renewal.sh:/etc/letsencrypt/renewal-hooks/pre/nginx.sh:ro
      # Logs
      - certbot_logs:/var/log/letsencrypt
    environment:
      - TZ=UTC
      # Certificate options
      - CERTBOT_EMAIL=admin@the-bot.ru
      - DOMAIN=the-bot.ru
      - ADDITIONAL_DOMAINS=www.the-bot.ru
      - RENEW_DAYS=30           # Renew when 30+ days remain
      - RENEW_INTERVAL=86400    # Check daily (86400 seconds)
    # Run certbot renewal twice daily
    entrypoint: /bin/sh -c "
      while true; do
        certbot renew --webroot -w /var/www/certbot --quiet;
        echo 'Certificate renewal check completed at '$(date);
        sleep 12h;
      done"
    depends_on:
      - nginx
    networks:
      - thebot-network

  daphne:
    # (Include your existing Daphne configuration here)
    image: thebot-backend:latest
    container_name: thebot-daphne
    restart: always
    command: daphne -b 0.0.0.0 -p 8001 config.asgi:application
    volumes:
      - ./backend:/app/backend
      - ./media:/app/media
    environment:
      - ENVIRONMENT=production
      - DEBUG=False
      # (Include other environment variables)
    networks:
      - thebot-network
    # Include health check and other configuration

networks:
  thebot-network:
    driver: bridge

# Named volumes for persistence
volumes:
  nginx_logs:
    driver: local
  certbot_logs:
    driver: local

# Optional: Pre-built images
# images:
#   nginx: nginx:1.25-alpine
#   certbot: certbot/certbot:v2.8.0
#   daphne: python:3.11-slim
