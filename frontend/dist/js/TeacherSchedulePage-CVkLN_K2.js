import{r as e,j as t}from"./react-core-JVqWokWt.js";import{r as s,I as a,az as n,aA as i,aB as r,aC as d,aD as l,g as o,aE as c,h as m,i as u,j as x,k as h,aF as j,B as p,_ as f,$ as g,C as b,M as y,u as _,S as v,a as w,e as N,J as S,K as k,L as C,D,w as E,x as L,y as M}from"./main-fde3JC90.js";import{T as z}from"./TeacherSidebar-Bwv8PTW2.js";import{u as T}from"./useTeacher-DJCQuFgv.js";import{u as I}from"./useTeacherLessons-FFsXHQWt.js";import{aW as q,aY as B,bP as O,bQ as F,az as U,ay as A,a_ as P,a$ as V,aD as $,ab as H,aF as R,aG as J,aZ as W,an as Y,aE as Z,ao as G,bI as K,$ as Q}from"./vendor-DC2AZkDs.js";import{a8 as X,a9 as ee,aa as te,ab as se}from"./radix-ui-Ch8xfAyl.js";import{N as ae}from"./react-router-WAeXREDX.js";import"./react-dom-DyRXjBRd.js";import"./react-query-DqnBFrGE.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";import"./teacher-BhCI6v5d.js";const ne=e=>null==e||""===e?"":String(e),ie={date:B().min(1,"Date is required"),start_time:B().min(1,"Start time is required"),end_time:B().min(1,"End time is required"),description:B().optional().default(""),telemost_link:B().optional().default("").refine(e=>!e||/^https?:\/\/.+/.test(e),"Invalid URL format")},re=q({student:O(ne,B().min(1,"Student is required")),subject:O(ne,B().min(1,"Subject is required")),...ie}).refine(e=>!e.start_time||!e.end_time||e.start_time<e.end_time,{message:"Start time must be before end time",path:["end_time"]}).refine(e=>{if(!e.date)return!0;const t=new Date(e.date),s=new Date;return s.setHours(0,0,0,0),t>=s},{message:"Date cannot be in the past",path:["date"]}),de=q({...ie}).refine(e=>!e.start_time||!e.end_time||e.start_time<e.end_time,{message:"Start time must be before end time",path:["end_time"]}).refine(e=>{if(!e.date)return!0;const t=new Date(e.date),s=new Date;return s.setHours(0,0,0,0),t>=s},{message:"Date cannot be in the past",path:["date"]}),le=X,oe=ee,ce=e.forwardRef(({className:e,align:a="center",sideOffset:n=4,...i},r)=>t.jsx(te,{children:t.jsx(se,{ref:r,align:a,sideOffset:n,className:s("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...i})}));function me({className:e,classNames:n,showOutsideDays:i=!0,...r}){return t.jsx(F,{showOutsideDays:i,className:s("p-3",e),classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium",nav:"space-x-1 flex items-center",nav_button:s(a({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"),nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:s(a({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100"),day_range_end:"day-range-end",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground",day_outside:"day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"text-muted-foreground opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible",...n},components:{IconLeft:({...e})=>t.jsx(A,{className:"h-4 w-4"}),IconRight:({...e})=>t.jsx(U,{className:"h-4 w-4"})},...r})}ce.displayName=se.displayName,me.displayName="Calendar";const ue=({onSubmit:s,onSuccess:a,isLoading:b=!1,initialData:y,students:_,subjects:v,onStudentSelect:w,isEditMode:N=!1})=>{const S=e=>"object"==typeof e&&(null==e?void 0:e.id)?String(e.id):String(e||""),k=P({resolver:V(N?de:re),defaultValues:y?N?{date:y.date||"",start_time:y.start_time||"09:00",end_time:y.end_time||"10:00",description:y.description||"",telemost_link:y.telemost_link||""}:{student:S(y.student),subject:S(y.subject),date:y.date||"",start_time:y.start_time||"09:00",end_time:y.end_time||"10:00",description:y.description||"",telemost_link:y.telemost_link||""}:{student:"",subject:"",date:"",start_time:"09:00",end_time:"10:00",description:"",telemost_link:""}}),C=N?(null==y?void 0:y.student)?S(y.student):"":k.watch("student");e.useEffect(()=>{y&&k.reset(N?{date:y.date||"",start_time:y.start_time||"09:00",end_time:y.end_time||"10:00",description:y.description||"",telemost_link:y.telemost_link||""}:{student:S(y.student),subject:S(y.subject),date:y.date||"",start_time:y.start_time||"09:00",end_time:y.end_time||"10:00",description:y.description||"",telemost_link:y.telemost_link||""})},[y,N,k]);const D=e.useMemo(()=>{if(!C)return v;const e=_.find(e=>e.id===C);return e&&e.subjects&&e.subjects.length>0?e.subjects:v},[C,_,v]);return t.jsx(n,{...k,children:t.jsxs("form",{onSubmit:k.handleSubmit(async e=>{if(N||e.student)try{await s(e),N||k.reset(),null==a||a()}catch(t){}else k.setError("student",{type:"manual",message:"Please select a student"})}),className:"space-y-6",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[N?t.jsxs("div",{className:"space-y-2",children:[t.jsx(i,{children:"Student"}),t.jsx("div",{className:"flex h-10 w-full rounded-md border border-input bg-muted px-3 py-2 text-sm",children:(()=>{const e=S(null==y?void 0:y.student),t=_.find(t=>t.id===e);return(null==t?void 0:t.full_name)||(null==t?void 0:t.name)||"Unknown"})()}),t.jsx(r,{className:"text-xs text-muted-foreground",children:"Student cannot be changed when editing"})]}):t.jsx(d,{control:k.control,name:"student",render:({field:e})=>t.jsxs(l,{children:[t.jsx(i,{children:"Student"}),t.jsxs(o,{value:e.value,onValueChange:t=>{e.onChange(t),null==w||w(t),k.setValue("subject","")},children:[t.jsx(c,{children:t.jsx(m,{children:t.jsx(u,{placeholder:"Select a student"})})}),t.jsx(x,{children:_.map(e=>t.jsx(h,{value:String(e.id),children:e.full_name||e.name},e.id))})]}),t.jsx(j,{})]})}),N?t.jsxs("div",{className:"space-y-2",children:[t.jsx(i,{children:"Subject"}),t.jsx("div",{className:"flex h-10 w-full rounded-md border border-input bg-muted px-3 py-2 text-sm",children:(()=>{const e=S(null==y?void 0:y.subject),t=v.find(t=>t.id===e);return(null==t?void 0:t.name)||"Unknown"})()}),t.jsx(r,{className:"text-xs text-muted-foreground",children:"Subject cannot be changed when editing"})]}):t.jsx(d,{control:k.control,name:"subject",render:({field:e})=>t.jsxs(l,{children:[t.jsx(i,{children:"Subject"}),t.jsxs(o,{value:e.value,onValueChange:e.onChange,children:[t.jsx(c,{children:t.jsx(m,{children:t.jsx(u,{placeholder:"Select a subject"})})}),t.jsx(x,{children:D.map(e=>t.jsx(h,{value:String(e.id),children:e.name},e.id))})]}),t.jsx(j,{})]})})]}),t.jsx(d,{control:k.control,name:"date",render:({field:e})=>t.jsxs(l,{children:[t.jsx(i,{children:"Date"}),t.jsxs(le,{children:[t.jsx(oe,{asChild:!0,children:t.jsxs(p,{type:"button",variant:"outline",className:"w-full justify-start text-left font-normal",children:[t.jsx(H,{className:"mr-2 h-4 w-4"}),e.value?$(new Date(e.value),"MMM dd, yyyy"):"Pick a date"]})}),t.jsx(ce,{className:"w-auto p-0",align:"start",children:t.jsx(me,{mode:"single",selected:e.value?new Date(e.value):void 0,onSelect:t=>{t&&e.onChange($(t,"yyyy-MM-dd"))},disabled:e=>{const t=new Date;return t.setHours(0,0,0,0),e<t}})})]}),t.jsx(j,{})]})}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsx(d,{control:k.control,name:"start_time",render:({field:e})=>t.jsxs(l,{children:[t.jsx(i,{children:"Start Time"}),t.jsx(c,{children:t.jsx(f,{type:"time",value:e.value||"",onChange:e.onChange,onBlur:e.onBlur,name:e.name,ref:e.ref})}),t.jsx(j,{})]})}),t.jsx(d,{control:k.control,name:"end_time",render:({field:e})=>t.jsxs(l,{children:[t.jsx(i,{children:"End Time"}),t.jsx(c,{children:t.jsx(f,{type:"time",value:e.value||"",onChange:e.onChange,onBlur:e.onBlur,name:e.name,ref:e.ref})}),t.jsx(j,{})]})})]}),t.jsx(d,{control:k.control,name:"description",render:({field:e})=>t.jsxs(l,{children:[t.jsx(i,{children:"Description"}),t.jsx(c,{children:t.jsx(g,{placeholder:"Lesson topic, materials to prepare, etc.",className:"resize-none",rows:3,...e})}),t.jsx(j,{})]})}),t.jsx(d,{control:k.control,name:"telemost_link",render:({field:e})=>t.jsxs(l,{children:[t.jsx(i,{children:"Telemost Link"}),t.jsx(c,{children:t.jsx(f,{placeholder:"https://telemost.yandex.ru/j/...",type:"url",...e})}),t.jsx(r,{children:"Optional - link to online lesson"}),t.jsx(j,{})]})}),t.jsx(p,{type:"submit",disabled:b,className:"w-full",children:b?y?"Saving...":"Creating...":y?"Update Lesson":"Create Lesson"})]})})},xe=({lesson:e,onEdit:s,onDelete:a,deletingId:n=null})=>{const i=n===e.id,r=e=>e.slice(0,5);return t.jsx(b,{className:"p-4 hover:shadow-md transition-shadow",children:t.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[t.jsxs("div",{className:"flex-1 space-y-2",children:[t.jsx("div",{className:"flex items-start gap-3",children:t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"font-semibold text-lg",children:e.student_name}),t.jsx("p",{className:"text-sm text-muted-foreground",children:e.subject_name})]})}),t.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[t.jsx(R,{className:"w-4 h-4"}),t.jsxs("span",{children:[(e=>{try{return $(new Date(e),"EEE, d MMM",{locale:Z})}catch{return e}})(e.date)," â€¢ ",r(e.start_time)," - ",r(e.end_time)]})]}),e.description&&t.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:e.description}),t.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:e.status&&t.jsx("span",{className:"text-xs px-2 py-1 rounded-full "+("confirmed"===e.status?"bg-blue-100 text-blue-800":"pending"===e.status?"bg-yellow-100 text-yellow-800":"completed"===e.status?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e.status})})]}),t.jsxs("div",{className:"flex gap-2 flex-wrap sm:flex-nowrap",children:[e.telemost_link&&t.jsx(p,{type:"button",size:"sm",variant:"outline",asChild:!0,children:t.jsxs("a",{href:e.telemost_link,target:"_blank",rel:"noopener noreferrer",children:[t.jsx(J,{className:"w-4 h-4 mr-1"}),t.jsx("span",{className:"hidden sm:inline",children:"Join"})]})}),s&&t.jsxs(p,{type:"button",size:"sm",variant:"outline",onClick:s,disabled:i,children:[t.jsx(W,{className:"w-4 h-4"}),t.jsx("span",{className:"hidden sm:inline ml-1",children:"Edit"})]}),a&&t.jsxs(p,{type:"button",size:"sm",variant:"destructive",onClick:a,disabled:i,children:[t.jsx(Y,{className:"w-4 h-4"}),t.jsx("span",{className:"hidden sm:inline ml-1",children:"Delete"})]})]})]})})},he=()=>{const{user:s}=y(),{data:a,isLoading:n}=T(),{toast:i}=_(),[r,d]=e.useState(!1),[l,o]=e.useState(null),[c,m]=e.useState(null),[u,x]=e.useState(null),{lessons:h,isLoading:j,error:f,createLesson:g,updateLesson:q,deleteLesson:B,isCreating:O,isUpdating:F}=I();if("teacher"!==(null==s?void 0:s.role))return t.jsx(ae,{to:"/dashboard",replace:!0});const U=(null==a?void 0:a.students)||[],A=new Map;U.forEach(e=>{e.subjects&&e.subjects.forEach(e=>{A.has(String(e.id))||A.set(String(e.id),e)})});const P=Array.from(A.values()),V=e=>2===e.split(":").length?`${e}:00`:e,$=[...h].sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime());return t.jsx(v,{children:t.jsxs("div",{className:"flex min-h-screen w-full bg-background",children:[t.jsx(z,{}),t.jsxs(w,{className:"flex-1",children:[t.jsxs("div",{className:"flex h-14 items-center border-b px-6",children:[t.jsx(N,{}),t.jsx("h1",{className:"ml-4 text-xl font-semibold",children:"My Schedule"})]}),t.jsxs("div",{className:"space-y-6 p-6",children:[t.jsxs(b,{children:[t.jsx(S,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(k,{children:"Create Lesson"}),!r&&t.jsxs(p,{type:"button",onClick:()=>{d(!0)},size:"sm",variant:"outline",children:[t.jsx(G,{className:"w-4 h-4 mr-2"}),"Add Lesson"]})]})}),r&&t.jsxs(C,{className:"space-y-4",children:[t.jsx(ue,{onSubmit:async e=>{try{const t={...e,start_time:V(e.start_time),end_time:V(e.end_time)};await g(t),d(!1)}catch(t){i({title:"Error",description:t instanceof Error?t.message:"Failed to create lesson",variant:"destructive"})}},isLoading:O,students:U,subjects:P}),t.jsx(p,{type:"button",variant:"ghost",onClick:()=>d(!1),className:"w-full",children:"Cancel"})]})]}),t.jsxs(b,{children:[t.jsx(S,{children:t.jsx(k,{children:"My Lessons"})}),t.jsxs(C,{className:"space-y-4",children:[j&&t.jsx("div",{className:"flex items-center justify-center py-8",children:t.jsx(K,{className:"w-5 h-5 animate-spin text-muted-foreground"})}),f&&t.jsxs("div",{className:"flex items-center gap-2 p-4 rounded-lg bg-red-50 text-red-700",children:[t.jsx(Q,{className:"w-5 h-5 flex-shrink-0"}),t.jsx("span",{className:"text-sm",children:"Failed to load lessons. Please try again."})]}),!j&&0===$.length&&t.jsx("p",{className:"text-center py-8 text-muted-foreground",children:'No lessons created yet. Click "Add Lesson" to create your first lesson.'}),!j&&$.length>0&&t.jsx("div",{className:"space-y-3",children:$.map(e=>t.jsx(xe,{lesson:e,onEdit:()=>(e=>{var t,s;const a="object"==typeof e.student?String((null==(t=e.student)?void 0:t.id)||e.student):String(e.student),n="object"==typeof e.subject?String((null==(s=e.subject)?void 0:s.id)||e.subject):String(e.subject),i={id:e.id,student:a,subject:n,date:e.date,start_time:e.start_time.substring(0,5),end_time:e.end_time.substring(0,5),description:e.description||"",telemost_link:e.telemost_link||"",status:e.status,teacher:e.teacher,created_at:e.created_at,updated_at:e.updated_at};o(e.id),m(i)})(e),onDelete:()=>{return t=e.id,x(t),void B(t,{onSettled:()=>{x(null)}});var t},deletingId:u},e.id))})]})]})]}),l&&c&&t.jsx(D,{open:null!==l,onOpenChange:e=>{e||(o(null),m(null))},children:t.jsxs(E,{className:"max-w-2xl",children:[t.jsx(L,{children:t.jsx(M,{children:"Edit Lesson"})}),t.jsx(ue,{onSubmit:async e=>{if(l)try{const t={date:e.date,start_time:V(e.start_time),end_time:V(e.end_time),description:e.description||"",telemost_link:e.telemost_link||""};await q({id:l,payload:t}),o(null),m(null)}catch(t){i({title:"Error",description:t instanceof Error?t.message:"Failed to update lesson",variant:"destructive"})}},initialData:c,isLoading:F,students:U,subjects:P,isEditMode:!0})]})})]})]})})};export{he as default};
