# Alert Rules for THE_BOT Platform
# Critical conditions that require immediate attention

groups:
  - name: django_alerts
    interval: 30s
    rules:
      # High Error Rate Alert
      - alert: DjangoHighErrorRate
        expr: django_request_errors_percent:5m > 5
        for: 5m
        labels:
          severity: critical
          component: backend
        annotations:
          summary: "High error rate in Django backend"
          description: "Error rate is {{ $value | humanize }}% (threshold: 5%)"
          runbook: "https://wiki.thebot.local/runbooks/high-error-rate"

      # High Latency Alert
      - alert: DjangoHighLatency
        expr: django_request_latency:p95 > 1
        for: 5m
        labels:
          severity: warning
          component: backend
        annotations:
          summary: "High request latency in Django backend"
          description: "P95 latency is {{ $value | humanize }}s (threshold: 1s)"
          runbook: "https://wiki.thebot.local/runbooks/high-latency"

      # Slow Database Queries Alert
      - alert: DjangoSlowQueries
        expr: rate(django_db_execute_total{duration="slow"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High rate of slow database queries"
          description: "Slow queries rate: {{ $value | humanize }}/s (threshold: 10/s)"
          runbook: "https://wiki.thebot.local/runbooks/slow-queries"

      # Low Cache Hit Rate Alert
      - alert: DjangoLowCacheHitRate
        expr: django_cache_hit_rate:5m < 50
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate: {{ $value | humanize }}% (threshold: 50%)"
          runbook: "https://wiki.thebot.local/runbooks/cache-performance"

  - name: nodejs_alerts
    interval: 30s
    rules:
      # Frontend High Error Rate
      - alert: NodeJSHighErrorRate
        expr: nodejs_http_errors_percent:5m > 5
        for: 5m
        labels:
          severity: critical
          component: frontend
        annotations:
          summary: "High error rate in Node.js frontend"
          description: "Error rate: {{ $value | humanize }}% (threshold: 5%)"
          runbook: "https://wiki.thebot.local/runbooks/frontend-errors"

      # Frontend High Latency
      - alert: NodeJSHighLatency
        expr: nodejs_http_latency:p95 > 2000
        for: 5m
        labels:
          severity: warning
          component: frontend
        annotations:
          summary: "High request latency in Node.js frontend"
          description: "P95 latency: {{ $value | humanize }}ms (threshold: 2000ms)"
          runbook: "https://wiki.thebot.local/runbooks/frontend-latency"

  - name: system_alerts
    interval: 30s
    rules:
      # High CPU Usage
      - alert: HighCPUUsage
        expr: node_cpu:usage_percent > 80
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage: {{ $value | humanize }}% (threshold: 80%)"
          runbook: "https://wiki.thebot.local/runbooks/high-cpu"

      # Critical CPU Usage
      - alert: CriticalCPUUsage
        expr: node_cpu:usage_percent > 95
        for: 2m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Critical CPU usage detected"
          description: "CPU usage: {{ $value | humanize }}% (threshold: 95%)"
          runbook: "https://wiki.thebot.local/runbooks/critical-cpu"

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: node_memory:usage_percent > 80
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage: {{ $value | humanize }}% (threshold: 80%)"
          runbook: "https://wiki.thebot.local/runbooks/high-memory"

      # Critical Memory Usage
      - alert: CriticalMemoryUsage
        expr: node_memory:usage_percent > 95
        for: 2m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Critical memory usage detected"
          description: "Memory usage: {{ $value | humanize }}% (threshold: 95%)"
          runbook: "https://wiki.thebot.local/runbooks/critical-memory"

      # High Disk I/O
      - alert: HighDiskIO
        expr: (node_disk_io:read_rate + node_disk_io:write_rate) > 1000
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High disk I/O activity"
          description: "I/O rate: {{ $value | humanize }} ops/s (threshold: 1000 ops/s)"
          runbook: "https://wiki.thebot.local/runbooks/high-disk-io"

  - name: database_alerts
    interval: 30s
    rules:
      # Long Running Queries
      - alert: LongRunningQueries
        expr: rate(pg_stat_statements_mean_exec_time[5m]) > 5000
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Long running database queries detected"
          description: "Average query time: {{ $value | humanize }}ms (threshold: 5000ms)"
          runbook: "https://wiki.thebot.local/runbooks/long-queries"

      # Sequential Scans Warning
      - alert: HighSequentialScans
        expr: pg_table_scans:ratio > 0.5
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High ratio of sequential table scans"
          description: "Sequential scan ratio: {{ $value | humanize }} (threshold: 0.5)"
          runbook: "https://wiki.thebot.local/runbooks/seq-scans"

      # Connection Pool Saturation
      - alert: DatabaseConnectionPoolSaturation
        expr: (pg_active_transactions / pg_connections_available) > 0.8
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection pool nearly saturated"
          description: "Pool usage: {{ $value | humanize }}% (threshold: 80%)"
          runbook: "https://wiki.thebot.local/runbooks/connection-pool"

      # Replication Lag
      - alert: PostgreSQLReplicationLag
        expr: pg_replication:lag_seconds > 10
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "PostgreSQL replication lag detected"
          description: "Replication lag: {{ $value | humanize }}s (threshold: 10s)"
          runbook: "https://wiki.thebot.local/runbooks/replication-lag"

  - name: redis_alerts
    interval: 30s
    rules:
      # High Memory Usage
      - alert: RedisHighMemoryUsage
        expr: redis_memory:usage_percent > 90
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Redis memory usage is high"
          description: "Memory usage: {{ $value | humanize }}% (threshold: 90%)"
          runbook: "https://wiki.thebot.local/runbooks/redis-memory"

      # Low Hit Rate
      - alert: RedisLowHitRate
        expr: redis_keyspace:hit_rate < 70
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Redis hit rate is low"
          description: "Hit rate: {{ $value | humanize }}% (threshold: 70%)"
          runbook: "https://wiki.thebot.local/runbooks/redis-hit-rate"

      # High Eviction Rate
      - alert: RedisHighEvictionRate
        expr: rate(redis_evicted_keys_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Redis evicting keys at high rate"
          description: "Eviction rate: {{ $value | humanize }}/s (threshold: 100/s)"
          runbook: "https://wiki.thebot.local/runbooks/redis-eviction"

  - name: availability_alerts
    interval: 30s
    rules:
      # Service Down Alert
      - alert: DjangoServiceDown
        expr: up{job="django-backend"} == 0
        for: 2m
        labels:
          severity: critical
          component: backend
        annotations:
          summary: "Django backend service is down"
          description: "Django backend has been unavailable for 2 minutes"
          runbook: "https://wiki.thebot.local/runbooks/service-down"

      - alert: NodeJSServiceDown
        expr: up{job="nodejs-frontend"} == 0
        for: 2m
        labels:
          severity: critical
          component: frontend
        annotations:
          summary: "Node.js frontend service is down"
          description: "Node.js frontend has been unavailable for 2 minutes"
          runbook: "https://wiki.thebot.local/runbooks/service-down"

      - alert: PostgreSQLDown
        expr: up{job="postgres-exporter"} == 0
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PostgreSQL database is down"
          description: "PostgreSQL has been unavailable for 2 minutes"
          runbook: "https://wiki.thebot.local/runbooks/db-down"

      - alert: RedisDown
        expr: up{job="redis-exporter"} == 0
        for: 2m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: "Redis cache is down"
          description: "Redis has been unavailable for 2 minutes"
          runbook: "https://wiki.thebot.local/runbooks/redis-down"

  - name: application_alerts
    interval: 30s
    rules:
      # Overall Health Check
      - alert: ApplicationHealthDegraded
        expr: api_health:score < 80
        for: 5m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "Overall application health is degraded"
          description: "Health score: {{ $value | humanize }}/100 (threshold: 80)"
          runbook: "https://wiki.thebot.local/runbooks/health-degraded"

      - alert: ApplicationHealthCritical
        expr: api_health:score < 50
        for: 2m
        labels:
          severity: critical
          component: application
        annotations:
          summary: "Overall application health is critical"
          description: "Health score: {{ $value | humanize }}/100 (threshold: 50)"
          runbook: "https://wiki.thebot.local/runbooks/health-critical"
