import{r as e,j as s}from"./react-core-JVqWokWt.js";import{as as a,aV as r,B as l,C as t,L as i,A as n,t as c,v as d,r as o,J as m,K as h,Y as x,Z as u,_ as p,$ as j,g as f,h as v,i as g,j as N,k as y,c as b,aU as w,l as _,f as F}from"./main-fde3JC90.js";import{u as C,a as P,b as S}from"./react-query-DqnBFrGE.js";import{p as A,T as E}from"./profileAPI-mpI8UVp9.js";import{a2 as q,ay as k,bA as L,X as T,ao as U}from"./vendor-DC2AZkDs.js";import{u as K}from"./react-router-WAeXREDX.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const $=()=>{var $,z,D;const G=K(),{user:J}=a(),{profile:M,isLoading:B,updateProfile:I,isUpdating:O,refetch:V}=(()=>{const e=C(),{data:s,isLoading:a,error:r,refetch:l}=P({queryKey:["teacherProfile"],queryFn:async()=>{const e=await A.getMyTeacherProfile();if(!e.success||!e.data)throw new Error(e.error||"Failed to fetch teacher profile");return e.data},staleTime:3e5,gcTime:6e5,refetchOnMount:!0,refetchOnWindowFocus:!1}),t=S({mutationFn:async e=>{const s=await A.updateTeacherProfile(e);if(!s.success||!s.data)throw new Error(s.error||"Failed to update teacher profile");return s.data},onSuccess:()=>{e.invalidateQueries({queryKey:["teacherProfile"]}),e.invalidateQueries({queryKey:["profile"]}),q.success("Профиль успешно обновлен")},onError:e=>{const s=e instanceof Error?e.message:"Ошибка при обновлении профиля";q.error(s)}});return{profile:s,isLoading:a,error:r,refetch:l,updateProfile:t.mutateAsync,isUpdating:t.isPending}})(),{data:W}=P({queryKey:["allSubjects"],queryFn:async()=>{const e=await F.request("/materials/subjects/all/");if(!e.success||!e.data)throw new Error("Failed to load subjects");const s=e.data;return Array.isArray(s)?s:s.results||[]}}),[Q,R]=e.useState({first_name:"",last_name:"",phone:"",experience_years:0,bio:""}),[Y,Z]=e.useState([]),[H,X]=e.useState(""),[ee,se]=e.useState(null),[ae,re]=e.useState(null),[le,te]=e.useState(!1),[ie,ne]=e.useState(0);e.useEffect(()=>{var e,s,a,r,l,t,i,n;if(M&&(R({first_name:(null==(e=M.user)?void 0:e.first_name)||"",last_name:(null==(s=M.user)?void 0:s.last_name)||"",phone:(null==(a=M.user)?void 0:a.phone)||"",experience_years:(null==(r=M.profile)?void 0:r.experience_years)||0,bio:(null==(l=M.profile)?void 0:l.bio)||""}),ne((null==(i=null==(t=M.profile)?void 0:t.bio)?void 0:i.length)||0),(null==(n=M.profile)?void 0:n.subjects_list)&&W&&Array.isArray(W))){const e=M.profile.subjects_list,s=W.filter(s=>e.includes(s.name)).map(e=>e.id);Z(s)}},[M,W]),e.useEffect(()=>{const e=e=>{le&&(e.preventDefault(),e.returnValue="")};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[le]);const ce=(e,s)=>{R(a=>({...a,[e]:s})),te(!0),"bio"===e&&"string"==typeof s&&ne(s.length)};if(!J)return null;if(B)return s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsx(r,{})});const de=`${Q.first_name[0]||""}${Q.last_name[0]||""}`.toUpperCase(),oe=ae||(null==($=null==M?void 0:M.user)?void 0:$.avatar);return s.jsx("div",{className:"min-h-screen bg-[hsl(240,20%,99%)] py-8 px-4",children:s.jsxs("div",{className:"max-w-7xl mx-auto",children:[s.jsx("div",{className:"mb-6 flex items-center gap-4",children:s.jsxs(l,{type:"button",variant:"outline",size:"sm",onClick:()=>G(-1),"aria-label":"Вернуться на предыдущую страницу",children:[s.jsx(k,{className:"w-4 h-4 mr-2"}),"Назад"]})}),s.jsxs("div",{className:"mb-6",children:[s.jsx("h1",{className:"text-3xl font-bold text-[hsl(240,10%,15%)] mb-2",children:"Мой профиль"}),s.jsx("p",{className:"text-[hsl(240,5%,45%)]",children:"Здесь вы можете редактировать информацию о себе"})]}),s.jsx("form",{onSubmit:async e=>{e.preventDefault();const s=new FormData;s.append("first_name",Q.first_name),s.append("last_name",Q.last_name),s.append("phone",Q.phone),s.append("experience_years",String(Q.experience_years)),s.append("bio",Q.bio),s.append("subject_ids",JSON.stringify(Y)),ee&&s.append("avatar",ee);try{await I(s),te(!1),se(null),re(null)}catch(a){_.error("Failed to update profile:",a)}},children:s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[s.jsx("div",{className:"lg:col-span-1",children:s.jsx("div",{className:"sticky top-4",children:s.jsx(t,{className:"shadow-md",children:s.jsxs(i,{className:"p-6 flex flex-col items-center gap-4",children:[s.jsxs(n,{className:"w-48 h-48 shadow-lg border-4 border-[hsl(0,0%,96%)]",children:[s.jsx(c,{src:oe,alt:`${Q.first_name} ${Q.last_name}`}),s.jsx(d,{className:"text-6xl font-bold text-white",style:{background:"linear-gradient(135deg, hsl(160, 60%, 50%), hsl(180, 70%, 60%))"},children:de})]}),s.jsxs("div",{className:"w-full",children:[s.jsxs("label",{htmlFor:"avatar-upload",className:o("flex flex-col items-center justify-center w-full p-6 border-2 border-dashed rounded-lg cursor-pointer transition-all","border-[hsl(240,10%,90%)] bg-[hsl(240,10%,98%)]","hover:border-[hsl(250,70%,60%)] hover:bg-[hsl(250,70%,98%)]"),children:[s.jsx(L,{className:"w-8 h-8 mb-2 text-[hsl(240,5%,45%)]"}),s.jsx("span",{className:"text-sm text-[hsl(240,5%,45%)]",children:ee?ee.name:"Загрузить фото"}),s.jsx("span",{className:"text-xs text-[hsl(240,5%,60%)] mt-1",children:"JPG, PNG, WebP (макс. 5MB)"}),s.jsx("input",{id:"avatar-upload",type:"file",className:"hidden",accept:"image/jpeg,image/png,image/webp",onChange:e=>{var s;const a=null==(s=e.target.files)?void 0:s[0];if(!a)return;if(a.size>5242880)return void q.error("Файл слишком большой. Максимум 5MB");if(!["image/jpeg","image/png","image/webp"].includes(a.type))return void q.error("Неподдерживаемый формат. Используйте JPG, PNG или WebP");se(a);const r=new FileReader;r.onloadend=()=>{re(r.result)},r.readAsDataURL(a),te(!0)}})]}),ae&&s.jsxs(l,{type:"button",variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>{se(null),re(null),te(!0)},children:[s.jsx(T,{className:"w-4 h-4 mr-2"}),"Отменить"]})]})]})})})}),s.jsx("div",{className:"lg:col-span-2",children:s.jsxs(t,{className:"shadow-md",children:[s.jsxs(m,{children:[s.jsx(h,{className:"text-2xl",children:"Профиль преподавателя"}),s.jsx(x,{children:"Обновите вашу персональную информацию и предметы"})]}),s.jsxs(i,{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs(u,{htmlFor:"first_name",className:"text-sm font-medium",children:["Имя ",s.jsx("span",{className:"text-[hsl(0,84%,60%)]",children:"*"})]}),s.jsx(p,{id:"first_name",value:Q.first_name,onChange:e=>ce("first_name",e.target.value),required:!0,className:"h-10"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(u,{htmlFor:"last_name",className:"text-sm font-medium",children:["Фамилия ",s.jsx("span",{className:"text-[hsl(0,84%,60%)]",children:"*"})]}),s.jsx(p,{id:"last_name",value:Q.last_name,onChange:e=>ce("last_name",e.target.value),required:!0,className:"h-10"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(u,{htmlFor:"email",className:"text-sm font-medium",children:"Email"}),s.jsx(p,{id:"email",type:"email",value:(null==(z=null==M?void 0:M.user)?void 0:z.email)||"",disabled:!0,className:"h-10 bg-[hsl(240,10%,96%)] opacity-50 cursor-not-allowed"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)]",children:"Email нельзя изменить"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(u,{htmlFor:"phone",className:"text-sm font-medium",children:"Телефон"}),s.jsx(p,{id:"phone",type:"tel",value:Q.phone,onChange:e=>ce("phone",e.target.value),placeholder:"+7 (999) 123-45-67",className:"h-10"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(u,{htmlFor:"experience_years",className:"text-sm font-medium",children:"Опыт работы (лет)"}),s.jsx(p,{id:"experience_years",type:"number",min:"0",max:"80",value:Q.experience_years,onChange:e=>ce("experience_years",parseInt(e.target.value)||0),className:"h-10"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)]",children:"Количество лет преподавания"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(u,{htmlFor:"bio",className:"text-sm font-medium",children:"Биография"}),s.jsx(j,{id:"bio",value:Q.bio,onChange:e=>ce("bio",e.target.value),placeholder:"Расскажите о своем опыте преподавания...",className:"min-h-32 resize-none",maxLength:1e3,rows:6}),s.jsxs("p",{className:"text-xs text-[hsl(240,5%,55%)] text-right",children:["Осталось: ",1e3-ie," символов"]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(u,{className:"text-sm font-medium",children:"Предметы"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)]",children:"Выберите предметы, которые вы преподаёте"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(f,{value:H,onValueChange:X,children:[s.jsx(v,{className:"h-10 flex-1",children:s.jsx(g,{placeholder:"Выберите предмет"})}),s.jsx(N,{children:Array.isArray(W)&&W.map(e=>s.jsx(y,{value:String(e.id),children:e.name},e.id))})]}),s.jsxs(l,{type:"button",variant:"outline",onClick:()=>{if(!H)return;const e=parseInt(H);Y.includes(e)?q.error("Этот предмет уже добавлен"):(Z(s=>[...s,e]),X(""),te(!0))},disabled:!H,className:"h-10",children:[s.jsx(U,{className:"w-4 h-4 mr-2"}),"Добавить"]})]}),s.jsxs("div",{className:"flex flex-wrap gap-2 mt-3",children:[Y.map(e=>{return s.jsxs(b,{variant:"secondary",className:"px-3 py-1 text-sm bg-[hsl(250,70%,95%)] text-[hsl(250,70%,40%)] hover:bg-[hsl(250,70%,90%)] transition-colors",children:[(a=e,Array.isArray(W)&&(null==(r=W.find(e=>e.id===a))?void 0:r.name)||"Unknown"),s.jsx("button",{type:"button",onClick:()=>(e=>{Z(s=>s.filter(s=>s!==e)),te(!0)})(e),className:"ml-2 hover:opacity-70 transition-opacity","aria-label":"Удалить предмет",children:s.jsx(T,{className:"w-3 h-3"})})]},e);var a,r}),0===Y.length&&s.jsx("p",{className:"text-sm text-[hsl(240,5%,55%)]",children:"Предметы не выбраны"})]})]}),s.jsxs("div",{className:"space-y-2 pt-4 border-t",children:[s.jsx(u,{className:"text-sm font-medium",children:"Привязка Telegram"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)] mb-2",children:"Привяжите аккаунт Telegram для получения уведомлений"}),s.jsx(E,{isLinked:!!(null==(D=null==M?void 0:M.user)?void 0:D.telegram_id),onStatusChange:V})]})]}),s.jsxs(w,{className:"flex items-center justify-between border-t pt-6",children:[s.jsx("div",{className:"flex items-center gap-2",children:le&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-2 h-2 bg-[hsl(30,95%,60%)] rounded-full animate-pulse"}),s.jsx("span",{className:"text-sm text-[hsl(240,5%,45%)]",children:"Несохраненные изменения"})]})}),s.jsx(l,{type:"submit",disabled:O,className:"bg-[hsl(250,70%,60%)] hover:bg-[hsl(250,70%,55%)] text-white shadow-sm hover:shadow-md transition-all",children:O?s.jsxs(s.Fragment,{children:[s.jsx(r,{className:"w-4 h-4 mr-2"}),"Сохранение..."]}):"Сохранить"})]})]})})]})})]})})};export{$ as TeacherProfilePage,$ as default};
