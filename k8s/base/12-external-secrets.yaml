---
# External Secrets Operator configuration for Vault integration
# ClusterSecretStore and ExternalSecret resources

apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
  namespace: external-secrets
spec:
  provider:
    vault:
      server: "https://vault.vault.svc.cluster.local:8200"
      path: "secret"
      version: "v2"
      auth:
        appRole:
          path: "approle"
          roleId:
            secretRef:
              name: vault-approle
              key: role-id
          secretId:
            secretRef:
              name: vault-approle
              key: secret-id

---
# Secret containing AppRole credentials
apiVersion: v1
kind: Secret
metadata:
  name: vault-approle
  namespace: external-secrets
type: Opaque
stringData:
  role-id: "CHANGE-ME-VAULT-ROLE-ID"
  secret-id: "CHANGE-ME-VAULT-SECRET-ID"

---
# ExternalSecret for Django application secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: django-secrets
  namespace: thebot
  labels:
    app: backend
    managed-by: external-secrets-operator
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: django-secrets
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: secret/django
      remoteRef:
        key: secret-key
    - secretKey: secret/django
      remoteRef:
        key: debug

---
# ExternalSecret for PostgreSQL
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-secrets
  namespace: thebot
  labels:
    app: postgres
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: postgres-secrets
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: secret/postgres
      remoteRef:
        key: db-password

---
# ExternalSecret for Redis
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-secrets
  namespace: thebot
  labels:
    app: redis
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: redis-secrets
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: secret/redis
      remoteRef:
        key: redis-password

---
# ExternalSecret for TLS certificates
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: tls-certificates
  namespace: thebot
  labels:
    app: ingress
spec:
  refreshInterval: 168h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: tls-certificates
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  dataFrom:
    - extract:
        key: secret/tls/certificates

---
# ExternalSecret for Docker Registry
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: docker-registry
  namespace: thebot
  labels:
    app: docker
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: docker-registry
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockercfg
  data:
    - secretKey: secret/docker
      remoteRef:
        key: registry-auth
