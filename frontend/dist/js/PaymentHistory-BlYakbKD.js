import{r as s,j as e}from"./react-core-JVqWokWt.js";import{u as t,S as a,P as i,a as r,b as n,B as l,C as c,c as d,d as o,p as m,l as x}from"./main-fde3JC90.js";import{u as h,e as p}from"./react-router-WAeXREDX.js";import{P as j,a as u,b as f,c as g,d as N,e as v,f as y}from"./pagination-C0J-iX43.js";import{be as b,b9 as w,ap as _,ab as S,aG as k}from"./vendor-DC2AZkDs.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./react-query-DqnBFrGE.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const C=()=>{const C=h(),{toast:D}=t(),[E,M]=p(),[P,z]=s.useState([]),[U,F]=s.useState(!0),[I,L]=s.useState(null),R=parseInt(E.get("page")||"1",10),[$,q]=s.useState(1);s.useEffect(()=>{(async()=>{try{F(!0);const s=await m.getPaymentHistory();z(s),q(Math.ceil(s.length/20))}catch(s){x.error("Error fetching payment history:",s),D({title:"Ошибка загрузки",description:s.message||"Не удалось загрузить историю платежей",variant:"destructive"})}finally{F(!1)}})()},[D]);const A=20*(R-1),B=A+20,G=P.slice(A,B),H=s=>{M({page:s.toString()}),window.scrollTo({top:0,behavior:"smooth"})};return U?e.jsxs(a,{children:[e.jsx(i,{}),e.jsx(r,{children:e.jsxs("div",{className:"flex flex-col gap-4 p-6",children:[e.jsx(n,{className:"h-12 w-full"}),e.jsx(n,{className:"h-64 w-full"}),e.jsx(n,{className:"h-64 w-full"})]})})]}):e.jsxs(a,{children:[e.jsx(i,{}),e.jsx(r,{children:e.jsxs("div",{className:"flex flex-col gap-6 p-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(l,{type:"button",variant:"ghost",size:"icon",onClick:()=>C("/dashboard/parent"),children:e.jsx(b,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"История платежей"}),e.jsx("p",{className:"text-muted-foreground",children:"Все платежи по предметам ваших детей"})]})]}),0===P.length?e.jsxs(c,{className:"p-12 text-center",children:[e.jsx(w,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Нет платежей"}),e.jsx("p",{className:"text-muted-foreground",children:"История платежей пуста"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Показаны ",A+1,"-",Math.min(B,P.length)," из ",P.length," платежей"]})}),e.jsx("div",{className:"space-y-4",children:G.map(s=>e.jsxs(c,{className:"p-6",children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(_,{className:"h-5 w-5 text-primary"}),e.jsx("h3",{className:"text-lg font-semibold",children:s.subject}),s.is_recurring&&e.jsx(d,{variant:"outline",children:"Регулярный платеж"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Ученик"}),e.jsx("p",{className:"font-medium",children:s.student})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Преподаватель"}),e.jsx("p",{className:"font-medium",children:s.teacher})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Сумма"}),e.jsxs("p",{className:"font-medium",children:[s.amount," ₽"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Статус"}),e.jsx(o,{status:s.status,size:"default"})]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between gap-4 text-sm border-t pt-4",children:[e.jsxs("div",{className:"flex items-center gap-4 text-muted-foreground",children:[s.paid_at&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"h-4 w-4"}),e.jsxs("span",{children:["Оплачено: ",new Date(s.paid_at).toLocaleDateString("ru-RU")]})]}),s.due_date&&!s.paid_at&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"h-4 w-4"}),e.jsxs("span",{children:["Срок оплаты: ",new Date(s.due_date).toLocaleDateString("ru-RU")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-4 w-4"}),e.jsxs("span",{children:["ID платежа: ",s.payment_id.slice(0,8),"..."]})]})]}),("pending"===s.status||"waiting_for_payment"===s.status)&&e.jsx(l,{type:"button",onClick:()=>(async s=>{if("pending"===s.status||"waiting_for_payment"===s.status){L(s.id);try{const e=await m.initiatePayment(s.student_id,s.enrollment_id,{description:`Оплата за предмет "${s.subject}" для ученика ${s.student}`,create_subscription:s.is_recurring});if(!e.confirmation_url)throw new Error("Не получена ссылка для оплаты");D({title:"Перенаправление на страницу оплаты",description:"Откроется новое окно для оплаты"}),window.open(e.confirmation_url,"_blank")||D({title:"Ошибка",description:"Не удалось открыть окно оплаты. Проверьте настройки блокировки всплывающих окон.",variant:"destructive"})}catch(e){x.error("Error creating payment:",e),D({title:"Ошибка оплаты",description:e.message||"Не удалось создать платеж",variant:"destructive"})}finally{L(null)}}})(s),disabled:I===s.id,size:"sm",className:"gradient-primary shadow-glow hover:opacity-90 transition-opacity",children:I===s.id?"Обработка...":e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Оплатить"]})})]})]},s.id))}),$>1&&e.jsx("div",{className:"mt-6",children:e.jsx(j,{children:e.jsxs(u,{children:[e.jsx(f,{children:e.jsx(g,{onClick:()=>R>1&&H(R-1),className:1===R?"pointer-events-none opacity-50":"cursor-pointer"})}),(()=>{const s=[];if($<=5)for(let e=1;e<=$;e++)s.push(e);else{s.push(1),R>3&&s.push("ellipsis");const e=Math.max(2,R-1),t=Math.min($-1,R+1);for(let a=e;a<=t;a++)s.push(a);R<$-2&&s.push("ellipsis"),$>1&&s.push($)}return s})().map((s,t)=>e.jsx(f,{children:"ellipsis"===s?e.jsx(N,{}):e.jsx(v,{onClick:()=>H(s),isActive:R===s,className:"cursor-pointer",children:s})},t)),e.jsx(f,{children:e.jsx(y,{onClick:()=>R<$&&H(R+1),className:R===$?"pointer-events-none opacity-50":"cursor-pointer"})})]})})})]})]})})]})};export{C as default};
