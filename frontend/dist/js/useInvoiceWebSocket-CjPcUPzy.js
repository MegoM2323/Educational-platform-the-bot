var e=Object.defineProperty,t=(t,n,o)=>((t,n,o)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[n]=o)(t,"symbol"!=typeof n?n+"":n,o);import{r as n}from"./react-core-JVqWokWt.js";import{ap as o,aq as i,ar as s,l as c,as as a}from"./main-fde3JC90.js";const r=new class{constructor(){t(this,"subscriptions",new Map),t(this,"eventHandlers",{}),t(this,"reconnectAttempts",0),t(this,"maxReconnectAttempts",5),t(this,"reconnectDelay",1e3),o.onConnectionChange(e=>{e?this.resubscribeAll():this.scheduleReconnect()})}connect(e){this.eventHandlers={...this.eventHandlers,...e};const t=o.subscribe("invoices",e=>{this.handleInvoiceMessage(e)});if(this.subscriptions.set("invoices",t),!o.isConnected()){const e=i(),{accessToken:t}=s.getTokens(),n=t||localStorage.getItem("auth_token");if(!n)return c.error("[InvoiceWebSocket] ERROR: No auth token available for WebSocket connection!",{tokenStorageResult:t,localStorageToken:localStorage.getItem("auth_token"),allLocalStorageKeys:Object.keys(localStorage)}),void(this.eventHandlers.onError&&this.eventHandlers.onError("Authentication token not found. Please log in again."));const a=`${e}/invoices/${`?token=${n}`}`;c.info("[InvoiceWebSocket] Connecting to invoice updates:",{hasToken:!!n,tokenLength:n.length,tokenStart:n.substring(0,10),fullUrl:a}),o.connect(a),this.reconnectAttempts=0}}disconnect(){const e=this.subscriptions.get("invoices");e&&(o.unsubscribe(e),this.subscriptions.delete("invoices")),c.info("[InvoiceWebSocket] Disconnected from invoice updates")}handleInvoiceMessage(e){switch(c.debug("[InvoiceWebSocketService] Received message:",{type:e.type,data:e.data}),e.type){case"connection.established":c.info("[InvoiceWebSocket] Connection established:",e.data),this.reconnectAttempts=0;break;case"invoice.created":e.data&&this.eventHandlers.onInvoiceCreated&&(c.debug("[InvoiceWebSocket] Invoice created event:",e.data),this.eventHandlers.onInvoiceCreated({invoice_id:e.invoice_id||e.data.invoice_id,data:e.data,timestamp:e.timestamp}));break;case"invoice.status_update":e.data&&this.eventHandlers.onStatusUpdate&&(c.debug("[InvoiceWebSocket] Status update event:",e.data),this.eventHandlers.onStatusUpdate({invoice_id:e.invoice_id||e.data.invoice_id,old_status:e.old_status||e.data.old_status,new_status:e.new_status||e.data.new_status,data:e.data,timestamp:e.timestamp}));break;case"invoice.paid":e.data&&this.eventHandlers.onInvoicePaid&&(c.debug("[InvoiceWebSocket] Invoice paid event:",e.data),this.eventHandlers.onInvoicePaid({invoice_id:e.invoice_id||e.data.invoice_id,data:e.data,timestamp:e.timestamp}));break;case"error":e.error&&this.eventHandlers.onError&&(c.error("[InvoiceWebSocket] Server error:",e.error),this.eventHandlers.onError(e.error));break;case"pong":break;default:c.warn("[InvoiceWebSocket] Unknown message type:",e.type)}}resubscribeAll(){c.debug("[InvoiceWebSocket] Resubscribing to invoice updates"),this.subscriptions.forEach((e,t)=>{const n=o.subscribe(t,e=>{this.handleInvoiceMessage(e)});this.subscriptions.set(t,n)}),this.reconnectAttempts=0}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return c.error("[InvoiceWebSocket] Max reconnection attempts reached"),void(this.eventHandlers.onError&&this.eventHandlers.onError("Failed to reconnect after multiple attempts"));this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);c.debug(`[InvoiceWebSocket] Scheduling reconnection attempt ${this.reconnectAttempts} in ${e}ms`),setTimeout(()=>{this.subscriptions.size>0&&this.connect(this.eventHandlers)},e)}isConnected(){return o.isConnected()}onConnectionChange(e){o.onConnectionChange(e)}},d=()=>{const{user:e}=a();return n.useEffect(()=>{if(null==e?void 0:e.id)return c.info("[useInvoiceWebSocket] Connecting to invoice WebSocket for user:",e.id),r.connect({}),()=>{c.info("[useInvoiceWebSocket] Disconnecting from invoice WebSocket"),r.disconnect()};c.debug("[useInvoiceWebSocket] User not authenticated, skipping WebSocket connection")},[null==e?void 0:e.id]),{on:(e,t)=>{const n={};n[e]=t,r.connect(n)},off:(e,t)=>{c.debug("[useInvoiceWebSocket] Unsubscribing from event:",e)},isConnected:()=>r.isConnected(),onConnectionChange:e=>{r.onConnectionChange(e)}}};export{r as i,d as u};
