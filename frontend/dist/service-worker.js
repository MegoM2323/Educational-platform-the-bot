const n="v3",e={APP_SHELL:`app-shell-${n}`,API_RESPONSES:`api-responses-${n}`,IMAGES:`images-${n}`,OFFLINE_FALLBACK:`offline-fallback-${n}`},t=[/^\/api\/auth\//,/^\/api\/materials\//,/^\/api\/chat\//,/^\/api\/scheduling\//,/^\/api\/knowledge-graph\//,/^\/api\/users\//,/^\/api\/profiles\//],a=6048e5,i=864e5,o=36e5;function s(n){return t.some(e=>e.test(new URL(n).pathname))}function c(n){return/\.(png|jpg|jpeg|gif|webp|svg|ico)$/i.test(new URL(n).pathname)}function r(){return new Response("\n    <!DOCTYPE html>\n    <html lang=\"en\">\n      <head>\n        <meta charset=\"UTF-8\" />\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n        <title>THE BOT - Offline Mode</title>\n        <style>\n          * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n          }\n\n          body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',\n              'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            min-height: 100vh;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 20px;\n          }\n\n          .offline-container {\n            background: white;\n            border-radius: 12px;\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n            padding: 40px;\n            max-width: 500px;\n            text-align: center;\n          }\n\n          .offline-icon {\n            width: 80px;\n            height: 80px;\n            margin: 0 auto 20px;\n            opacity: 0.8;\n          }\n\n          h1 {\n            color: #333;\n            font-size: 28px;\n            margin-bottom: 10px;\n          }\n\n          p {\n            color: #666;\n            font-size: 16px;\n            line-height: 1.6;\n            margin-bottom: 30px;\n          }\n\n          .offline-tips {\n            text-align: left;\n            background: #f5f5f5;\n            padding: 20px;\n            border-radius: 8px;\n            margin-bottom: 30px;\n          }\n\n          .offline-tips h3 {\n            color: #333;\n            font-size: 14px;\n            margin-bottom: 10px;\n          }\n\n          .offline-tips ul {\n            list-style: none;\n          }\n\n          .offline-tips li {\n            color: #666;\n            font-size: 14px;\n            padding: 5px 0;\n            padding-left: 20px;\n            position: relative;\n          }\n\n          .offline-tips li:before {\n            content: \"âœ“\";\n            position: absolute;\n            left: 0;\n            color: #667eea;\n            font-weight: bold;\n          }\n\n          button {\n            background: #667eea;\n            color: white;\n            border: none;\n            padding: 12px 30px;\n            border-radius: 6px;\n            font-size: 16px;\n            cursor: pointer;\n            transition: background 0.3s ease;\n          }\n\n          button:hover {\n            background: #764ba2;\n          }\n\n          .status {\n            margin-top: 20px;\n            padding: 10px;\n            background: #f0f0f0;\n            border-radius: 6px;\n            font-size: 14px;\n            color: #666;\n          }\n        </style>\n      </head>\n      <body>\n        <div class=\"offline-container\">\n          <svg class=\"offline-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n            <path d=\"M1 21h22M17 3a6.002 6.002 0 0 0-5.7 3.9m-11.4 8.7A6 6 0 0 1 12 3c4 0 7.33 2.67 9 8M9.172 15.172a4 4 0 0 1 5.656 0M9 17h.01\"/>\n          </svg>\n\n          <h1>You're Offline</h1>\n          <p>We've lost your internet connection. Some features may not be available right now.</p>\n\n          <div class=\"offline-tips\">\n            <h3>What you can still do:</h3>\n            <ul>\n              <li>View your cached materials</li>\n              <li>Read messages sent earlier</li>\n              <li>Access your profile information</li>\n              <li>View your study progress</li>\n            </ul>\n          </div>\n\n          <button onclick=\"window.location.reload()\">Reload Page</button>\n\n          <div class=\"status\">\n            <p id=\"status\">Waiting for connection...</p>\n          </div>\n        </div>\n\n        <script>\n          // Update status when connection restored\n          window.addEventListener('online', () => {\n            document.getElementById('status').textContent = 'Connection restored! Reloading...';\n            setTimeout(() => window.location.reload(), 1500);\n          });\n\n          // Periodic check for connection\n          setInterval(() => {\n            fetch('/ping', { method: 'HEAD' })\n              .then(() => {\n                document.getElementById('status').textContent = 'Connection restored! Reloading...';\n                setTimeout(() => window.location.reload(), 1500);\n              })\n              .catch(() => {\n                document.getElementById('status').textContent = 'Still offline... retrying...';\n              });\n          }, 3000);\n        <\/script>\n      </body>\n    </html>\n  ",{headers:{"Content-Type":"text/html; charset=UTF-8"}})}async function l(n,e,t){try{const r=await caches.open(n),l=t.clone(),d=function(n){return s(n)?i:c(n)?o:a}(e),p=new Response(l.body,{status:l.status,statusText:l.statusText,headers:new Headers(l.headers)});p.headers.set("X-Cache-Timestamp",Date.now().toString()),p.headers.set("X-Cache-TTL",d.toString()),await r.put(e,p)}catch(r){console.warn("Failed to cache response:",r)}}async function d(n,e){try{const t=await caches.open(n),a=await t.match(e);return a?function(n){const e=n.headers.get("X-Cache-Timestamp"),t=n.headers.get("X-Cache-TTL");return!e||!t||Date.now()-parseInt(e,10)<parseInt(t,10)}(a)?a.clone():(await t.delete(e),null):null}catch{return null}}self.addEventListener("install",n=>{n.waitUntil(caches.open(e.APP_SHELL).then(n=>n.addAll(["/index.html","/favicon.ico"]).catch(()=>{console.warn("Some critical assets could not be cached during install")})).then(()=>self.skipWaiting()))}),self.addEventListener("activate",n=>{n.waitUntil(async function(){try{const n=await caches.keys(),t=Object.values(e);await Promise.all(n.filter(n=>!t.includes(n)).map(n=>caches.delete(n)))}catch(n){console.warn("Cache cleanup failed:",n)}}().then(()=>self.clients.claim()))}),self.addEventListener("fetch",n=>{const{request:t}=n,a=t.url;if("GET"!==t.method||!function(n){try{return new URL(n).origin===self.location.origin&&!n.includes("/ws")&&!n.includes("/admin")}catch{return!1}}(a))return;let i;i=s(a)?async function(n){try{const t=await fetch(n.clone());return t.ok&&await l(e.API_RESPONSES,n.url,t.clone()),t}catch{return await d(e.API_RESPONSES,n.url)||r()}}(t):c(a)?async function(n){const t=await caches.open(e.IMAGES),a=await t.match(n),i=fetch(n.clone()).then(e=>{if(e.ok){const a=e.clone();t.put(n,a)}return e}).catch(()=>a||r());return a||i}(t):async function(n){const t=await d(e.APP_SHELL,n.url);if(t)return t;try{const t=await fetch(n.clone());return t.ok&&await l(e.APP_SHELL,n.url,t.clone()),t}catch{if("document"===n.destination)return r();throw new Error(`Failed to fetch: ${n.url}`)}}(t),n.respondWith(i.catch(()=>"document"===t.destination?r():new Response("Resource unavailable offline",{status:503,statusText:"Service Unavailable"})))}),self.addEventListener("sync",n=>{"sync-messages"===n.tag&&n.waitUntil(fetch("/api/chat/pending-messages/",{method:"POST"}).catch(()=>{console.warn("Failed to sync messages, will retry later")}))}),self.addEventListener("message",n=>{"CLEAR_CACHE"===n.data.type?n.waitUntil(Promise.all(Object.values(e).map(n=>caches.delete(n))).then(()=>{}).catch(n=>{console.error("Failed to clear caches:",n)})):"SKIP_WAITING"===n.data.type&&self.skipWaiting()});
