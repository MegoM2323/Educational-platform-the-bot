var e=Object.defineProperty,s=(s,t,a)=>((s,t,a)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a)(s,"symbol"!=typeof t?t+"":t,a);import{r as t,j as a}from"./react-core-JVqWokWt.js";import{M as n,ap as r,l as i,ar as o,aq as c,r as l,B as d,D as u,w as m,x as h,y as g,z as x,$ as p,a7 as f,u as v,S as y,a as b,e as j,aa as N,ab as w,ac as C,ad as _,ae as k,af as S,ag as E,ah as M,P as T,a0 as I,C as F,_ as P,ax as A,b as H,A as U,v as W,g as D,h as Q,i as q,j as L,k as R,c as K}from"./main-fde3JC90.js";import{u as $,a as O,b as z,c as B}from"./react-query-DqnBFrGE.js";import{f as G}from"./forumAPI-CXsZ6fyy.js";import{a2 as J,az as V,ak as Y,bS as X,bT as Z,bU as ee,bV as se,an as te,a6 as ae,ao as ne,at as re,aS as ie,aa as oe,$ as ce,bW as le,a5 as de,a3 as ue,bX as me,ac as he,aq as ge,a7 as xe,bY as pe,X as fe,bO as ve,ad as ye,aU as be,aA as je}from"./vendor-DC2AZkDs.js";import{T as Ne}from"./TeacherSidebar-Bwv8PTW2.js";import{T as we}from"./TutorSidebar-DEiDMEeu.js";import{ac as Ce,ad as _e,ae as ke,af as Se,ag as Ee,ah as Me,ai as Te,aj as Ie,ak as Fe,al as Pe,am as Ae,an as He}from"./radix-ui-Ch8xfAyl.js";import{u as Ue}from"./react-router-WAeXREDX.js";import"./react-dom-DyRXjBRd.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const We=new class{constructor(){s(this,"subscriptions",new Map),s(this,"typingTimeouts",new Map),s(this,"eventHandlers",{}),s(this,"connectionStatus","disconnected"),s(this,"connectionStatusCallbacks",[]),s(this,"connectionUnsubscribe",null),s(this,"authErrorUnsubscribe",null),s(this,"activeSubscriptions",new Map),this.connectionUnsubscribe=r.onConnectionChange(e=>{e?(this.setConnectionStatus("connected"),this.resubscribeAll(),this.eventHandlers.onConnect&&this.eventHandlers.onConnect()):this.setConnectionStatus("disconnected")}),this.authErrorUnsubscribe=r.onAuthError((e,s)=>{i.error("[ChatWebSocket] Auth error received:",{code:e,reason:s}),this.handleAuthError(e,s)})}handleAuthError(e,s){this.setConnectionStatus("auth_error");let t=s;4001===e?t="Authentication failed. Please log in again.":4002===e&&(t="Access denied. You do not have permission to access this resource."),this.eventHandlers.onError&&this.eventHandlers.onError(t,e.toString()),4001===e&&"undefined"!=typeof window&&(i.info("[ChatWebSocket] Redirecting to login due to auth error"),o.clearTokens())}setConnectionStatus(e){this.connectionStatus!==e&&(this.connectionStatus=e,this.connectionStatusCallbacks.forEach(s=>s(e)))}onConnectionStatusChange(e){return this.connectionStatusCallbacks.push(e),()=>{this.connectionStatusCallbacks=this.connectionStatusCallbacks.filter(s=>s!==e)}}getConnectionStatus(){return this.connectionStatus}getAuthToken(){const{accessToken:e}=o.getTokens();if(e)return i.debug("[ChatWebSocket] Using token from tokenStorage"),e;const s=localStorage.getItem("auth_token");return s?(i.debug("[ChatWebSocket] Using token from localStorage (fallback)"),s):(i.error("[ChatWebSocket] No authentication token found in any storage"),null)}connectToGeneralChat(e){this.eventHandlers={...this.eventHandlers,...e};const s=r.subscribe("general_chat",e=>{this.handleChatMessage(e)});if(this.subscriptions.set("general_chat",s),!r.isConnected()){const e=c(),s=this.getAuthToken();if(!s){const e="Authentication token not found. Please log in again.";return i.error("[ChatWebSocket] "+e),this.setConnectionStatus("auth_error"),void(this.eventHandlers.onError&&this.eventHandlers.onError(e))}this.setConnectionStatus("connecting");const t=`${e}/chat/general/${`?token=${s}`}`;i.info("[ChatWebSocket] Connecting to general chat:",{hasToken:!!s,tokenLength:s.length,fullUrl:t}),r.connect(t)}}async connectToRoom(e,s){this.eventHandlers={...this.eventHandlers,...s};const t=`chat_${e}`,a=this.getAuthToken();if(!a){const e="Authentication token not found. Please log in again.";return i.error("[ChatWebSocket] "+e),this.setConnectionStatus("auth_error"),s.onError&&s.onError(e),Promise.reject(new Error(e))}this.setConnectionStatus("connecting");const n=r.subscribe(t,e=>{this.handleChatMessage(e)});this.subscriptions.set(t,n),this.activeSubscriptions.set(e,n);const o=`${c()}/chat/${e}/${`?token=${a}`}`;return i.info("[ChatWebSocket] Connecting to room:",{roomId:e,hasToken:!!a,tokenLength:a.length,fullUrl:o}),new Promise((e,t)=>{let a=null;const n=setTimeout(()=>{a&&a(),i.warn("[ChatWebSocket] Connection timeout"),this.setConnectionStatus("error"),t(new Error("Connection timeout"))},5e3),c=()=>{const s=this.getConnectionStatus();"connected"===s?(clearTimeout(n),a&&a(),e(!0)):"error"!==s&&"auth_error"!==s||(clearTimeout(n),a&&a(),t(new Error(`Connection failed with status: ${s}`)))};a=this.onConnectionStatusChange(s=>{"connected"===s?(clearTimeout(n),a&&a(),e(!0)):"error"!==s&&"auth_error"!==s||(clearTimeout(n),a&&a(),t(new Error(`Connection failed with status: ${s}`)))});try{r.connect(o),c()}catch(l){clearTimeout(n),a&&a(),i.error("[ChatWebSocket] Failed to connect:",l),this.setConnectionStatus("error");const e=l instanceof Error?l.message:"Unknown error";s.onError&&s.onError(e),t(new Error(e))}})}disconnectFromRoom(e){if(!this.activeSubscriptions.has(e))return void i.warn("[ChatWebSocket] Already disconnected from room",e);const s=`chat_${e}`,t=this.subscriptions.get(s);t&&(r.unsubscribe(t),this.subscriptions.delete(s)),this.activeSubscriptions.delete(e);const a=e,n=this.typingTimeouts.get(a);n&&(clearTimeout(n),this.typingTimeouts.delete(a))}disconnectFromChat(){this.subscriptions.forEach(e=>{r.unsubscribe(e)}),this.subscriptions.clear(),this.clearAllTypingTimeouts()}disconnect(){this.clearAllTypingTimeouts(),this.subscriptions.forEach(e=>{r.unsubscribe(e)}),this.subscriptions.clear(),this.activeSubscriptions.clear(),this.connectionUnsubscribe&&(this.connectionUnsubscribe(),this.connectionUnsubscribe=null),this.authErrorUnsubscribe&&(this.authErrorUnsubscribe(),this.authErrorUnsubscribe=null),this.eventHandlers={},r.disconnect(),this.setConnectionStatus("disconnected")}sendGeneralMessage(e){e&&0!==e.trim().length?r.send({type:"chat_message",data:{content:e}}):i.warn("[ChatWebSocketService] Attempt to send empty message")}sendRoomMessage(e,s){s&&0!==s.trim().length?r.send({type:"chat_message",data:{content:s}}):i.warn("[ChatWebSocketService] Attempt to send empty message")}sendTyping(e){r.send({type:"typing",data:{room_id:e}})}sendTypingStop(e){r.send({type:"typing_stop",data:{room_id:e}})}markMessageAsRead(e){r.send({type:"mark_read",data:{message_id:e}})}sendPinMessage(e,s){r.send({type:"pin_message",room_id:e,message_id:s})}sendLockChat(e){r.send({type:"lock_chat",room_id:e})}sendMuteUser(e,s){r.send({type:"mute_user",room_id:e,user_id:s})}validateMessage(e){if(!e||"object"!=typeof e)return{valid:!1,error:"Message is not an object"};if(!e.type||"string"!=typeof e.type)return{valid:!1,error:"Message type is missing or invalid"};switch(e.type){case"chat_message":if(!e.message||"object"!=typeof e.message)return{valid:!1,error:"chat_message must contain message object"};if(!e.message.id)return{valid:!1,error:"chat_message.message must have id"};if(!e.message.content&&!e.message.file&&!e.message.image)return{valid:!1,error:"chat_message.message must have content, file, or image"};break;case"typing":case"typing_stop":case"user_joined":case"user_left":if(!e.user||"object"!=typeof e.user)return{valid:!1,error:`${e.type} must contain user object`};break;case"room_history":if(!Array.isArray(e.messages))return{valid:!1,error:"room_history must contain messages array"};break;case"error":if(!e.error||"string"!=typeof e.error)return{valid:!1,error:"error message must contain error string"};break;case"message_sent":if("number"!=typeof e.message_id)return{valid:!1,error:"message_sent must contain numeric message_id"};if("delivered"!==e.status)return{valid:!1,error:'message_sent must have status "delivered"'}}return{valid:!0}}handleChatMessage(e){var s,t,a,n,r,o,c,l,d,u,m;i.debug("[ChatWebSocketService] Received message:",{type:e.type,hasMessage:!!e.message,messageId:null==(s=e.message)?void 0:s.id,hasHandler:!!this.eventHandlers.onMessage});const h=this.validateMessage(e);if(!h.valid)return i.error("[ChatWebSocketService] Invalid message structure:",{error:h.error,message:e}),void(this.eventHandlers.onError&&this.eventHandlers.onError(`Invalid message: ${h.error}`,"validation_error"));switch(e.type){case"chat_message":e.message&&this.eventHandlers.onMessage?(i.debug("[ChatWebSocketService] Calling onMessage handler for message ID:",e.message.id),this.eventHandlers.onMessage(e.message)):i.warn("[ChatWebSocketService] chat_message received but no handler or message data:",{hasMessage:!!e.message,hasHandler:!!this.eventHandlers.onMessage});break;case"typing":e.user&&this.eventHandlers.onTyping&&this.eventHandlers.onTyping(e.user);break;case"typing_stop":e.user&&this.eventHandlers.onTypingStop&&this.eventHandlers.onTypingStop(e.user);break;case"user_joined":e.user&&this.eventHandlers.onUserJoined&&this.eventHandlers.onUserJoined(e.user);break;case"user_left":e.user&&this.eventHandlers.onUserLeft&&this.eventHandlers.onUserLeft(e.user);break;case"room_history":e.messages&&this.eventHandlers.onRoomHistory&&this.eventHandlers.onRoomHistory(e.messages);break;case"error":i.error("[ChatWebSocketService] Server error received:",{error:e.error,code:e.code}),e.error&&this.eventHandlers.onError&&this.eventHandlers.onError(e.error,e.code),"auth_error"!==e.code&&"access_denied"!==e.code||this.setConnectionStatus("auth_error");break;case"message_sent":i.debug("[ChatWebSocketService] Message delivery confirmation:",{messageId:e.message_id,status:e.status}),e.message_id&&this.eventHandlers.onMessageDelivered&&this.eventHandlers.onMessageDelivered(e.message_id);break;case"message_pinned":i.debug("[ChatWebSocketService] Message pinned event:",{messageId:null==(t=e.data)?void 0:t.message_id,isPinned:null==(a=e.data)?void 0:a.is_pinned,threadId:null==(n=e.data)?void 0:n.thread_id}),e.data&&this.eventHandlers.onMessagePinned&&this.eventHandlers.onMessagePinned(e.data);break;case"chat_locked":i.debug("[ChatWebSocketService] Chat locked event:",{chatId:null==(r=e.data)?void 0:r.chat_id,isActive:null==(o=e.data)?void 0:o.is_active}),e.data&&this.eventHandlers.onChatLocked&&this.eventHandlers.onChatLocked(e.data);break;case"user_muted":i.debug("[ChatWebSocketService] User muted event:",{userId:null==(c=e.data)?void 0:c.user_id,isMuted:null==(l=e.data)?void 0:l.is_muted}),e.data&&this.eventHandlers.onUserMuted&&this.eventHandlers.onUserMuted(e.data);break;case"message_edited":if(i.debug("[ChatWebSocketService] Message edited event:",{messageId:e.message_id||(null==(d=e.data)?void 0:d.message_id),content:e.content||(null==(u=e.data)?void 0:u.content)}),this.eventHandlers.onMessageEdited){const s=e.data||{message_id:e.message_id,content:e.content,is_edited:e.is_edited,edited_at:e.edited_at};this.eventHandlers.onMessageEdited(s)}break;case"message_deleted":if(i.debug("[ChatWebSocketService] Message deleted event:",{messageId:e.message_id||(null==(m=e.data)?void 0:m.message_id)}),this.eventHandlers.onMessageDeleted){const s=e.data||{message_id:e.message_id};this.eventHandlers.onMessageDeleted(s)}break;default:i.warn("[ChatWebSocketService] Unknown message type:",e.type),this.eventHandlers.onError&&this.eventHandlers.onError(`Unknown message type: ${e.type}`,"unknown_type")}}resubscribeAll(){this.subscriptions.forEach((e,s)=>{const t=r.subscribe(s,e=>{this.handleChatMessage(e)});this.subscriptions.set(s,t)})}clearAllTypingTimeouts(){this.typingTimeouts.forEach(e=>{clearTimeout(e)}),this.typingTimeouts.clear()}startTypingTimer(e){const s=e||0,t=this.typingTimeouts.get(s);t&&clearTimeout(t);const a=setTimeout(()=>{this.sendTypingStop(e),this.typingTimeouts.delete(s)},3e3);this.typingTimeouts.set(s,a)}isConnected(){return r.isConnected()}onConnectionChange(e){r.onConnectionChange(e)}getReconnectionInfo(){return r.getReconnectionInfo()}retryConnection(){i.info("[ChatWebSocket] Manual retry connection requested"),r.retryConnection()}},De=Ce,Qe=_e;t.forwardRef(({className:e,inset:s,children:t,...n},r)=>a.jsxs(Te,{ref:r,className:l("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent focus:bg-accent",s&&"pl-8",e),...n,children:[t,a.jsx(V,{className:"ml-auto h-4 w-4"})]})).displayName=Te.displayName;t.forwardRef(({className:e,...s},t)=>a.jsx(Ie,{ref:t,className:l("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...s})).displayName=Ie.displayName;const qe=t.forwardRef(({className:e,sideOffset:s=4,...t},n)=>a.jsx(ke,{children:a.jsx(Se,{ref:n,sideOffset:s,className:l("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...t})}));qe.displayName=Se.displayName;const Le=t.forwardRef(({className:e,inset:s,...t},n)=>a.jsx(Ee,{ref:n,className:l("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",s&&"pl-8",e),...t}));Le.displayName=Ee.displayName;t.forwardRef(({className:e,children:s,checked:t,...n},r)=>a.jsxs(Fe,{ref:r,className:l("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",e),checked:t,...n,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(Pe,{children:a.jsx(Y,{className:"h-4 w-4"})})}),s]})).displayName=Fe.displayName;t.forwardRef(({className:e,children:s,...t},n)=>a.jsxs(Ae,{ref:n,className:l("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",e),...t,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(Pe,{children:a.jsx(X,{className:"h-2 w-2 fill-current"})})}),s]})).displayName=Ae.displayName;t.forwardRef(({className:e,inset:s,...t},n)=>a.jsx(He,{ref:n,className:l("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",e),...t})).displayName=He.displayName;const Re=t.forwardRef(({className:e,...s},t)=>a.jsx(Me,{ref:t,className:l("-mx-1 my-1 h-px bg-muted",e),...s}));Re.displayName=Me.displayName;const Ke=({messageId:e,isOwner:s,canModerate:t=!1,onEdit:n,onDelete:r,onPin:i,isPinned:o=!1,disabled:c=!1})=>s||t?a.jsxs(De,{children:[a.jsx(Qe,{asChild:!0,children:a.jsxs(d,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",disabled:c,children:[a.jsx(Z,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Действия с сообщением"})]})}),a.jsxs(qe,{align:"end",children:[s&&a.jsxs(Le,{onClick:n,children:[a.jsx(ee,{className:"mr-2 h-4 w-4"}),"Редактировать"]}),t&&i&&a.jsxs(a.Fragment,{children:[s&&a.jsx(Re,{}),a.jsxs(Le,{onClick:i,children:[a.jsx(se,{className:"mr-2 h-4 w-4"}),o?"Открепить":"Закрепить"]})]}),(s||t)&&a.jsxs(a.Fragment,{children:[a.jsx(Re,{}),a.jsxs(Le,{onClick:r,className:"text-destructive focus:text-destructive",children:[a.jsx(te,{className:"mr-2 h-4 w-4"}),"Удалить"]})]})]})]}):null,$e=({isOpen:e,onClose:s,messageContent:n,onSave:r,isLoading:i=!1})=>{const[o,c]=t.useState(n),[l,v]=t.useState(null);t.useEffect(()=>{e&&(c(n),v(null))},[e,n]);const y=o.trim()===n.trim(),b=()=>{const e=o.trim();e?e.length>5e3?v("Сообщение слишком длинное (максимум 5000 символов)"):e!==n.trim()?r(e):s():v("Сообщение не может быть пустым")};return a.jsx(u,{open:e,onOpenChange:e=>!e&&s(),children:a.jsxs(m,{className:"sm:max-w-[500px]",children:[a.jsxs(h,{children:[a.jsx(g,{children:"Редактировать сообщение"}),a.jsx(x,{children:"Измените текст сообщения. Нажмите Ctrl+Enter для сохранения."})]}),a.jsxs("div",{className:"py-4",children:[a.jsx(p,{value:o,onChange:e=>{c(e.target.value),v(null)},onKeyDown:e=>{"Enter"===e.key&&e.ctrlKey&&(e.preventDefault(),y||b())},placeholder:"Введите сообщение...",className:"min-h-[100px] resize-none",disabled:i,autoFocus:!0}),l&&a.jsx("p",{className:"text-sm text-destructive mt-2",children:l}),y&&!l&&a.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Сообщение не изменено"}),a.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:[o.length,"/5000 символов"]})]}),a.jsxs(f,{children:[a.jsx(d,{variant:"outline",onClick:s,disabled:i,children:"Отмена"}),a.jsx(d,{onClick:b,disabled:i||y,children:i?a.jsxs(a.Fragment,{children:[a.jsx(ae,{className:"mr-2 h-4 w-4 animate-spin"}),"Сохранение..."]}):"Сохранить"})]})]})})},Oe=({chat:e,selected:s,onClick:t,currentUserId:n})=>{var r,i;const o=e.participants.filter(e=>e.id!==n).map(e=>e.full_name.charAt(0)).join("").toUpperCase()||"C",c=e.participants.filter(e=>e.id!==n).map(e=>e.full_name).join(", "),l=e.name||c||"Чат",d=(null==(r=e.last_message)?void 0:r.content)||"Нет сообщений",u=(null==(i=e.last_message)?void 0:i.created_at)?new Date(e.last_message.created_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}):"";return a.jsx("div",{onClick:t,"data-testid":"chat-item",className:"p-3 rounded-lg cursor-pointer transition-colors border "+(s?"bg-primary/10 border-primary":"border-transparent hover:bg-muted"),children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx(U,{className:"w-10 h-10",children:a.jsx(W,{className:"gradient-primary text-primary-foreground",children:o})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("div",{className:"font-medium truncate text-sm",children:l}),e.unread_count>0&&a.jsx(K,{variant:"destructive",className:"ml-2 text-xs",children:e.unread_count})]}),e.subject&&a.jsx("p",{className:"text-xs text-muted-foreground mb-1 truncate",children:e.subject.name}),a.jsx("p",{className:"text-xs text-muted-foreground truncate",children:d}),u&&a.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:u})]})]})})},ze=({chats:e,selectedChat:s,onSelectChat:n,searchQuery:r,onSearchChange:i,isLoading:o,currentUserId:c})=>{const l=t.useMemo(()=>{if(!r)return e;const s=r.toLowerCase();return e.filter(e=>{var t,a;return e.name.toLowerCase().includes(s)||(null==(a=null==(t=e.subject)?void 0:t.name)?void 0:a.toLowerCase().includes(s))||e.participants.some(e=>e.full_name.toLowerCase().includes(s))})},[e,r]);return a.jsxs(F,{className:"p-4 md:col-span-1 flex flex-col h-full overflow-hidden","data-testid":"chat-list",children:[a.jsxs("div",{className:"relative mb-4 flex-shrink-0",children:[a.jsx(re,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),a.jsx(P,{placeholder:"Поиск чатов...",className:"pl-10 text-sm",value:r,onChange:e=>i(e.target.value),"data-testid":"chat-search"})]}),a.jsx(A,{className:"flex-1 min-h-0",children:a.jsx("div",{className:"space-y-2 pr-4",children:o?a.jsxs(a.Fragment,{children:[a.jsx(H,{className:"h-20 rounded-lg","data-testid":"chat-list-skeleton"}),a.jsx(H,{className:"h-20 rounded-lg","data-testid":"chat-list-skeleton"}),a.jsx(H,{className:"h-20 rounded-lg","data-testid":"chat-list-skeleton"})]}):0===l.length?a.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center","data-testid":"no-chats-message",children:[a.jsx(ie,{className:"h-12 w-12 text-gray-400 mb-4"}),a.jsx("h3",{className:"text-lg font-medium",children:"Нет чатов"}),a.jsx("p",{className:"text-gray-500",children:r?"Чатов не найдено":"У вас пока нет доступных чатов. Начните общение!"})]}):l.map(e=>a.jsx(Oe,{chat:e,selected:(null==s?void 0:s.id)===e.id,onClick:()=>n(e),currentUserId:c},e.id))})})]})},Be=({chat:e,messages:s,isLoadingMessages:n,isSending:r,onSendMessage:i,isConnected:o,typingUsers:c,error:u,onRetryConnection:m,onEditMessage:h,onDeleteMessage:g,onPinMessage:x,onLockChat:p,isEditingOrDeleting:f,currentUserId:y,currentUserRole:b,fetchNextPage:j,hasNextPage:N,isFetchingNextPage:w,isSwitchingChat:C=!1})=>{const{toast:_}=v(),[k,S]=t.useState(""),[E,M]=t.useState(null),T=t.useRef(null),I=t.useRef(null),A="admin"===b,D=e&&!e.is_active,Q=t.useCallback(()=>{N&&!w&&j&&j()},[N,w,j]),q=t.useCallback(e=>{e.target.scrollTop<100&&Q()},[Q]),L=()=>{!k.trim()&&!E||r||(i(k.trim(),E||void 0),S(""),M(null),T.current&&(T.current.value=""))};if(!e)return a.jsxs(F,{className:"p-6 md:col-span-2 flex flex-col items-center justify-center h-full overflow-hidden","data-testid":"chat-window-empty",children:[a.jsx(oe,{className:"h-12 w-12 text-gray-400 mb-4"}),a.jsx("h3",{className:"text-lg font-medium",children:"Выберите чат"}),a.jsx("p",{className:"text-gray-500",children:"Выберите чат из списка слева для начала общения"})]});const R=e.participants.filter(e=>e.id!==y).map(e=>e.full_name).join(", "),K=e.name||R||"Чат";return a.jsxs(F,{className:"p-6 md:col-span-2 flex flex-col h-full overflow-hidden","data-testid":"chat-window",children:[u&&a.jsxs("div",{className:"mb-4 p-3 bg-destructive/10 border border-destructive/20 rounded-lg flex items-center gap-3 flex-shrink-0",children:[a.jsx(ce,{className:"w-5 h-5 text-destructive"}),a.jsx("div",{className:"flex-1",children:a.jsx("p",{className:"text-sm text-destructive font-medium",children:u})}),a.jsx(d,{type:"button",size:"sm",variant:"outline",onClick:m,className:"text-xs",children:"Повторить"})]}),a.jsxs("div",{className:"flex items-center gap-3 pb-4 border-b flex-shrink-0","data-testid":"chat-header",children:[a.jsx(U,{className:"w-10 h-10",children:a.jsx(W,{className:"gradient-primary text-primary-foreground",children:e.participants.filter(e=>e.id!==y).map(e=>e.full_name.charAt(0)).join("").toUpperCase()||"C"})}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"font-bold text-sm",children:K}),D&&a.jsxs("div",{className:"flex items-center gap-1 px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800",children:[a.jsx(le,{className:"w-3 h-3"}),a.jsx("span",{className:"text-xs",children:"Заблокирован"})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[o?a.jsx(de,{className:"w-3 h-3 text-green-500"}):a.jsx(ue,{className:"w-3 h-3 text-red-500"}),a.jsx("span",{className:l("text-xs px-2 py-0.5 rounded-full",o?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:o?"Онлайн":"Оффлайн"})]}),["teacher","tutor","admin"].includes(b)&&p&&a.jsx(d,{variant:"ghost",size:"sm",onClick:()=>p(e.id),title:e.is_active?"Заблокировать чат":"Разблокировать чат",className:"h-7 w-7 p-0",children:e.is_active?a.jsx(le,{className:"h-4 w-4"}):a.jsx(me,{className:"h-4 w-4"})})]}),e.subject&&a.jsx("div",{className:"text-xs text-muted-foreground",children:e.subject.name}),e.participants.length>1&&a.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.participants.filter(e=>e.id!==y).length," ","участник(и)"]})]})]}),a.jsx("div",{ref:I,className:"flex-1 overflow-y-auto py-4 pr-4 min-h-0",onScroll:q,children:a.jsxs("div",{className:"space-y-4",children:[w&&a.jsxs("div",{className:"flex items-center justify-center py-2",children:[a.jsx(ae,{className:"w-4 h-4 animate-spin text-muted-foreground mr-2"}),a.jsx("span",{className:"text-sm text-muted-foreground",children:"Загрузка старых сообщений..."})]}),C||n?a.jsxs("div",{className:"space-y-4","data-testid":"messages-loading",children:[a.jsx(H,{className:"h-12 rounded w-[70%]"}),a.jsx(H,{className:"h-12 rounded w-[70%] ml-auto"}),a.jsx(H,{className:"h-12 rounded w-[70%]"}),a.jsxs("div",{className:"flex items-center justify-center py-4",children:[a.jsx(ae,{className:"w-4 h-4 animate-spin text-muted-foreground mr-2"}),a.jsx("span",{className:"text-sm text-muted-foreground",children:C?"Переключение чата...":"Загрузка сообщений..."})]})]}):0===s.length?a.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center",children:[a.jsx(he,{className:"h-12 w-12 text-gray-400 mb-4"}),a.jsx("h3",{className:"text-lg font-medium",children:"Нет сообщений"}),a.jsx("p",{className:"text-gray-500",children:"Напишите первое сообщение в этом чате!"})]}):s.map(s=>{const t=s.sender.id===y,n=(()=>{const s=b,t=null==e?void 0:e.type;return"teacher"===s||("tutor"===s&&"forum_tutor"===t||"admin"===s)})();return a.jsx("div",{className:`flex ${t?"justify-end":"justify-start"} group`,children:a.jsxs("div",{className:"max-w-[70%] p-3 rounded-lg relative "+(t?"bg-primary text-primary-foreground":"bg-muted"),children:[!t&&a.jsxs("p",{className:"text-xs font-medium mb-1 opacity-75 flex items-center gap-1",children:[s.sender.full_name,s.is_pinned&&a.jsx(se,{className:"h-3 w-3 text-yellow-500",title:"Закрепленное сообщение"})]}),t&&s.is_pinned&&a.jsx("div",{className:"absolute top-1 left-1",children:a.jsx(se,{className:"h-3 w-3 text-yellow-500",title:"Закрепленное сообщение"})}),a.jsx("p",{className:"text-sm break-words pr-6",children:s.content}),s.is_image&&(s.image_url||s.image)&&a.jsx("div",{className:"mt-2",children:a.jsx("a",{href:s.image_url||s.image,target:"_blank",rel:"noopener noreferrer",children:a.jsx("img",{src:s.image_url||s.image,alt:s.file_name||"Image",className:"max-w-xs rounded border cursor-pointer hover:opacity-90 transition-opacity"})})}),(s.file_url||s.file)&&!s.is_image&&a.jsxs("div",{className:"mt-2 flex items-center gap-2 p-2 bg-background/10 rounded border",children:[a.jsx(ge,{className:"w-4 h-4"}),a.jsx("a",{href:s.file_url||s.file,target:"_blank",rel:"noopener noreferrer",className:"text-sm hover:underline flex-1 truncate",children:s.file_name||"Файл"}),a.jsx(xe,{className:"w-4 h-4"})]}),a.jsxs("div",{className:"text-xs mt-1 flex items-center gap-1 "+(t?"text-primary-foreground/70":"text-muted-foreground"),children:[s.is_edited&&a.jsx("span",{className:"italic",children:"(ред.)"}),new Date(s.created_at).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})]}),a.jsx("div",{className:"absolute top-2 right-2",children:a.jsx(Ke,{messageId:s.id,isOwner:t,canModerate:n,onEdit:()=>h(s.id,s.content),onDelete:()=>g(s.id),onPin:x?()=>x(s.id):void 0,isPinned:s.is_pinned,disabled:f})})]})},s.id)})]})}),a.jsx("div",{className:"pt-4 border-t flex-shrink-0",children:A||D?a.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg border border-muted-foreground/20 flex items-center justify-center gap-2",children:[a.jsx(le,{className:"w-4 h-4 text-muted-foreground"}),a.jsx("span",{className:"text-sm text-muted-foreground",children:D?"Чат заблокирован модератором":"Доступ только для чтения"})]}):a.jsxs(a.Fragment,{children:[E&&a.jsxs("div",{className:"mb-2 flex items-center gap-2 p-2 bg-muted rounded-lg border",children:[E.type.startsWith("image/")?a.jsx(pe,{className:"w-4 h-4 text-muted-foreground"}):a.jsx(ge,{className:"w-4 h-4 text-muted-foreground"}),a.jsxs("span",{className:"text-sm flex-1 truncate",children:[E.name," (",($=E.size,$<1024?$+" B":$<1048576?($/1024).toFixed(1)+" KB":($/1048576).toFixed(1)+" MB"),")"]}),a.jsx(d,{type:"button",variant:"ghost",size:"sm",onClick:()=>{M(null),T.current&&(T.current.value="")},className:"h-6 w-6 p-0",children:a.jsx(fe,{className:"w-4 h-4"})})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("input",{type:"file",ref:T,onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];if(t){const e=10485760;if(t.size>e)return void _({variant:"destructive",title:"Файл слишком большой",description:"Максимальный размер файла: 10 МБ"});M(t)}},accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.zip",style:{display:"none"},"data-testid":"file-input-hidden"}),a.jsx(d,{type:"button",variant:"ghost",size:"sm",onClick:()=>{var e;return null==(e=T.current)?void 0:e.click()},disabled:r,className:"shrink-0","data-testid":"file-attach-button",children:a.jsx(ve,{className:"w-4 h-4"})}),a.jsx(P,{placeholder:"Введите сообщение...",value:k,onChange:s=>{return t=s.target.value,S(t),void(t.trim()&&o&&e&&(We.sendTyping(e.id),We.startTypingTimer(e.id)));var t},onKeyPress:e=>{"Enter"===e.key&&!e.shiftKey&&k.trim()&&(e.preventDefault(),L())},disabled:r,className:"text-sm"}),a.jsx(d,{type:"button",onClick:L,disabled:r||!k.trim()&&!E,className:"gradient-primary",children:r?a.jsx(ae,{className:"w-4 h-4 animate-spin"}):a.jsx(ye,{className:"w-4 h-4"})})]}),!o&&a.jsx("div",{className:"pt-2 text-xs text-muted-foreground text-center",children:"Сообщения будут отправлены при восстановлении соединения"})]})})]});var $},Ge=({isOpen:e,onClose:s,onChatInitiated:n})=>{const[r,o]=t.useState(""),[c,p]=t.useState("all"),{toast:f}=v(),y=$(),{data:b=[],isLoading:j,error:N,refetch:w}=O({queryKey:["available-contacts"],queryFn:G.getAvailableContacts,enabled:e,retry:2}),C=z({mutationFn:({contactUserId:e,subjectId:s})=>G.initiateChat(e,s),onSuccess:e=>{i.debug("[ContactSearchModal] Chat initiated successfully:",e),y.invalidateQueries({queryKey:["forum","chats"]}),f({title:e.created?"Чат создан":"Чат найден",description:e.created?"Новый чат успешно создан":"Вы перешли к существующему чату"}),n(e.chat.id),s()},onError:e=>{i.error("[ContactSearchModal] Error initiating chat:",e);const s=e.message||"Ошибка при создании чата";f({title:"Ошибка",description:s,variant:"destructive"})}}),_=t.useMemo(()=>{let e=b;if("all"!==c&&(e=e.filter(e=>e.role===c)),r.trim()){const s=r.toLowerCase();e=e.filter(e=>e.first_name.toLowerCase().includes(s)||e.last_name.toLowerCase().includes(s)||e.email.toLowerCase().includes(s))}return e},[b,r,c]);t.useEffect(()=>{e||(o(""),p("all"))},[e]);const k=t.useMemo(()=>{const e=new Set(b.map(e=>e.role));return Array.from(e)},[b]);return a.jsx(u,{open:e,onOpenChange:s,children:a.jsxs(m,{className:"max-w-2xl max-h-[80vh] flex flex-col",children:[a.jsxs(h,{children:[a.jsx(g,{children:"Начать новый чат"}),a.jsx(x,{children:"Выберите пользователя для начала общения"})]}),a.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[a.jsxs("div",{className:"relative flex-1",children:[a.jsx(re,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),a.jsx(P,{placeholder:"Поиск по имени или email...",className:"pl-10",value:r,onChange:e=>o(e.target.value),autoFocus:!0})]}),a.jsx("div",{className:"w-full sm:w-[200px]",children:a.jsxs(D,{value:c,onValueChange:p,children:[a.jsx(Q,{className:"w-full",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(be,{className:"w-4 h-4 text-muted-foreground"}),a.jsx(q,{placeholder:"Все роли"})]})}),a.jsxs(L,{children:[a.jsx(R,{value:"all",children:"Все роли"}),k.includes("student")&&a.jsx(R,{value:"student",children:"Студенты"}),k.includes("teacher")&&a.jsx(R,{value:"teacher",children:"Преподаватели"}),k.includes("tutor")&&a.jsx(R,{value:"tutor",children:"Тьюторы"}),k.includes("parent")&&a.jsx(R,{value:"parent",children:"Родители"})]})]})})]}),a.jsx(A,{className:"flex-1 pr-4 mt-4",children:j?a.jsx("div",{className:"space-y-3","data-testid":"contacts-skeleton",children:[...Array(5)].map((e,s)=>a.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg border animate-pulse",children:[a.jsx(H,{className:"w-10 h-10 rounded-full"}),a.jsxs("div",{className:"flex-1 space-y-2",children:[a.jsx(H,{className:"h-4 w-32"}),a.jsx(H,{className:"h-3 w-48"}),a.jsx(H,{className:"h-3 w-24"})]}),a.jsx(H,{className:"h-8 w-24 rounded"})]},`contact-skeleton-${s}`))}):N?a.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center","data-testid":"contacts-error",children:[a.jsx(ce,{className:"w-12 h-12 text-destructive mb-3"}),a.jsx("p",{className:"text-sm font-medium text-foreground mb-2",children:"Не удалось загрузить контакты"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-4",children:"Проверьте подключение к интернету"}),a.jsxs(d,{type:"button",variant:"outline",size:"sm",onClick:()=>{w()},className:"gap-2",children:[a.jsx(ae,{className:"w-4 h-4"}),"Повторить попытку"]})]}):0===_.length?a.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center","data-testid":"contacts-empty",children:[a.jsx(he,{className:"w-12 h-12 text-muted-foreground mb-3"}),a.jsx("p",{className:"text-sm font-medium text-foreground mb-1",children:r||"all"!==c?"Контактов не найдено":"Нет доступных контактов"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:r||"all"!==c?"Попробуйте изменить фильтры поиска":"У вас пока нет контактов для общения"})]}):a.jsx("div",{className:"space-y-2","data-testid":"contacts-list",children:_.map(e=>{const t=`${e.first_name.charAt(0)}${e.last_name.charAt(0)}`.toUpperCase(),r=`${e.first_name} ${e.last_name}`.trim();return a.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg border hover:bg-muted/50 hover:border-primary/50 transition-all duration-200 group","data-testid":"contact-item",children:[a.jsx(U,{className:"w-10 h-10 ring-2 ring-transparent group-hover:ring-primary/20 transition-all",children:a.jsx(W,{className:"gradient-primary text-primary-foreground font-semibold text-sm",children:t})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx("p",{className:"font-medium text-sm truncate",children:r}),a.jsx(K,{variant:(e=>{switch(e){case"teacher":return"default";case"tutor":return"secondary";default:return"outline"}})(e.role),className:"text-xs shrink-0",children:(e=>{switch(e){case"teacher":return"Преподаватель";case"tutor":return"Тьютор";case"student":return"Студент";case"parent":return"Родитель";default:return e}})(e.role)}),e.has_active_chat&&a.jsx(je,{className:"w-3 h-3 text-green-500 shrink-0",title:"Активный чат"})]}),a.jsx("p",{className:"text-xs text-muted-foreground truncate mb-0.5",children:e.email}),e.subject&&a.jsxs("p",{className:"text-xs text-muted-foreground truncate flex items-center gap-1",children:[a.jsx("span",{className:"inline-block w-1.5 h-1.5 rounded-full bg-primary/50"}),e.subject.name]})]}),a.jsx(d,{type:"button",size:"sm",variant:e.has_active_chat?"default":"outline",onClick:()=>(e=>{var t,a;if(e.has_active_chat&&e.chat_id)return n(e.chat_id),void s();"teacher"!==e.role||(null==(t=e.subject)?void 0:t.id)?C.mutate({contactUserId:e.id,subjectId:null==(a=e.subject)?void 0:a.id}):f({title:"Ошибка",description:"Не удалось создать чат: предмет не найден",variant:"destructive"})})(e),disabled:C.isPending,className:l("shrink-0 transition-all duration-200",e.has_active_chat?"bg-primary text-primary-foreground hover:bg-primary/90":"hover:bg-primary hover:text-primary-foreground"),children:C.isPending?a.jsx(ae,{className:"w-4 h-4 animate-spin"}):e.has_active_chat?a.jsxs(a.Fragment,{children:[a.jsx(he,{className:"w-4 h-4 mr-1"}),"Продолжить"]}):a.jsxs(a.Fragment,{children:[a.jsx(ne,{className:"w-4 h-4 mr-1"}),"Начать чат"]})})]},e.id)})})})]})})},Je=e=>e instanceof Error?e.message:"string"==typeof e?e:e&&"object"==typeof e&&"message"in e?String(e.message):"Произошла ошибка";function Ve(){var e;const{user:s,signOut:r}=n();Ue();const{toast:o}=v(),[c,l]=t.useState(null),[u,m]=t.useState(""),[h,g]=t.useState(!1),[x,p]=t.useState([]),[f,F]=t.useState(null),[P,A]=t.useState(!1),[H,U]=t.useState(!1),W=$(),D=t.useRef(new Map),Q=t.useRef(null),q=t.useRef(!0),[L,R]=t.useState(null),[K,V]=t.useState(null),[Y,X]=t.useState(!1);t.useEffect(()=>(q.current=!0,()=>{q.current=!1}),[]);const{chats:Z=[],isLoadingChats:ee}=(()=>{const e=$(),s=O({queryKey:["forum","chats"],queryFn:async()=>{var e,s;try{return await G.getForumChats()}catch(f){const a=(null==(s=null==(e=null==f?void 0:f.response)?void 0:e.data)?void 0:s.detail)||(null==f?void 0:f.message)||"Не удалось загрузить список чатов";throw new Error(a)}},staleTime:6e4,retry:(e,s)=>!(s.message.includes("401")||s.message.includes("403")||s.message.includes("авторизован")||s.message.includes("доступ"))&&e<2,refetchOnMount:!0,refetchOnWindowFocus:!1}),t=O({queryKey:["forum","available-contacts"],queryFn:async()=>{var e,s;try{return await G.getAvailableContacts()}catch(f){const a=(null==(s=null==(e=null==f?void 0:f.response)?void 0:e.data)?void 0:s.detail)||(null==f?void 0:f.message)||"Не удалось загрузить контакты";throw new Error(a)}},staleTime:3e5,retry:(e,s)=>!s.message.includes("401")&&!s.message.includes("403")&&e<2,refetchOnMount:!0,refetchOnWindowFocus:!1}),a=z({mutationFn:({contactUserId:e,subjectId:s})=>G.initiateChat(e,s),onSuccess:()=>{e.invalidateQueries({queryKey:["forum","chats"]}),e.invalidateQueries({queryKey:["forum","available-contacts"]})}});return s.isLoading,s.isFetching,s.isError,Array.isArray(s.data)&&s.data.length,s.error,t.isLoading,t.isError,Array.isArray(t.data)&&t.data.length,t.error,a.isPending,a.isError,a.error,{chats:s.data||[],isLoadingChats:s.isLoading,chatsError:s.error,availableContacts:t.data||[],isLoadingContacts:t.isLoading,contactsError:t.error,initiateChat:(e,s)=>a.mutateAsync({contactUserId:e,subjectId:s}),isInitiatingChat:a.isPending,initiateError:a.error,clearInitiateError:()=>a.reset()}})(),se=(te=(null==c?void 0:c.id)||null,B({queryKey:["forum-messages",te],queryFn:async({pageParam:e=0,signal:s})=>{var t,a;if(!te)throw new Error("Chat ID is required");try{return await G.getForumMessages(te,50,e,s)}catch(f){if("AbortError"===f.name)throw f;const s=(null==(a=null==(t=null==f?void 0:f.response)?void 0:t.data)?void 0:a.detail)||(null==f?void 0:f.message)||"Не удалось загрузить сообщения";throw new Error(s)}},getNextPageParam:(e,s)=>{const t=s.flat().length;return 50===e.length?t:void 0},initialPageParam:0,enabled:!!te&&te>0,staleTime:6e4,refetchOnMount:"stale",refetchOnWindowFocus:!1,retry:(e,s)=>!(s.message.includes("401")||s.message.includes("403")||s.message.includes("авторизован")||s.message.includes("доступ"))&&e<2}));var te;const ae=t.useMemo(()=>{var e;return(null==(e=se.data)?void 0:e.pages)?se.data.pages.flat():[]},[null==(e=se.data)?void 0:e.pages]),re=se.isLoading,{fetchNextPage:ie,hasNextPage:oe,isFetchingNextPage:ce}=se,le=(()=>{const e=$(),{user:s}=n(),{toast:t}=n();return z({mutationFn:async({chatId:e,data:s,file:t})=>{var a,n;try{return await G.sendForumMessage(e,{...s,file:t})}catch(f){const s=(null==(n=null==(a=null==f?void 0:f.response)?void 0:a.data)?void 0:n.detail)||(null==f?void 0:f.message)||"Не удалось отправить сообщение";throw new Error(s)}},onMutate:async({chatId:t,data:a,file:n})=>{await e.cancelQueries({queryKey:["forum-messages",t]});const r=e.getQueryData(["forum-messages",t]),i=-Date.now(),o=s,c={id:i,content:a.content,sender:{id:(null==o?void 0:o.id)||0,full_name:(null==o?void 0:o.first_name)&&(null==o?void 0:o.last_name)?`${o.first_name} ${o.last_name}`.trim():(null==o?void 0:o.email)||"Вы",role:(null==o?void 0:o.role)||""},created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),is_read:!1,is_edited:!1,message_type:n?"file":"text",file_name:null==n?void 0:n.name,file_type:null==n?void 0:n.type,is_image:!!n&&n.type.startsWith("image/")};return e.setQueryData(["forum-messages",t],e=>{if(!e||!e.pages||!Array.isArray(e.pages))return{pages:[[c]],pageParams:[0]};const s=[...e.pages],t=s.length-1;return s[t]=[...s[t],c],{pages:s,pageParams:e.pageParams}}),{previousMessages:r,tempId:i,timestamp:Date.now()}},onSuccess:(s,t,a)=>{e.setQueryData(["forum-messages",t.chatId],e=>e&&e.pages&&Array.isArray(e.pages)?{pages:e.pages.map(e=>{const t=e.filter(e=>e.id!==(null==a?void 0:a.tempId)),n=e.some(e=>e.id===(null==a?void 0:a.tempId)),r=e.some(e=>e.id===s.id);return n&&!r?[...t,s]:t}),pageParams:e.pageParams}:{pages:[[s]],pageParams:[0]}),e.setQueriesData({queryKey:["forum","chats"]},e=>e&&Array.isArray(e)?e.map(e=>e.id===t.chatId?{...e,last_message:s}:e):e),J.success("Сообщение отправлено")},onError:(s,t,a)=>{(null==a?void 0:a.previousMessages)&&e.setQueryData(["forum-messages",t.chatId],a.previousMessages),J.error(`Ошибка отправки сообщения: ${s.message}`)}})})(),de=(({chatId:e,onSuccess:s,onError:t})=>{const a=$();return z({mutationFn:({messageId:s,data:t})=>G.editForumMessage(e,s,t),onMutate:async({messageId:s,data:t})=>{await a.cancelQueries({queryKey:["forum-messages",e]});const n=a.getQueriesData({queryKey:["forum-messages",e]});return a.setQueriesData({queryKey:["forum-messages",e],exact:!1},e=>null==e?void 0:e.map(e=>e.id===s?{...e,content:t.content,is_edited:!0,updated_at:(new Date).toISOString()}:e)),{previousQueries:n}},onError:(e,s,n)=>{(null==n?void 0:n.previousQueries)&&n.previousQueries.forEach(([e,s])=>{a.setQueryData(e,s)}),J.error("Не удалось отредактировать сообщение"),null==t||t(e)},onSuccess:e=>{J.success("Сообщение отредактировано"),null==s||s(e)},onSettled:()=>{a.invalidateQueries({queryKey:["forum-messages",e]}),a.invalidateQueries({queryKey:["forum","chats"]})}})})({chatId:(null==c?void 0:c.id)||0,onSuccess:()=>{F(null),R(null)},onError:e=>{R(null),o({variant:"destructive",title:"Ошибка редактирования",description:Je(e)||"Не удалось отредактировать сообщение"})}}),ue=(({chatId:e,onSuccess:s,onError:t})=>{const a=$();return z({mutationFn:s=>G.deleteForumMessage(e,s),onMutate:async s=>{await a.cancelQueries({queryKey:["forum-messages",e]});const t=a.getQueriesData({queryKey:["forum-messages",e]});return a.setQueriesData({queryKey:["forum-messages",e],exact:!1},e=>null==e?void 0:e.filter(e=>e.id!==s)),{previousQueries:t}},onError:(e,s,n)=>{(null==n?void 0:n.previousQueries)&&n.previousQueries.forEach(([e,s])=>{a.setQueryData(e,s)}),J.error("Не удалось удалить сообщение"),null==t||t(e)},onSuccess:()=>{J.success("Сообщение успешно удалено"),null==s||s()},onSettled:()=>{a.invalidateQueries({queryKey:["forum-messages",e]}),a.invalidateQueries({queryKey:["forum","chats"]})}})})({chatId:(null==c?void 0:c.id)||0,onSuccess:()=>{F(null),V(null),X(!1)},onError:e=>{V(null),X(!1),o({variant:"destructive",title:"Ошибка удаления",description:Je(e)||"Не удалось удалить сообщение"})}}),me=t.useCallback(e=>{try{if(i.debug("[Forum] WebSocket message received in component handler:",{messageId:e.id,content:e.content.substring(0,50),senderId:e.sender.id,selectedChatId:null==c?void 0:c.id}),!c)return void i.warn("[Forum] Received message but no chat selected");const s={id:e.id,content:e.content,sender:{id:e.sender.id,full_name:`${e.sender.first_name} ${e.sender.last_name}`.trim()||e.sender.username,role:e.sender.role},created_at:e.created_at,updated_at:e.updated_at,is_read:e.is_read,is_edited:e.is_edited||!1,message_type:e.message_type};i.debug("[Forum] Updating TanStack Query cache for chat:",c.id),W.setQueriesData({queryKey:["forum-messages",c.id],exact:!1},e=>{if(!e||!e.pages)return i.debug("[Forum] No existing data, creating new InfiniteData with message"),{pages:[[s]],pageParams:[0]};if(e.pages.some(e=>e.some(e=>e.id===s.id)))return i.debug("[Forum] Message already exists in cache, skipping"),e;i.debug("[Forum] Adding new message to last page of InfiniteData");const t=[...e.pages],a=t.length-1;return t[a]=[...t[a],s],{...e,pages:t}}),W.invalidateQueries({queryKey:["forum","chats"]}),F(null)}catch(s){i.error("[Forum] WebSocket handler error:",s),o({variant:"destructive",title:"Ошибка обработки сообщения",description:"Не удалось обработать полученное сообщение"}),F("Ошибка обработки сообщения")}},[c,W]),he=t.useCallback((e,s)=>{p(s=>[...s.filter(s=>s.id!==e.id),e]),null==s||s.toString();const t=D.current.get(e.id);t&&clearTimeout(t);const a=setTimeout(()=>{p(s=>s.filter(s=>s.id!==e.id)),D.current.delete(e.id)},3e3);D.current.set(e.id,a)},[]),ge=t.useCallback(e=>{p(s=>s.filter(s=>s.id!==e.id));const s=D.current.get(e.id);s&&(clearTimeout(s),D.current.delete(e.id))},[]),xe=t.useCallback(e=>{i.error("WebSocket error:",e),F(e)},[]);t.useEffect(()=>{if(!c||!s)return;const e=c.id;let t=!0;i.debug("[Forum] Chat selected, setting up WebSocket for chat:",e);const a={onMessage:me,onTyping:he,onTypingStop:ge,onError:xe};(async()=>{try{if(!t)return void i.debug("[Forum] Effect unmounted, skipping WebSocket connection");i.debug("[Forum] Connecting to chat room:",e);await We.connectToRoom(e,a)?(i.debug("[Forum] Successfully connected to chat room:",e),t&&U(!1)):(i.error("[Forum] Failed to connect to chat room:",e),t&&(F("Не удалось подключиться к чату. Проверьте авторизацию."),U(!1)))}catch(s){i.error("[Forum] WebSocket connection failed:",s),t&&(U(!1),F("Не удалось подключиться к чату"))}})();const n=We.isConnected();i.debug("[Forum] Initial connection state:",n),t&&(g(n),n&&F(null));return We.onConnectionChange(e=>{i.debug("[Forum] Connection state changed to:",e),t&&(g(e),F(e?null:"Соединение потеряно. Попытка переподключения..."))}),()=>{t=!1,i.debug("[Forum] Cleaning up WebSocket for chat:",e),We.disconnectFromRoom(e),p([]),D.current.forEach(e=>clearTimeout(e)),D.current.clear()}},[c,s,me,he,ge,xe]);const pe=t.useCallback(e=>{i.debug("[Forum] Chat initiated, selecting chat:",e),W.invalidateQueries({queryKey:["forum","chats"]}).then(()=>{if(!q.current)return void i.debug("[Forum] Component unmounted, skipping chat selection");const s=W.getQueryData(["forum","chats"]),t=null==s?void 0:s.find(s=>s.id===e);t&&l(t)})},[W]),fe=t.useCallback(async e=>{if(c)try{const s=await G.pinMessage(c.id,e);o({title:"pinned"===s.action?"Сообщение закреплено":"Сообщение откреплено",description:"pinned"===s.action?"Сообщение закреплено в верхней части чата":"Сообщение откреплено"}),W.invalidateQueries({queryKey:["forum-messages",c.id]})}catch(s){o({variant:"destructive",title:"Ошибка",description:Je(s)})}},[c,W,o]),ve=t.useCallback(async e=>{try{const s=await G.lockChat(e);o({title:"locked"===s.action?"Чат заблокирован":"Чат разблокирован",description:"locked"===s.action?"Участники не могут отправлять сообщения":"Чат снова активен"}),(null==c?void 0:c.id)===e&&l({...c,is_active:"unlocked"===s.action}),W.invalidateQueries({queryKey:["forum","chats"]})}catch(s){o({variant:"destructive",title:"Ошибка",description:Je(s)})}},[c,W,o]),ye=(e=>{switch(e){case"student":return I;case"teacher":return Ne;case"tutor":return we;case"parent":return T;default:return null}})((null==s?void 0:s.role)||"");return ye?a.jsxs(y,{children:[a.jsxs("div",{className:"flex h-screen w-full overflow-hidden",children:[a.jsx(ye,{}),a.jsxs(b,{className:"flex flex-col h-full overflow-hidden",children:[a.jsxs("header",{className:"flex-shrink-0 flex h-16 items-center gap-4 border-b bg-background px-6",children:[a.jsx(j,{}),a.jsx("h1",{className:"text-2xl font-bold ml-4",children:"Форум"}),a.jsx("div",{className:"flex-1"}),"admin"!==(null==s?void 0:s.role)&&a.jsxs(d,{type:"button",variant:"default",size:"sm",onClick:()=>A(!0),className:"gradient-primary",children:[a.jsx(ne,{className:"w-4 h-4 mr-2"}),"Новый чат"]})]}),a.jsxs("main",{className:"flex-1 overflow-hidden flex flex-col p-6 min-h-0",children:[a.jsx("div",{className:"flex-shrink-0 mb-4",children:a.jsx("p",{className:"text-muted-foreground",children:"Общайтесь с преподавателями и тьюторами"})}),a.jsxs("div",{className:"grid md:grid-cols-3 gap-6 flex-1 overflow-hidden min-h-0",children:[a.jsx(ze,{chats:Z,selectedChat:c,onSelectChat:async e=>{Q.current&&clearTimeout(Q.current),Q.current=setTimeout(async()=>{U(!0),F(null),p([]);const s=null==c?void 0:c.id;if(s&&s!==e.id&&(i.debug("[Forum] Clearing message cache for previous chat:",s),W.removeQueries({queryKey:["forum-messages",s]})),l(e),m(""),s&&s!==e.id&&await W.cancelQueries({queryKey:["forum-messages",s]}),e.unread_count>0)try{await G.markChatAsRead(e.id),W.setQueryData(["forum","chats"],s=>s?s.map(s=>s.id===e.id?{...s,unread_count:0}:s):s)}catch(t){i.error("Failed to mark chat as read:",t)}setTimeout(()=>{q.current&&U(!1)},500)},200)},searchQuery:u,onSearchChange:m,isLoading:ee,currentUserId:(null==s?void 0:s.id)||0}),a.jsx(Be,{chat:c,messages:ae,isLoadingMessages:re,isSending:le.isPending,onSendMessage:(e,s)=>{c?(F(null),le.mutate({chatId:c.id,data:{content:e},file:s})):o({variant:"destructive",title:"Ошибка",description:"Чат не выбран"})},isConnected:h,typingUsers:x,error:f,onRetryConnection:()=>{if(F(null),c){const e=c;l(null),setTimeout(()=>{l(e)},100)}},onEditMessage:(e,s)=>{R({id:e,content:s})},onDeleteMessage:e=>{V(e),X(!0)},onPinMessage:fe,onLockChat:ve,isEditingOrDeleting:de.isPending||ue.isPending,currentUserId:(null==s?void 0:s.id)||0,currentUserRole:(null==s?void 0:s.role)||"",isSwitchingChat:H,fetchNextPage:ie,hasNextPage:oe,isFetchingNextPage:ce})]})]})]})]}),a.jsx(Ge,{isOpen:P,onClose:()=>A(!1),onChatInitiated:pe}),a.jsx($e,{isOpen:null!==L,onClose:()=>R(null),messageContent:(null==L?void 0:L.content)||"",onSave:e=>{L&&de.mutate({messageId:L.id,data:{content:e}})},isLoading:de.isPending}),a.jsx(N,{open:Y,onOpenChange:e=>{X(e),e||V(null)},children:a.jsxs(w,{children:[a.jsxs(C,{children:[a.jsx(_,{children:"Удалить сообщение?"}),a.jsx(k,{children:"Это действие нельзя отменить. Сообщение будет удалено из чата."})]}),a.jsxs(S,{children:[a.jsx(E,{onClick:()=>{X(!1),V(null)},children:"Отмена"}),a.jsx(M,{onClick:()=>{K&&ue.mutate(K)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:ue.isPending?"Удаление...":"Удалить"})]})]})})]}):a.jsx("div",{className:"flex items-center justify-center h-screen",children:a.jsx("p",{className:"text-muted-foreground",children:"Неизвестная роль пользователя"})})}export{Ve as default};
