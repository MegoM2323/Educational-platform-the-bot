import{r as e,j as s}from"./react-core-JVqWokWt.js";import{as as a,aV as l,B as t,C as r,L as i,A as n,t as c,v as o,r as d,J as m,K as h,Y as u,Z as x,_ as p,$ as j,aU as f,l as g}from"./main-fde3JC90.js";import{u as v,a as N,b}from"./react-query-DqnBFrGE.js";import{p as w,T as y}from"./profileAPI-mpI8UVp9.js";import{a2 as _,ay as F,bA as z,X as P}from"./vendor-DC2AZkDs.js";import{u as C}from"./react-router-WAeXREDX.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const E=()=>{var E,L,S;const q=C(),{user:T}=a(),{profile:k,isLoading:A,updateProfile:U,isUpdating:$,refetch:D}=(()=>{const e=v(),{data:s,isLoading:a,error:l,refetch:t}=N({queryKey:["tutorProfile"],queryFn:async()=>{const e=await w.getMyTutorProfile();if(!e.success||!e.data)throw new Error(e.error||"Failed to fetch tutor profile");return e.data},staleTime:3e5,gcTime:6e5,refetchOnMount:!0,refetchOnWindowFocus:!1}),r=b({mutationFn:async e=>{const s=await w.updateTutorProfile(e);if(!s.success||!s.data)throw new Error(s.error||"Failed to update tutor profile");return s.data},onSuccess:()=>{e.invalidateQueries({queryKey:["tutorProfile"]}),e.invalidateQueries({queryKey:["profile"]}),_.success("Профиль успешно обновлен")},onError:e=>{const s=e instanceof Error?e.message:"Ошибка при обновлении профиля";_.error(s)}});return{profile:s,isLoading:a,error:l,refetch:t,updateProfile:r.mutateAsync,isUpdating:r.isPending}})(),[G,K]=e.useState({first_name:"",last_name:"",phone:"",specialization:""}),[M,B]=e.useState(null),[J,W]=e.useState(null),[O,Q]=e.useState(!1),[R,V]=e.useState(0);e.useEffect(()=>{var e,s,a,l,t,r;k&&(K({first_name:(null==(e=k.user)?void 0:e.first_name)||"",last_name:(null==(s=k.user)?void 0:s.last_name)||"",phone:(null==(a=k.user)?void 0:a.phone)||"",specialization:(null==(l=k.profile)?void 0:l.specialization)||""}),V((null==(r=null==(t=k.profile)?void 0:t.specialization)?void 0:r.length)||0))},[k]),e.useEffect(()=>{const e=e=>{O&&(e.preventDefault(),e.returnValue="")};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[O]);const I=(e,s)=>{K(a=>({...a,[e]:s})),Q(!0),"specialization"===e&&V(s.length)};if(!T)return null;if(A)return s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsx(l,{})});const Y=`${G.first_name[0]||""}${G.last_name[0]||""}`.toUpperCase(),Z=J||(null==(E=null==k?void 0:k.user)?void 0:E.avatar);return s.jsx("div",{className:"min-h-screen bg-[hsl(240,20%,99%)] py-8 px-4",children:s.jsxs("div",{className:"max-w-7xl mx-auto",children:[s.jsx("div",{className:"mb-6 flex items-center gap-4",children:s.jsxs(t,{type:"button",variant:"outline",size:"sm",onClick:()=>q(-1),"aria-label":"Вернуться на предыдущую страницу",children:[s.jsx(F,{className:"w-4 h-4 mr-2"}),"Назад"]})}),s.jsxs("div",{className:"mb-6",children:[s.jsx("h1",{className:"text-3xl font-bold text-[hsl(240,10%,15%)] mb-2",children:"Мой профиль"}),s.jsx("p",{className:"text-[hsl(240,5%,45%)]",children:"Здесь вы можете редактировать информацию о себе"})]}),s.jsx("form",{onSubmit:async e=>{e.preventDefault();const s=new FormData;s.append("first_name",G.first_name),s.append("last_name",G.last_name),s.append("phone",G.phone),s.append("specialization",G.specialization),M&&s.append("avatar",M);try{await U(s),Q(!1),B(null),W(null)}catch(a){g.error("Failed to update profile:",a)}},children:s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[s.jsx("div",{className:"lg:col-span-1",children:s.jsx("div",{className:"sticky top-4",children:s.jsx(r,{className:"shadow-md",children:s.jsxs(i,{className:"p-6 flex flex-col items-center gap-4",children:[s.jsxs(n,{className:"w-48 h-48 shadow-lg border-4 border-[hsl(0,0%,96%)]",children:[s.jsx(c,{src:Z,alt:`${G.first_name} ${G.last_name}`}),s.jsx(o,{className:"text-6xl font-bold text-white",style:{background:"linear-gradient(135deg, hsl(220, 70%, 55%), hsl(240, 75%, 65%))"},children:Y})]}),s.jsxs("div",{className:"w-full",children:[s.jsxs("label",{htmlFor:"avatar-upload",className:d("flex flex-col items-center justify-center w-full p-6 border-2 border-dashed rounded-lg cursor-pointer transition-all","border-[hsl(240,10%,90%)] bg-[hsl(240,10%,98%)]","hover:border-[hsl(250,70%,60%)] hover:bg-[hsl(250,70%,98%)]"),children:[s.jsx(z,{className:"w-8 h-8 mb-2 text-[hsl(240,5%,45%)]"}),s.jsx("span",{className:"text-sm text-[hsl(240,5%,45%)]",children:M?M.name:"Загрузить фото"}),s.jsx("span",{className:"text-xs text-[hsl(240,5%,60%)] mt-1",children:"JPG, PNG, WebP (макс. 5MB)"}),s.jsx("input",{id:"avatar-upload",type:"file",className:"hidden",accept:"image/jpeg,image/png,image/webp",onChange:e=>{var s;const a=null==(s=e.target.files)?void 0:s[0];if(!a)return;if(a.size>5242880)return void _.error("Файл слишком большой. Максимум 5MB");if(!["image/jpeg","image/png","image/webp"].includes(a.type))return void _.error("Неподдерживаемый формат. Используйте JPG, PNG или WebP");B(a);const l=new FileReader;l.onloadend=()=>{W(l.result)},l.readAsDataURL(a),Q(!0)}})]}),J&&s.jsxs(t,{type:"button",variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>{B(null),W(null),Q(!0)},children:[s.jsx(P,{className:"w-4 h-4 mr-2"}),"Отменить"]})]})]})})})}),s.jsx("div",{className:"lg:col-span-2",children:s.jsxs(r,{className:"shadow-md",children:[s.jsxs(m,{children:[s.jsx(h,{className:"text-2xl",children:"Профиль тьютора"}),s.jsx(u,{children:"Обновите вашу персональную информацию"})]}),s.jsxs(i,{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs(x,{htmlFor:"first_name",className:"text-sm font-medium",children:["Имя ",s.jsx("span",{className:"text-[hsl(0,84%,60%)]",children:"*"})]}),s.jsx(p,{id:"first_name",value:G.first_name,onChange:e=>I("first_name",e.target.value),required:!0,className:"h-10"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(x,{htmlFor:"last_name",className:"text-sm font-medium",children:["Фамилия ",s.jsx("span",{className:"text-[hsl(0,84%,60%)]",children:"*"})]}),s.jsx(p,{id:"last_name",value:G.last_name,onChange:e=>I("last_name",e.target.value),required:!0,className:"h-10"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"email",className:"text-sm font-medium",children:"Email"}),s.jsx(p,{id:"email",type:"email",value:(null==(L=null==k?void 0:k.user)?void 0:L.email)||"",disabled:!0,className:"h-10 bg-[hsl(240,10%,96%)] opacity-50 cursor-not-allowed"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)]",children:"Email нельзя изменить"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"phone",className:"text-sm font-medium",children:"Телефон"}),s.jsx(p,{id:"phone",type:"tel",value:G.phone,onChange:e=>I("phone",e.target.value),placeholder:"+7 (999) 123-45-67",className:"h-10"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"specialization",className:"text-sm font-medium",children:"Специализация"}),s.jsx(j,{id:"specialization",value:G.specialization,onChange:e=>I("specialization",e.target.value),placeholder:"Опишите вашу специализацию и подход к работе...",className:"min-h-24 resize-none",maxLength:500,rows:4}),s.jsxs("p",{className:"text-xs text-[hsl(240,5%,55%)] text-right",children:["Осталось: ",500-R," символов"]}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)]",children:"Опишите вашу специализацию и подход к работе"})]}),s.jsxs("div",{className:"space-y-2 pt-4 border-t",children:[s.jsx(x,{className:"text-sm font-medium",children:"Привязка Telegram"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)] mb-2",children:"Привяжите аккаунт Telegram для получения уведомлений"}),s.jsx(y,{isLinked:!!(null==(S=null==k?void 0:k.user)?void 0:S.telegram_id),onStatusChange:D})]})]}),s.jsxs(f,{className:"flex items-center justify-between border-t pt-6",children:[s.jsx("div",{className:"flex items-center gap-2",children:O&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-2 h-2 bg-[hsl(30,95%,60%)] rounded-full animate-pulse"}),s.jsx("span",{className:"text-sm text-[hsl(240,5%,45%)]",children:"Несохраненные изменения"})]})}),s.jsx(t,{type:"submit",disabled:$,className:"bg-[hsl(250,70%,60%)] hover:bg-[hsl(250,70%,55%)] text-white shadow-sm hover:shadow-md transition-all",children:$?s.jsxs(s.Fragment,{children:[s.jsx(l,{className:"w-4 h-4 mr-2"}),"Сохранение..."]}):"Сохранить"})]})]})})]})})]})})};export{E as TutorProfilePage,E as default};
