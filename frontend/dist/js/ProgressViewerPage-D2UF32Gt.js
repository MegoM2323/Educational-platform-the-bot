import{r as e,j as s,a as t}from"./react-core-JVqWokWt.js";import{f as r,V as a,W as l,B as n,r as d,C as i,J as c,K as o,L as m,b as x,g as h,h as u,i as j,j as g,k as p,a1 as f,Y as N,c as v,T as w,m as b,n as y,o as _,q as S,s as k,S as E,a as L,e as C}from"./main-fde3JC90.js";import{T}from"./TeacherSidebar-Bwv8PTW2.js";import{a as $}from"./react-query-DqnBFrGE.js";import{$ as D,a1 as I,av as q,ap as P,aT as F,aF as z,a7 as A,bS as M,aO as O,c4 as R,aA as U,aj as K,ai as G}from"./vendor-DC2AZkDs.js";import{u as V}from"./useTeacher-DJCQuFgv.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./react-router-WAeXREDX.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";import"./teacher-BhCI6v5d.js";const B={getTeacherStudents:async()=>{const e=await r.get("/materials/teacher/all-students/");if(e.error)throw new Error(e.error);const s=e.data;return s?Array.isArray(s)?s:Array.isArray(s.results)?s.results:[]:[]},getGraphProgress:async e=>{const s=await r.get(`/knowledge-graph/${e}/progress/`);if(s.error)throw new Error(s.error);return s.data},getStudentDetailedProgress:async(e,s)=>{const t=await r.get(`/knowledge-graph/${e}/students/${s}/progress/`);if(t.error)throw new Error(t.error);return t.data},getLessonDetail:async(e,s,t)=>{const a=await r.get(`/knowledge-graph/${e}/students/${s}/lesson/${t}/`);if(a.error)throw new Error(a.error);return a.data},exportProgress:async e=>{const s=await fetch(`/api/knowledge-graph/${e}/export/?format=csv`,{method:"GET",headers:{Authorization:`Bearer ${r.getToken()}`}});if(!s.ok){const e=await s.json().catch(()=>({error:"Export failed"}));throw new Error(e.error||"Failed to export progress")}return await s.blob()},getOrCreateGraph:async(e,s)=>{const t=await r.get(`/knowledge-graph/students/${e}/subject/${s}/`);if(t.error)throw new Error(t.error);return t.data.data}},W=({subjectId:t})=>{const{students:r,selectedStudent:v,graphProgress:w,lessonProgress:b,selectedLesson:y,elementDetails:_,isLoadingStudents:S,isLoadingProgress:k,isLoadingLessons:E,isLoadingElements:L,studentsError:C,progressError:T,lessonsError:K,selectStudent:G,selectLesson:V,refreshProgress:W,exportProgress:Y,lastUpdated:Z}=((s={})=>{var t,r,a;const{graphId:l,studentId:n,subjectId:d,autoRefresh:i=!1,refreshInterval:c=3e4}=s,[o,m]=e.useState(null),[x,h]=e.useState(null),[u,j]=e.useState(l||null),[g,p]=e.useState(null),{data:f=[],isLoading:N,error:v}=$({queryKey:["teacher","students"],queryFn:B.getTeacherStudents,staleTime:3e5}),{data:w}=$({queryKey:["knowledge-graph","graph",null==o?void 0:o.id,d],queryFn:()=>B.getOrCreateGraph(o.id,d),enabled:!!o&&!!d,staleTime:6e5});e.useEffect(()=>{(null==w?void 0:w.id)&&j(w.id)},[w]);const{data:b,isLoading:y,error:_,refetch:S}=$({queryKey:["knowledge-graph","progress",u],queryFn:async()=>{const e=await B.getGraphProgress(u);return p(new Date),e},enabled:!!u,refetchInterval:!!i&&c,staleTime:i?c:6e4}),k=(null==(t=null==b?void 0:b.data)?void 0:t.student)||null,{data:E,isLoading:L,error:C,refetch:T}=$({queryKey:["knowledge-graph","lessons",u,null==o?void 0:o.id],queryFn:async()=>await B.getStudentDetailedProgress(u,o.id),enabled:!!u&&!!o,refetchInterval:!!i&&c,staleTime:i?c:3e4}),D=(null==(r=null==E?void 0:E.data)?void 0:r.lessons)||[],{data:I,isLoading:q,error:P}=$({queryKey:["knowledge-graph","lesson-elements",u,null==o?void 0:o.id,null==x?void 0:x.lesson_id],queryFn:async()=>await B.getLessonDetail(u,o.id,x.lesson_id),enabled:!!u&&!!o&&!!x,staleTime:3e4}),F=(null==(a=null==I?void 0:I.data)?void 0:a.elements)||[],z=e.useCallback(e=>{m(e),h(null)},[]),A=e.useCallback(e=>{h(e)},[]),M=e.useCallback(()=>{S(),T(),p(new Date)},[S,T]),O=e.useCallback(async()=>{if(!u)throw new Error("No graph selected");const e=await B.exportProgress(u),s=window.URL.createObjectURL(e),t=document.createElement("a");t.href=s,t.download=`student_progress_${(new Date).toISOString().split("T")[0]}.csv`,document.body.appendChild(t),t.click(),window.URL.revokeObjectURL(s),document.body.removeChild(t)},[u]);return e.useEffect(()=>{if(n&&f.length>0&&!o){const e=f.find(e=>e.id===n);e&&m(e)}},[n,f,o]),{students:f,selectedStudent:o,graphId:u,graphProgress:k,lessonProgress:D,selectedLesson:x,elementDetails:F,isLoadingStudents:N,isLoadingProgress:y,isLoadingLessons:L,isLoadingElements:q,studentsError:v,progressError:_,lessonsError:C,elementsError:P,selectStudent:z,selectLesson:A,refreshProgress:M,exportProgress:O,lastUpdated:g}})({subjectId:t,autoRefresh:!0,refreshInterval:3e4}),[H,Q]=e.useState("all"),[ee,se]=e.useState(new Set),te=e.useMemo(()=>"all"===H?b:b.filter(e=>e.status===H),[b,H]),re=e=>{switch(e){case"completed":return"bg-green-500";case"in_progress":return"bg-yellow-500";case"failed":return"bg-red-500";default:return"bg-gray-400"}},ae=e=>{switch(e){case"completed":return s.jsx(U,{className:"h-4 w-4"});case"in_progress":return s.jsx(R,{className:"h-4 w-4"});case"failed":return s.jsx(O,{className:"h-4 w-4"});default:return s.jsx(M,{className:"h-4 w-4"})}},le=e=>{switch(e){case"completed":return"Завершён";case"in_progress":return"В процессе";case"failed":return"Не пройден";default:return"Не начат"}},ne=e=>{const s=Math.floor(e/3600),t=Math.floor(e%3600/60);return s>0?`${s}ч ${t}м`:`${t}м`},de=e=>{if(!e)return"-";return new Date(e).toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})},ie=e=>{if(!e)return"Никогда";const s=new Date,t=new Date(e),r=s.getTime()-t.getTime(),a=Math.floor(r/6e4),l=Math.floor(a/60),n=Math.floor(l/24);return a<1?"Только что":a<60?`${a} мин. назад`:l<24?`${l} ч. назад`:n<7?`${n} дн. назад`:de(e)};return C?s.jsxs(a,{variant:"destructive",children:[s.jsx(D,{className:"h-4 w-4"}),s.jsxs(l,{children:["Ошибка загрузки списка студентов: ",C.message]})]}):s.jsxs("div",{className:"space-y-6 p-4 md:p-6",children:[s.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-bold",children:"Прогресс студентов"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Просмотр прогресса по графу знаний"})]}),s.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[Z&&s.jsxs("span",{className:"text-xs text-muted-foreground",children:["Обновлено: ",ie(Z.toISOString())]}),s.jsxs(n,{variant:"outline",size:"sm",onClick:W,disabled:k,children:[s.jsx(I,{className:d("mr-2 h-4 w-4",k&&"animate-spin")}),"Обновить"]})]})]}),s.jsxs(i,{children:[s.jsx(c,{children:s.jsx(o,{className:"text-lg",children:"Выбор студента"})}),s.jsx(m,{children:S?s.jsx(x,{className:"h-10 w-full"}):s.jsxs(h,{value:null==v?void 0:v.id.toString(),onValueChange:e=>{const s=r.find(s=>s.id.toString()===e);s&&G(s)},children:[s.jsx(u,{children:s.jsx(j,{placeholder:"Выберите студента"})}),s.jsx(g,{children:r.map(e=>s.jsx(p,{value:e.id.toString(),children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(q,{className:"h-4 w-4"}),s.jsx("span",{children:e.name}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",e.email,")"]})]})},e.id))})]})})]}),v&&s.jsxs(s.Fragment,{children:[k?s.jsx("div",{className:"grid gap-4 md:grid-cols-4",children:[...Array(4)].map((e,t)=>s.jsx(i,{children:s.jsx(m,{className:"p-6",children:s.jsx(x,{className:"h-20 w-full"})})},`progress-skeleton-${t}`))}):T?s.jsxs(a,{variant:"destructive",children:[s.jsx(D,{className:"h-4 w-4"}),s.jsxs(l,{children:["Ошибка загрузки прогресса: ",T.message]})]}):w?s.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[s.jsxs(i,{children:[s.jsx(c,{className:"pb-2",children:s.jsx(o,{className:"text-sm font-medium text-muted-foreground",children:"Общее завершение"})}),s.jsxs(m,{children:[s.jsxs("div",{className:"text-3xl font-bold",children:[w.completion_percentage.toFixed(0),"%"]}),s.jsx(f,{value:w.completion_percentage,className:"mt-2"})]})]}),s.jsxs(i,{children:[s.jsx(c,{className:"pb-2",children:s.jsxs(o,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[s.jsx(P,{className:"h-4 w-4"}),"Уроки"]})}),s.jsxs(m,{children:[s.jsxs("div",{className:"text-3xl font-bold",children:[w.lessons_completed,"/",w.lessons_total]}),s.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"завершено"})]})]}),s.jsxs(i,{children:[s.jsx(c,{className:"pb-2",children:s.jsxs(o,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[s.jsx(F,{className:"h-4 w-4"}),"Баллы"]})}),s.jsxs(m,{children:[s.jsxs("div",{className:"text-3xl font-bold",children:[w.total_score,"/",w.max_possible_score]}),s.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[w.max_possible_score>0?Math.round(w.total_score/w.max_possible_score*100):0,"% правильных ответов"]})]})]}),s.jsxs(i,{children:[s.jsx(c,{className:"pb-2",children:s.jsxs(o,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[s.jsx(z,{className:"h-4 w-4"}),"Последняя активность"]})}),s.jsxs(m,{children:[s.jsx("div",{className:"text-lg font-semibold",children:ie(w.last_activity)}),s.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:w.last_activity?de(w.last_activity):"Нет активности"})]})]})]}):null,s.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[s.jsxs("div",{className:"flex flex-wrap gap-2",children:[s.jsx(n,{variant:"all"===H?"default":"outline",size:"sm",onClick:()=>Q("all"),children:"Все"}),s.jsx(n,{variant:"not_started"===H?"default":"outline",size:"sm",onClick:()=>Q("not_started"),children:"Не начаты"}),s.jsx(n,{variant:"in_progress"===H?"default":"outline",size:"sm",onClick:()=>Q("in_progress"),children:"В процессе"}),s.jsx(n,{variant:"completed"===H?"default":"outline",size:"sm",onClick:()=>Q("completed"),children:"Завершены"}),s.jsx(n,{variant:"failed"===H?"default":"outline",size:"sm",onClick:()=>Q("failed"),children:"Не пройдены"})]}),s.jsxs(n,{variant:"outline",size:"sm",onClick:async()=>{try{await Y()}catch(e){console.error("Export failed:",e)}},children:[s.jsx(A,{className:"mr-2 h-4 w-4"}),"Экспорт CSV"]})]}),s.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[s.jsxs(i,{children:[s.jsxs(c,{children:[s.jsxs(o,{children:["Уроки (",te.length,")"]}),s.jsx(N,{children:"Нажмите на урок для просмотра деталей"})]}),s.jsx(m,{children:E?s.jsx("div",{className:"space-y-2",children:[...Array(5)].map((e,t)=>s.jsx(x,{className:"h-16 w-full"},`lesson-skeleton-${t}`))}):K?s.jsxs(a,{variant:"destructive",children:[s.jsx(D,{className:"h-4 w-4"}),s.jsxs(l,{children:["Ошибка загрузки уроков: ",K.message]})]}):0===te.length?s.jsx("p",{className:"text-center text-muted-foreground py-8",children:"Нет уроков в выбранной категории"}):s.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:te.map(e=>s.jsx(J,{lesson:e,isSelected:(null==y?void 0:y.lesson_id)===e.lesson_id,onClick:()=>V(e),getStatusColor:re,getStatusIcon:ae,getStatusText:le,formatTime:ne},e.lesson_id))})})]}),s.jsxs(i,{children:[s.jsxs(c,{children:[s.jsx(o,{children:"Детали урока"}),s.jsx(N,{children:y?`${y.lesson_title}`:"Выберите урок для просмотра деталей"})]}),s.jsx(m,{children:y?L?s.jsx(x,{className:"h-64 w-full"}):s.jsx(X,{lesson:y,elements:_,expandedElements:ee,toggleElementExpansion:e=>{se(s=>{const t=new Set(s);return t.has(e)?t.delete(e):t.add(e),t})},formatDate:de,getStatusText:le,getStatusIcon:ae}):s.jsx("p",{className:"text-center text-muted-foreground py-8",children:"Выберите урок из списка слева"})})]})]})]})]})},J=({lesson:e,isSelected:t,onClick:r,getStatusColor:a,getStatusIcon:l,getStatusText:n,formatTime:i})=>s.jsxs("div",{className:d("p-4 border rounded-lg cursor-pointer transition-all hover:shadow-md",t&&"border-primary bg-primary/5"),onClick:r,children:[s.jsxs("div",{className:"flex items-start justify-between mb-2",children:[s.jsx("h4",{className:"font-semibold text-sm",children:e.lesson_title}),s.jsxs(v,{variant:"outline",className:d("ml-2 flex items-center gap-1",a(e.status)),children:[l(e.status),s.jsx("span",{className:"text-xs",children:n(e.status)})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[s.jsxs("span",{children:[e.completed_elements,"/",e.total_elements," элементов"]}),s.jsxs("span",{children:[e.completion_percent.toFixed(0),"%"]})]}),s.jsx(f,{value:e.completion_percent,className:"h-2"}),s.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[s.jsxs("span",{children:["Баллы: ",e.total_score,"/",e.max_possible_score]}),e.total_time_spent_seconds>0&&s.jsxs("span",{children:["Время: ",i(e.total_time_spent_seconds)]})]})]})]}),X=({lesson:e,elements:r,expandedElements:a,toggleElementExpansion:l,formatDate:d,getStatusText:i,getStatusIcon:c})=>{const o=e=>{switch(e){case"text_problem":return"Задача";case"quick_question":return"Тест";case"theory":return"Теория";case"video":return"Видео";default:return e}};return s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 bg-muted rounded-lg",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Завершение"}),s.jsxs("p",{className:"text-lg font-semibold",children:[e.completion_percent.toFixed(0),"%"]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Баллы"}),s.jsxs("p",{className:"text-lg font-semibold",children:[e.total_score,"/",e.max_possible_score]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Начат"}),s.jsx("p",{className:"text-sm",children:d(e.started_at)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Завершён"}),s.jsx("p",{className:"text-sm",children:d(e.completed_at)})]})]}),s.jsx("div",{className:"border rounded-lg overflow-hidden",children:s.jsxs(w,{children:[s.jsx(b,{children:s.jsxs(y,{children:[s.jsx(_,{className:"w-12"}),s.jsx(_,{children:"Элемент"}),s.jsx(_,{children:"Тип"}),s.jsx(_,{children:"Статус"}),s.jsx(_,{className:"text-right",children:"Баллы"})]})}),s.jsx(S,{children:0===r.length?s.jsx(y,{children:s.jsx(k,{colSpan:5,className:"text-center text-muted-foreground",children:"Нет элементов в этом уроке"})}):r.map((e,r)=>s.jsxs(t.Fragment,{children:[s.jsxs(y,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>l(e.element_id),children:[s.jsx(k,{children:s.jsx(n,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",children:a.has(e.element_id)?s.jsx(K,{className:"h-4 w-4"}):s.jsx(G,{className:"h-4 w-4"})})}),s.jsxs(k,{className:"font-medium",children:[r+1,". ",e.element_title]}),s.jsx(k,{children:s.jsx(v,{variant:"outline",children:o(e.element_type)})}),s.jsx(k,{children:s.jsxs("div",{className:"flex items-center gap-1",children:[c(e.status),s.jsx("span",{className:"text-xs",children:i(e.status)})]})}),s.jsxs(k,{className:"text-right",children:[null!==e.score?e.score:"-","/",e.max_score]})]}),a.has(e.element_id)&&s.jsx(y,{children:s.jsx(k,{colSpan:5,className:"bg-muted/30",children:s.jsx(Y,{element:e,formatDate:d})})})]},e.element_id))})]})})]})},Y=({element:e,formatDate:t})=>s.jsxs("div",{className:"p-4 space-y-3",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"Попытки:"})," ",s.jsx("span",{className:"font-medium",children:e.attempts})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-muted-foreground",children:"Завершено:"})," ",s.jsx("span",{className:"font-medium",children:t(e.completed_at)})]})]}),e.student_answer&&s.jsxs("div",{className:"space-y-2",children:[s.jsx("h5",{className:"font-semibold text-sm",children:"Ответ студента:"}),"text_problem"===e.element_type&&s.jsx("div",{className:"p-3 bg-background rounded border",children:s.jsx("p",{className:"text-sm whitespace-pre-wrap",children:e.student_answer.text||"Нет ответа"})}),"quick_question"===e.element_type&&e.choices&&s.jsx("div",{className:"space-y-2",children:e.choices.map((t,r)=>{var a;const l=(null==(a=e.student_answer)?void 0:a.choice)===r,n=e.correct_answer===r;return s.jsx("div",{className:d("p-2 rounded border text-sm",l&&n&&"bg-green-100 border-green-500",l&&!n&&"bg-red-100 border-red-500",!l&&n&&"bg-green-50 border-green-300"),children:s.jsxs("div",{className:"flex items-center gap-2",children:[l&&s.jsx(U,{className:"h-4 w-4"}),!l&&n&&s.jsx("span",{className:"text-xs text-green-600",children:"(правильный)"}),s.jsx("span",{children:t})]})},r)})}),"theory"===e.element_type&&s.jsx("p",{className:"text-sm text-muted-foreground",children:e.student_answer.viewed?"Материал просмотрен":"Не просмотрен"}),"video"===e.element_type&&s.jsxs("p",{className:"text-sm text-muted-foreground",children:["Просмотрено до ",e.student_answer.watched_until||0," секунд"]})]}),!e.student_answer&&s.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Студент ещё не ответил"})]}),Z=()=>{var t;const{data:r,isLoading:n,error:d}=V(),[c,o]=e.useState(null),m=(null==(t=null==r?void 0:r.profile)?void 0:t.subjects)||[];return e.useEffect(()=>{if(m.length>0&&!c){const e=m[0];"object"==typeof e&&(null==e?void 0:e.id)&&o(e.id)}},[m,c]),s.jsx(E,{children:s.jsxs("div",{className:"flex min-h-screen w-full",children:[s.jsx(T,{}),s.jsxs(L,{children:[s.jsxs("header",{className:"sticky top-0 z-10 flex h-16 items-center gap-4 border-b bg-background px-6",children:[s.jsx(C,{}),s.jsx("div",{className:"flex-1",children:s.jsx("h1",{className:"text-2xl font-bold",children:"Прогресс учеников"})})]}),s.jsxs("main",{className:"p-6",children:[n&&s.jsxs("div",{className:"space-y-4",children:[s.jsx(x,{className:"h-12 w-full"}),s.jsx(x,{className:"h-64 w-full"})]}),d&&s.jsxs(a,{variant:"destructive",children:[s.jsx(D,{className:"h-4 w-4"}),s.jsxs(l,{children:["Ошибка загрузки данных преподавателя: ",d.message]})]}),!n&&!d&&0===m.length&&s.jsx(i,{className:"p-6",children:s.jsx("div",{className:"text-center text-muted-foreground",children:"У вас нет назначенных предметов. Обратитесь к администратору."})}),!n&&!d&&m.length>0&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx("label",{className:"text-sm font-medium",children:"Предмет:"}),s.jsxs(h,{value:(null==c?void 0:c.toString())||"",onValueChange:e=>o(Number(e)),children:[s.jsx(u,{className:"w-[300px]",children:s.jsx(j,{placeholder:"Выберите предмет"})}),s.jsx(g,{children:m.map(e=>{const t="object"==typeof e?e.id:null,r="object"==typeof e?e.name:e;return t?s.jsx(p,{value:t.toString(),children:r},t):null})})]})]}),c&&s.jsx(W,{subjectId:c})]})]})]})]})})};export{Z as default};
