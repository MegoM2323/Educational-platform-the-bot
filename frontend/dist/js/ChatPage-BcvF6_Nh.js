import{r as e,j as s}from"./react-core-JVqWokWt.js";import{M as a,S as i,a0 as l,a as n,e as t,C as d,B as r,l as c}from"./main-fde3JC90.js";import{u as o,a as m,b as x,c as u,d as h,C as j,e as f,M as p,f as g}from"./useChat-CofLPcaT.js";import{N}from"./react-router-WAeXREDX.js";import{aS as b,ao as v}from"./vendor-DC2AZkDs.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./react-query-DqnBFrGE.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";import"./forumAPI-CXsZ6fyy.js";function C(){const{user:C}=a(),[w,y]=e.useState(null),[L,S]=e.useState(!1),[k,I]=e.useState(""),{data:z,isLoading:M}=o(),{data:P,isLoading:A}=m((null==w?void 0:w.id)||0),_=x(),q=u(),{isConnected:B}=h((null==w?void 0:w.id)||0,!!(null==w?void 0:w.id));if("student"!==(null==C?void 0:C.role))return s.jsx(N,{to:"/dashboard",replace:!0});const F=(null==z?void 0:z.results)||[],O=k.trim()?F.filter(e=>(e.name||e.participants.filter(e=>e.id!==C.id).map(e=>e.full_name).join(", ")).toLowerCase().includes(k.toLowerCase())):F,Q=async(e,s)=>{if(w&&e.trim())try{await _.mutateAsync({chatId:w.id,data:{content:e,attachments:s||[]}})}catch(a){c.error("Failed to send message:",a)}};return s.jsx(i,{children:s.jsxs("div",{className:"flex min-h-screen w-full bg-background",children:[s.jsx(l,{}),s.jsxs(n,{className:"flex-1",children:[s.jsxs("header",{className:"sticky top-0 z-10 flex h-16 items-center border-b bg-background px-6",children:[s.jsx(t,{}),s.jsxs("h1",{className:"ml-4 text-xl font-semibold flex items-center gap-2",children:[s.jsx(b,{className:"w-5 h-5"}),"Сообщения"]}),q>0&&s.jsx("span",{className:"ml-2 inline-flex items-center justify-center rounded-full bg-destructive px-2.5 py-0.5 text-xs font-medium text-destructive-foreground",children:q})]}),s.jsx("main",{className:"flex-1 overflow-hidden",children:s.jsxs("div",{className:"flex h-[calc(100vh-4rem)] gap-4 p-4",children:[s.jsx("div",{className:"w-full md:w-1/3 flex flex-col",children:s.jsxs(d,{className:"flex flex-col flex-1",children:[s.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[s.jsx("h2",{className:"font-semibold",children:"Чаты"}),s.jsxs(r,{size:"sm",variant:"outline",onClick:()=>S(!0),className:"gap-1",children:[s.jsx(v,{className:"w-4 h-4"}),s.jsx("span",{className:"hidden sm:inline",children:"Новый"})]})]}),s.jsx(j,{chats:O,selectedChat:w,onSelectChat:e=>{y(e),I("")},searchQuery:k,onSearchChange:I,isLoading:M,currentUserId:(null==C?void 0:C.id)||0})]})}),s.jsx("div",{className:"hidden md:flex w-2/3 flex-col",children:w?s.jsx(f,{chatId:w.id,messages:(null==P?void 0:P.results)||[],isLoading:A,isConnected:B,renderMessageInput:()=>s.jsx(p,{onSend:Q,isLoading:_.isPending})}):s.jsx(d,{className:"flex flex-1 items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx(b,{className:"mx-auto mb-4 h-12 w-12 text-muted-foreground opacity-50"}),s.jsx("p",{className:"text-lg font-medium",children:"Выберите чат для начала переписки"}),s.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Нажмите на чат в списке слева или создайте новый"}),s.jsxs(r,{onClick:()=>S(!0),className:"mt-4 gap-2",children:[s.jsx(v,{className:"w-4 h-4"}),"Создать новый чат"]})]})})}),w&&s.jsxs("div",{className:"absolute inset-0 z-50 flex flex-col md:hidden bg-background",children:[s.jsxs("header",{className:"flex h-16 items-center border-b bg-background px-4",children:[s.jsx(r,{variant:"ghost",size:"sm",onClick:()=>y(null),className:"mr-2",children:"←"}),s.jsx("h2",{className:"font-semibold",children:w.name||w.participants.filter(e=>e.id!==(null==C?void 0:C.id)).map(e=>e.full_name).join(", ")})]}),s.jsx(f,{chatId:w.id,messages:(null==P?void 0:P.results)||[],isLoading:A,isConnected:B,renderMessageInput:()=>s.jsx(p,{onSend:Q,isLoading:_.isPending})})]})]})}),L&&s.jsx(g,{isOpen:L,onClose:()=>S(!1),onChatInitiated:e=>{y((null==z?void 0:z.results.find(s=>s.id===e))||null),S(!1)}})]})]})})}export{C as StudentChatPage,C as default};
