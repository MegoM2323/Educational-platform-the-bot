import{r as e,j as s}from"./react-core-JVqWokWt.js";import{as as a,aV as r,B as l,C as t,L as n,A as i,t as c,v as d,r as o,J as m,K as h,Y as u,Z as x,_ as p,aU as f,l as j}from"./main-fde3JC90.js";import{u as v,a as g,b as N}from"./react-query-DqnBFrGE.js";import{p as b,T as y}from"./profileAPI-mpI8UVp9.js";import{a2 as w,ay as _,bA as P,X as F}from"./vendor-DC2AZkDs.js";import{u as E}from"./react-router-WAeXREDX.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const C=()=>{var C,L,S;const q=E(),{user:k}=a(),{profile:A,isLoading:T,updateProfile:U,isUpdating:D,refetch:G}=(()=>{const e=v(),{data:s,isLoading:a,error:r,refetch:l}=g({queryKey:["parentProfile"],queryFn:async()=>{const e=await b.getMyParentProfile();if(!e.success||!e.data)throw new Error(e.error||"Failed to fetch parent profile");return e.data},staleTime:3e5,gcTime:6e5,refetchOnMount:!0,refetchOnWindowFocus:!1}),t=N({mutationFn:async e=>{const s=await b.updateParentProfile(e);if(!s.success||!s.data)throw new Error(s.error||"Failed to update parent profile");return s.data},onSuccess:()=>{e.invalidateQueries({queryKey:["parentProfile"]}),e.invalidateQueries({queryKey:["profile"]}),w.success("Профиль успешно обновлен")},onError:e=>{const s=e instanceof Error?e.message:"Ошибка при обновлении профиля";w.error(s)}});return{profile:s,isLoading:a,error:r,refetch:l,updateProfile:t.mutateAsync,isUpdating:t.isPending}})(),[K,M]=e.useState({first_name:"",last_name:"",phone:""}),[$,z]=e.useState({first_name:"",last_name:"",phone:""}),[B,J]=e.useState(null),[O,W]=e.useState(null),[Q,R]=e.useState(!1);e.useEffect(()=>{var e,s,a;if(A){const r={first_name:(null==(e=A.user)?void 0:e.first_name)||"",last_name:(null==(s=A.user)?void 0:s.last_name)||"",phone:(null==(a=A.user)?void 0:a.phone)||""};M(r),z(r)}},[A]),e.useEffect(()=>{const e=e=>{Q&&(e.preventDefault(),e.returnValue="")};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[Q]);const V=(e,s)=>{M(a=>{const r={...a,[e]:s},l=Object.keys(r).some(e=>r[e]!==$[e]);return R(l),r})};if(!k)return null;if(T)return s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsx(r,{})});const I=`${K.first_name[0]||""}${K.last_name[0]||""}`.toUpperCase(),Y=O||(null==(C=null==A?void 0:A.user)?void 0:C.avatar);return s.jsx("div",{className:"min-h-screen bg-[hsl(240,20%,99%)] py-8 px-4",children:s.jsxs("div",{className:"max-w-7xl mx-auto",children:[s.jsx("div",{className:"mb-6 flex items-center gap-4",children:s.jsxs(l,{type:"button",variant:"outline",size:"sm",onClick:()=>q(-1),"aria-label":"Вернуться на предыдущую страницу",children:[s.jsx(_,{className:"w-4 h-4 mr-2"}),"Назад"]})}),s.jsxs("div",{className:"mb-6",children:[s.jsx("h1",{className:"text-3xl font-bold text-[hsl(240,10%,15%)] mb-2",children:"Мой профиль"}),s.jsx("p",{className:"text-[hsl(240,5%,45%)]",children:"Здесь вы можете редактировать информацию о себе"})]}),s.jsx("form",{onSubmit:async e=>{e.preventDefault();const s=new FormData;K.first_name!==$.first_name&&s.append("first_name",K.first_name),K.last_name!==$.last_name&&s.append("last_name",K.last_name),K.phone!==$.phone&&s.append("phone",K.phone),B&&s.append("avatar",B);try{await U(s),R(!1),J(null),W(null)}catch(a){j.error("Failed to update profile:",a)}},children:s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[s.jsx("div",{className:"lg:col-span-1",children:s.jsx("div",{className:"sticky top-4",children:s.jsx(t,{className:"shadow-md",children:s.jsxs(n,{className:"p-6 flex flex-col items-center gap-4",children:[s.jsxs(i,{className:"w-48 h-48 shadow-lg border-4 border-[hsl(0,0%,96%)]",children:[s.jsx(c,{src:Y,alt:`${K.first_name} ${K.last_name}`}),s.jsx(d,{className:"text-6xl font-bold text-white",style:{background:"linear-gradient(135deg, hsl(30, 80%, 55%), hsl(50, 90%, 60%))"},children:I})]}),s.jsxs("div",{className:"w-full",children:[s.jsxs("label",{htmlFor:"avatar-upload",className:o("flex flex-col items-center justify-center w-full p-6 border-2 border-dashed rounded-lg cursor-pointer transition-all","border-[hsl(240,10%,90%)] bg-[hsl(240,10%,98%)]","hover:border-[hsl(250,70%,60%)] hover:bg-[hsl(250,70%,98%)]"),children:[s.jsx(P,{className:"w-8 h-8 mb-2 text-[hsl(240,5%,45%)]"}),s.jsx("span",{className:"text-sm text-[hsl(240,5%,45%)]",children:B?B.name:"Загрузить фото"}),s.jsx("span",{className:"text-xs text-[hsl(240,5%,60%)] mt-1",children:"JPG, PNG, WebP (макс. 5MB)"}),s.jsx("input",{id:"avatar-upload",type:"file",className:"hidden",accept:"image/jpeg,image/png,image/webp",onChange:e=>{var s;const a=null==(s=e.target.files)?void 0:s[0];if(!a)return;if(a.size>5242880)return void w.error("Файл слишком большой. Максимум 5MB");if(!["image/jpeg","image/png","image/webp"].includes(a.type))return void w.error("Неподдерживаемый формат. Используйте JPG, PNG или WebP");J(a);const r=new FileReader;r.onloadend=()=>{W(r.result)},r.readAsDataURL(a),R(!0)}})]}),O&&s.jsxs(l,{type:"button",variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>{var e;J(null),W(null),(null==(e=null==A?void 0:A.user)?void 0:e.avatar)&&R(!0)},children:[s.jsx(F,{className:"w-4 h-4 mr-2"}),"Отменить"]})]})]})})})}),s.jsx("div",{className:"lg:col-span-2",children:s.jsxs(t,{className:"shadow-md",children:[s.jsxs(m,{children:[s.jsx(h,{className:"text-2xl",children:"Профиль родителя"}),s.jsx(u,{children:"Обновите вашу персональную информацию"})]}),s.jsxs(n,{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs(x,{htmlFor:"first_name",className:"text-sm font-medium",children:["Имя ",s.jsx("span",{className:"text-[hsl(0,84%,60%)]",children:"*"})]}),s.jsx(p,{id:"first_name",value:K.first_name,onChange:e=>V("first_name",e.target.value),required:!0,className:"h-10"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(x,{htmlFor:"last_name",className:"text-sm font-medium",children:["Фамилия ",s.jsx("span",{className:"text-[hsl(0,84%,60%)]",children:"*"})]}),s.jsx(p,{id:"last_name",value:K.last_name,onChange:e=>V("last_name",e.target.value),required:!0,className:"h-10"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"email",className:"text-sm font-medium",children:"Email"}),s.jsx(p,{id:"email",type:"email",value:(null==(L=null==A?void 0:A.user)?void 0:L.email)||"",disabled:!0,className:"h-10 bg-[hsl(240,10%,96%)] opacity-50 cursor-not-allowed"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)]",children:"Email нельзя изменить"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"phone",className:"text-sm font-medium",children:"Телефон"}),s.jsx(p,{id:"phone",type:"tel",value:K.phone,onChange:e=>V("phone",e.target.value),placeholder:"+7 (999) 123-45-67",className:"h-10"})]}),s.jsxs("div",{className:"space-y-2 pt-4 border-t",children:[s.jsx(x,{className:"text-sm font-medium",children:"Привязка Telegram"}),s.jsx("p",{className:"text-xs text-[hsl(240,5%,55%)] mb-2",children:"Привяжите аккаунт Telegram для получения уведомлений"}),s.jsx(y,{isLinked:!!(null==(S=null==A?void 0:A.user)?void 0:S.telegram_id),onStatusChange:G})]})]}),s.jsxs(f,{className:"flex items-center justify-between border-t pt-6",children:[s.jsx("div",{className:"flex items-center gap-2",children:Q&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-2 h-2 bg-[hsl(30,95%,60%)] rounded-full animate-pulse"}),s.jsx("span",{className:"text-sm text-[hsl(240,5%,45%)]",children:"Несохраненные изменения"})]})}),s.jsx(l,{type:"submit",disabled:D,className:"bg-[hsl(250,70%,60%)] hover:bg-[hsl(250,70%,55%)] text-white shadow-sm hover:shadow-md transition-all",children:D?s.jsxs(s.Fragment,{children:[s.jsx(r,{className:"w-4 h-4 mr-2"}),"Сохранение..."]}):"Сохранить"})]})]})})]})})]})})};export{C as ParentProfilePage,C as default};
