import{r as e,j as s}from"./react-core-JVqWokWt.js";import{u as t,O as a,Q as r,S as n,a as l,e as d,C as i,Z as c,g as u,h as o,i as h,j as x,k as m,D as j,a8 as p,B as f,w as v,x as g,y,_ as b,$ as w,a1 as N,c as _,f as S,l as k,aj as C}from"./main-fde3JC90.js";import{T as $}from"./TeacherSidebar-Bwv8PTW2.js";import{h as M}from"./fileDownload-DfJJnQoy.js";import{bB as z,aq as q,bD as P,bE as E,bz as D,ao as V,$ as B,X as O,av as T,aD as F,ab as L,aE as I,aF as W,as as A,ad as H,an as J}from"./vendor-DC2AZkDs.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./react-query-DqnBFrGE.js";import"./react-router-WAeXREDX.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";function U(e){var s;if(!e)return z;switch(null==(s=e.split(".").pop())?void 0:s.toLowerCase()){case"pdf":case"doc":case"docx":case"txt":case"md":case"csv":return q;case"ppt":case"pptx":return D;case"jpg":case"jpeg":case"png":case"gif":case"webp":case"svg":return E;case"zip":case"rar":case"7z":case"tar":case"gz":return P;default:return z}}function G(e){var s;if(!e)return"text-gray-500";switch(null==(s=e.split(".").pop())?void 0:s.toLowerCase()){case"pdf":return"text-red-500";case"doc":case"docx":return"text-blue-500";case"ppt":case"pptx":return"text-orange-500";case"jpg":case"jpeg":case"png":case"gif":case"webp":case"svg":return"text-green-500";case"zip":case"rar":case"7z":case"tar":case"gz":return"text-purple-500";default:return"text-gray-500"}}function K(e,s=2){if(0===e)return"0 Bytes";if(e<0)return"Invalid size";const t=1024,a=s<0?0:s,r=["Bytes","KB","MB","GB","TB"],n=Math.floor(Math.log(e)/Math.log(t));return n>=r.length?`${(e/Math.pow(t,r.length-1)).toFixed(a)} ${r[r.length-1]}`:`${parseFloat((e/Math.pow(t,n)).toFixed(a))} ${r[n]}`}function Q(e,s){const t=1024*s*1024;return e.size>t?{isValid:!1,error:`Файл "${e.name}" слишком большой. Максимальный размер: ${s} MB, размер файла: ${K(e.size)}`}:{isValid:!0}}function R(){t();const z=a(),P=r(),[E,D]=e.useState([]),[R,Z]=e.useState([]),[X,Y]=e.useState([]),[ee,se]=e.useState([]),[te,ae]=e.useState(!0),[re,ne]=e.useState(null),[le,de]=e.useState("all"),[ie,ce]=e.useState("all"),[ue,oe]=e.useState("all"),[he,xe]=e.useState(!1),[me,je]=e.useState(!1),[pe,fe]=e.useState(!1),[ve,ge]=e.useState(null),[ye,be]=e.useState(null),[we,Ne]=e.useState(!1),[_e,Se]=e.useState(null),[ke,Ce]=e.useState(null),[$e,Me]=e.useState([]),[ze,qe]=e.useState([]),[Pe,Ee]=e.useState(!1),[De,Ve]=e.useState({}),[Be,Oe]=e.useState({student:"",subject:"",title:"",content:"",week_start_date:"",status:"draft"}),Te=async()=>{try{ae(!0),ne(null);const e=new URLSearchParams;"all"!==le&&e.append("subject_id",le),"all"!==ie&&e.append("student_id",ie),"all"!==ue&&e.append("status",ue);const s=await S.request(`/materials/teacher/study-plans/?${e.toString()}`);if(s.data){const e=s.data.study_plans||[];k.debug("Loaded plans:",e),k.debug("Plans with files:",e.filter(e=>e.files&&e.files.length>0)),D(e)}else{const e=s.error||"Ошибка загрузки планов";ne(e),z(e)}}catch(e){const s="Произошла ошибка при загрузке планов";ne(s),z(s),k.error("Study plans fetch error:",e)}finally{ae(!1)}};e.useEffect(()=>{Te()},[le,ie,ue]),e.useEffect(()=>{(async()=>{var e;try{const s=await S.request("/materials/teacher/subjects/");if(s.data){const t=Array.isArray(s.data)?s.data:null!=(e=s.data.subjects)?e:[],a=t.filter(e=>e.is_assigned);0===a.length?(t.length>0&&z("У вас нет назначенных предметов. Сначала назначьте предмет себе."),Z(t)):Z(a)}}catch(s){k.error("Subjects fetch error:",s),z("Ошибка загрузки предметов")}})();(async()=>{var e;try{const s=await S.request("/materials/dashboard/teacher/students/");(null==(e=s.data)?void 0:e.students)&&Y(s.data.students)}catch(s){k.error("Students fetch error:",s)}})()},[]),e.useEffect(()=>{(async()=>{if(Be.subject&&""!==Be.subject){k.debug("[StudyPlans] Loading students for selected subject:",Be.subject),Ne(!0);const e=await(async e=>{var s;try{k.debug("[StudyPlans] Fetching students for subject:",e);const t=await S.request(`/materials/teacher/subjects/${e}/students/`);if(k.debug("[StudyPlans] Students response:",t),null==(s=t.data)?void 0:s.students){const e=t.data.students.map(e=>({id:e.id,name:e.name,email:e.email}));return k.debug("[StudyPlans] Available students:",e),e}return k.warn("[StudyPlans] No students found in response"),[]}catch(t){return k.error("[StudyPlans] Students fetch error:",t),[]}})(parseInt(Be.subject));k.debug("[StudyPlans] Students loaded, count:",e.length),se(e),Ne(!1),Oe(e=>({...e,student:""}))}else k.debug("[StudyPlans] No subject selected, clearing students"),se([])})()},[Be.subject]);const Fe=E;return s.jsx(n,{children:s.jsxs("div",{className:"flex min-h-screen w-full",children:[s.jsx($,{}),s.jsxs(l,{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-4 border-b p-4",children:[s.jsx(d,{}),s.jsx("h1",{className:"text-2xl font-bold",children:"Планы занятий"})]}),s.jsxs("main",{className:"p-6 space-y-6",children:[s.jsx(i,{className:"p-4",children:s.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[s.jsxs("div",{className:"flex-1 min-w-[200px]",children:[s.jsx(c,{children:"Предмет"}),s.jsxs(u,{value:le,onValueChange:de,children:[s.jsx(o,{children:s.jsx(h,{placeholder:"Все предметы"})}),s.jsxs(x,{children:[s.jsx(m,{value:"all",children:"Все предметы"}),R.map(e=>s.jsx(m,{value:e.id.toString(),children:e.name},e.id))]})]})]}),s.jsxs("div",{className:"flex-1 min-w-[200px]",children:[s.jsx(c,{children:"Студент"}),s.jsxs(u,{value:ie,onValueChange:ce,children:[s.jsx(o,{children:s.jsx(h,{placeholder:"Все студенты"})}),s.jsxs(x,{children:[s.jsx(m,{value:"all",children:"Все студенты"}),X.map(e=>s.jsx(m,{value:e.id.toString(),children:e.name},e.id))]})]})]}),s.jsxs("div",{className:"flex-1 min-w-[200px]",children:[s.jsx(c,{children:"Статус"}),s.jsxs(u,{value:ue,onValueChange:oe,children:[s.jsx(o,{children:s.jsx(h,{placeholder:"Все статусы"})}),s.jsxs(x,{children:[s.jsx(m,{value:"all",children:"Все статусы"}),s.jsx(m,{value:"draft",children:"Черновик"}),s.jsx(m,{value:"sent",children:"Отправлен"}),s.jsx(m,{value:"archived",children:"Архив"})]})]})]}),s.jsxs(j,{open:he,onOpenChange:e=>{xe(e),e||(Oe({student:"",subject:"",title:"",content:"",week_start_date:"",status:"draft"}),qe([]),se([]))},children:[s.jsx(p,{asChild:!0,children:s.jsxs(f,{type:"button",children:[s.jsx(V,{className:"w-4 h-4 mr-2"}),"Создать план"]})}),s.jsxs(v,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[s.jsx(g,{children:s.jsx(y,{children:"Создать план занятий"})}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx(c,{children:"Предмет *"}),s.jsxs(u,{value:Be.subject,onValueChange:e=>Oe({...Be,subject:e}),children:[s.jsx(o,{children:s.jsx(h,{placeholder:"Выберите предмет"})}),s.jsx(x,{children:R.map(e=>s.jsx(m,{value:e.id.toString(),children:e.name},e.id))})]})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Студент *"}),s.jsxs(u,{value:Be.student,onValueChange:e=>Oe({...Be,student:e}),disabled:!Be.subject||we,children:[s.jsx(o,{children:s.jsx(h,{placeholder:Be.subject?we?"Загрузка...":"Выберите студента":"Сначала выберите предмет"})}),s.jsx(x,{children:0===ee.length&&Be.subject?s.jsx("div",{className:"px-2 py-1 text-sm text-muted-foreground",children:"Нет студентов на этом предмете"}):ee.map(e=>s.jsx(m,{value:e.id.toString(),children:e.name},e.id))})]})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Название плана *"}),s.jsx(b,{value:Be.title,onChange:e=>Oe({...Be,title:e.target.value}),placeholder:"Например: Неделя 1: Алгебра"})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Дата начала недели *"}),s.jsx(b,{type:"date",value:Be.week_start_date,onChange:e=>Oe({...Be,week_start_date:e.target.value}),required:!0})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Содержание плана *"}),s.jsx(w,{value:Be.content,onChange:e=>Oe({...Be,content:e.target.value}),placeholder:"Опишите план занятий на неделю...",rows:10})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Статус"}),s.jsxs(u,{value:Be.status,onValueChange:e=>Oe({...Be,status:e}),children:[s.jsx(o,{children:s.jsx(h,{})}),s.jsxs(x,{children:[s.jsx(m,{value:"draft",children:"Черновик"}),s.jsx(m,{value:"sent",children:"Отправить сразу"})]})]})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Прикрепить файлы"}),s.jsxs("div",{className:"mt-2 space-y-2",children:[s.jsx(b,{type:"file",multiple:!0,onChange:e=>{const s=Array.from(e.target.files||[]),t=[];if(s.forEach(e=>{const s=Q(e,10);s.isValid||t.push(s.error||e.name)}),t.length>0)return z(t.join("\n")),void(e.target.value="");qe(e=>[...e,...s]),e.target.value=""},accept:".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,.zip,.rar"}),s.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[s.jsx(B,{className:"w-3 h-3"}),"Максимальный размер файла: 10 MB"]}),ze.length>0&&s.jsx("div",{className:"space-y-2 mt-2",children:ze.map((e,t)=>{const a=U(e.name),r=G(e.name),n=`${e.name}-${t}`,l=De[n];return s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between p-2 bg-muted rounded-md",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[s.jsx(a,{className:`w-4 h-4 ${r}`}),s.jsx("span",{className:"text-sm font-medium truncate",children:e.name}),s.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:K(e.size)})]}),!Pe&&s.jsx(f,{type:"button",variant:"ghost",size:"sm",onClick:()=>{qe(e=>e.filter((e,s)=>s!==t))},children:s.jsx(O,{className:"w-4 h-4 text-destructive"})})]}),Pe&&void 0!==l&&s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[s.jsx("span",{children:"Загрузка..."}),s.jsxs("span",{children:[l,"%"]})]}),s.jsx(N,{value:l,className:"h-1"})]})]},t)})})]})]}),s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx(f,{type:"button",variant:"outline",onClick:()=>xe(!1),children:"Отмена"}),s.jsx(f,{type:"button",onClick:async()=>{const e=[];if(Be.student||e.push("Студент"),Be.subject||e.push("Предмет"),Be.title||e.push("Название плана"),Be.content||e.push("Содержание плана"),Be.week_start_date||e.push("Дата начала недели"),e.length>0)return k.debug("[StudyPlans] Missing fields:",e),k.debug("[StudyPlans] Form data:",Be),void z(`Заполните все обязательные поля: ${e.join(", ")}`);for(const a of ze){const e=Q(a,10);if(!e.isValid)return void z(e.error||"Файл слишком большой")}try{Ee(!0),Ve({});const e=await S.request("/materials/teacher/study-plans/",{method:"POST",body:JSON.stringify({student:parseInt(Be.student),subject:parseInt(Be.subject),title:Be.title,content:Be.content,week_start_date:Be.week_start_date,status:Be.status})});if(e.data){const a=e.data.id;if(ze.length>0)try{for(let e=0;e<ze.length;e++){const t=ze[e],r=`${t.name}-${e}`;Ve(e=>({...e,[r]:0}));const n=new FormData;n.append("file",t);const l=setInterval(()=>{Ve(e=>{const s=e[r]||0;return s<90?{...e,[r]:s+10}:e})},100);try{await S.request(`/materials/teacher/study-plans/${a}/files/`,{method:"POST",body:n}),clearInterval(l),Ve(e=>({...e,[r]:100}))}catch(s){throw clearInterval(l),s}}}catch(t){k.error("Error uploading files:",t),z("План создан, но не все файлы удалось загрузить")}P("План занятий создан"),xe(!1),Oe({student:"",subject:"",title:"",content:"",week_start_date:"",status:"draft"}),qe([]),se([]),C.keys().forEach(e=>{e.startsWith("/materials/teacher/study-plans/")&&C.delete(e)}),Te()}else z(e.error||"Ошибка при создании плана")}catch(s){z("Произошла ошибка при создании плана"),k.error("Create plan error:",s)}finally{Ee(!1)}},disabled:Pe,children:Pe?"Создание...":"Создать"})]})]})]})]})]})}),te?s.jsx("div",{className:"text-center py-8",children:"Загрузка..."}):re?s.jsx("div",{className:"text-center py-8 text-destructive",children:re}):0===Fe.length?s.jsxs(i,{className:"p-8 text-center",children:[s.jsx(q,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{className:"text-muted-foreground",children:"Нет планов занятий"})]}):s.jsx("div",{className:"grid gap-4",children:Fe.map(e=>s.jsx(i,{className:"p-6",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[s.jsx(_,{style:{backgroundColor:e.subject_color},className:"text-white",children:e.subject_name}),s.jsx(_,{variant:"sent"===e.status?"default":"outline",children:"sent"===e.status?"Отправлен":"draft"===e.status?"Черновик":"Архив"})]}),s.jsx("h3",{className:"text-xl font-bold mb-2",children:e.title}),s.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground mb-3",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(T,{className:"w-4 h-4"}),e.student_name]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(L,{className:"w-4 h-4"}),F(new Date(e.week_start_date),"dd.MM.yyyy",{locale:I})," - ",F(new Date(e.week_end_date),"dd.MM.yyyy",{locale:I})]}),e.sent_at&&s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(W,{className:"w-4 h-4"}),"Отправлен: ",F(new Date(e.sent_at),"dd.MM.yyyy HH:mm",{locale:I})]})]}),s.jsx("p",{className:"text-muted-foreground line-clamp-2",children:e.content}),e.files&&e.files.length>0&&s.jsxs("div",{className:"flex items-center gap-2 mt-2 text-sm text-muted-foreground",children:[s.jsx(q,{className:"w-4 h-4"}),s.jsxs("span",{children:["Прикреплено файлов: ",e.files.length]})]})]}),s.jsxs("div",{className:"flex gap-2 ml-4",children:[s.jsxs(f,{type:"button",variant:"outline",size:"sm",onClick:async()=>{try{const s=await S.request(`/materials/teacher/study-plans/${e.id}/`);s.data?(ge(s.data),je(!0)):z("Ошибка при загрузке деталей плана")}catch(s){z("Произошла ошибка при загрузке деталей плана"),k.error("Load plan details error:",s)}},children:[s.jsx(q,{className:"w-4 h-4 mr-2"}),"Просмотр"]}),s.jsxs(f,{type:"button",variant:"outline",size:"sm",onClick:()=>(async e=>{if("sent"!==e.status&&"archived"!==e.status)try{const s=await S.request(`/materials/teacher/study-plans/${e.id}/`);s.data?(ge(s.data),Oe({student:s.data.student.toString(),subject:s.data.subject.toString(),title:s.data.title,content:s.data.content,week_start_date:s.data.week_start_date,status:s.data.status}),fe(!0)):z("Ошибка при загрузке деталей плана")}catch(s){z("Произошла ошибка при загрузке деталей плана"),k.error("Load plan details error:",s)}else z("Нельзя редактировать отправленные или архивные планы занятий")})(e),disabled:"sent"===e.status||"archived"===e.status,title:"sent"===e.status||"archived"===e.status?"Нельзя редактировать отправленные или архивные планы":"",children:[s.jsx(A,{className:"w-4 h-4 mr-2"}),"Редактировать"]}),"draft"===e.status&&s.jsxs(f,{type:"button",variant:"default",size:"sm",onClick:()=>(async e=>{try{be(e);const s=await S.request(`/materials/teacher/study-plans/${e}/send/`,{method:"POST"});s.data?(P("План занятий отправлен студенту"),C.keys().forEach(e=>{e.startsWith("/materials/teacher/study-plans/")&&C.delete(e),e.startsWith("/student/study-plans/")&&C.delete(e)}),Te()):z(s.error||"Ошибка при отправке плана")}catch(s){z("Произошла ошибка при отправке плана"),k.error("Send plan error:",s)}finally{be(null)}})(e.id),disabled:ye===e.id,children:[s.jsx(H,{className:"w-4 h-4 mr-2"}),ye===e.id?"Отправка...":"Отправить"]})]})]})},e.id))}),s.jsx(j,{open:me,onOpenChange:je,children:s.jsxs(v,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[s.jsx(g,{children:s.jsx(y,{children:null==ve?void 0:ve.title})}),ve&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(_,{style:{backgroundColor:ve.subject_color},className:"text-white",children:ve.subject_name}),s.jsx(_,{variant:"sent"===ve.status?"default":"outline",children:"sent"===ve.status?"Отправлен":"draft"===ve.status?"Черновик":"Архив"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[s.jsxs("div",{children:[s.jsx(c,{children:"Студент"}),s.jsx("p",{className:"font-medium",children:ve.student_name})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Период"}),s.jsxs("p",{className:"font-medium",children:[F(new Date(ve.week_start_date),"dd.MM.yyyy",{locale:I})," - ",F(new Date(ve.week_end_date),"dd.MM.yyyy",{locale:I})]})]}),ve.sent_at&&s.jsxs("div",{children:[s.jsx(c,{children:"Отправлен"}),s.jsx("p",{className:"font-medium",children:F(new Date(ve.sent_at),"dd.MM.yyyy HH:mm",{locale:I})})]})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Содержание плана"}),s.jsx("div",{className:"mt-2 p-4 bg-muted rounded-md whitespace-pre-wrap",children:ve.content})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Прикрепленные файлы"}),s.jsx("div",{className:"mt-2 space-y-2",children:ve.files&&ve.files.length>0?ve.files.map(e=>{const t=U(e.name),a=G(e.name);return s.jsx("div",{className:"flex items-center justify-between p-3 bg-muted rounded-md hover:bg-muted/80 transition-colors",children:s.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[s.jsx(t,{className:`w-4 h-4 flex-shrink-0 ${a}`}),s.jsx("a",{href:e.file_url,target:"_blank",rel:"noopener noreferrer",className:"text-sm font-medium hover:underline truncate",onClick:s=>M(s,e.file_url,e.name),children:e.name}),s.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap flex-shrink-0",children:K(e.file_size)})]})},e.id)}):s.jsx("p",{className:"text-sm text-muted-foreground",children:"Нет прикрепленных файлов"})})]})]})]})}),s.jsx(j,{open:pe,onOpenChange:e=>{fe(e),e||(ge(null),Me([]))},children:s.jsxs(v,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[s.jsx(g,{children:s.jsx(y,{children:"Редактировать план занятий"})}),ve&&s.jsxs("div",{className:"space-y-4",children:[("sent"===ve.status||"archived"===ve.status)&&s.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-950 border border-amber-200 dark:border-amber-800 rounded-md",children:s.jsxs("p",{className:"text-sm text-amber-800 dark:text-amber-200 flex items-center gap-2",children:[s.jsx(B,{className:"w-4 h-4"}),"Этот план уже отправлен студенту и не может быть изменен"]})}),s.jsxs("div",{children:[s.jsx(c,{children:"Название плана *"}),s.jsx(b,{value:Be.title,onChange:e=>Oe({...Be,title:e.target.value}),placeholder:"Например: Неделя 1: Алгебра",disabled:"sent"===ve.status||"archived"===ve.status})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Дата начала недели *"}),s.jsx(b,{type:"date",value:Be.week_start_date,onChange:e=>Oe({...Be,week_start_date:e.target.value}),required:!0,disabled:"sent"===ve.status||"archived"===ve.status})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Содержание плана *"}),s.jsx(w,{value:Be.content,onChange:e=>Oe({...Be,content:e.target.value}),placeholder:"Опишите план занятий на неделю...",rows:10,disabled:"sent"===ve.status||"archived"===ve.status})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Статус"}),s.jsxs(u,{value:Be.status,onValueChange:e=>Oe({...Be,status:e}),disabled:"sent"===ve.status||"archived"===ve.status,children:[s.jsx(o,{children:s.jsx(h,{})}),s.jsxs(x,{children:[s.jsx(m,{value:"draft",children:"Черновик"}),s.jsx(m,{value:"sent",children:"Отправить сразу"})]})]})]}),s.jsxs("div",{children:[s.jsx(c,{children:"Прикрепленные файлы"}),("sent"===ve.status||"archived"===ve.status)&&s.jsxs("p",{className:"text-xs text-amber-600 dark:text-amber-500 mt-1 flex items-center gap-1",children:[s.jsx(B,{className:"w-3 h-3"}),"Нельзя изменять файлы в отправленных или архивных планах"]}),s.jsx("div",{className:"mt-2 space-y-2",children:ve.files&&ve.files.length>0?ve.files.map(e=>{const t=U(e.name),a=G(e.name),r="draft"===ve.status;return s.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-md hover:bg-muted/80 transition-colors",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[s.jsx(t,{className:`w-4 h-4 flex-shrink-0 ${a}`}),s.jsx("a",{href:e.file_url,target:"_blank",rel:"noopener noreferrer",className:"text-sm font-medium hover:underline truncate",onClick:s=>M(s,e.file_url,e.name),children:e.name}),s.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap flex-shrink-0",children:K(e.file_size)})]}),r&&s.jsx(f,{type:"button",variant:"ghost",size:"sm",onClick:()=>(async(e,s)=>{if(confirm("Вы уверены, что хотите удалить этот файл?"))try{Ce(s);const t=await S.request(`/materials/teacher/study-plans/${e}/files/${s}/`,{method:"DELETE"});t.data||204===t.status?(P("Файл удален"),C.keys().forEach(e=>{e.startsWith("/materials/teacher/study-plans/")&&C.delete(e)}),Te()):z(t.error||"Ошибка при удалении файла")}catch(t){z("Произошла ошибка при удалении файла"),k.error("Delete file error:",t)}finally{Ce(null)}})(ve.id,e.id),disabled:ke===e.id,className:"flex-shrink-0",children:ke===e.id?s.jsx("span",{className:"text-xs",children:"Удаление..."}):s.jsx(J,{className:"w-4 h-4 text-destructive"})})]},e.id)}):s.jsx("p",{className:"text-sm text-muted-foreground",children:"Нет прикрепленных файлов"})})]}),"draft"===ve.status&&s.jsxs("div",{children:[s.jsx(c,{children:"Загрузить файл"}),s.jsxs("div",{className:"mt-2 space-y-2",children:[s.jsx(b,{type:"file",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&((async(e,s)=>{const t=Q(s,10);if(t.isValid)try{Se(e);const t=new FormData;t.append("file",s);const a=await S.request(`/materials/teacher/study-plans/${e}/files/`,{method:"POST",body:t});if(a.data){if(P("Файл загружен"),C.keys().forEach(e=>{e.startsWith("/materials/teacher/study-plans/")&&C.delete(e)}),ve&&ve.id===e){const s=await S.request(`/materials/teacher/study-plans/${e}/`);s.data&&ge(s.data)}Te()}else z(a.error||"Ошибка при загрузке файла")}catch(a){z("Произошла ошибка при загрузке файла"),k.error("Upload file error:",a)}finally{Se(null)}else z(t.error||"Файл слишком большой")})(ve.id,t),e.target.value="")},disabled:_e===ve.id,accept:".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,.zip,.rar"}),s.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[s.jsx(B,{className:"w-3 h-3"}),"Максимальный размер файла: 10 MB"]}),_e===ve.id&&s.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Загрузка..."})]})]}),s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx(f,{type:"button",variant:"outline",onClick:()=>fe(!1),children:"sent"===ve.status||"archived"===ve.status?"Закрыть":"Отмена"}),"draft"===ve.status&&s.jsx(f,{type:"button",onClick:async()=>{if(ve&&Be.title&&Be.content&&Be.week_start_date)try{const e=await S.request(`/materials/teacher/study-plans/${ve.id}/`,{method:"PATCH",body:JSON.stringify({title:Be.title,content:Be.content,week_start_date:Be.week_start_date,status:Be.status})});e.data?(P("План занятий обновлен"),fe(!1),C.keys().forEach(e=>{e.startsWith("/materials/teacher/study-plans/")&&C.delete(e)}),Te()):z(e.error||"Ошибка при обновлении плана")}catch(e){z("Произошла ошибка при обновлении плана"),k.error("Edit plan error:",e)}else z("Заполните все обязательные поля")},children:"Сохранить"})]})]})]})})]})]})]})})}export{R as default};
