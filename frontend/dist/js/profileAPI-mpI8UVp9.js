import{r as e,j as t}from"./react-core-JVqWokWt.js";import{f as r,l as a,u as s,B as c}from"./main-fde3JC90.js";const n={async generateLinkToken(){try{const e=await r.post("/api/accounts/telegram/link-token/");if(!e.success)throw new Error(e.error||"Failed to generate link token");return e}catch(e){const t=e instanceof Error?e.message:"Failed to generate link token";return a.error("generateLinkToken error:",{error:t}),{success:!1,error:t,timestamp:(new Date).toISOString()}}},async getTelegramProfile(){try{const e=await r.get("/api/accounts/telegram/profile/");if(!e.success)throw new Error(e.error||"Failed to get Telegram profile");return e}catch(e){const t=e instanceof Error?e.message:"Failed to get Telegram profile";return a.error("getTelegramProfile error:",{error:t}),{success:!1,error:t,timestamp:(new Date).toISOString()}}},async unlinkTelegram(){try{const e=await r.delete("/api/accounts/telegram/unlink/");if(!e.success)throw new Error(e.error||"Failed to unlink Telegram");return e}catch(e){const t=e instanceof Error?e.message:"Failed to unlink Telegram";return a.error("unlinkTelegram error:",{error:t}),{success:!1,error:t,timestamp:(new Date).toISOString()}}}},o=({isLinked:r,telegramUsername:a,onStatusChange:o})=>{const[i,l]=e.useState(!1),[u,d]=e.useState(null),[h,m]=e.useState(null),{toast:p}=s();e.useEffect(()=>{r&&f()},[r]);const f=async()=>{try{const e=await n.getTelegramProfile();e.success&&e.data&&m(e.data)}catch(e){console.error("Failed to fetch Telegram profile:",e)}};return t.jsxs("div",{className:"flex flex-col gap-3 p-4 rounded-lg border border-gray-200 bg-gray-50",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{d:"M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.146-.28.292-.576.292-.482 0-.403-.178-.568-.631l-1.25-4.405-3.51-1.094c-.532-.17-.547-.547.12-.816l13.863-5.338c.684-.256 1.29.063 1.061 1.196z"})}),r&&h?t.jsxs("div",{className:"flex flex-col",children:[t.jsxs("span",{className:"text-sm font-medium text-gray-900",children:["Telegram привязан: @",h.telegram_username]}),t.jsxs("span",{className:"text-xs text-gray-500",children:["Привязано: ",new Date(h.linked_at).toLocaleDateString("ru-RU")]})]}):t.jsx("span",{className:"text-sm text-gray-600",children:"Telegram не привязан"})]}),t.jsx("div",{className:"flex gap-2",children:r?t.jsx(c,{variant:"destructive",size:"sm",onClick:async()=>{l(!0);try{const e=await n.unlinkTelegram();if(!e.success)throw new Error(e.error||"Failed to unlink");m(null),p({title:"Готово",description:"Telegram отвязан от аккаунта"}),null==o||o()}catch(e){const t=e instanceof Error?e.message:"Не удалось отвязать Telegram";p({title:"Ошибка",description:t,variant:"destructive"})}finally{l(!1)}},disabled:i,className:"whitespace-nowrap",children:i?"Отвязка...":"Отвязать"}):t.jsx(c,{size:"sm",onClick:async()=>{l(!0),d(null);try{const e=await n.generateLinkToken();if(!e.success||!e.data)throw new Error(e.error||"Failed to generate link");{const{link:t}=e.data;null===window.open(t,"_blank","width=600,height=700")?(d(t),p({title:"Всплывающее окно заблокировано",description:"Нажмите на ссылку ниже для привязки аккаунта"})):p({title:"Ссылка создана",description:"Перейдите в Telegram для привязки аккаунта"})}}catch(e){const t=e instanceof Error?e.message:"Не удалось создать ссылку";p({title:"Ошибка",description:t,variant:"destructive"})}finally{l(!1)}},disabled:i,className:"whitespace-nowrap",children:i?"Загрузка...":"Привязать"})})]}),u&&t.jsx("div",{className:"mt-2",children:t.jsxs("a",{href:u,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 px-3 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors",children:[t.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"})}),"Открыть ссылку для привязки Telegram"]})})]})},i={_cache:new Map,_cacheTTL:3e5,async getCurrentUserProfile(){const e="/auth/profile/current",t=this._getCachedData(e);if(t)return{success:!0,data:t,timestamp:(new Date).toISOString()};try{const t=await r.request("/auth/profile/");return t.success&&t.data&&this._setCachedData(e,t.data),t}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to fetch profile",timestamp:(new Date).toISOString()}}},async getMyStudentProfile(){const e="/profile/student/",t=this._getCachedData(e);if(t)return{success:!0,data:t,timestamp:(new Date).toISOString()};try{const t=await r.request("/profile/student/");return t.success&&t.data&&this._setCachedData(e,t.data),t}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to fetch student profile",timestamp:(new Date).toISOString()}}},async updateStudentProfile(e){try{const t=e instanceof FormData,a=await r.request("/profile/student/",{method:"PATCH",body:t?e:JSON.stringify(e)});return a.success&&this._clearCache(),a}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to update student profile",timestamp:(new Date).toISOString()}}},async uploadStudentAvatar(e){try{const t=new FormData;t.append("avatar",e);const a=await r.request("/profile/student/",{method:"PATCH",body:t});return a.success&&this._clearCache(),a}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to upload student avatar",timestamp:(new Date).toISOString()}}},async getMyTeacherProfile(){const e="/profile/teacher/",t=this._getCachedData(e);if(t)return{success:!0,data:t,timestamp:(new Date).toISOString()};try{const t=await r.request("/profile/teacher/");return t.success&&t.data&&this._setCachedData(e,t.data),t}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to fetch teacher profile",timestamp:(new Date).toISOString()}}},async updateTeacherProfile(e){try{const t=e instanceof FormData,a=await r.request("/profile/teacher/",{method:"PATCH",body:t?e:JSON.stringify(e)});return a.success&&this._clearCache(),a}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to update teacher profile",timestamp:(new Date).toISOString()}}},async uploadTeacherAvatar(e){try{const t=new FormData;t.append("avatar",e);const a=await r.request("/profile/teacher/",{method:"PATCH",body:t});return a.success&&this._clearCache(),a}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to upload teacher avatar",timestamp:(new Date).toISOString()}}},async getMyTutorProfile(){const e="/profile/tutor/",t=this._getCachedData(e);if(t)return{success:!0,data:t,timestamp:(new Date).toISOString()};try{const t=await r.request("/profile/tutor/");return t.success&&t.data&&this._setCachedData(e,t.data),t}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to fetch tutor profile",timestamp:(new Date).toISOString()}}},async updateTutorProfile(e){try{const t=e instanceof FormData,a=await r.request("/profile/tutor/",{method:"PATCH",body:t?e:JSON.stringify(e)});return a.success&&this._clearCache(),a}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to update tutor profile",timestamp:(new Date).toISOString()}}},async uploadTutorAvatar(e){try{const t=new FormData;t.append("avatar",e);const a=await r.request("/profile/tutor/",{method:"PATCH",body:t});return a.success&&this._clearCache(),a}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to upload tutor avatar",timestamp:(new Date).toISOString()}}},async getMyParentProfile(){const e="/profile/parent/",t=this._getCachedData(e);if(t)return{success:!0,data:t,timestamp:(new Date).toISOString()};try{const t=await r.request("/profile/parent/");return t.success&&t.data&&this._setCachedData(e,t.data),t}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to fetch parent profile",timestamp:(new Date).toISOString()}}},async updateParentProfile(e){try{const t=e instanceof FormData,a=await r.request("/profile/parent/",{method:"PATCH",body:t?e:JSON.stringify(e)});return a.success&&this._clearCache(),a}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to update parent profile",timestamp:(new Date).toISOString()}}},async uploadParentAvatar(e){try{const t=new FormData;t.append("avatar",e);const a=await r.request("/profile/parent/",{method:"PATCH",body:t});return a.success&&this._clearCache(),a}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to upload parent avatar",timestamp:(new Date).toISOString()}}},async getUserProfile(e){const t=`/auth/profile/user/${e}`,a=this._getCachedData(t);if(a)return{success:!0,data:a,timestamp:(new Date).toISOString()};try{const a=await r.request(`/auth/profile/${e}/`);return a.success&&a.data&&this._setCachedData(t,a.data),a}catch(s){return{success:!1,error:s instanceof Error?s.message:"Failed to fetch user profile",timestamp:(new Date).toISOString()}}},async updateCurrentProfile(e){try{const t=await r.request("/auth/profile/update/",{method:"PATCH",body:JSON.stringify(e)});return t.success&&this._clearCache(),t}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to update profile",timestamp:(new Date).toISOString()}}},async updateUserProfile(e,t){try{const a=await r.request(`/auth/profile/${e}/`,{method:"PATCH",body:JSON.stringify(t)});return a.success&&this._clearCache(),a}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to update user profile",timestamp:(new Date).toISOString()}}},async getProfilesByRole(e){const t=`/auth/profiles/role/${e}`,a=this._getCachedData(t);if(a)return{success:!0,data:a,timestamp:(new Date).toISOString()};try{const a=await r.request(`/auth/profiles/?role=${e}`);return a.success&&a.data&&this._setCachedData(t,a.data),a}catch(s){return{success:!1,error:s instanceof Error?s.message:`Failed to fetch ${e} profiles`,timestamp:(new Date).toISOString()}}},invalidateCache(){this._clearCache()},async prefetchProfile(){await this.getCurrentUserProfile()},_getCachedData(e){const t=this._cache.get(e);if(!t)return null;return Date.now()-t.timestamp>t.ttl?(this._cache.delete(e),null):t.data},_setCachedData(e,t,r=this._cacheTTL){this._cache.set(e,{data:t,timestamp:Date.now(),ttl:r})},_clearCache(){this._cache.clear()},extractProfileData(e){if(!e||!e.user)return null;switch(e.user.role){case"student":case"teacher":case"tutor":case"parent":return e.profile;default:return null}},isProfileComplete(e){if(!e||!e.user)return!1;const t=Boolean(e.user.id&&e.user.email&&e.user.role),r=void 0!==e.profile;return t&&r},async reactivateProfile(){try{const e=await r.request("/profile/reactivate/",{method:"POST"});return e.success&&this._clearCache(),e}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to reactivate profile",timestamp:(new Date).toISOString()}}}};export{o as T,i as p};
