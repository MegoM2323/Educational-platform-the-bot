import{r as e,j as t}from"./react-core-JVqWokWt.js";import{u as s,S as a,P as r,a as n,e as i,C as d,B as l,l as c,f as m}from"./main-fde3JC90.js";import{e as o,u}from"./react-router-WAeXREDX.js";import{u as x}from"./react-query-DqnBFrGE.js";import{a6 as h,am as p,bu as j,aO as f,be as g}from"./vendor-DC2AZkDs.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const b=()=>{const[b]=o(),y=u(),N=x(),{toast:v}=s(),[w,C]=e.useState("loading"),[k,S]=e.useState(null),[E,P]=e.useState(null),[_,q]=e.useState(!1),[D,K]=e.useState(null);return e.useEffect(()=>{let e,t=b.get("payment_id");if(!t&&(t=sessionStorage.getItem("pending_payment_id"),t)){const e=new URL(window.location.href);e.searchParams.set("payment_id",t),window.history.replaceState({},"",e.toString())}if(!t)return C("failed"),void v({title:"Ошибка",description:"Не указан идентификатор платежа",variant:"destructive"});sessionStorage.removeItem("pending_payment_id");let s=0;const a=async(r=0)=>{try{q(!0),s++,c.debug(`[Payment Check ${s}] Retry ${r+1}/60`);const n=await m.request(`/payments/check-payment-status/?payment_id=${t}`);if(n.data){const t=n.data.status;S(n.data),"succeeded"===t||"SUCCEEDED"===t?(c.debug("[Payment Check] Status: SUCCEEDED"),C("success"),c.debug("[Payment Success] Invalidating all parent dashboard caches..."),await N.invalidateQueries({queryKey:["parent-dashboard"]}),await N.invalidateQueries({queryKey:["parent-children"]}),await N.invalidateQueries({queryKey:["parent-payments"]}),await N.invalidateQueries({queryKey:["parent-subscriptions"]}),c.debug("[Payment Success] Refetching parent dashboard data..."),await N.refetchQueries({queryKey:["parent-dashboard"]}),await N.refetchQueries({queryKey:["parent-children"]}),await N.refetchQueries({queryKey:["parent-payments"]}),c.debug("[Payment Success] All caches refreshed successfully"),v({title:"Платеж успешно завершен!",description:"Доступ к предмету активирован."}),P(5)):"pending"===t||"PENDING"===t||"waiting_for_capture"===t?(c.debug(`[Payment Check] Status: ${t} - continuing polling`),C("pending"),r<60?(r%5==0&&c.debug(`Payment pending, retry ${r+1}/60`),e=setTimeout(()=>a(r+1),3e3)):(c.debug("[Payment Check] Max retries reached (3 minutes), stopping polling"),C("pending"),v({title:"Платеж обрабатывается",description:"Обработка платежа занимает больше времени, чем обычно (более 3 минут). Платеж будет учтен автоматически, пожалуйста, вернитесь в личный кабинет.",variant:"default"}))):"canceled"!==t&&"CANCELED"!==t||(c.debug("[Payment Check] Status: CANCELED"),C("failed"),v({title:"Платеж отменен",description:"Платеж был отменен.",variant:"destructive"}))}}catch(n){c.error("[Payment Check] Error:",n),C("pending"),r<30&&(e=setTimeout(()=>a(r+1),5e3))}finally{q(!1)}};return a(),()=>{e&&clearTimeout(e)}},[b,v,N]),e.useEffect(()=>{if(null===E)return;if(0===E)return void y("/dashboard/parent",{replace:!0});const e=setTimeout(()=>{P(E-1)},1e3);return()=>clearTimeout(e)},[E,y]),t.jsx(a,{children:t.jsxs("div",{className:"flex min-h-screen w-full",children:[t.jsx(r,{}),t.jsxs(n,{children:[t.jsxs("header",{className:"flex h-16 shrink-0 items-center gap-2 border-b px-4",children:[t.jsx(i,{}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("h1",{className:"text-lg font-semibold",children:"Статус платежа"})})]}),t.jsx("main",{className:"flex flex-1 flex-col gap-4 p-6",children:t.jsxs(d,{className:"p-8 max-w-2xl mx-auto",children:["loading"===w&&t.jsxs("div",{className:"text-center",children:[t.jsx(h,{className:"h-16 w-16 mx-auto mb-4 animate-spin text-primary"}),t.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Проверка платежа..."}),t.jsx("p",{className:"text-muted-foreground",children:"Пожалуйста, подождите"})]}),"success"===w&&t.jsxs("div",{className:"text-center",children:[t.jsx(p,{className:"h-16 w-16 mx-auto mb-4 text-green-500"}),t.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Платеж успешно завершен!"}),t.jsx("p",{className:"text-muted-foreground mb-6",children:"Ваш платеж был успешно обработан"}),k&&t.jsxs("div",{className:"space-y-2 mb-6 text-left bg-muted p-4 rounded-lg",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-muted-foreground",children:"Сумма:"}),t.jsxs("span",{className:"font-semibold",children:[k.amount," ₽"]})]}),k.description&&t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-muted-foreground",children:"Описание:"}),t.jsx("span",{className:"font-medium",children:k.description})]}),k.paid_at&&t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-muted-foreground",children:"Дата оплаты:"}),t.jsx("span",{children:new Date(k.paid_at).toLocaleString("ru-RU")})]})]}),t.jsx("div",{className:"mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg",children:t.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[t.jsx(j,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),t.jsxs("div",{children:[t.jsx("p",{className:"font-semibold text-green-800 dark:text-green-200",children:"Автосписание подключено"}),t.jsx("p",{className:"text-sm text-green-700 dark:text-green-300",children:"Платежи будут списываться автоматически согласно расписанию"})]})]})}),null!==E&&t.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["Автоматический переход в личный кабинет через ",E," сек..."]}),t.jsxs("div",{className:"flex gap-4 justify-center",children:[t.jsx(l,{type:"button",onClick:()=>y("/dashboard/parent"),children:"Вернуться в личный кабинет"}),t.jsx(l,{type:"button",variant:"outline",onClick:()=>y("/dashboard/parent/payment-history"),children:"История платежей"})]})]}),"pending"===w&&t.jsxs("div",{className:"text-center",children:[t.jsx(h,{className:"h-16 w-16 mx-auto mb-4 animate-spin text-yellow-500"}),t.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Платеж обрабатывается"}),t.jsx("p",{className:"text-muted-foreground mb-2",children:"Ваш платеж находится в обработке. Пожалуйста, подождите."}),t.jsx("p",{className:"text-sm text-muted-foreground mb-6",children:"Обработка может занять до 3 минут"}),t.jsx(l,{type:"button",onClick:()=>y("/dashboard/parent"),children:"Вернуться в личный кабинет"})]}),"failed"===w&&t.jsxs("div",{className:"text-center",children:[t.jsx(f,{className:"h-16 w-16 mx-auto mb-4 text-red-500"}),t.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Ошибка платежа"}),t.jsx("p",{className:"text-muted-foreground mb-6",children:"Произошла ошибка при обработке платежа. Пожалуйста, попробуйте еще раз."}),t.jsxs("div",{className:"flex gap-4 justify-center",children:[t.jsx(l,{type:"button",onClick:()=>y("/dashboard/parent"),children:"Вернуться в личный кабинет"}),t.jsxs(l,{type:"button",variant:"outline",onClick:()=>window.history.back(),children:[t.jsx(g,{className:"w-4 h-4 mr-2"}),"Назад"]})]})]})]})})]})]})})};export{b as default};
