import{r as e,j as s}from"./react-core-JVqWokWt.js";import{D as n,w as a,x as l,y as t,z as i,V as d,W as r,a7 as c,B as o,u as m,C as u,J as x,K as h,Y as p,L as j,g as f,h as v,i as g,j as y,k as N,a8 as w,_ as b,E as k,c as C,S,a as L,e as _,b as D}from"./main-fde3JC90.js";import{T as I}from"./TeacherSidebar-Bwv8PTW2.js";import{u as E,a as q,b as P}from"./react-query-DqnBFrGE.js";import{k as F}from"./knowledgeGraphAPI-D8HHnFWf.js";import{G as z}from"./GraphVisualization-DxSFfcHP.js";import{an as A,$ as K,cc as M,aa as O,a6 as Q,a1 as G,cd as T,X as U,bc as W,ao as V,at as R,ap as $,ce as B,cf as J,bp as X,cg as Y,aF as Z}from"./vendor-DC2AZkDs.js";import{u as H}from"./useTeacher-DJCQuFgv.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./react-router-WAeXREDX.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";import"./teacher-BhCI6v5d.js";const ee=({open:m,onOpenChange:u,lessonId:x,lessonName:h,affectedDependencies:p,affectedStudents:j=0,onConfirm:f,onCancel:v})=>{const[g,y]=e.useState(!1),[N,w]=e.useState(null);return s.jsx(n,{open:m,onOpenChange:u,children:s.jsxs(a,{className:"sm:max-w-[500px]",children:[s.jsxs(l,{children:[s.jsxs(t,{className:"flex items-center gap-2",children:[s.jsx(A,{className:"h-5 w-5 text-destructive"}),"Удалить урок из графа?"]}),s.jsx(i,{children:"Это действие приведет к удалению урока и всех связанных данных"})]}),s.jsxs("div",{className:"space-y-4 py-4",children:[s.jsxs(d,{variant:"destructive",children:[s.jsx(K,{className:"h-4 w-4"}),s.jsxs(r,{children:[s.jsx("strong",{children:"ВНИМАНИЕ:"})," Вы собираетесь удалить урок ",s.jsxs("strong",{children:['"',h,'"']})," из графа знаний."]})]}),s.jsxs("div",{className:"space-y-3 text-sm",children:[s.jsx("p",{className:"font-medium text-muted-foreground",children:"Что будет удалено:"}),s.jsxs("div",{className:"space-y-2 pl-4",children:[p>0&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(M,{className:"h-4 w-4 text-orange-500"}),s.jsxs("span",{children:[s.jsx("strong",{children:p})," ",1===p?"зависимость":p>4?"зависимостей":"зависимости"]})]}),j>0&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(O,{className:"h-4 w-4 text-blue-500"}),s.jsxs("span",{children:["Прогресс ",s.jsx("strong",{children:j})," ",1===j?"студента":"студентов"," будет очищен"]})]}),0===p&&0===j&&s.jsx("p",{className:"text-muted-foreground italic",children:"Урок не имеет зависимостей и не используется студентами"})]}),s.jsxs(d,{className:"mt-4",children:[s.jsx(K,{className:"h-4 w-4"}),s.jsxs(r,{className:"text-xs",children:["Это действие будет сохранено только после нажатия кнопки ",s.jsx("strong",{children:'"Сохранить"'})," в редакторе графа."]})]})]}),N&&s.jsxs(d,{variant:"destructive",children:[s.jsx(K,{className:"h-4 w-4"}),s.jsx(r,{children:N})]})]}),s.jsxs(c,{children:[s.jsx(o,{type:"button",variant:"outline",onClick:()=>{g||(w(null),null==v||v(),u(!1))},disabled:g,children:"Отмена"}),s.jsx(o,{type:"button",variant:"destructive",onClick:async()=>{y(!0),w(null);try{await f(),u(!1)}catch(e){const s=e instanceof Error?e.message:"Неизвестная ошибка при удалении урока";w(s)}finally{y(!1)}},disabled:g,children:g?s.jsxs(s.Fragment,{children:[s.jsx(Q,{className:"h-4 w-4 mr-2 animate-spin"}),"Удаление..."]}):s.jsxs(s.Fragment,{children:[s.jsx(A,{className:"h-4 w-4 mr-2"}),"Удалить"]})})]})]})})},se=({subjectId:d,subjectName:r})=>{var c,S,L,_,D,I,H,se,ne,ae;const{toast:le}=m(),{students:te,selectedStudent:ie,graph:de,availableLessons:re,isLoadingStudents:ce,isLoadingGraph:oe,isLoadingLessons:me,isSaving:ue,studentsError:xe,graphError:he,lessonsError:pe,editState:je,hasUnsavedChanges:fe,selectStudent:ve,addLesson:ge,removeLesson:ye,updateLessonPosition:Ne,addDependency:we,removeDependency:be,saveChanges:ke,cancelChanges:Ce,undo:Se,redo:Le,canUndo:_e,canRedo:De,refetchStudents:Ie,refetchGraph:Ee}=(s=>{const n=E(),[a,l]=e.useState(null),[t,i]=e.useState({modifiedPositions:new Map,addedLessons:new Set,removedLessons:new Set,addedDependencies:[],removedDependencies:new Set}),[d,r]=e.useState([]),[c,o]=e.useState([]),[m,u]=e.useState(!1),[x,h]=e.useState(null),{data:p=[],isLoading:j,error:f,refetch:v}=q({queryKey:["teacher-students"],queryFn:F.getTeacherStudents,staleTime:6e4,refetchOnMount:!0,refetchOnWindowFocus:!1,retry:2,retryDelay:e=>Math.min(1e3*2**e,5e3)}),{data:g=null,isLoading:y,error:N,refetch:w}=q({queryKey:["knowledge-graph",null==a?void 0:a.id,s],queryFn:()=>a&&s?F.getOrCreateGraph(a.id,s):Promise.resolve(null),enabled:!!a&&!!s,staleTime:3e4,refetchOnMount:!0,refetchOnWindowFocus:!1,retry:2}),{data:b=[],isLoading:k,error:C}=q({queryKey:["lessons",s],queryFn:()=>F.getLessons({subject:s,created_by:"me"}),enabled:!!s,staleTime:6e4,refetchOnMount:!0,refetchOnWindowFocus:!1,retry:2}),S=P({mutationFn:({graphId:e,lessonId:s,x:n,y:a})=>F.addLessonToGraph(e,{lesson_id:s,position_x:n,position_y:a}),onSuccess:()=>{(null==a?void 0:a.id)&&s&&n.invalidateQueries({queryKey:["knowledge-graph",a.id,s]}),n.invalidateQueries({queryKey:["knowledge-graph"],exact:!1})}}),L=P({mutationFn:({graphId:e,updates:s})=>F.batchUpdateLessons(e,{lessons:s}),onSuccess:()=>{(null==a?void 0:a.id)&&s&&n.invalidateQueries({queryKey:["knowledge-graph",a.id,s]}),n.invalidateQueries({queryKey:["knowledge-graph"],exact:!1})}}),_=P({mutationFn:({graphId:e,graphLessonId:s})=>F.removeLessonFromGraph(e,s),onSuccess:()=>{(null==a?void 0:a.id)&&s&&n.invalidateQueries({queryKey:["knowledge-graph",a.id,s]}),n.invalidateQueries({queryKey:["knowledge-graph"],exact:!1})}}),D=P({mutationFn:({graphId:e,fromLessonId:s,toLessonId:n})=>F.addDependency(e,s,{to_lesson_id:n}),onSuccess:()=>{(null==a?void 0:a.id)&&s&&n.invalidateQueries({queryKey:["knowledge-graph",a.id,s]}),n.invalidateQueries({queryKey:["knowledge-graph"],exact:!1})}}),I=P({mutationFn:({graphId:e,lessonId:s,dependencyId:n})=>F.removeDependency(e,s,n),onSuccess:()=>{(null==a?void 0:a.id)&&s&&n.invalidateQueries({queryKey:["knowledge-graph",a.id,s]}),n.invalidateQueries({queryKey:["knowledge-graph"],exact:!1})}});e.useEffect(()=>{p.length>0&&!a&&l(p[0])},[p]),e.useEffect(()=>{i({modifiedPositions:new Map,addedLessons:new Set,removedLessons:new Set,addedDependencies:[],removedDependencies:new Set}),r([]),o([])},[null==g?void 0:g.id]);const z=e.useCallback(()=>{r(e=>[...e,{...t}]),o([])},[t]),A=t.modifiedPositions.size>0||t.addedLessons.size>0||t.removedLessons.size>0||t.addedDependencies.length>0||t.removedDependencies.size>0,K=e.useCallback(e=>{l(e)},[]),M=e.useCallback(async(e,s=0,n=0)=>{g&&(z(),i(s=>({...s,addedLessons:new Set([...s.addedLessons,e])})),await S.mutateAsync({graphId:g.id,lessonId:e,x:s,y:n}))},[g,z,S]),O=e.useCallback(e=>{z(),i(s=>({...s,removedLessons:new Set([...s.removedLessons,e])}))},[z]),Q=e.useCallback((e,s,n)=>{z(),i(a=>{const l=new Map(a.modifiedPositions);return l.set(e,{x:s,y:n}),{...a,modifiedPositions:l}})},[z]),G=e.useCallback((e,s)=>{z(),i(n=>({...n,addedDependencies:[...n.addedDependencies,{from:e,to:s}]}))},[z]),T=e.useCallback(e=>{z(),i(s=>({...s,removedDependencies:new Set([...s.removedDependencies,e])}))},[z]),U=e.useCallback(async()=>{if(g){if(t.modifiedPositions.size>0){const e=Array.from(t.modifiedPositions.entries()).map(([e,s])=>({graph_lesson_id:e,position_x:s.x,position_y:s.y}));await L.mutateAsync({graphId:g.id,updates:e})}for(const e of t.removedLessons)await _.mutateAsync({graphId:g.id,graphLessonId:e});for(const e of t.addedDependencies)await D.mutateAsync({graphId:g.id,fromLessonId:e.from,toLessonId:e.to});for(const e of t.removedDependencies){const s=g.dependencies.find(s=>s.id===e);s&&await I.mutateAsync({graphId:g.id,lessonId:s.from_lesson,dependencyId:e})}await w(),i({modifiedPositions:new Map,addedLessons:new Set,removedLessons:new Set,addedDependencies:[],removedDependencies:new Set}),r([]),o([])}},[g,t,L,_,D,I,w]),W=e.useCallback(()=>{i({modifiedPositions:new Map,addedLessons:new Set,removedLessons:new Set,addedDependencies:[],removedDependencies:new Set}),r([]),o([])},[]),V=e.useCallback(()=>{if(0===d.length)return;const e=d[d.length-1];o(e=>[...e,t]),i(e),r(e=>e.slice(0,-1))},[d,t]),R=e.useCallback(()=>{if(0===c.length)return;const e=c[c.length-1];r(e=>[...e,t]),i(e),o(e=>e.slice(0,-1))},[c,t]),$=e.useCallback(e=>{if(e instanceof Error){const s=e.message.toLowerCase();return s.includes("403")||s.includes("forbidden")||s.includes("прав")?{type:"permission",message:e.message,statusCode:403}:s.includes("404")||s.includes("не найден")?{type:"not_found",message:e.message,statusCode:404}:s.includes("400")||s.includes("validation")||s.includes("используется")?{type:"validation",message:e.message,statusCode:400}:s.includes("network")||s.includes("сеть")?{type:"network",message:e.message}:{type:"unknown",message:e.message}}return{type:"unknown",message:"Неизвестная ошибка"}},[]),B=e.useCallback(async e=>{if(g){u(!0),h(null);try{await F.deleteLesson(g.id,e);const l=g.lessons.find(s=>s.lesson.id===e);l&&(n.setQueryData(["knowledge-graph",null==a?void 0:a.id,s],s=>s?{...s,lessons:s.lessons.filter(s=>s.lesson.id!==e),dependencies:s.dependencies.filter(e=>e.from_lesson!==l.id&&e.to_lesson!==l.id)}:null),z()),await w()}catch(l){const e=$(l);throw h(e),l}finally{u(!1)}}},[g,a,s,n,z,$,w]),J=e.useCallback(async(e,l,t)=>{if(g){u(!0),h(null);try{await F.deleteDependency(g.id,t,e),n.setQueryData(["knowledge-graph",null==a?void 0:a.id,s],s=>s?{...s,dependencies:s.dependencies.filter(s=>s.id!==e)}:null),z(),await w()}catch(i){const e=$(i);throw h(e),i}finally{u(!1)}}},[g,a,s,n,z,$,w]);return{students:p,selectedStudent:a,graph:g,availableLessons:b,isLoadingStudents:j,isLoadingGraph:y,isLoadingLessons:k,isSaving:S.isPending||L.isPending||_.isPending||D.isPending||I.isPending,isDeleting:m,studentsError:f,graphError:N,lessonsError:C,deleteError:x,editState:t,hasUnsavedChanges:A,selectStudent:K,refetchStudents:v,addLesson:M,removeLesson:O,updateLessonPosition:Q,addDependency:G,removeDependency:T,deleteLesson:B,deleteDependency:J,saveChanges:U,cancelChanges:W,undo:V,redo:R,canUndo:d.length>0,canRedo:c.length>0}})(d),[qe,Pe]=e.useState("view"),[Fe,ze]=e.useState(!1),[Ae,Ke]=e.useState(""),[Me,Oe]=e.useState(null),[Qe,Ge]=e.useState(null),[Te,Ue]=e.useState(!1),[We,Ve]=e.useState(null),[Re,$e]=e.useState(!1),[Be,Je]=e.useState(null),Xe=e.useCallback(e=>{if(!e)return{nodes:[],links:[]};const s=Array.isArray(e.lessons)?e.lessons:[],n=Array.isArray(e.dependencies)?e.dependencies:[];s.length,n.length;const a=s.filter(e=>e&&e.lesson).map((e,n)=>{var a;let l=e.position_x,t=e.position_y;if(null==l||null==t){const e=n/s.length*2*Math.PI,a=200;l=400+a*Math.cos(e),t=300+a*Math.sin(e)}return{id:e.id.toString(),title:(null==(a=e.lesson)?void 0:a.title)||"Без названия",status:e.is_unlocked?"not_started":"locked",x:l,y:t}}),l=n.map(e=>({source:e.from_lesson.toString(),target:e.to_lesson.toString(),type:"prerequisite"===e.dependency_type?"prerequisite":"suggested",id:e.id})),t={nodes:a,links:l};return t},[]),Ye=te||[],Ze=re||[],He=new Set(Array.isArray(null==de?void 0:de.lessons)?de.lessons.map(e=>{var s;return null==(s=null==e?void 0:e.lesson)?void 0:s.id}).filter(e=>void 0!==e):[]),es=Ze.filter(e=>{var s,n;return!!e&&(!He.has(e.id)&&(!Ae||((null==(s=e.title)?void 0:s.toLowerCase().includes(Ae.toLowerCase()))||(null==(n=e.description)?void 0:n.toLowerCase().includes(Ae.toLowerCase())))))}),ss=e.useCallback((e,s,n)=>{const a=parseInt(e,10);isNaN(a)||Ne(a,s,n)},[Ne]),ns=e.useCallback(e=>{var s;if(We){if(We!==e){const s=parseInt(We,10),n=parseInt(e,10);isNaN(s)||isNaN(n)||(we(s,n),le({title:"Зависимость добавлена",description:'Связь будет сохранена после нажатия "Сохранить"'}))}Ve(null)}else if("view"===qe){const n=null==(s=null==de?void 0:de.lessons)?void 0:s.find(s=>s.id.toString()===e);n&&(Ge(n),Ue(!0))}else Oe(s=>s===e?null:e)},[qe,de,We,we,le]);e.useEffect(()=>{const e=e=>{"Escape"===e.key&&(Ve(null),Oe(null))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);const as=e.useCallback(()=>{if("edit"===qe&&fe){if(!window.confirm("У вас есть несохранённые изменения. Вы уверены, что хотите выйти из режима редактирования?"))return;Ce()}Pe(e=>"view"===e?"edit":"view")},[qe,fe,Ce]),ls=e.useCallback(async()=>{try{await ke(),le({title:"Изменения сохранены",description:"Граф знаний успешно обновлён"}),Pe("view")}catch(e){le({title:"Ошибка сохранения",description:e instanceof Error?e.message:"Не удалось сохранить изменения",variant:"destructive"})}},[ke,le]),ts=e.useCallback(()=>{window.confirm("Вы уверены, что хотите отменить все несохранённые изменения?")&&(Ce(),Pe("view"))},[Ce]),is=e.useCallback(async e=>{try{const s=400,n=300;await ge(e,s,n),ze(!1),le({title:"Урок добавлен",description:"Урок успешно добавлен в граф"})}catch(s){le({title:"Ошибка",description:s instanceof Error?s.message:"Не удалось добавить урок",variant:"destructive"})}},[ge,le]),ds=e.useCallback(e=>{var s,n,a;const l=null==(s=null==de?void 0:de.lessons)?void 0:s.find(s=>s.id===e),t=(null==(n=null==l?void 0:l.lesson)?void 0:n.title)||"этот урок",i=(null==(a=null==de?void 0:de.dependencies)?void 0:a.filter(s=>s.from_lesson===e||s.to_lesson===e).length)||0;Je({id:e,title:t,affectedDependencies:i,affectedStudents:ie?1:0}),$e(!0)},[de,ie]);return ce?s.jsxs("div",{className:"flex flex-col items-center justify-center h-96 space-y-4",children:[s.jsx(Q,{className:"h-8 w-8 animate-spin text-primary"}),s.jsx("span",{className:"text-muted-foreground",children:"Загрузка списка студентов..."})]}):oe||me?s.jsxs("div",{className:"flex flex-col items-center justify-center h-96 space-y-4",children:[s.jsx(Q,{className:"h-8 w-8 animate-spin text-primary"}),s.jsx("span",{className:"text-muted-foreground",children:oe?"Загрузка графа знаний...":"Загрузка уроков..."})]}):xe?s.jsxs("div",{className:"flex flex-col items-center justify-center h-96 space-y-4",children:[s.jsx(K,{className:"h-8 w-8 text-destructive"}),s.jsxs("div",{className:"text-center max-w-md",children:[s.jsx("p",{className:"font-semibold",children:"Ошибка загрузки студентов"}),s.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:xe instanceof Error?xe.message:"Не удалось загрузить список студентов"}),s.jsxs(o,{onClick:()=>Ie(),variant:"outline",size:"sm",children:[s.jsx(G,{className:"h-4 w-4 mr-2"}),"Попробовать снова"]})]})]}):he?s.jsxs("div",{className:"flex flex-col items-center justify-center h-96 space-y-4",children:[s.jsx(K,{className:"h-8 w-8 text-destructive"}),s.jsxs("div",{className:"text-center max-w-md",children:[s.jsx("p",{className:"font-semibold",children:"Ошибка загрузки графа знаний"}),s.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:he instanceof Error?he.message:"Не удалось загрузить граф знаний"}),s.jsxs(o,{onClick:()=>Ee(),variant:"outline",size:"sm",children:[s.jsx(G,{className:"h-4 w-4 mr-2"}),"Попробовать снова"]})]})]}):0===Ye.length?s.jsx(u,{children:s.jsxs(x,{children:[s.jsx(h,{children:"Нет студентов"}),s.jsx(p,{children:"У вас пока нет студентов для редактирования графов знаний"})]})}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-bold",children:"Редактор графов знаний"}),s.jsx("p",{className:"text-muted-foreground",children:r?`Предмет: ${r}`:"Визуальное редактирование графов"})]}),s.jsx("div",{className:"flex items-center gap-2",children:"view"===qe?s.jsxs(o,{onClick:as,variant:"default",children:[s.jsx(T,{className:"h-4 w-4 mr-2"}),"Редактировать"]}):s.jsxs(s.Fragment,{children:[s.jsxs(o,{onClick:ts,variant:"outline",disabled:ue,children:[s.jsx(U,{className:"h-4 w-4 mr-2"}),"Отмена"]}),s.jsxs(o,{onClick:ls,disabled:!fe||ue,children:[ue?s.jsx(Q,{className:"h-4 w-4 mr-2 animate-spin"}):s.jsx(W,{className:"h-4 w-4 mr-2"}),"Сохранить"]})]})})]}),s.jsxs(u,{children:[s.jsx(x,{children:s.jsxs(h,{className:"flex items-center gap-2",children:[s.jsx(O,{className:"h-5 w-5"}),"Выбор студента"]})}),s.jsx(j,{children:s.jsxs(f,{value:null==ie?void 0:ie.id.toString(),onValueChange:e=>{const s=Ye.find(s=>s.id.toString()===e);s&&ve(s)},children:[s.jsx(v,{className:"w-full",children:s.jsx(g,{placeholder:"Выберите студента"})}),s.jsx(y,{children:Ye.map(e=>s.jsxs(N,{value:e.id.toString(),children:[e.full_name," (",e.email,")"]},e.id))})]})})]}),"edit"===qe&&s.jsxs(u,{children:[s.jsx(x,{children:s.jsx(h,{children:"Инструменты редактирования"})}),s.jsxs(j,{className:"flex flex-wrap gap-2",children:[s.jsxs(n,{open:Fe,onOpenChange:ze,children:[s.jsx(w,{asChild:!0,children:s.jsxs(o,{variant:"outline",children:[s.jsx(V,{className:"h-4 w-4 mr-2"}),"Добавить урок"]})}),s.jsxs(a,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[s.jsxs(l,{children:[s.jsx(t,{children:"Банк уроков"}),s.jsx(i,{children:"Выберите уроки для добавления в граф знаний"})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"relative",children:[s.jsx(R,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(b,{placeholder:"Поиск уроков...",value:Ae,onChange:e=>Ke(e.target.value),className:"pl-10"})]}),s.jsx(k,{}),me&&s.jsxs("div",{className:"flex items-center justify-center py-8",children:[s.jsx(Q,{className:"h-6 w-6 animate-spin"}),s.jsx("span",{className:"ml-2 text-muted-foreground",children:"Загрузка уроков..."})]}),pe&&!me&&s.jsxs("div",{className:"text-center py-8 text-destructive",children:[s.jsx(K,{className:"h-8 w-8 mx-auto mb-2"}),s.jsx("p",{className:"font-medium",children:"Ошибка загрузки уроков"}),s.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:pe instanceof Error?pe.message:"Неизвестная ошибка"})]}),!me&&!pe&&0===es.length&&s.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[s.jsx($,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),Ae?s.jsxs(s.Fragment,{children:[s.jsx("p",{className:"font-medium",children:"Уроки не найдены"}),s.jsx("p",{className:"text-sm mt-1",children:"Попробуйте изменить поисковый запрос"})]}):s.jsxs(s.Fragment,{children:[s.jsx("p",{className:"font-medium",children:"Нет доступных уроков для добавления"}),s.jsx("p",{className:"text-sm mt-1",children:"Все уроки уже добавлены в граф или нет созданных уроков"})]})]}),!me&&!pe&&es.length>0&&s.jsx("div",{className:"space-y-2 max-h-[400px] overflow-y-auto",children:es.map(e=>s.jsx(u,{className:"cursor-pointer hover:bg-accent transition-colors",onClick:()=>is(e.id),children:s.jsx(j,{className:"p-4",children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"space-y-1 flex-1",children:[s.jsxs("h4",{className:"font-semibold flex items-center gap-2",children:[s.jsx($,{className:"h-4 w-4"}),e.title]}),s.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:e.description}),s.jsxs("div",{className:"flex gap-2 mt-2",children:[void 0!==e.elements_count&&s.jsxs(C,{variant:"outline",children:[e.elements_count," элементов"]}),s.jsxs(C,{variant:"outline",children:[e.total_duration_minutes," мин"]})]})]}),s.jsx(o,{type:"button",size:"sm",variant:"ghost",children:s.jsx(V,{className:"h-4 w-4"})})]})})},e.id))})]})]})]}),s.jsxs(o,{onClick:Se,variant:"outline",disabled:!_e,children:[s.jsx(B,{className:"h-4 w-4 mr-2"}),"Отменить"]}),s.jsxs(o,{onClick:Le,variant:"outline",disabled:!De,children:[s.jsx(J,{className:"h-4 w-4 mr-2"}),"Повторить"]}),fe&&s.jsx(C,{variant:"destructive",className:"ml-auto",children:"Есть несохранённые изменения"})]})]}),s.jsxs(u,{children:[s.jsxs(x,{children:[s.jsx(h,{children:"График знаний"}),s.jsx(p,{children:"view"===qe?"Режим просмотра - переключитесь в режим редактирования для изменения графа":"Перетаскивайте уроки, создавайте связи между ними"})]}),s.jsx(j,{children:de&&Array.isArray(de.lessons)&&0!==de.lessons.length?s.jsxs("div",{className:"relative",children:[s.jsx(z,{data:Xe(de),isEditable:"edit"===qe,onNodeClick:ns,onNodeDrag:ss,onDependencyDelete:be,width:800,height:600,showLegend:!0}),Me&&"edit"===qe&&s.jsxs(u,{className:"absolute top-4 left-4 p-4 space-y-2 z-50 bg-white/95 backdrop-blur shadow-lg",children:[s.jsx("p",{className:"font-medium text-sm",children:"Выбран урок"}),s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsxs(o,{type:"button",variant:"destructive",size:"sm",onClick:()=>{ds(parseInt(Me,10)),Oe(null)},children:[s.jsx(A,{className:"h-4 w-4 mr-2"}),"Удалить из графа"]}),s.jsxs(o,{type:"button",variant:"outline",size:"sm",onClick:()=>{Ve(Me),Oe(null)},children:[s.jsx(M,{className:"h-4 w-4 mr-2"}),"Создать связь"]})]})]}),We&&s.jsxs(u,{className:"absolute top-4 left-4 p-4 bg-yellow-50 border-yellow-200 z-50 shadow-lg",children:[s.jsx("p",{className:"font-medium text-yellow-800",children:"Режим создания связи"}),s.jsx("p",{className:"text-sm text-yellow-600 mt-1",children:"Выберите целевой урок (который зависит от выбранного)"}),s.jsx(o,{type:"button",variant:"outline",size:"sm",className:"mt-2",onClick:()=>Ve(null),children:"Отмена"})]})]}):s.jsxs("div",{className:"flex flex-col items-center justify-center py-16 text-center",children:[s.jsx($,{className:"h-16 w-16 text-muted-foreground mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Граф пуст"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"edit"===qe?"Добавьте уроки из банка, чтобы начать создание графа знаний":"Переключитесь в режим редактирования для добавления уроков"}),"edit"===qe&&s.jsxs(o,{onClick:()=>ze(!0),children:[s.jsx(V,{className:"h-4 w-4 mr-2"}),"Добавить первый урок"]})]})})]}),de&&s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[s.jsxs(u,{children:[s.jsx(x,{className:"pb-3",children:s.jsx(h,{className:"text-sm font-medium text-muted-foreground",children:"Уроков в графе"})}),s.jsx(j,{children:s.jsx("div",{className:"text-2xl font-bold",children:null!=(S=null==(c=null==de?void 0:de.lessons)?void 0:c.length)?S:0})})]}),s.jsxs(u,{children:[s.jsx(x,{className:"pb-3",children:s.jsx(h,{className:"text-sm font-medium text-muted-foreground",children:"Зависимостей"})}),s.jsx(j,{children:s.jsx("div",{className:"text-2xl font-bold",children:null!=(_=null==(L=null==de?void 0:de.dependencies)?void 0:L.length)?_:0})})]}),s.jsxs(u,{children:[s.jsx(x,{className:"pb-3",children:s.jsx(h,{className:"text-sm font-medium text-muted-foreground",children:"Статус"})}),s.jsx(j,{children:s.jsx(C,{variant:(null==de?void 0:de.is_active)?"default":"secondary",children:(null==de?void 0:de.is_active)?"Активен":"Неактивен"})})]})]}),"edit"===qe&&de&&Array.isArray(de.dependencies)&&de.dependencies.length>0&&s.jsxs(u,{className:"mt-4",children:[s.jsxs(x,{children:[s.jsx(h,{className:"text-lg",children:"Зависимости"}),s.jsx(p,{children:"Нажмите на иконку удаления чтобы убрать связь"})]}),s.jsx(j,{children:s.jsx("ul",{className:"space-y-2",children:de.dependencies.map(e=>{var n,a,l,t,i;const d=null==(n=de.lessons)?void 0:n.find(s=>s.id===e.from_lesson),r=null==(a=de.lessons)?void 0:a.find(s=>s.id===e.to_lesson),c=null==(l=null==je?void 0:je.removedDependencies)?void 0:l.has(e.id);return s.jsxs("li",{className:"flex items-center justify-between p-2 rounded "+(c?"bg-red-50 line-through text-muted-foreground":"bg-muted/50"),children:[s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-medium",children:(null==(t=null==d?void 0:d.lesson)?void 0:t.title)||"Урок"}),s.jsx(X,{className:"h-4 w-4"}),s.jsx("span",{className:"font-medium",children:(null==(i=null==r?void 0:r.lesson)?void 0:i.title)||"Урок"}),s.jsx(C,{variant:"outline",className:"ml-2",children:"prerequisite"===e.dependency_type||"required"===e.dependency_type?"Обязательная":"Рекомендуемая"})]}),s.jsx(o,{type:"button",variant:"ghost",size:"sm",onClick:()=>be(e.id),disabled:c,children:s.jsx(A,{className:"h-4 w-4 text-destructive"})})]},e.id)})})})]}),s.jsx(n,{open:Te,onOpenChange:Ue,children:s.jsxs(a,{children:[s.jsx(l,{children:s.jsxs(t,{className:"flex items-center gap-2",children:[s.jsx($,{className:"h-5 w-5"}),(null==(D=null==Qe?void 0:Qe.lesson)?void 0:D.title)||"Урок"]})}),s.jsxs("div",{className:"space-y-4",children:[s.jsx("p",{className:"text-muted-foreground",children:(null==(I=null==Qe?void 0:Qe.lesson)?void 0:I.description)||"Нет описания"}),s.jsx(k,{}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Y,{className:"h-4 w-4 text-muted-foreground"}),s.jsxs("span",{className:"text-sm",children:[s.jsx("span",{className:"font-medium",children:"Элементов:"})," ",null!=(se=null==(H=null==Qe?void 0:Qe.lesson)?void 0:H.elements_count)?se:0]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Z,{className:"h-4 w-4 text-muted-foreground"}),s.jsxs("span",{className:"text-sm",children:[s.jsx("span",{className:"font-medium",children:"Время:"})," ",null!=(ae=null==(ne=null==Qe?void 0:Qe.lesson)?void 0:ne.total_duration_minutes)?ae:0," мин"]})]})]}),s.jsx("div",{className:"flex items-center gap-2",children:s.jsx(C,{variant:(null==Qe?void 0:Qe.is_unlocked)?"default":"secondary",children:(null==Qe?void 0:Qe.is_unlocked)?"Разблокирован":"Заблокирован"})})]})]})}),Be&&s.jsx(ee,{open:Re,onOpenChange:$e,lessonId:Be.id,lessonName:Be.title,affectedDependencies:Be.affectedDependencies,affectedStudents:Be.affectedStudents,onConfirm:async()=>{ye(Be.id),le({title:"Урок удалён",description:"Урок будет удалён из графа после сохранения"}),Oe(null)},onCancel:()=>{Je(null)}})]})},ne=()=>{var n,a;const{data:l,isLoading:t,error:i}=H(),[c,o]=e.useState(null),m=(null==(n=null==l?void 0:l.profile)?void 0:n.subjects)||[];return e.useEffect(()=>{if(m.length>0&&!c){const e=m[0];"object"==typeof e&&(null==e?void 0:e.id)&&o(e.id)}},[m,c]),s.jsx(S,{children:s.jsxs("div",{className:"flex min-h-screen w-full",children:[s.jsx(I,{}),s.jsxs(L,{children:[s.jsxs("header",{className:"sticky top-0 z-10 flex h-16 items-center gap-4 border-b bg-background px-6",children:[s.jsx(_,{}),s.jsx("div",{className:"flex-1",children:s.jsx("h1",{className:"text-2xl font-bold",children:"Редактор графа знаний"})})]}),s.jsxs("main",{className:"p-6",children:[t&&s.jsxs("div",{className:"space-y-4",children:[s.jsx(D,{className:"h-12 w-full"}),s.jsx(D,{className:"h-64 w-full"})]}),i&&s.jsxs(d,{variant:"destructive",children:[s.jsx(K,{className:"h-4 w-4"}),s.jsxs(r,{children:["Ошибка загрузки данных преподавателя: ",i.message]})]}),!t&&!i&&0===m.length&&s.jsx(u,{className:"p-6",children:s.jsx("div",{className:"text-center text-muted-foreground",children:"У вас нет назначенных предметов. Обратитесь к администратору."})}),!t&&!i&&m.length>0&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx("label",{className:"text-sm font-medium",children:"Предмет:"}),s.jsxs(f,{value:(null==c?void 0:c.toString())||"",onValueChange:e=>o(Number(e)),children:[s.jsx(v,{className:"w-[300px]",children:s.jsx(g,{placeholder:"Выберите предмет"})}),s.jsx(y,{children:m.map(e=>{const n="object"==typeof e?e.id:null,a="object"==typeof e?e.name:e;return n?s.jsx(N,{value:n.toString(),children:a},n):null})})]})]}),c&&s.jsx(se,{subjectId:c,subjectName:(null==(a=m.find(e=>("object"==typeof e?e.id:null)===c))?void 0:a.name)||""})]})]})]})]})})};export{ne as default};
