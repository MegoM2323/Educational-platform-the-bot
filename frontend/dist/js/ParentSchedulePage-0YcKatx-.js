import{r as e,j as s}from"./react-core-JVqWokWt.js";import{aG as a,M as l,aH as t,S as r,P as n,a as c,e as i,C as d,J as m,K as o,L as x,b as h,g as u,h as j,i as p,j as g,k as N,a3 as f,a4 as v,a5 as b,a6 as w,B as y}from"./main-fde3JC90.js";import{a as _}from"./react-query-DqnBFrGE.js";import{L as T}from"./LessonCard-BUGWm0lu.js";import{N as S}from"./react-router-WAeXREDX.js";import{ab as C,aa as k,aU as $}from"./vendor-DC2AZkDs.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const L=()=>{const{user:L}=l(),{data:M,isLoading:D}=t(),[F,V]=e.useState(""),[q,B]=e.useState("upcoming"),[I,E]=e.useState("all"),[K,P]=e.useState("all"),{data:z,isLoading:A,error:G}=function(e,s={}){return _({queryKey:["lessons","parent-child",e,null==s?void 0:s.dateFrom,null==s?void 0:s.dateTo,null==s?void 0:s.subjectId,null==s?void 0:s.status],queryFn:async()=>{if(!e)throw new Error("No child selected");const l=await a.getParentChildSchedule(e,{date_from:s.dateFrom,date_to:s.dateTo,subject_id:s.subjectId,status:s.status});return{student:l.student,lessons:l.lessons,totalLessons:l.total_lessons}},enabled:!!e,staleTime:3e4,refetchOnMount:!0})}(F||null,{subjectId:"all"!==I?I:void 0}),H=(null==z?void 0:z.lessons)||[];if("parent"!==(null==L?void 0:L.role))return s.jsx(S,{to:"/dashboard",replace:!0});const J=(null==M?void 0:M.children)||[],O=e.useMemo(()=>{const e=new Date;return H.filter(s=>{if(!s.date||!s.start_time)return!1;const a=new Date(`${s.date}T${s.start_time}`);if(isNaN(a.getTime()))return!1;const l=a>e;return!("upcoming"===q&&!l)&&(("past"!==q||!l)&&((!I||"all"===I||s.subject_name===I)&&(!K||"all"===K||s.teacher_name===K)))}).sort((e,s)=>{const a=new Date(`${e.date}T${e.start_time}`),l=new Date(`${s.date}T${s.start_time}`);return"upcoming"===q?a.getTime()-l.getTime():l.getTime()-a.getTime()})},[H,q,I,K]),U=e.useMemo(()=>[...new Set(H.map(e=>e.subject_name).filter(Boolean))].sort(),[H]),Q=e.useMemo(()=>[...new Set(H.map(e=>e.teacher_name).filter(Boolean))].sort(),[H]),R=J.find(e=>String(e.id)===F);return s.jsx(r,{children:s.jsxs("div",{className:"flex min-h-screen w-full bg-background",children:[s.jsx(n,{}),s.jsxs(c,{className:"flex-1",children:[s.jsxs("header",{className:"sticky top-0 z-10 flex h-16 items-center border-b bg-background px-6",children:[s.jsx(i,{}),s.jsxs("h1",{className:"ml-4 text-xl font-semibold flex items-center gap-2",children:[s.jsx(C,{className:"w-5 h-5"}),"Расписание детей"]})]}),s.jsx("main",{className:"p-6",children:s.jsxs("div",{className:"space-y-6",children:[s.jsxs(d,{children:[s.jsx(m,{children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(k,{className:"w-5 h-5"}),s.jsx(o,{className:"text-lg",children:"Выберите ребенка"})]})}),s.jsxs(x,{children:[D?s.jsx(h,{className:"h-10 w-full"}):s.jsxs(u,{value:F,onValueChange:V,children:[s.jsx(j,{children:s.jsx(p,{placeholder:"Выберите ребенка..."})}),s.jsx(g,{children:J.map(e=>s.jsx(N,{value:String(e.id),children:e.name},e.id))})]}),R&&s.jsxs("div",{className:"mt-4 p-4 bg-muted rounded-lg",children:[s.jsx("p",{className:"text-sm font-medium",children:R.name}),R.subjects&&R.subjects.length>0&&s.jsxs("div",{className:"mt-2",children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Предметы:"}),s.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:R.subjects.map(e=>s.jsx("span",{className:"text-xs px-2 py-1 bg-background rounded-md",children:e.name},e.enrollment_id))})]})]})]})]}),F&&s.jsxs(s.Fragment,{children:[s.jsxs(d,{children:[s.jsx(m,{children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx($,{className:"w-5 h-5"}),s.jsx(o,{className:"text-lg",children:"Фильтры"})]})}),s.jsx(x,{children:s.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium",children:"Предмет"}),s.jsxs(u,{value:I,onValueChange:E,children:[s.jsx(j,{children:s.jsx(p,{placeholder:"Все предметы"})}),s.jsxs(g,{children:[s.jsx(N,{value:"all",children:"Все предметы"}),U.map(e=>s.jsx(N,{value:e,children:e},e))]})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("label",{className:"text-sm font-medium",children:"Преподаватель"}),s.jsxs(u,{value:K,onValueChange:P,children:[s.jsx(j,{children:s.jsx(p,{placeholder:"Все преподаватели"})}),s.jsxs(g,{children:[s.jsx(N,{value:"all",children:"Все преподаватели"}),Q.map(e=>s.jsx(N,{value:e,children:e},e))]})]})]})]})})]}),s.jsxs(f,{value:q,onValueChange:e=>B(e),children:[s.jsxs(v,{className:"grid w-full sm:w-auto grid-cols-2",children:[s.jsx(b,{value:"upcoming",children:"Предстоящие"}),s.jsx(b,{value:"past",children:"Прошедшие"})]}),s.jsx(w,{value:q,className:"space-y-4 mt-6",children:A?s.jsx("div",{className:"space-y-4",children:[...Array(3)].map((e,a)=>s.jsx(d,{className:"overflow-hidden",children:s.jsx(x,{className:"p-6",children:s.jsxs("div",{className:"space-y-3",children:[s.jsx(h,{className:"h-6 w-1/2"}),s.jsx(h,{className:"h-4 w-1/3"}),s.jsx(h,{className:"h-4 w-2/3"})]})})},`lesson-skeleton-${a}`))}):G?s.jsx(d,{className:"border-destructive",children:s.jsxs(x,{className:"p-12 text-center",children:[s.jsx("div",{className:"mx-auto mb-4 w-12 h-12 rounded-full bg-destructive/10 flex items-center justify-center",children:s.jsx(C,{className:"w-6 h-6 text-destructive"})}),s.jsx("h3",{className:"text-lg font-semibold mb-2 text-destructive",children:"Ошибка загрузки расписания"}),s.jsx("p",{className:"text-muted-foreground mb-6",children:G instanceof Error?G.message:"Не удалось загрузить расписание. Попробуйте обновить страницу."}),s.jsx(y,{type:"button",onClick:()=>window.location.reload(),variant:"outline",children:"Обновить страницу"})]})}):0===O.length?s.jsx(d,{children:s.jsxs(x,{className:"p-12 text-center",children:[s.jsx(C,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground opacity-50"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"upcoming"===q?"Нет предстоящих занятий":"Нет прошедших занятий"}),s.jsx("p",{className:"text-muted-foreground",children:"upcoming"===q?"У ребенка пока нет запланированных занятий":"У ребенка ещё нет завершённых занятий"})]})}):s.jsx("div",{className:"space-y-4",children:O.map(e=>s.jsx(T,{lesson:e},e.id))})})]})]}),!F&&!D&&s.jsx(d,{children:s.jsxs(x,{className:"p-12 text-center",children:[s.jsx(k,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground opacity-50"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Выберите ребенка"}),s.jsx("p",{className:"text-muted-foreground",children:"Выберите ребенка из списка выше, чтобы просмотреть его расписание"})]})})]})})]})]})})};export{L as default};
