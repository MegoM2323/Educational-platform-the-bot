{
  "review_iteration": 1,
  "status": "has_issues",
  "file": "scripts/deployment/rsync-deploy-native.sh",
  "total_issues": 14,
  "critical_issues": 3,
  "high_issues": 8,
  "medium_issues": 2,
  "low_issues": 1,
  "issues": [
    {
      "severity": "critical",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 590,
      "issue": "Script contains 'exit 0' at line 590, but PHASE 6-8 code (lines 593-717) continues after this exit. This mertvu kod nikogda ne vypolnitsya. PHASE 6 (migration validation), PHASE 7 (health checks), and PHASE 8 (final summary) will NEVER execute.",
      "fix": "Move lines 593-717 (PHASE 6-8) to BEFORE the first 'exit 0' at line 590. These phases must execute BEFORE the script exits. Proper order: PHASE 0-5 → PHASE 6-8 → exit 0. Remove duplicate exit 0 at line 717."
    },
    {
      "severity": "critical",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 473,
      "issue": "PHASE 5 (migrations & restart) is ONLY executed when DRY_RUN=false, but PHASE 6-8 (which must validate migrations) is unreachable due to exit 0. This means production deployments NEVER validate migrations before restarting services. If migration is broken, service restart will leave database in inconsistent state.",
      "fix": "Restructure code: PHASE 5 must call 'migrate --check' BEFORE 'migrate' to validate. Move ALL health checks to BEFORE exit 0. Ensure: (1) migrate --check validates, (2) migrate applies, (3) health checks run, (4) only then exit 0."
    },
    {
      "severity": "critical",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 259,
      "issue": "trap cleanup EXIT handler calls exit 1 inside cleanup function (line 256), which is already in trap. This creates double-exit behavior and may mask actual error code. The cleanup function should only log, not exit.",
      "fix": "Remove 'exit 1' from cleanup function (line 256). Let trap handler terminate naturally with exit code from failed command. Change: cleanup() { if [ $? -ne 0 ]; then error 'Deployment failed!...'; fi } (no exit)"
    },
    {
      "severity": "high",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 482,
      "issue": "VENV_PATH and PROD_HOME are hardcoded in PHASE 5 heredoc (lines 482-484, 520-522) instead of using script variables. If admin passes PROD_HOME='/opt/thebot' via env var, PHASE 5 will still use hardcoded '/home/mg/THE_BOT_platform'.",
      "fix": "Replace hardcoded values with variable substitution in heredoc. Change: << 'EOFREMOTE' to << EOFREMOTE (without quotes), then use $VENV_PATH, $PROD_HOME. Or pass them as arguments: ssh ... bash -s \"$VENV_PATH\" \"$PROD_HOME\" << 'EOF'"
    },
    {
      "severity": "high",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 316,
      "issue": "Database dump created with 'dumpdata' is redirected to BACKUP_DIR without explicit file permissions. Database dumps contain sensitive data (password hashes, user PII). File may be world-readable if umask is 022.",
      "fix": "Add explicit chmod 600 after creating backup: 'python ... dumpdata > $BACKUP_DIR/$BACKUP_FILE && chmod 600 $BACKUP_DIR/$BACKUP_FILE'. Also add 'chmod 700 $BACKUP_DIR' to ensure backup directory is not world-readable."
    },
    {
      "severity": "high",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 331,
      "issue": "Missing validation after 'cd' command before npm install. If 'cd $LOCAL_PATH/frontend' fails (directory missing, permission denied), npm install will execute in wrong directory or fail silently due to '2>/dev/null'.",
      "fix": "Add validation: cd \"$LOCAL_PATH/frontend\" || { error \"Cannot change to frontend directory\"; exit 1; } before npm install."
    },
    {
      "severity": "high",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 28,
      "issue": "LOCAL_PATH uses ${BASH_SOURCE[0]} which returns empty string if script is sourced (not directly executed). This breaks path resolution for sourced invocations.",
      "fix": "Use: LOCAL_PATH=\"$(cd \"$(dirname \"$(readlink -f \"$0\")\")/../..\" && pwd)\" which works for both direct execution and sourcing."
    },
    {
      "severity": "high",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 530,
      "issue": "PHASE 5 executes 'migrate --noinput' without first running 'migrate --check' to validate migrations. If migration is broken, it will fail and leave database in partial state without proper rollback. PHASE 6 (which would validate) never executes due to exit 0.",
      "fix": "Add migration validation BEFORE apply: (1) Add to PHASE 5: 'python backend/manage.py migrate --check --noinput' before the actual migrate, (2) Move PHASE 6 validation to execute before migrate command, (3) Add explicit error handling if validation fails."
    },
    {
      "severity": "high",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 673,
      "issue": "API health check uses 'grep -q ... || true' which returns success even if curl fails or grep finds no match. This masks deployment failures. Line: if curl -f --max-time 10 http://localhost:8000/api/health/ ... || true; means health check will ALWAYS appear successful.",
      "fix": "Remove '|| true' to allow health check to fail properly. Change: if curl -f --max-time 10 http://localhost:8000/api/health/ 2>/dev/null | grep -q 'status\\|ok\\|healthy'; then (let grep return actual status). Also, PHASE 7 needs to run BEFORE exit 0."
    },
    {
      "severity": "high",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 283,
      "issue": "SSH command passes PROD_HOME unquoted in variable substitution: 'df -h $PROD_HOME' inside double-quoted SSH command. If PROD_HOME contains spaces or special chars, this breaks. Should be '\"$PROD_HOME\"'.",
      "fix": "Change line 283 to: REMOTE_DISK=$(ssh \"${PROD_USER}@${PROD_SERVER}\" \"df -h \\\"$PROD_HOME\\\" | tail -1 | awk '{print \\$5}'\")"
    },
    {
      "severity": "medium",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 145,
      "issue": "Backup tar.gz files created without explicit permissions. Should be 600 to prevent other users from reading database backups.",
      "fix": "In BACKUP_SCRIPT (inside create_backup_phase), add after each tar command: 'chmod 600 \"${BACKUP_DIR}\"/*.tar.gz 2>/dev/null || true'"
    },
    {
      "severity": "medium",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 316,
      "issue": "Database backup failure is logged as warning (line 319) instead of error. Data loss is critical. Current: 'warning \"Database backup skipped (non-critical)\"' is WRONG - database backup IS critical.",
      "fix": "Change warning to error and make deployment fail: change 'warning \"Database backup skipped...\"' to 'error \"Database backup failed - critical data!\"' and 'exit 1' instead of continuing."
    },
    {
      "severity": "medium",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 478,
      "issue": "PHASE 5 contains duplicate code for SKIP_MIGRATIONS case (lines 479-515) and normal case (lines 517-555). Both blocks perform similar operations with minor differences. This violates DRY principle and complicates maintenance.",
      "fix": "Refactor into single function: create_remote_deploy_function() that takes SKIP_MIGRATIONS as parameter and conditionally executes 'migrate' command. Reduces code duplication and improves maintainability."
    },
    {
      "severity": "low",
      "file": "scripts/deployment/rsync-deploy-native.sh",
      "line": 30,
      "issue": "DEPLOY_LOG stored in /tmp/rsync_deploy_*.log may be cleaned by system (tmpwatch/systemd-tmpfiles-clean). Sensitive deployment logs with error details could be lost or accessed by other users.",
      "fix": "Change to: DEPLOY_LOG=\"${PROD_HOME}/logs/rsync_deploy_${TIMESTAMP}.log\" (ensure logs directory exists) or use ~/.thebotlogs/rsync_deploy_${TIMESTAMP}.log. This preserves logs and respects user privacy."
    }
  ],
  "passed_checks": [
    "✓ .env properly excluded from rsync (line 373)",
    "✓ __pycache__, *.pyc, venv, node_modules properly excluded",
    "✓ .git properly excluded",
    "✓ SSH key-based auth used (no hardcoded passwords)",
    "✓ set -euo pipefail in main script (line 20)",
    "✓ Backup/rollback functions implemented",
    "✓ Systemd services properly restarted",
    "✓ Logging via functions (log/success/error/warning)",
    "✓ Pre-checks validate SSH and local structure"
  ],
  "failed_checks": [
    "CRITICAL: Exit 0 at line 590 makes PHASE 6-8 unreachable",
    "CRITICAL: Trap cleanup function has nested exit causing double-exit",
    "CRITICAL: No migration validation before apply in PHASE 5",
    "HIGH: Hardcoded paths in heredoc override script variables",
    "HIGH: Database backup lacks file permissions (chmod 600)",
    "HIGH: Missing cd validation in frontend build phase",
    "HIGH: Health checks use || true masking failures",
    "HIGH: No migration --check before migrate --noinput",
    "MEDIUM: Duplicate code in PHASE 5 (SKIP_MIGRATIONS variants)",
    "MEDIUM: Database backup failure logged as warning not error"
  ]
}
