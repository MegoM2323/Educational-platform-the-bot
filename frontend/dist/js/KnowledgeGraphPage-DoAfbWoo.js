import{r as s,a as e,j as l}from"./react-core-JVqWokWt.js";import{U as a,b as r,V as i,W as n,B as c,C as t,J as d,K as x,Y as m,L as h,g as j,h as o,i as u,j as p,k as N,a1 as f,S as g,a0 as v,a as b,e as w}from"./main-fde3JC90.js";import{a as y,u as _}from"./react-query-DqnBFrGE.js";import{k}from"./knowledgeGraphAPI-D8HHnFWf.js";import{G as S}from"./GraphVisualization-DxSFfcHP.js";import{u as q}from"./react-router-WAeXREDX.js";import{$ as C,a1 as G,bG as z,c4 as F,am as K,bW as M}from"./vendor-DC2AZkDs.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const O=()=>{var g;const v=q(),{profile:b}=a(),w=null!=(g=null==b?void 0:b.id)?g:null,[O,V]=s.useState(null),{data:W,isLoading:E,error:I}=y({queryKey:["student-subjects"],queryFn:()=>k.getStudentSubjects(),staleTime:3e5,retry:2,refetchOnMount:!1,refetchOnWindowFocus:!1}),{data:L,isLoading:D,error:T,refreshGraph:$}=((s,e)=>{const l=_();return{...y({queryKey:["knowledge-graph",s,e],queryFn:async()=>{if(!s||!e)throw new Error("Student ID and Subject ID are required");return k.getStudentGraph(s,e)},enabled:!!s&&!!e,staleTime:6e4,retry:2,refetchOnMount:!0,refetchOnWindowFocus:!1}),refreshGraph:()=>{l.invalidateQueries({queryKey:["knowledge-graph",s,e]})}}})(w,O);e.useEffect(()=>{W&&1===W.length&&!O&&V(W[0].id)},[W,O]);const A=s.useMemo(()=>L?{nodes:L.lessons.map(s=>({id:String(s.lesson_id),title:s.title,status:s.status,x:s.position_x,y:s.position_y})),links:L.dependencies.map(s=>({source:String(s.from_lesson_id),target:String(s.to_lesson_id),type:s.type}))}:null,[L]),B=s.useCallback(s=>{const e=null==L?void 0:L.lessons.find(e=>String(e.lesson_id)===s);e&&("locked"!==e.status&&e.can_start?v(`/lessons/${s}`):alert("Этот урок заблокирован. Сначала завершите предыдущие уроки."))},[L,v]),J=s=>{V(Number(s))},P=()=>{$()};return E||D&&O?l.jsxs("div",{className:"space-y-4 p-4",children:[l.jsx(r,{className:"h-12 w-full"}),l.jsx(r,{className:"h-96 w-full"})]}):I||T?l.jsxs(i,{variant:"destructive",className:"m-4",children:[l.jsx(C,{className:"h-4 w-4"}),l.jsxs(n,{children:["Ошибка загрузки графа знаний: ",(null==I?void 0:I.message)||(null==T?void 0:T.message),l.jsxs(c,{variant:"outline",size:"sm",onClick:P,className:"ml-4",children:[l.jsx(G,{className:"h-4 w-4 mr-2"}),"Повторить"]})]})]}):W&&0!==W.length?O?L&&0===L.lessons.length?l.jsxs(t,{className:"m-4",children:[l.jsxs(d,{children:[l.jsx(x,{children:"Граф знаний"}),l.jsx(m,{children:L.subject_name})]}),l.jsx(h,{children:l.jsxs(i,{children:[l.jsx(z,{className:"h-4 w-4"}),l.jsx(n,{children:"В графе знаний пока нет уроков. Ваш преподаватель скоро добавит учебные материалы."})]})})]}):l.jsxs("div",{className:"flex flex-col gap-4 p-4 h-full",children:[l.jsxs(t,{children:[l.jsx(d,{children:l.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[l.jsxs("div",{className:"flex-1",children:[l.jsx(x,{children:"Граф знаний"}),l.jsx(m,{children:(null==L?void 0:L.subject_name)||"Выберите предмет"})]}),W.length>1&&l.jsx("div",{className:"w-full sm:w-64",children:l.jsxs(j,{value:String(O),onValueChange:J,children:[l.jsx(o,{children:l.jsx(u,{})}),l.jsx(p,{children:W.map(s=>l.jsx(N,{value:String(s.id),children:s.name},s.id))})]})})]})}),l.jsxs(h,{className:"space-y-4",children:[L&&l.jsxs("div",{className:"space-y-2",children:[l.jsxs("div",{className:"flex justify-between text-sm",children:[l.jsx("span",{className:"font-medium",children:"Общий прогресс:"}),l.jsxs("span",{className:"text-muted-foreground",children:[L.completed_lessons," из ",L.total_lessons," уроков завершено"]})]}),l.jsx(f,{value:L.overall_progress_percent,className:"h-2"}),l.jsxs("p",{className:"text-sm text-muted-foreground text-center",children:[Math.round(L.overall_progress_percent),"%"]})]}),l.jsx("div",{className:"flex justify-end",children:l.jsxs(c,{variant:"outline",size:"sm",onClick:P,children:[l.jsx(G,{className:"h-4 w-4 mr-2"}),"Обновить"]})})]})]}),l.jsx(t,{children:l.jsx(h,{className:"pt-6",children:l.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx("div",{className:"w-4 h-4 rounded-full bg-gray-300"}),l.jsx("span",{className:"text-sm",children:"Не начато"})]}),l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx(F,{className:"w-4 h-4 text-blue-500"}),l.jsx("span",{className:"text-sm",children:"В процессе"})]}),l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx(K,{className:"w-4 h-4 text-green-500"}),l.jsx("span",{className:"text-sm",children:"Завершено"})]}),l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx(M,{className:"w-4 h-4 text-red-500"}),l.jsx("span",{className:"text-sm",children:"Заблокировано"})]})]})})}),l.jsx(t,{className:"flex-1 min-h-[500px]",children:l.jsx(h,{className:"p-0 h-full",children:A&&l.jsx(S,{data:A,onNodeClick:B,isEditable:!1,className:"w-full h-full"})})}),l.jsx(t,{children:l.jsx(h,{className:"pt-6",children:l.jsxs(i,{children:[l.jsx(z,{className:"h-4 w-4"}),l.jsxs(n,{children:[l.jsx("strong",{children:"Как использовать граф знаний:"}),l.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1 text-sm",children:[l.jsx("li",{children:"Нажмите на урок, чтобы открыть его"}),l.jsx("li",{children:"Серые уроки доступны для начала"}),l.jsx("li",{children:"Синие уроки - в процессе выполнения"}),l.jsx("li",{children:"Зелёные уроки - завершены"}),l.jsx("li",{children:"Красные уроки - заблокированы (нужно выполнить предыдущие)"}),l.jsx("li",{children:"Используйте колёсико мыши для масштабирования"}),l.jsx("li",{children:"Перетаскивайте граф для навигации"})]})]})]})})})]}):l.jsxs(t,{className:"m-4",children:[l.jsxs(d,{children:[l.jsx(x,{children:"Граф знаний"}),l.jsx(m,{children:"Визуализация вашего учебного прогресса"})]}),l.jsx(h,{className:"space-y-4",children:l.jsxs("div",{children:[l.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Выберите предмет:"}),l.jsxs(j,{onValueChange:J,children:[l.jsx(o,{children:l.jsx(u,{placeholder:"Выберите предмет"})}),l.jsx(p,{children:W.map(s=>l.jsx(N,{value:String(s.id),children:s.name},s.id))})]})]})})]}):l.jsxs(t,{className:"m-4",children:[l.jsxs(d,{children:[l.jsx(x,{children:"Граф знаний"}),l.jsx(m,{children:"Визуализация вашего учебного прогресса"})]}),l.jsx(h,{children:l.jsxs(i,{children:[l.jsx(z,{className:"h-4 w-4"}),l.jsx(n,{children:"У вас пока нет зачисленных предметов. Обратитесь к вашему преподавателю."})]})})]})},V=()=>l.jsx(g,{children:l.jsxs("div",{className:"flex min-h-screen w-full",children:[l.jsx(v,{}),l.jsxs(b,{children:[l.jsxs("header",{className:"sticky top-0 z-10 flex h-16 items-center gap-4 border-b bg-background px-6",children:[l.jsx(w,{}),l.jsx("div",{className:"flex-1",children:l.jsx("h1",{className:"text-2xl font-bold",children:"Граф знаний"})})]}),l.jsx("main",{className:"p-6",children:l.jsx(O,{})})]})]})});export{V as default};
