{
  "test_task": "T011: Проверка видимости приватных полей для админа",
  "test_date": "2026-01-07",
  "test_file": "/backend/tests/test_admin_sees_private_fields.py",
  "summary": {
    "total": 12,
    "passed": 10,
    "failed": 2,
    "success_rate": "83.3%"
  },
  "test_results": {
    "passed_tests": [
      {
        "name": "test_admin_profile_endpoint_shows_goal",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Admin endpoint /api/accounts/admin/users/{id}/profile/ shows goal field",
        "status": "PASSED"
      },
      {
        "name": "test_admin_profile_endpoint_shows_tutor",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Admin endpoint shows tutor field with proper ID reference",
        "status": "PASSED"
      },
      {
        "name": "test_admin_profile_endpoint_shows_parent",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Admin endpoint shows parent field with proper ID reference",
        "status": "PASSED"
      },
      {
        "name": "test_admin_profile_endpoint_shows_null_tutor",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Admin endpoint correctly shows null tutor when not assigned",
        "status": "PASSED"
      },
      {
        "name": "test_admin_profile_endpoint_shows_null_parent",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Admin endpoint correctly shows null parent when not assigned",
        "status": "PASSED"
      },
      {
        "name": "test_admin_sees_private_fields_all_set",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Admin view shows all private fields when all are set",
        "status": "PASSED"
      },
      {
        "name": "test_superuser_can_see_private_fields",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Superuser (is_superuser=True) can also see all private fields",
        "status": "PASSED"
      },
      {
        "name": "test_admin_cannot_see_inactive_student_private_fields_maybe",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Admin can view private fields of inactive students",
        "status": "PASSED"
      },
      {
        "name": "test_admin_response_includes_goal_field",
        "class": "TestAdminPrivateFieldsNotHidden",
        "description": "Admin response includes goal field (not filtered out)",
        "status": "PASSED"
      },
      {
        "name": "test_admin_response_includes_all_private_field_keys",
        "class": "TestAdminPrivateFieldsNotHidden",
        "description": "Admin response includes all private field keys",
        "status": "PASSED"
      }
    ],
    "failed_tests": [
      {
        "name": "test_admin_list_students_shows_private_fields",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Admin list endpoint /api/accounts/students/ shows private fields",
        "status": "FAILED",
        "error": "Invalid field name(s) given in select_related: 'tutor'. Choices are: student, subject, teacher, assigned_by, subscription",
        "cause": "Bug in profile_views.py AdminUserFullInfoView or related view - incorrect select_related configuration",
        "file": "/backend/accounts/profile_views.py",
        "line": 1111
      },
      {
        "name": "test_admin_full_info_endpoint_shows_all_private_fields",
        "class": "TestAdminCanSeeStudentPrivateFields",
        "description": "Admin full-info endpoint shows all private fields",
        "status": "FAILED",
        "error": "Invalid field name(s) given in select_related: 'tutor'. Choices are: student, subject, teacher, assigned_by, subscription",
        "cause": "Bug in profile_views.py AdminUserFullInfoView - incorrect select_related configuration",
        "file": "/backend/accounts/profile_views.py",
        "line": 1111
      }
    ]
  },
  "key_findings": {
    "admin_visibility_works": true,
    "endpoints_tested": [
      "/api/accounts/admin/users/{user_id}/profile/",
      "/api/accounts/students/",
      "/api/accounts/admin/users/{user_id}/full-info/"
    ],
    "private_fields_verified": [
      "goal",
      "tutor",
      "parent"
    ],
    "behavior_verified": [
      "Admin can see goal field for students",
      "Admin can see tutor reference with ID",
      "Admin can see parent reference with ID",
      "Null values handled correctly (tutor=None, parent=None)",
      "Private fields not filtered for admin users",
      "Superuser (is_superuser=True) also has access",
      "All private fields present in response"
    ]
  },
  "requirements_verification": {
    "requirement_1": {
      "description": "Admin sees goal field",
      "endpoint": "GET /api/accounts/admin/users/{student_id}/profile/",
      "verified": true,
      "test": "test_admin_profile_endpoint_shows_goal"
    },
    "requirement_2": {
      "description": "Admin sees tutor field with ID",
      "endpoint": "GET /api/accounts/admin/users/{student_id}/profile/",
      "verified": true,
      "test": "test_admin_profile_endpoint_shows_tutor"
    },
    "requirement_3": {
      "description": "Admin sees parent field with ID",
      "endpoint": "GET /api/accounts/admin/users/{student_id}/profile/",
      "verified": true,
      "test": "test_admin_profile_endpoint_shows_parent"
    },
    "requirement_4": {
      "description": "Admin list endpoint shows private fields",
      "endpoint": "GET /api/accounts/students/",
      "verified": false,
      "test": "test_admin_list_students_shows_private_fields",
      "issue": "Backend error in full-info view implementation"
    },
    "requirement_5": {
      "description": "Admin full-info endpoint returns all private data",
      "endpoint": "GET /api/accounts/admin/users/{student_id}/full-info/",
      "verified": false,
      "test": "test_admin_full_info_endpoint_shows_all_private_fields",
      "issue": "Backend error in full-info view implementation"
    }
  },
  "issues_found": [
    {
      "id": "ISSUE_001",
      "severity": "HIGH",
      "title": "Invalid select_related in AdminUserFullInfoView",
      "description": "The AdminUserFullInfoView at profile_views.py:1111 attempts to use select_related('tutor') on SubjectEnrollment queryset, but 'tutor' is not a related field of SubjectEnrollment",
      "file": "/backend/accounts/profile_views.py",
      "line": 1111,
      "error": "FieldError: Invalid field name(s) given in select_related: 'tutor'. Choices are: student, subject, teacher, assigned_by, subscription",
      "status": "REQUIRES_FIX",
      "impact": "Admin list and full-info endpoints will crash when accessing student data"
    }
  ],
  "recommendations": [
    {
      "priority": "HIGH",
      "recommendation": "Fix the select_related configuration in AdminUserFullInfoView",
      "details": "Remove or correct the select_related('tutor') call in profile_views.py:1111. The tutor field is on StudentProfile, not SubjectEnrollment."
    },
    {
      "priority": "MEDIUM",
      "recommendation": "Add integration tests for list_students endpoint with private fields",
      "details": "Once the bug is fixed, verify that list_students endpoint properly exposes private fields to admin users"
    }
  ],
  "execution_time_sec": 10.21,
  "test_coverage": {
    "endpoints_covered": 3,
    "user_roles_tested": [
      "Admin (is_staff=True)",
      "Superuser (is_superuser=True)"
    ],
    "field_visibility_scenarios": [
      "All private fields set",
      "Null private fields",
      "Mix of set and null fields"
    ],
    "edge_cases": [
      "Inactive student viewing",
      "Null FK references",
      "Private field filtering disabled for admin"
    ]
  },
  "conclusion": {
    "main_objective": "Verify admin can see all private student fields (goal, tutor, parent)",
    "status": "PARTIALLY_VERIFIED",
    "details": "The primary endpoint /api/accounts/admin/users/{id}/profile/ works correctly and admin can see all private fields. However, list and full-info endpoints have bugs in their implementation. The core functionality is verified and working as expected.",
    "next_steps": "Fix the select_related bug in AdminUserFullInfoView, then re-run full test suite"
  }
}
