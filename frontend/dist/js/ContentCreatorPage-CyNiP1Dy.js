import{r as e,j as s,a as t}from"./react-core-JVqWokWt.js";import{u as n,a3 as i,a4 as l,a5 as a,a6 as r,aa as c,ab as o,ac as d,ad as m,ae as x,af as u,ag as h,ah as j,B as p,_ as v,g,h as f,i as y,j as b,k as N,C as w,b as _,T as C,m as k,n as S,o as E,q as L,s as q,a9 as z,c as D,aC as F,aD as T,aA as V,aE as M,$,aB as P,aF as I,J as K,K as A,Y as Q,L as O,f as U,az as R,aX as B,S as Y,a as X,e as W,D as G,w as J,x as Z,y as H}from"./main-fde3JC90.js";import{T as ee}from"./TeacherSidebar-Bwv8PTW2.js";import{u as se,a as te,b as ne}from"./react-query-DqnBFrGE.js";import{c as ie}from"./contentCreatorService-CIIkPfml.js";import{a6 as le,ao as ae,at as re,c8 as ce,c9 as oe,an as de,$ as me,au as xe,bC as ue,aD as he,aE as je,as as pe,al as ve,aW as ge,aX as fe,b5 as ye,b3 as be,b4 as Ne,aY as we,b6 as _e,ca as Ce,aA as ke,a2 as Se,bA as Ee,a7 as Le,X as qe,a_ as ze,a$ as De,cb as Fe}from"./vendor-DC2AZkDs.js";import{R as Te,a as Ve}from"./radio-group-rQxajO1F.js";import{t as Me}from"./teacher-BhCI6v5d.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./react-router-WAeXREDX.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";import"./migration-O34B3Isr.js";const $e={text_problem:"Текстовая задача",quick_question:"Быстрый вопрос",theory:"Теория",video:"Видео"},Pe=({onCreateElement:t,onEditElement:F,onCreateLesson:T,onEditLesson:V})=>{const{elements:M,elementsCount:$,elementsLoading:P,lessons:I,lessonsCount:K,lessonsLoading:A,elementFilters:Q,setElementFilters:O,lessonFilters:U,setLessonFilters:R,selectedElements:B,selectedLessons:Y,toggleElementSelection:X,toggleLessonSelection:W,clearElementSelection:G,clearLessonSelection:J,deleteElement:Z,deleteLesson:H,copyElement:ee,copyLesson:ge,bulkDeleteElements:fe,bulkDeleteLessons:ye,isDeleting:be}=(()=>{var s,t,i,l;const a=se(),{toast:r}=n(),[c,o]=e.useState({visibility:"mine",type:void 0,search:"",page:1}),[d,m]=e.useState({visibility:"mine",search:"",page:1}),[x,u]=e.useState(new Set),[h,j]=e.useState(new Set),{data:p,isLoading:v,error:g,refetch:f}=te({queryKey:["content-creator","elements",c],queryFn:()=>ie.getElements({created_by:"mine"===c.visibility?"me":void 0,type:c.type,search:c.search||void 0,page:c.page}),staleTime:6e4}),{data:y,isLoading:b,error:N,refetch:w}=te({queryKey:["content-creator","lessons",d],queryFn:()=>ie.getLessons({created_by:"mine"===d.visibility?"me":void 0,search:d.search||void 0,page:d.page}),staleTime:6e4}),_=ne({mutationFn:e=>ie.createElement(e),onSuccess:()=>{a.invalidateQueries({queryKey:["content-creator","elements"]}),r({title:"Успех",description:"Элемент успешно создан"})},onError:e=>{var s,t;r({title:"Ошибка",description:(null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.error)||"Не удалось создать элемент",variant:"destructive"})}}),C=ne({mutationFn:({id:e,data:s})=>ie.updateElement(e,s),onSuccess:()=>{a.invalidateQueries({queryKey:["content-creator","elements"]}),r({title:"Успех",description:"Элемент успешно обновлен"})},onError:e=>{var s,t;r({title:"Ошибка",description:(null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.error)||"Не удалось обновить элемент",variant:"destructive"})}}),k=ne({mutationFn:e=>ie.deleteElement(e),onSuccess:()=>{a.invalidateQueries({queryKey:["content-creator","elements"]}),r({title:"Успех",description:"Элемент успешно удален"})},onError:e=>{var s,t;r({title:"Ошибка",description:(null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.error)||"Не удалось удалить элемент",variant:"destructive"})}}),S=ne({mutationFn:e=>ie.copyElement(e),onSuccess:()=>{a.invalidateQueries({queryKey:["content-creator","elements"]}),r({title:"Успех",description:"Элемент успешно скопирован"})},onError:e=>{var s,t;r({title:"Ошибка",description:(null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.error)||"Не удалось скопировать элемент",variant:"destructive"})}}),E=ne({mutationFn:e=>ie.createLesson(e),onSuccess:()=>{a.invalidateQueries({queryKey:["content-creator","lessons"]}),r({title:"Успех",description:"Урок успешно создан"})},onError:e=>{var s,t;r({title:"Ошибка",description:(null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.error)||"Не удалось создать урок",variant:"destructive"})}}),L=ne({mutationFn:({id:e,data:s})=>ie.updateLesson(e,s),onSuccess:()=>{a.invalidateQueries({queryKey:["content-creator","lessons"]}),r({title:"Успех",description:"Урок успешно обновлен"})},onError:e=>{var s,t;r({title:"Ошибка",description:(null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.error)||"Не удалось обновить урок",variant:"destructive"})}}),q=ne({mutationFn:e=>ie.deleteLesson(e),onSuccess:()=>{a.invalidateQueries({queryKey:["content-creator","lessons"]}),r({title:"Успех",description:"Урок успешно удален"})},onError:e=>{var s,t;r({title:"Ошибка",description:(null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.error)||"Не удалось удалить урок",variant:"destructive"})}}),z=ne({mutationFn:e=>ie.copyLesson(e),onSuccess:()=>{a.invalidateQueries({queryKey:["content-creator","lessons"]}),r({title:"Успех",description:"Урок успешно скопирован"})},onError:e=>{var s,t;r({title:"Ошибка",description:(null==(t=null==(s=e.response)?void 0:s.data)?void 0:t.error)||"Не удалось скопировать урок",variant:"destructive"})}}),D=()=>u(new Set),F=()=>j(new Set);return{elements:null!=(s=null==p?void 0:p.data)?s:[],elementsCount:null!=(t=null==p?void 0:p.count)?t:0,elementsLoading:v,elementsError:g,refetchElements:f,lessons:null!=(i=null==y?void 0:y.data)?i:[],lessonsCount:null!=(l=null==y?void 0:y.count)?l:0,lessonsLoading:b,lessonsError:N,refetchLessons:w,elementFilters:c,setElementFilters:o,lessonFilters:d,setLessonFilters:m,selectedElements:x,selectedLessons:h,toggleElementSelection:e=>{u(s=>{const t=new Set(s);return t.has(e)?t.delete(e):t.add(e),t})},toggleLessonSelection:e=>{j(s=>{const t=new Set(s);return t.has(e)?t.delete(e):t.add(e),t})},clearElementSelection:D,clearLessonSelection:F,createElement:_.mutate,updateElement:C.mutate,deleteElement:k.mutate,copyElement:S.mutate,createLesson:E.mutate,updateLesson:L.mutate,deleteLesson:q.mutate,copyLesson:z.mutate,bulkDeleteElements:async()=>{const e=Array.from(x).map(e=>k.mutateAsync(e));await Promise.all(e),D()},bulkDeleteLessons:async()=>{const e=Array.from(h).map(e=>q.mutateAsync(e));await Promise.all(e),F()},isCreating:_.isPending||E.isPending,isUpdating:C.isPending||L.isPending,isDeleting:k.isPending||q.isPending}})(),[Ne,we]=e.useState("list"),[_e,Ce]=e.useState(!1),[ke,Se]=e.useState(null),[Ee,Le]=e.useState(!1),[qe,ze]=e.useState("elements"),De=(e,s,t)=>{Se({type:e,id:s,title:t}),Ce(!0)},Fe=e=>{ze(e),Le(!0)},Te=e=>{ee(e)},Ve=e=>{ge(e)};return s.jsxs(s.Fragment,{children:[s.jsxs(i,{defaultValue:"elements",className:"w-full",children:[s.jsxs(l,{className:"grid w-full grid-cols-2 max-w-md",children:[s.jsx(a,{value:"elements",children:"Элементы"}),s.jsx(a,{value:"lessons",children:"Уроки"})]}),s.jsx(r,{value:"elements",className:"mt-6",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[s.jsxs(p,{type:"button",onClick:t,className:"gradient-primary shadow-glow",children:[s.jsx(ae,{className:"w-4 h-4 mr-2"}),"Создать элемент"]}),s.jsxs("div",{className:"flex-1 flex flex-col sm:flex-row gap-2",children:[s.jsxs("div",{className:"relative flex-1",children:[s.jsx(re,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),s.jsx(v,{placeholder:"Поиск по названию или описанию...",value:Q.search,onChange:e=>O({...Q,search:e.target.value,page:1}),className:"pl-10"})]}),s.jsxs(g,{value:Q.type||"all",onValueChange:e=>O({...Q,type:"all"===e?void 0:e,page:1}),children:[s.jsx(f,{className:"w-full sm:w-48",children:s.jsx(y,{placeholder:"Тип элемента"})}),s.jsxs(b,{children:[s.jsx(N,{value:"all",children:"Все типы"}),s.jsx(N,{value:"text_problem",children:"Текстовая задача"}),s.jsx(N,{value:"quick_question",children:"Быстрый вопрос"}),s.jsx(N,{value:"theory",children:"Теория"}),s.jsx(N,{value:"video",children:"Видео"})]})]}),s.jsxs(g,{value:Q.visibility,onValueChange:e=>O({...Q,visibility:e,page:1}),children:[s.jsx(f,{className:"w-full sm:w-40",children:s.jsx(y,{})}),s.jsxs(b,{children:[s.jsx(N,{value:"mine",children:"Мои элементы"}),s.jsx(N,{value:"all",children:"Все элементы"})]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(p,{type:"button",variant:"list"===Ne?"default":"outline",size:"icon",onClick:()=>we("list"),children:s.jsx(ce,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"grid"===Ne?"default":"outline",size:"icon",onClick:()=>we("grid"),children:s.jsx(oe,{className:"w-4 h-4"})})]})]})]}),B.size>0&&s.jsx(w,{className:"p-4 bg-muted",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-sm font-medium",children:["Выбрано: ",B.size]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(p,{type:"button",variant:"outline",size:"sm",onClick:G,children:"Отменить выбор"}),s.jsxs(p,{type:"button",variant:"destructive",size:"sm",onClick:()=>Fe("elements"),disabled:be,children:[s.jsx(de,{className:"w-4 h-4 mr-2"}),"Удалить выбранные"]})]})]})}),P&&s.jsx("div",{className:"space-y-3",children:[1,2,3].map(e=>s.jsx(_,{className:"h-16 w-full"},`element-skeleton-${e}`))}),!P&&0===M.length&&s.jsx(w,{className:"p-8",children:s.jsxs("div",{className:"text-center",children:[s.jsx(me,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),s.jsx("h3",{className:"text-lg font-medium mb-2",children:"Элементы не найдены"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"mine"===Q.visibility?"Вы еще не создали ни одного элемента":"Нет элементов, соответствующих критериям поиска"}),s.jsxs(p,{type:"button",onClick:t,children:[s.jsx(ae,{className:"w-4 h-4 mr-2"}),"Создать первый элемент"]})]})}),!P&&M.length>0&&"list"===Ne&&s.jsx(w,{children:s.jsxs(C,{children:[s.jsx(k,{children:s.jsxs(S,{children:[s.jsx(E,{className:"w-12"}),s.jsx(E,{children:"Название"}),s.jsx(E,{children:"Тип"}),s.jsx(E,{children:"Время (мин)"}),s.jsx(E,{children:"Создано"}),s.jsx(E,{className:"w-32",children:"Действия"})]})}),s.jsx(L,{children:M.map(e=>s.jsxs(S,{children:[s.jsx(q,{children:s.jsx(z,{checked:B.has(e.id),onCheckedChange:()=>X(e.id)})}),s.jsx(q,{children:s.jsxs("div",{children:[s.jsxs("div",{className:"font-medium flex items-center gap-2",children:[e.title,e.is_public?s.jsx(xe,{className:"w-3 h-3 text-muted-foreground"}):s.jsx(ue,{className:"w-3 h-3 text-muted-foreground"})]}),e.description&&s.jsx("div",{className:"text-sm text-muted-foreground line-clamp-1",children:e.description})]})}),s.jsx(q,{children:s.jsx(D,{variant:"outline",children:$e[e.element_type]||e.element_type})}),s.jsx(q,{children:e.estimated_time_minutes||"—"}),s.jsx(q,{children:he(new Date(e.created_at),"dd MMM yyyy",{locale:je})}),s.jsx(q,{children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>null==F?void 0:F(e.id),title:"Редактировать",children:s.jsx(pe,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>Te(e.id),title:"Копировать",children:s.jsx(ve,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>De("element",e.id,e.title),title:"Удалить",children:s.jsx(de,{className:"w-4 h-4 text-destructive"})})]})})]},e.id))})]})}),!P&&M.length>0&&"grid"===Ne&&s.jsx("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-4",children:M.map(e=>s.jsxs(w,{className:"p-4 hover:border-primary transition-colors",children:[s.jsxs("div",{className:"flex items-start justify-between mb-3",children:[s.jsx(z,{checked:B.has(e.id),onCheckedChange:()=>X(e.id)}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>null==F?void 0:F(e.id),children:s.jsx(pe,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>Te(e.id),children:s.jsx(ve,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>De("element",e.id,e.title),children:s.jsx(de,{className:"w-4 h-4 text-destructive"})})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("h3",{className:"font-medium line-clamp-1",children:e.title}),e.is_public?s.jsx(xe,{className:"w-3 h-3 text-muted-foreground flex-shrink-0"}):s.jsx(ue,{className:"w-3 h-3 text-muted-foreground flex-shrink-0"})]}),e.description&&s.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:e.description}),s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsx(D,{variant:"outline",children:$e[e.element_type]||e.element_type}),e.estimated_time_minutes&&s.jsxs(D,{variant:"secondary",children:[e.estimated_time_minutes," мин"]})]}),s.jsx("div",{className:"text-xs text-muted-foreground",children:he(new Date(e.created_at),"dd MMM yyyy",{locale:je})})]})]},e.id))}),!P&&M.length>0&&s.jsxs("div",{className:"text-sm text-muted-foreground text-center",children:["Показано ",M.length," из ",$]})]})}),s.jsx(r,{value:"lessons",className:"mt-6",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[s.jsxs(p,{type:"button",onClick:T,className:"gradient-primary shadow-glow",children:[s.jsx(ae,{className:"w-4 h-4 mr-2"}),"Создать урок"]}),s.jsxs("div",{className:"flex-1 flex flex-col sm:flex-row gap-2",children:[s.jsxs("div",{className:"relative flex-1",children:[s.jsx(re,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),s.jsx(v,{placeholder:"Поиск по названию или описанию...",value:U.search,onChange:e=>R({...U,search:e.target.value,page:1}),className:"pl-10"})]}),s.jsxs(g,{value:U.visibility,onValueChange:e=>R({...U,visibility:e,page:1}),children:[s.jsx(f,{className:"w-full sm:w-40",children:s.jsx(y,{})}),s.jsxs(b,{children:[s.jsx(N,{value:"mine",children:"Мои уроки"}),s.jsx(N,{value:"all",children:"Все уроки"})]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(p,{type:"button",variant:"list"===Ne?"default":"outline",size:"icon",onClick:()=>we("list"),children:s.jsx(ce,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"grid"===Ne?"default":"outline",size:"icon",onClick:()=>we("grid"),children:s.jsx(oe,{className:"w-4 h-4"})})]})]})]}),Y.size>0&&s.jsx(w,{className:"p-4 bg-muted",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"text-sm font-medium",children:["Выбрано: ",Y.size]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(p,{type:"button",variant:"outline",size:"sm",onClick:J,children:"Отменить выбор"}),s.jsxs(p,{type:"button",variant:"destructive",size:"sm",onClick:()=>Fe("lessons"),disabled:be,children:[s.jsx(de,{className:"w-4 h-4 mr-2"}),"Удалить выбранные"]})]})]})}),A&&s.jsx("div",{className:"space-y-3",children:[1,2,3].map(e=>s.jsx(_,{className:"h-16 w-full"},`lesson-skeleton-${e}`))}),!A&&0===I.length&&s.jsx(w,{className:"p-8",children:s.jsxs("div",{className:"text-center",children:[s.jsx(me,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),s.jsx("h3",{className:"text-lg font-medium mb-2",children:"Уроки не найдены"}),s.jsx("p",{className:"text-muted-foreground mb-4",children:"mine"===U.visibility?"Вы еще не создали ни одного урока":"Нет уроков, соответствующих критериям поиска"}),s.jsxs(p,{type:"button",onClick:T,children:[s.jsx(ae,{className:"w-4 h-4 mr-2"}),"Создать первый урок"]})]})}),!A&&I.length>0&&"list"===Ne&&s.jsx(w,{children:s.jsxs(C,{children:[s.jsx(k,{children:s.jsxs(S,{children:[s.jsx(E,{className:"w-12"}),s.jsx(E,{children:"Название"}),s.jsx(E,{children:"Элементов"}),s.jsx(E,{children:"Время (мин)"}),s.jsx(E,{children:"Создано"}),s.jsx(E,{className:"w-32",children:"Действия"})]})}),s.jsx(L,{children:I.map(e=>s.jsxs(S,{children:[s.jsx(q,{children:s.jsx(z,{checked:Y.has(e.id),onCheckedChange:()=>W(e.id)})}),s.jsx(q,{children:s.jsxs("div",{children:[s.jsxs("div",{className:"font-medium flex items-center gap-2",children:[e.title,e.is_public?s.jsx(xe,{className:"w-3 h-3 text-muted-foreground"}):s.jsx(ue,{className:"w-3 h-3 text-muted-foreground"})]}),e.description&&s.jsx("div",{className:"text-sm text-muted-foreground line-clamp-1",children:e.description})]})}),s.jsx(q,{children:e.elements_count}),s.jsx(q,{children:e.total_duration_minutes||"—"}),s.jsx(q,{children:he(new Date(e.created_at),"dd MMM yyyy",{locale:je})}),s.jsx(q,{children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>null==V?void 0:V(e.id),title:"Редактировать",children:s.jsx(pe,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>Ve(e.id),title:"Копировать",children:s.jsx(ve,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>De("lesson",e.id,e.title),title:"Удалить",children:s.jsx(de,{className:"w-4 h-4 text-destructive"})})]})})]},e.id))})]})}),!A&&I.length>0&&"grid"===Ne&&s.jsx("div",{className:"grid sm:grid-cols-2 lg:grid-cols-3 gap-4",children:I.map(e=>s.jsxs(w,{className:"p-4 hover:border-primary transition-colors",children:[s.jsxs("div",{className:"flex items-start justify-between mb-3",children:[s.jsx(z,{checked:Y.has(e.id),onCheckedChange:()=>W(e.id)}),s.jsxs("div",{className:"flex gap-1",children:[s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>null==V?void 0:V(e.id),children:s.jsx(pe,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>Ve(e.id),children:s.jsx(ve,{className:"w-4 h-4"})}),s.jsx(p,{type:"button",variant:"ghost",size:"icon",onClick:()=>De("lesson",e.id,e.title),children:s.jsx(de,{className:"w-4 h-4 text-destructive"})})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("h3",{className:"font-medium line-clamp-1",children:e.title}),e.is_public?s.jsx(xe,{className:"w-3 h-3 text-muted-foreground flex-shrink-0"}):s.jsx(ue,{className:"w-3 h-3 text-muted-foreground flex-shrink-0"})]}),e.description&&s.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:e.description}),s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs(D,{variant:"outline",children:[e.elements_count," элементов"]}),e.total_duration_minutes&&s.jsxs(D,{variant:"secondary",children:[e.total_duration_minutes," мин"]}),e.total_max_score&&s.jsxs(D,{variant:"secondary",children:[e.total_max_score," баллов"]})]}),s.jsx("div",{className:"text-xs text-muted-foreground",children:he(new Date(e.created_at),"dd MMM yyyy",{locale:je})})]})]},e.id))}),!A&&I.length>0&&s.jsxs("div",{className:"text-sm text-muted-foreground text-center",children:["Показано ",I.length," из ",K]})]})})]}),s.jsx(c,{open:_e,onOpenChange:Ce,children:s.jsxs(o,{children:[s.jsxs(d,{children:[s.jsx(m,{children:"Подтвердите удаление"}),s.jsxs(x,{children:["Вы уверены, что хотите удалить"," ",s.jsx("strong",{children:null==ke?void 0:ke.title}),"?",s.jsx("br",{}),"Это действие нельзя отменить."]})]}),s.jsxs(u,{children:[s.jsx(h,{children:"Отмена"}),s.jsx(j,{onClick:()=>{ke&&("element"===ke.type?Z(ke.id):H(ke.id),Ce(!1),Se(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",disabled:be,children:be?s.jsxs(s.Fragment,{children:[s.jsx(le,{className:"w-4 h-4 mr-2 animate-spin"}),"Удаление..."]}):"Удалить"})]})]})}),s.jsx(c,{open:Ee,onOpenChange:Le,children:s.jsxs(o,{children:[s.jsxs(d,{children:[s.jsx(m,{children:"Подтвердите массовое удаление"}),s.jsxs(x,{children:["Вы уверены, что хотите удалить"," ","elements"===qe?`${B.size} элементов`:`${Y.size} уроков`,"?",s.jsx("br",{}),"Это действие нельзя отменить."]})]}),s.jsxs(u,{children:[s.jsx(h,{children:"Отмена"}),s.jsx(j,{onClick:async()=>{"elements"===qe?await fe():await ye(),Le(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",disabled:be,children:be?s.jsxs(s.Fragment,{children:[s.jsx(le,{className:"w-4 h-4 mr-2 animate-spin"}),"Удаление..."]}):"Удалить всё"})]})]})})]})},Ie=ge({type:Ne(["text_problem","quick_question","theory","video"],{required_error:"Element type is required"}),title:we().min(3,"Title must be at least 3 characters").max(200,"Title must not exceed 200 characters"),description:we().max(1e3,"Description must not exceed 1000 characters").optional().default(""),content:we().min(1,"Content is required").max(1e4,"Content must not exceed 10000 characters"),options:ye(ge({text:we().min(1,"Option text is required"),is_correct:fe().default(!1)})).optional(),video_url:we().url("Invalid URL format").optional().or(_e("")),video_type:Ne(["youtube","vimeo","other"]).optional(),difficulty:be().min(1,"Difficulty must be between 1-10").max(10,"Difficulty must be between 1-10").default(5),estimated_time_minutes:be().min(1,"Time must be at least 1 minute").default(5),max_score:be().min(0,"Score cannot be negative").default(100),tags:ye(we()).default([]),is_public:fe().default(!1)}).superRefine((e,s)=>{"quick_question"===e.type&&((!e.options||e.options.length<2)&&s.addIssue({code:Ce.custom,message:"Quick question must have at least 2 options",path:["options"]}),e.options&&!e.options.some(e=>e.is_correct)&&s.addIssue({code:Ce.custom,message:"At least one option must be marked as correct",path:["options"]}),e.options&&e.options.length>10&&s.addIssue({code:Ce.custom,message:"Maximum 10 options allowed",path:["options"]})),"video"!==e.type||e.video_url||s.addIssue({code:Ce.custom,message:"Video URL is required for video elements",path:["video_url"]})}),Ke=ge({title:we().min(3,"Title must be at least 3 characters").max(200,"Title must not exceed 200 characters"),description:we().max(1e3,"Description must not exceed 1000 characters").optional().default(""),subject_id:be().positive("Subject is required"),difficulty:Ne(["easy","medium","hard"],{required_error:"Difficulty is required"}),element_ids:ye(we()).min(1,"At least one element is required").max(50,"Maximum 50 elements allowed"),is_public:fe().default(!1)}),Ae=({form:t,elementType:n})=>{const[i,l]=e.useState(!1),a=t.watch("options")||[],r=t.watch("content"),c=t.watch("video_url"),o=()=>{const e=t.getValues("options")||[];t.setValue("options",[...e,{text:"",is_correct:!1}])},d=()=>i?s.jsxs(w,{className:"mt-4 bg-muted/50",children:[s.jsxs(K,{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(A,{className:"text-base",children:"Предпросмотр"}),s.jsx(p,{type:"button",variant:"ghost",size:"sm",onClick:()=>l(!1),children:s.jsx(ue,{className:"h-4 w-4"})})]}),s.jsx(Q,{children:"Как это будет выглядеть для студента"})]}),s.jsxs(O,{children:["text_problem"===n&&r&&s.jsx("div",{className:"prose prose-sm max-w-none",children:s.jsx("div",{className:"whitespace-pre-wrap text-foreground",children:r})}),"quick_question"===n&&s.jsxs("div",{className:"space-y-3",children:[r&&s.jsx("p",{className:"font-medium",children:r}),a.length>0&&s.jsx("div",{className:"space-y-2",children:a.map((e,t)=>s.jsx("div",{className:"p-3 border rounded-lg "+(e.is_correct?"bg-green-50 border-green-500":"bg-card"),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{children:e.text||`Вариант ${t+1}`}),e.is_correct&&s.jsx(D,{variant:"default",className:"ml-2",children:"Правильный"})]})},t))})]}),"theory"===n&&r&&s.jsx("div",{className:"prose prose-sm max-w-none",children:s.jsx("div",{className:"whitespace-pre-wrap text-foreground",children:r})}),"video"===n&&c&&s.jsxs("div",{className:"space-y-2",children:[s.jsx("div",{className:"aspect-video bg-muted rounded-lg flex items-center justify-center",children:s.jsxs("p",{className:"text-sm text-muted-foreground",children:["Видео: ",c]})}),r&&s.jsx("p",{className:"text-sm text-muted-foreground",children:r})]})]})]}):null;return"text_problem"===n?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"text-lg font-medium",children:"Текстовая задача"}),s.jsxs(p,{type:"button",variant:"outline",size:"sm",onClick:()=>l(!i),children:[i?s.jsx(ue,{className:"h-4 w-4 mr-2"}):s.jsx(xe,{className:"h-4 w-4 mr-2"}),i?"Скрыть":"Предпросмотр"]})]}),s.jsx(F,{control:t.control,name:"content",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Текст задачи *"}),s.jsx(M,{children:s.jsx($,{placeholder:"Введите условие задачи, вопросы для студента...",className:"resize-none min-h-[200px]",...e})}),s.jsx(P,{children:"Опишите задачу, которую студент должен решить. Можно использовать математические формулы."}),s.jsx(I,{})]})}),d()]}):"quick_question"===n?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"text-lg font-medium",children:"Быстрый вопрос"}),s.jsxs(p,{type:"button",variant:"outline",size:"sm",onClick:()=>l(!i),children:[i?s.jsx(ue,{className:"h-4 w-4 mr-2"}):s.jsx(xe,{className:"h-4 w-4 mr-2"}),i?"Скрыть":"Предпросмотр"]})]}),s.jsx(F,{control:t.control,name:"content",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Вопрос *"}),s.jsx(M,{children:s.jsx($,{placeholder:"Введите вопрос для студента...",className:"resize-none",rows:3,...e})}),s.jsx(P,{children:"Четкий вопрос с одним правильным ответом"}),s.jsx(I,{})]})}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(V,{children:"Варианты ответа *"}),s.jsxs(p,{type:"button",onClick:o,size:"sm",variant:"outline",children:[s.jsx(ae,{className:"h-4 w-4 mr-1"}),"Добавить вариант"]})]}),0===a.length&&s.jsx("p",{className:"text-sm text-muted-foreground",children:"Добавьте минимум 2 варианта ответа"}),s.jsx(Te,{value:a.findIndex(e=>e.is_correct).toString(),onValueChange:e=>(e=>{const s=t.getValues("options")||[];t.setValue("options",s.map((s,t)=>({...s,is_correct:t===e})))})(parseInt(e)),children:a.map((e,n)=>s.jsxs("div",{className:"flex items-start gap-2 p-3 border rounded-md bg-card",children:[s.jsx("div",{className:"flex items-center gap-2 pt-2",children:s.jsx(Ve,{value:n.toString(),id:`option-${n}`})}),s.jsxs("div",{className:"flex-1 space-y-2",children:[s.jsx(v,{placeholder:`Вариант ${n+1}`,value:e.text,onChange:e=>{const s=[...t.getValues("options")||[]];s[n]={...s[n],text:e.target.value},t.setValue("options",s)}}),e.is_correct&&s.jsxs("p",{className:"text-xs text-green-600 flex items-center gap-1",children:[s.jsx(ke,{className:"h-3 w-3"}),"Правильный ответ"]})]}),s.jsx(p,{type:"button",onClick:()=>(e=>{const s=t.getValues("options")||[];t.setValue("options",s.filter((s,t)=>t!==e))})(n),size:"sm",variant:"ghost",className:"text-destructive hover:text-destructive",children:s.jsx(de,{className:"h-4 w-4"})})]},n))}),t.formState.errors.options&&s.jsx("p",{className:"text-sm font-medium text-destructive",children:t.formState.errors.options.message})]}),d()]}):"theory"===n?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"text-lg font-medium",children:"Теоретический материал"}),s.jsxs(p,{type:"button",variant:"outline",size:"sm",onClick:()=>l(!i),children:[i?s.jsx(ue,{className:"h-4 w-4 mr-2"}):s.jsx(xe,{className:"h-4 w-4 mr-2"}),i?"Скрыть":"Предпросмотр"]})]}),s.jsx(F,{control:t.control,name:"content",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Содержание *"}),s.jsx(M,{children:s.jsx($,{placeholder:"Введите теоретический материал, объяснения, формулы...",className:"resize-none min-h-[300px] font-mono",...e})}),s.jsx(P,{children:"Теоретическая информация, примеры, формулы для изучения"}),s.jsx(I,{})]})}),d()]}):"video"===n?s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"text-lg font-medium",children:"Видео"}),s.jsxs(p,{type:"button",variant:"outline",size:"sm",onClick:()=>l(!i),children:[i?s.jsx(ue,{className:"h-4 w-4 mr-2"}):s.jsx(xe,{className:"h-4 w-4 mr-2"}),i?"Скрыть":"Предпросмотр"]})]}),s.jsx(F,{control:t.control,name:"video_url",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"URL видео *"}),s.jsx(M,{children:s.jsx(v,{placeholder:"https://youtube.com/watch?v=...",type:"url",...e})}),s.jsx(P,{children:"Введите полный URL видео (YouTube, Vimeo или другой платформы)"}),s.jsx(I,{})]})}),s.jsx(F,{control:t.control,name:"video_type",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Платформа"}),s.jsxs(g,{value:e.value,onValueChange:e.onChange,children:[s.jsx(M,{children:s.jsx(f,{children:s.jsx(y,{placeholder:"Выберите платформу"})})}),s.jsxs(b,{children:[s.jsx(N,{value:"youtube",children:"YouTube"}),s.jsx(N,{value:"vimeo",children:"Vimeo"}),s.jsx(N,{value:"other",children:"Другая"})]})]}),s.jsx(P,{children:"Выберите платформу для правильного отображения"}),s.jsx(I,{})]})}),s.jsx(F,{control:t.control,name:"content",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Описание (опционально)"}),s.jsx(M,{children:s.jsx($,{placeholder:"Краткое описание содержания видео...",className:"resize-none",rows:3,...e})}),s.jsx(P,{children:"Что студенты узнают из этого видео"}),s.jsx(I,{})]})}),d()]}):null},Qe=async e=>{const s=await U.get(`/knowledge-graph/elements/${e}/files/`);if(s.error)throw new Error(s.error);return s.data.data||[]},Oe=async(e,s)=>{const t=new FormData;t.append("file",s);const n=await U.post(`/knowledge-graph/elements/${e}/files/`,t,{headers:{"Content-Type":"multipart/form-data"}});if(n.error)throw new Error(n.error);return n.data.data},Ue=async(e,s)=>{const t=await U.delete(`/knowledge-graph/elements/${e}/files/${s}/`);if(t.error)throw new Error(t.error)},Re=({elementId:n,onFilesChange:i,disabled:l=!1})=>{const[a,r]=e.useState([]),[c,o]=e.useState(!1),[d,m]=e.useState(!1),[x,u]=e.useState(new Set);t.useEffect(()=>{h()},[n]);const h=async()=>{try{o(!0);const e=await Qe(n);r(e),null==i||i(e)}catch(e){console.error("Failed to load files:",e),Se.error("Ошибка загрузки файлов")}finally{o(!1)}},j=async e=>{const s=`${e.name}-${Date.now()}`;try{u(e=>new Set(e).add(s));const t=[await Oe(n,e),...a];r(t),null==i||i(t),Se.success(`Файл "${e.name}" загружен`)}catch(t){console.error("Upload failed:",t);const e=t instanceof Error?t.message:"Ошибка загрузки файла";Se.error(e)}finally{u(e=>{const t=new Set(e);return t.delete(s),t})}},p=e=>{if(0===e)return"0 Б";const s=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,s)*100)/100+" "+["Б","КБ","МБ","ГБ"][s]},v=x.size>0;return s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{onDragOver:e=>{e.preventDefault(),e.stopPropagation(),l||m(!0)},onDragLeave:e=>{e.preventDefault(),e.stopPropagation(),m(!1)},onDrop:async e=>{if(e.preventDefault(),e.stopPropagation(),m(!1),l)return;const s=Array.from(e.dataTransfer.files);for(const t of s)await j(t)},className:`border-2 border-dashed rounded-lg p-6 text-center transition-colors ${d?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"} ${l?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,role:"button",tabIndex:l?-1:0,"aria-label":"Зона для загрузки файлов",onKeyDown:e=>{var s;l||"Enter"!==e.key&&" "!==e.key||null==(s=document.getElementById("file-input"))||s.click()},children:[s.jsx(Ee,{className:"w-8 h-8 mx-auto mb-2 text-gray-400"}),s.jsx("p",{className:"text-sm font-medium text-gray-700 mb-1",children:"Перетащите файлы сюда или"}),s.jsxs("label",{className:"inline-block",children:[s.jsx("span",{className:"text-blue-600 hover:underline cursor-pointer",children:"выберите файлы"}),s.jsx("input",{id:"file-input",type:"file",multiple:!0,onChange:async e=>{if(!e.target.files)return;const s=Array.from(e.target.files);for(const t of s)await j(t);e.target.value=""},disabled:l,className:"hidden",accept:".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.mp4,.zip"})]}),s.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Максимум 10МБ. Допустимые типы: PDF, DOC, DOCX, TXT, JPG, PNG, MP4, ZIP"})]}),v&&s.jsxs("div",{className:"flex items-center justify-center p-3 bg-blue-50 rounded-lg",children:[s.jsx(le,{className:"w-4 h-4 animate-spin mr-2 text-blue-600"}),s.jsx("span",{className:"text-sm text-blue-700",children:"Загрузка файлов..."})]}),c?s.jsxs("div",{className:"flex items-center justify-center py-4",children:[s.jsx(le,{className:"w-4 h-4 animate-spin mr-2 text-gray-400"}),s.jsx("span",{className:"text-sm text-gray-500",children:"Загрузка файлов..."})]}):a.length>0?s.jsxs("div",{className:"space-y-2",children:[s.jsxs("p",{className:"text-sm font-medium text-gray-700",children:["Файлы (",a.length,")"]}),a.map(e=>{return s.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors",children:[s.jsxs("div",{className:"flex-1 min-w-0 mr-4",children:[s.jsx("a",{href:e.file_url,target:"_blank",rel:"noopener noreferrer",className:"text-sm font-medium text-blue-600 hover:underline truncate block",title:e.original_filename,children:e.original_filename}),s.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[p(e.file_size)," · ",(t=e.uploaded_at,new Date(t).toLocaleDateString("ru-RU",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}))]})]}),s.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[s.jsx("a",{href:e.file_url,download:e.original_filename,className:"p-1.5 hover:bg-gray-200 rounded transition-colors",title:"Скачать","aria-label":`Скачать ${e.original_filename}`,children:s.jsx(Le,{className:"w-4 h-4 text-gray-600"})}),s.jsx("button",{type:"button",onClick:()=>(async(e,s)=>{if(confirm(`Вы уверены, что хотите удалить файл "${s}"?`))try{await Ue(n,e);const s=a.filter(s=>s.id!==e);r(s),null==i||i(s),Se.success("Файл удален")}catch(t){console.error("Delete failed:",t);const e=t instanceof Error?t.message:"Ошибка удаления файла";Se.error(e)}})(e.id,e.original_filename),disabled:l,className:"p-1.5 hover:bg-red-100 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Удалить","aria-label":`Удалить ${e.original_filename}`,children:s.jsx(qe,{className:"w-4 h-4 text-red-600"})})]})]},e.id);var t})]}):s.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"Файлы еще не загружены"})]})},Be=({onSubmit:t,onCancel:n,initialData:i,isLoading:l=!1,createdElementId:a=null})=>{const[r,c]=e.useState(!1),[o,d]=e.useState(!1),m=ze({resolver:De(Ie),defaultValues:i?{type:i.type||"text_problem",title:i.title||"",description:i.description||"",content:i.content||"",options:i.options||[],video_url:i.video_url||"",video_type:i.video_type,difficulty:i.difficulty||5,estimated_time_minutes:i.estimated_time_minutes||5,max_score:i.max_score||100,tags:i.tags||[],is_public:i.is_public||!1}:{type:"text_problem",title:"",description:"",content:"",options:[],video_url:"",difficulty:5,estimated_time_minutes:5,max_score:100,tags:[],is_public:!1}}),x=m.watch("type"),u=m.formState.isDirty;return s.jsxs(w,{children:[s.jsxs(K,{children:[s.jsx(A,{children:"Create New Element"}),s.jsx(Q,{children:"Add a new educational element to your content bank. Choose the type and fill in the details."})]}),s.jsxs(O,{children:[s.jsx(R,{...m,children:s.jsxs("form",{onSubmit:m.handleSubmit(async e=>{c(!0),d(!1);try{await t(e),d(!0),B({title:"Element created successfully",description:`"${e.title}" has been added to the element bank.`,variant:"default"}),m.reset({type:"text_problem",title:"",description:"",content:"",options:[],video_url:"",difficulty:5,estimated_time_minutes:5,max_score:100,tags:[],is_public:!1}),setTimeout(()=>{d(!1)},3e3)}catch(s){const e=s instanceof Error?s.message:"Failed to create element";B({title:"Error",description:e,variant:"destructive"})}finally{c(!1)}}),className:"space-y-6",children:[o&&s.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-md flex items-center gap-2 text-green-800",children:[s.jsx(ke,{className:"h-5 w-5"}),s.jsx("span",{className:"font-medium",children:"Element created successfully!"})]}),s.jsx(F,{control:m.control,name:"type",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Element Type"}),s.jsxs(g,{value:e.value,onValueChange:s=>{e.onChange(s),m.setValue("content",""),m.setValue("options",[]),m.setValue("video_url","")},children:[s.jsx(M,{children:s.jsx(f,{children:s.jsx(y,{placeholder:"Select element type"})})}),s.jsxs(b,{children:[s.jsx(N,{value:"text_problem",children:"Text Problem"}),s.jsx(N,{value:"quick_question",children:"Quick Question"}),s.jsx(N,{value:"theory",children:"Theory"}),s.jsx(N,{value:"video",children:"Video"})]})]}),s.jsxs(P,{children:["text_problem"===x&&"A problem requiring written solution","quick_question"===x&&"Multiple choice question with instant feedback","theory"===x&&"Theoretical material and explanations","video"===x&&"Video lecture or demonstration"]}),s.jsx(I,{})]})}),s.jsx(F,{control:m.control,name:"title",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Title"}),s.jsx(M,{children:s.jsx(v,{placeholder:"Element title (3-200 characters)",...e})}),s.jsx(I,{})]})}),s.jsx(F,{control:m.control,name:"description",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Description (Optional)"}),s.jsx(M,{children:s.jsx($,{placeholder:"Brief description of this element...",className:"resize-none",rows:2,...e})}),s.jsx(P,{children:"Optional - helps organize your element bank"}),s.jsx(I,{})]})}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[s.jsx(F,{control:m.control,name:"difficulty",render:({field:e})=>{var t;return s.jsxs(T,{children:[s.jsx(V,{children:"Сложность (1-10)"}),s.jsxs(g,{value:null==(t=e.value)?void 0:t.toString(),onValueChange:s=>e.onChange(parseInt(s)),children:[s.jsx(M,{children:s.jsx(f,{children:s.jsx(y,{placeholder:"Выберите сложность"})})}),s.jsx(b,{children:[1,2,3,4,5,6,7,8,9,10].map(e=>s.jsxs(N,{value:e.toString(),children:[1===e&&"1 - Очень легко",2===e&&"2 - Легко",3===e&&"3",4===e&&"4",5===e&&"5 - Средне",6===e&&"6",7===e&&"7",8===e&&"8 - Сложно",9===e&&"9",10===e&&"10 - Очень сложно"]},e))})]}),s.jsx(I,{})]})}}),s.jsx(F,{control:m.control,name:"estimated_time_minutes",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Время (минут)"}),s.jsx(M,{children:s.jsx(v,{type:"number",min:1,placeholder:"5",...e,onChange:s=>e.onChange(parseInt(s.target.value)||1)})}),s.jsx(I,{})]})}),s.jsx(F,{control:m.control,name:"max_score",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Максимальный балл"}),s.jsx(M,{children:s.jsx(v,{type:"number",min:0,placeholder:"100",...e,onChange:s=>e.onChange(parseInt(s.target.value)||0)})}),s.jsx(I,{})]})})]}),s.jsx(F,{control:m.control,name:"is_public",render:({field:e})=>s.jsxs(T,{className:"flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4",children:[s.jsx(M,{children:s.jsx(z,{checked:e.value,onCheckedChange:e.onChange})}),s.jsxs("div",{className:"space-y-1 leading-none",children:[s.jsx(V,{children:"Опубликовать элемент"}),s.jsx(P,{children:"Сделать элемент доступным для других учителей"})]})]})}),s.jsx("div",{className:"pt-4 border-t",children:s.jsx(Ae,{form:m,elementType:x})}),s.jsxs("div",{className:"flex gap-3 pt-4",children:[s.jsx(p,{type:"submit",disabled:r||l,className:"flex-1",children:r||l?s.jsxs(s.Fragment,{children:[s.jsx(le,{className:"h-4 w-4 mr-2 animate-spin"}),"Creating..."]}):"Create Element"}),u&&s.jsxs(p,{type:"button",onClick:()=>{m.reset({type:"text_problem",title:"",description:"",content:"",options:[],video_url:"",difficulty:5,estimated_time_minutes:5,max_score:100,tags:[],is_public:!1}),d(!1)},variant:"outline",children:[s.jsx(qe,{className:"h-4 w-4 mr-2"}),"Clear"]}),n&&s.jsx(p,{type:"button",onClick:n,variant:"ghost",children:"Cancel"})]}),u&&!r&&s.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"You have unsaved changes"})]})}),a&&s.jsxs("div",{className:"mt-6 pt-6 border-t",children:[s.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Файлы элемента"}),s.jsx(Re,{elementId:a,disabled:l||r})]})]})]})},Ye=({onSubmit:t,onCancel:n,availableElements:i,availableSubjects:l,isLoading:a=!1})=>{const[r,c]=e.useState(!1),[o,d]=e.useState(!1),[m,x]=e.useState(""),[u,h]=e.useState([]),[j,_]=e.useState("all"),C=ze({resolver:De(Ke),defaultValues:{title:"",description:"",subject_id:l.length>0?l[0].id:0,difficulty:"medium",element_ids:[],is_public:!1}}),k=e.useMemo(()=>{if(!m)return i;const e=m.toLowerCase();return i.filter(s=>{var t;return s.title.toLowerCase().includes(e)||(null==(t=s.description)?void 0:t.toLowerCase().includes(e))||s.element_type.toLowerCase().includes(e)})},[m,i]),S=e.useMemo(()=>u.map(e=>i.find(s=>s.id===e)).filter(e=>void 0!==e),[u,i]),E=e.useMemo(()=>S.reduce((e,s)=>e+(s.estimated_time_minutes||0),0),[S]),L=e=>{h(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])},q=(e,s)=>{h(t=>{const n=[...t],i="up"===s?e-1:e+1;return i<0||i>=n.length?t:([n[e],n[i]]=[n[i],n[e]],n)})},D=C.formState.isDirty||u.length>0,U=e=>({text_problem:"Problem",quick_question:"Question",theory:"Theory",video:"Video"}[e]||e);return s.jsxs(w,{children:[s.jsxs(K,{children:[s.jsx(A,{children:"Create New Lesson"}),s.jsx(Q,{children:"Build a lesson by selecting elements from your content bank and arranging them in order."})]}),s.jsx(O,{children:s.jsx(R,{...C,children:s.jsxs("form",{onSubmit:C.handleSubmit(async e=>{c(!0),d(!1);try{const s={...e,element_ids:u};await t(s),d(!0),B({title:"Lesson created successfully",description:`"${e.title}" has been created with ${u.length} elements.`,variant:"default"}),C.reset({title:"",description:"",subject_id:l.length>0?l[0].id:0,difficulty:"medium",element_ids:[],is_public:!1}),h([]),x(""),_("all"),setTimeout(()=>{d(!1)},3e3)}catch(s){const e=s instanceof Error?s.message:"Failed to create lesson";B({title:"Error",description:e,variant:"destructive"})}finally{c(!1)}}),className:"space-y-6",children:[o&&s.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-md flex items-center gap-2 text-green-800",children:[s.jsx(ke,{className:"h-5 w-5"}),s.jsx("span",{className:"font-medium",children:"Lesson created successfully!"})]}),s.jsx(F,{control:C.control,name:"title",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Lesson Title"}),s.jsx(M,{children:s.jsx(v,{placeholder:"Lesson title (3-200 characters)",...e})}),s.jsx(I,{})]})}),s.jsx(F,{control:C.control,name:"description",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Description (Optional)"}),s.jsx(M,{children:s.jsx($,{placeholder:"Brief description of lesson objectives...",className:"resize-none",rows:2,...e})}),s.jsx(P,{children:"What will students learn in this lesson?"}),s.jsx(I,{})]})}),s.jsx(F,{control:C.control,name:"subject_id",render:({field:e})=>{var t;return s.jsxs(T,{children:[s.jsx(V,{children:"Subject"}),s.jsxs(g,{value:null==(t=e.value)?void 0:t.toString(),onValueChange:s=>e.onChange(parseInt(s,10)),children:[s.jsx(M,{children:s.jsx(f,{children:s.jsx(y,{placeholder:"Select subject"})})}),s.jsx(b,{children:l.map(e=>s.jsx(N,{value:e.id.toString(),children:e.name},e.id))})]}),s.jsx(I,{})]})}}),s.jsx(F,{control:C.control,name:"difficulty",render:({field:e})=>s.jsxs(T,{children:[s.jsx(V,{children:"Difficulty Level"}),s.jsxs(g,{value:e.value,onValueChange:e.onChange,children:[s.jsx(M,{children:s.jsx(f,{children:s.jsx(y,{placeholder:"Select difficulty"})})}),s.jsxs(b,{children:[s.jsx(N,{value:"easy",children:"Easy"}),s.jsx(N,{value:"medium",children:"Medium"}),s.jsx(N,{value:"hard",children:"Hard"})]})]}),s.jsx(I,{})]})}),s.jsx(F,{control:C.control,name:"is_public",render:({field:e})=>s.jsxs(T,{className:"flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4",children:[s.jsx(M,{children:s.jsx(z,{checked:e.value,onCheckedChange:e.onChange})}),s.jsxs("div",{className:"space-y-1 leading-none",children:[s.jsx(V,{children:"Make lesson public"}),s.jsx(P,{children:"Allow other teachers to use this lesson in their courses"})]})]})}),s.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"text-sm font-medium mb-2",children:"Select Elements"}),s.jsxs("div",{className:"relative",children:[s.jsx(re,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),s.jsx(v,{placeholder:"Search elements...",value:m,onChange:e=>x(e.target.value),className:"pl-9"})]})]}),s.jsx("div",{className:"border rounded-md max-h-64 overflow-y-auto",children:0===k.length?s.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:m?"No elements found matching your search":"No elements available"}):s.jsx("div",{className:"divide-y",children:k.map(e=>s.jsxs("div",{className:"p-3 hover:bg-accent/50 cursor-pointer flex items-start gap-3",onClick:()=>L(e.id),children:[s.jsx(z,{checked:u.includes(e.id),onCheckedChange:()=>L(e.id),onClick:e=>e.stopPropagation()}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-medium text-sm truncate",children:e.title}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-primary/10 text-primary shrink-0",children:U(e.element_type)})]}),e.description&&s.jsx("p",{className:"text-xs text-muted-foreground mt-1 line-clamp-1",children:e.description})]})]},e.id))})})]}),S.length>0&&s.jsxs("div",{className:"space-y-3 pt-4 border-t",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("h3",{className:"text-sm font-medium",children:["Selected Elements (",S.length,")"]}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"Use arrows to reorder"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3 p-3 bg-muted/50 rounded-md",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Elements"}),s.jsx("p",{className:"text-lg font-semibold",children:S.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Estimated Time"}),s.jsxs("p",{className:"text-lg font-semibold",children:[E," min",E>=60&&s.jsxs("span",{className:"text-sm font-normal text-muted-foreground ml-1",children:["(~",Math.floor(E/60),"h ",E%60,"m)"]})]})]})]}),s.jsx("div",{className:"space-y-2",children:S.map((e,t)=>s.jsxs("div",{className:"flex items-center gap-2 p-3 border rounded-md bg-card",children:[s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsx(p,{type:"button",size:"sm",variant:"ghost",className:"h-4 w-4 p-0",onClick:()=>q(t,"up"),disabled:0===t,children:"▲"}),s.jsx(p,{type:"button",size:"sm",variant:"ghost",className:"h-4 w-4 p-0",onClick:()=>q(t,"down"),disabled:t===S.length-1,children:"▼"})]}),s.jsx(Fe,{className:"h-4 w-4 text-muted-foreground shrink-0"}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{className:"text-xs text-muted-foreground",children:["#",t+1]}),s.jsx("span",{className:"font-medium text-sm truncate",children:e.title}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-primary/10 text-primary shrink-0",children:U(e.element_type)})]}),e.estimated_time_minutes&&s.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["~",e.estimated_time_minutes," min"]})]}),s.jsx(p,{type:"button",size:"sm",variant:"ghost",onClick:()=>{return s=e.id,void h(e=>e.filter(e=>e!==s));var s},className:"text-destructive hover:text-destructive shrink-0",children:s.jsx(de,{className:"h-4 w-4"})})]},e.id))}),u.length<1&&s.jsx("p",{className:"text-sm text-destructive",children:"At least 1 element is required"})]}),s.jsxs("div",{className:"flex gap-3 pt-4",children:[s.jsx(p,{type:"submit",disabled:r||a||0===u.length,className:"flex-1",children:r||a?s.jsxs(s.Fragment,{children:[s.jsx(le,{className:"h-4 w-4 mr-2 animate-spin"}),"Creating..."]}):"Create Lesson"}),D&&s.jsxs(p,{type:"button",onClick:()=>{C.reset({title:"",description:"",subject_id:l.length>0?l[0].id:0,difficulty:"medium",element_ids:[],is_public:!1}),h([]),x(""),_("all"),d(!1)},variant:"outline",children:[s.jsx(qe,{className:"h-4 w-4 mr-2"}),"Clear"]}),n&&s.jsx(p,{type:"button",onClick:n,variant:"ghost",children:"Cancel"})]}),D&&!r&&s.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"You have unsaved changes"})]})})})]})},Xe=()=>{const[t,i]=e.useState(!1),[l,a]=e.useState(!1),[r,c]=e.useState(null),[o,d]=e.useState(null),[m,x]=e.useState(null),[u,h]=e.useState(!1),{toast:j}=n(),p=se(),{data:v}=te({queryKey:["content-creator","all-elements"],queryFn:()=>ie.getElements({created_by:"me"}),staleTime:6e4}),{data:g}=te({queryKey:["teacher","subjects"],queryFn:()=>Me.getSubjects(),staleTime:3e5}),f=(null==v?void 0:v.data)||[],y=g||[],b=()=>{a(!1),d(null)};return s.jsx(Y,{children:s.jsxs("div",{className:"flex min-h-screen w-full",children:[s.jsx(ee,{}),s.jsxs(X,{children:[s.jsxs("header",{className:"sticky top-0 z-10 flex h-16 items-center gap-4 border-b bg-background px-6",children:[s.jsx(W,{}),s.jsx("div",{className:"flex-1",children:s.jsx("h1",{className:"text-2xl font-bold",children:"Создание контента"})})]}),s.jsxs("main",{className:"p-6",children:[s.jsx(Pe,{onCreateElement:()=>{c(null),x(null),i(!0)},onEditElement:e=>{c(e),x(e),i(!0)},onCreateLesson:()=>{d(null),a(!0)},onEditLesson:e=>{d(e),a(!0)}}),s.jsx(G,{open:t,onOpenChange:i,children:s.jsxs(J,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[s.jsx(Z,{children:s.jsx(H,{children:r?"Редактировать элемент":"Создать элемент"})}),s.jsx(Be,{onSubmit:async e=>{h(!0);try{const s=(e,s,t=[],n=null)=>{switch(e){case"text_problem":return{problem_text:s||""};case"quick_question":return{question:s||"",choices:t&&t.length>0?t:["",""],correct_answer:null!==n?n:0};default:return{content:s||""}}},t={title:e.title,description:e.description||"",element_type:e.type,content:s(e.type,e.content,e.options,e.correct_answer),video_url:e.video_url||"",max_score:e.max_score||100,difficulty:e.difficulty||5,estimated_time_minutes:e.estimated_time_minutes||5,tags:e.tags||[],is_public:e.is_public||!1};if(r){const e=await ie.updateElement(r,t);j({title:"Успех",description:"Элемент успешно обновлен"}),x(e.data.id)}else{const e=await ie.createElement(t);j({title:"Успех",description:"Элемент успешно создан"}),x(e.data.id)}p.invalidateQueries({queryKey:["content-creator","elements"]})}catch(s){j({title:"Ошибка",description:s instanceof Error?s.message:"Не удалось сохранить элемент",variant:"destructive"})}finally{h(!1)}},onCancel:()=>{i(!1),c(null),x(null)},isLoading:u,createdElementId:m})]})}),s.jsx(G,{open:l,onOpenChange:a,children:s.jsxs(J,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[s.jsx(Z,{children:s.jsx(H,{children:o?"Редактировать урок":"Создать урок"})}),s.jsx(Ye,{onSubmit:async e=>{h(!0);try{o?(await ie.updateLesson(o,e),j({title:"Успех",description:"Урок успешно обновлен"})):(await ie.createLesson(e),j({title:"Успех",description:"Урок успешно создан"})),p.invalidateQueries({queryKey:["content-creator","lessons"]}),b()}catch(s){j({title:"Ошибка",description:s instanceof Error?s.message:"Не удалось сохранить урок",variant:"destructive"})}finally{h(!1)}},onCancel:b,availableElements:f,availableSubjects:y,isLoading:u})]})})]})]})]})})};export{Xe as default};
