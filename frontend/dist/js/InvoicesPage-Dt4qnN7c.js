import{r as e,j as s}from"./react-core-JVqWokWt.js";import{u as t,l as a,F as i,C as n,B as r,Z as d,a9 as l,_ as c,b as o,T as u,m,n as x,o as h,q as j,s as v,c as p,D as g,w as y,x as f,y as N,g as b,h as w,i as _,j as C,k as S,$ as D,a7 as I,A as k,t as F,v as M,E as P,aa as Q,ab as q,ac as L,ad as K,ae as O,af as E,ag as H,ah as T,S as A,a as $,e as R}from"./main-fde3JC90.js";import{T as U}from"./TutorSidebar-DEiDMEeu.js";import{u as W,a as z,b as V}from"./react-query-DqnBFrGE.js";import{i as B,u as Z}from"./useInvoiceWebSocket-CjPcUPzy.js";import{X as G,aq as J,aD as X,aE as Y,bK as ee,bL as se,bM as te,a6 as ae,ad as ie,an as ne,bN as re,aA as de,au as le,aF as ce,ao as oe,ar as ue}from"./vendor-DC2AZkDs.js";import"./react-dom-DyRXjBRd.js";import"./radix-ui-Ch8xfAyl.js";import"./react-router-WAeXREDX.js";import"./charts-CKrVAx-o.js";import"./d3-lib-BmB4v4DK.js";const me={draft:"Черновик",sent:"Отправлен",viewed:"Просмотрен",paid:"Оплачен",cancelled:"Отменён"},xe={draft:"secondary",sent:"default",viewed:"outline",paid:"default",cancelled:"destructive"},he=({invoices:t,isLoading:a,onInvoiceClick:i,selectedStatuses:g,onStatusChange:y,dateFrom:f,dateTo:N,onDateRangeChange:b,ordering:w,onOrderingChange:_,currentPage:C,totalPages:S,onPageChange:D,onClearFilters:I})=>{const[k,F]=e.useState(f||""),[M,P]=e.useState(N||""),Q=e=>w===e?s.jsx(ee,{className:"h-4 w-4 ml-1"}):w===`-${e}`?s.jsx(se,{className:"h-4 w-4 ml-1"}):s.jsx(te,{className:"h-4 w-4 ml-1 opacity-50"}),q=e=>{_(w===e?`-${e}`:e)},L=g.length>0||f||N;return s.jsxs("div",{className:"space-y-4",children:[s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"text-lg font-semibold",children:"Фильтры"}),L&&s.jsxs(r,{type:"button",variant:"ghost",size:"sm",onClick:I,children:[s.jsx(G,{className:"h-4 w-4 mr-1"}),"Сбросить"]})]}),s.jsxs("div",{children:[s.jsx(d,{className:"mb-2 block",children:"Статус"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:Object.keys(me).map(e=>s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(l,{id:`status-${e}`,checked:g.includes(e),onCheckedChange:()=>(e=>{g.includes(e)?y(g.filter(s=>s!==e)):y([...g,e])})(e)}),s.jsx(d,{htmlFor:`status-${e}`,className:"cursor-pointer font-normal",children:me[e]})]},e))})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[s.jsxs("div",{children:[s.jsx(d,{htmlFor:"date-from",children:"Дата от"}),s.jsx(c,{id:"date-from",type:"date",value:k,onChange:e=>F(e.target.value)})]}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"date-to",children:"Дата до"}),s.jsx(c,{id:"date-to",type:"date",value:M,onChange:e=>P(e.target.value)})]}),s.jsxs("div",{className:"flex items-end gap-2",children:[s.jsx(r,{type:"button",onClick:()=>{b(k||void 0,M||void 0)},className:"flex-1",children:"Применить"}),(k||M)&&s.jsx(r,{type:"button",variant:"outline",onClick:()=>{F(""),P(""),b(void 0,void 0)},children:s.jsx(G,{className:"h-4 w-4"})})]})]})]})}),s.jsx(n,{children:a?s.jsx("div",{className:"p-4 space-y-3",children:[1,2,3,4,5].map(e=>s.jsx(o,{className:"h-16 w-full"},e))}):0===t.length?s.jsxs("div",{className:"p-12 text-center",children:[s.jsx(J,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),s.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Нет счетов"}),s.jsx("p",{className:"text-muted-foreground",children:L?"По заданным фильтрам счета не найдены":"Вы ещё не создали ни одного счёта"})]}):s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"overflow-x-auto",children:s.jsxs(u,{children:[s.jsx(m,{children:s.jsxs(x,{children:[s.jsx(h,{children:"Студент"}),s.jsx(h,{children:s.jsxs("button",{type:"button",className:"flex items-center hover:text-primary transition-colors",onClick:()=>q("amount"),children:["Сумма",Q("amount")]})}),s.jsx(h,{children:s.jsxs("button",{type:"button",className:"flex items-center hover:text-primary transition-colors",onClick:()=>q("due_date"),children:["Срок оплаты",Q("due_date")]})}),s.jsx(h,{children:s.jsxs("button",{type:"button",className:"flex items-center hover:text-primary transition-colors",onClick:()=>q("status"),children:["Статус",Q("status")]})}),s.jsx(h,{children:s.jsxs("button",{type:"button",className:"flex items-center hover:text-primary transition-colors",onClick:()=>q("created_at"),children:["Создан",Q("created_at")]})})]})}),s.jsx(j,{children:t.map(e=>s.jsxs(x,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>i(e),children:[s.jsx(v,{className:"font-medium",children:e.student.full_name}),s.jsxs(v,{className:"font-semibold",children:[parseFloat(e.amount).toLocaleString("ru-RU")," ₽"]}),s.jsx(v,{children:X(new Date(e.due_date),"d MMM yyyy",{locale:Y})}),s.jsx(v,{children:s.jsx(p,{variant:xe[e.status],children:me[e.status]})}),s.jsx(v,{className:"text-muted-foreground",children:X(new Date(e.created_at),"d MMM yyyy, HH:mm",{locale:Y})})]},e.id))})]})}),S>1&&s.jsxs("div",{className:"p-4 border-t flex items-center justify-between",children:[s.jsxs("div",{className:"text-sm text-muted-foreground",children:["Страница ",C+1," из ",S]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(r,{type:"button",variant:"outline",size:"sm",disabled:0===C,onClick:()=>D(C-1),children:"Назад"}),s.jsx(r,{type:"button",variant:"outline",size:"sm",disabled:C>=S-1,onClick:()=>D(C+1),children:"Вперёд"})]})]})]})})]})},je=({open:n,onOpenChange:l})=>{const o=(()=>{const e=W(),{toast:s}=t();return V({mutationFn:async e=>{a.debug("[useCreateInvoice] Creating invoice:",e);const s=await i.createInvoice(e);return a.debug("[useCreateInvoice] Created:",s),s},onSuccess:()=>{e.invalidateQueries({queryKey:["invoices","tutor"]}),s({title:"Успешно",description:"Счёт создан"})},onError:e=>{a.error("[useCreateInvoice] Error:",e),s({title:"Ошибка",description:e.message||"Не удалось создать счёт",variant:"destructive"})}})})(),[u,m]=e.useState({student_id:"",amount:"",description:"",due_date:"",enrollment_id:""}),[x,h]=e.useState({}),{data:j,isLoading:v}=z({queryKey:["tutor-students-for-invoice"],queryFn:async()=>{a.debug("[CreateInvoiceForm] Fetching students...");const e=await i.getTutorStudents();return a.debug("[CreateInvoiceForm] Fetched students:",e),e},enabled:n}),p=null==j?void 0:j.find(e=>e.id===parseInt(u.student_id));e.useEffect(()=>{n||(m({student_id:"",amount:"",description:"",due_date:"",enrollment_id:""}),h({}))},[n]);const k=(e,s)=>{m(t=>({...t,[e]:s})),x[e]&&h(s=>{const t={...s};return delete t[e],t})};return s.jsx(g,{open:n,onOpenChange:l,children:s.jsxs(y,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[s.jsx(f,{children:s.jsx(N,{children:"Создать счёт"})}),s.jsxs("div",{className:"space-y-4 py-4",children:[s.jsxs("div",{children:[s.jsx(d,{htmlFor:"student",children:"Студент *"}),s.jsxs(b,{value:u.student_id,onValueChange:e=>{k("student_id",e),k("enrollment_id","")},children:[s.jsx(w,{id:"student",className:x.student_id?"border-red-500":"",children:s.jsx(_,{placeholder:"Выберите студента"})}),s.jsx(C,{children:v?s.jsx("div",{className:"p-2 text-center text-sm text-muted-foreground",children:"Загрузка..."}):j&&j.length>0?j.map(e=>s.jsx(S,{value:String(e.id),children:e.full_name},e.id)):s.jsx("div",{className:"p-2 text-center text-sm text-muted-foreground",children:"Нет доступных студентов"})})]}),x.student_id&&s.jsx("p",{className:"text-sm text-red-500 mt-1",children:x.student_id})]}),(null==p?void 0:p.enrollments)&&p.enrollments.length>0&&s.jsxs("div",{children:[s.jsx(d,{htmlFor:"enrollment",children:"Предмет (опционально)"}),s.jsxs(b,{value:u.enrollment_id,onValueChange:e=>k("enrollment_id",e),children:[s.jsx(w,{id:"enrollment",children:s.jsx(_,{placeholder:"Выберите предмет (если применимо)"})}),s.jsxs(C,{children:[s.jsx(S,{value:"none",children:"Не указывать предмет"}),p.enrollments.map(e=>s.jsx(S,{value:String(e.id),children:e.subject.name},e.id))]})]})]}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"amount",children:"Сумма (руб) *"}),s.jsx(c,{id:"amount",type:"number",step:"0.01",min:"0",placeholder:"5000.00",value:u.amount,onChange:e=>k("amount",e.target.value),className:x.amount?"border-red-500":""}),x.amount&&s.jsx("p",{className:"text-sm text-red-500 mt-1",children:x.amount})]}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"due_date",children:"Срок оплаты *"}),s.jsx(c,{id:"due_date",type:"date",value:u.due_date,onChange:e=>k("due_date",e.target.value),className:x.due_date?"border-red-500":"",min:X(new Date,"yyyy-MM-dd")}),x.due_date&&s.jsx("p",{className:"text-sm text-red-500 mt-1",children:x.due_date})]}),s.jsxs("div",{children:[s.jsx(d,{htmlFor:"description",children:"Описание *"}),s.jsx(D,{id:"description",placeholder:"Например: Оплата за занятия по математике за декабрь 2025 года",value:u.description,onChange:e=>k("description",e.target.value),className:x.description?"border-red-500":"",rows:4,maxLength:2e3}),s.jsxs("div",{className:"flex justify-between items-center mt-1",children:[x.description?s.jsx("p",{className:"text-sm text-red-500",children:x.description}):s.jsx("p",{className:"text-sm text-muted-foreground",children:"Максимум 2000 символов"}),s.jsxs("p",{className:"text-sm text-muted-foreground",children:[u.description.length," / 2000"]})]})]})]}),s.jsxs(I,{children:[s.jsx(r,{type:"button",variant:"outline",onClick:()=>l(!1),disabled:o.isPending,children:"Отмена"}),s.jsx(r,{type:"button",onClick:async()=>{if((()=>{const e={};if(u.student_id||(e.student_id="Выберите студента"),u.amount){const s=parseFloat(u.amount);(isNaN(s)||s<=0)&&(e.amount="Сумма должна быть больше 0")}else e.amount="Укажите сумму";if(u.description&&0!==u.description.trim().length?u.description.length>2e3&&(e.description="Описание не должно превышать 2000 символов"):e.description="Укажите описание",u.due_date){const s=new Date(u.due_date),t=new Date;t.setHours(0,0,0,0),s<t&&(e.due_date="Срок оплаты не может быть в прошлом")}else e.due_date="Укажите срок оплаты";return h(e),0===Object.keys(e).length})())try{await o.mutateAsync({student_id:parseInt(u.student_id),amount:u.amount,description:u.description.trim(),due_date:u.due_date,enrollment_id:u.enrollment_id&&"none"!==u.enrollment_id?parseInt(u.enrollment_id):void 0}),l(!1)}catch(e){a.error("[CreateInvoiceForm] Submit error:",e)}},disabled:o.isPending,children:o.isPending?s.jsxs(s.Fragment,{children:[s.jsx(ae,{className:"mr-2 h-4 w-4 animate-spin"}),"Создание..."]}):"Создать счёт"})]})]})})},ve={draft:"Черновик",sent:"Отправлен",viewed:"Просмотрен",paid:"Оплачен",cancelled:"Отменён"},pe={draft:"secondary",sent:"default",viewed:"outline",paid:"default",cancelled:"destructive"},ge={draft:s.jsx(ce,{className:"h-4 w-4"}),sent:s.jsx(ie,{className:"h-4 w-4"}),viewed:s.jsx(le,{className:"h-4 w-4"}),paid:s.jsx(de,{className:"h-4 w-4"}),cancelled:s.jsx(re,{className:"h-4 w-4"})},ye=({invoice:d,open:l,onOpenChange:c})=>{const o=(()=>{const e=W(),{toast:s}=t();return V({mutationFn:async e=>{a.debug("[useSendInvoice] Sending invoice:",e);const s=await i.sendInvoice(e);return a.debug("[useSendInvoice] Sent:",s),s},onMutate:async s=>{await e.cancelQueries({queryKey:["invoices","tutor"]}),await e.cancelQueries({queryKey:["invoice","tutor",s]});const t=e.getQueriesData({queryKey:["invoices","tutor"]}),a=e.getQueryData(["invoice","tutor",s]);return e.setQueriesData({queryKey:["invoices","tutor"]},e=>e?{...e,results:e.results.map(e=>e.id===s?{...e,status:"sent",sent_at:(new Date).toISOString()}:e)}:e),a&&e.setQueryData(["invoice","tutor",s],{...a,status:"sent",sent_at:(new Date).toISOString()}),{previousLists:t,previousDetail:a}},onError:(t,i,n)=>{(null==n?void 0:n.previousLists)&&n.previousLists.forEach(([s,t])=>{e.setQueryData(s,t)}),(null==n?void 0:n.previousDetail)&&e.setQueryData(["invoice","tutor",i],n.previousDetail),a.error("[useSendInvoice] Error:",t),s({title:"Ошибка",description:t.message||"Не удалось отправить счёт",variant:"destructive"})},onSuccess:()=>{e.invalidateQueries({queryKey:["invoices","tutor"]}),s({title:"Успешно",description:"Счёт отправлен студенту"})}})})(),u=(()=>{const e=W(),{toast:s}=t();return V({mutationFn:async e=>{a.debug("[useCancelInvoice] Cancelling invoice:",e);const s=await i.cancelInvoice(e);return a.debug("[useCancelInvoice] Cancelled:",s),s},onMutate:async s=>{await e.cancelQueries({queryKey:["invoices","tutor"]}),await e.cancelQueries({queryKey:["invoice","tutor",s]});const t=e.getQueriesData({queryKey:["invoices","tutor"]}),a=e.getQueryData(["invoice","tutor",s]);return e.setQueriesData({queryKey:["invoices","tutor"]},e=>e?{...e,results:e.results.map(e=>e.id===s?{...e,status:"cancelled",cancelled_at:(new Date).toISOString()}:e)}:e),a&&e.setQueryData(["invoice","tutor",s],{...a,status:"cancelled",cancelled_at:(new Date).toISOString()}),{previousLists:t,previousDetail:a}},onError:(t,i,n)=>{(null==n?void 0:n.previousLists)&&n.previousLists.forEach(([s,t])=>{e.setQueryData(s,t)}),(null==n?void 0:n.previousDetail)&&e.setQueryData(["invoice","tutor",i],n.previousDetail),a.error("[useCancelInvoice] Error:",t),s({title:"Ошибка",description:t.message||"Не удалось отменить счёт",variant:"destructive"})},onSuccess:()=>{e.invalidateQueries({queryKey:["invoices","tutor"]}),s({title:"Успешно",description:"Счёт отменён"})}})})(),m=(()=>{const e=W(),{toast:s}=t();return V({mutationFn:async e=>{a.debug("[useDeleteInvoice] Deleting invoice:",e),await i.deleteTutorInvoice(e),a.debug("[useDeleteInvoice] Deleted")},onMutate:async s=>{await e.cancelQueries({queryKey:["invoices","tutor"]});const t=e.getQueriesData({queryKey:["invoices","tutor"]});return e.setQueriesData({queryKey:["invoices","tutor"]},e=>e?{...e,results:e.results.filter(e=>e.id!==s),count:e.count-1}:e),{previousLists:t}},onError:(t,i,n)=>{(null==n?void 0:n.previousLists)&&n.previousLists.forEach(([s,t])=>{e.setQueryData(s,t)}),a.error("[useDeleteInvoice] Error:",t),s({title:"Ошибка",description:t.message||"Не удалось удалить счёт",variant:"destructive"})},onSuccess:()=>{e.invalidateQueries({queryKey:["invoices","tutor"]}),s({title:"Успешно",description:"Счёт удалён"})}})})(),[x,h]=e.useState(!1),[j,v]=e.useState(!1),[b,w]=e.useState(!1);if(!d)return null;const _="draft"===d.status;d.status;const C="draft"===d.status,S=["sent","viewed"].includes(d.status),D=o.isPending||u.isPending||m.isPending;return s.jsxs(s.Fragment,{children:[s.jsx(g,{open:l,onOpenChange:c,children:s.jsxs(y,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[s.jsx(f,{children:s.jsxs(N,{children:["Счёт #",d.id]})}),s.jsxs("div",{className:"space-y-6",children:[s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs(k,{className:"h-16 w-16",children:[s.jsx(F,{src:d.student.avatar}),s.jsx(M,{className:"text-lg",children:d.student.full_name.charAt(0).toUpperCase()})]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"text-xl font-semibold",children:d.student.full_name}),d.enrollment&&s.jsxs("p",{className:"text-sm text-muted-foreground",children:["Предмет: ",d.enrollment.subject_name]})]}),s.jsxs(p,{variant:pe[d.status],className:"text-base px-4 py-2",children:[s.jsx("span",{className:"mr-2",children:ge[d.status]}),ve[d.status]]})]})}),s.jsx(n,{className:"p-6 bg-gradient-to-br from-primary/5 to-primary/10",children:s.jsxs("div",{className:"text-center",children:[s.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Сумма к оплате"}),s.jsxs("p",{className:"text-4xl font-bold",children:[parseFloat(d.amount).toLocaleString("ru-RU")," ₽"]})]})}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Срок оплаты"}),s.jsx("p",{className:"font-medium",children:X(new Date(d.due_date),"d MMMM yyyy",{locale:Y})})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Создан"}),s.jsx("p",{className:"font-medium",children:X(new Date(d.created_at),"d MMMM yyyy, HH:mm",{locale:Y})})]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Описание"}),s.jsx(n,{className:"p-4",children:s.jsx("p",{className:"whitespace-pre-wrap",children:d.description})})]}),s.jsx(P,{}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-semibold mb-3",children:"История изменений"}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"mt-1 "+("draft"!==d.status?"text-primary":"text-muted-foreground"),children:ge.draft}),s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"font-medium",children:"Черновик"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:X(new Date(d.created_at),"d MMM yyyy, HH:mm",{locale:Y})})]})]}),d.sent_at&&s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"mt-1 "+(["sent","viewed","paid"].includes(d.status)?"text-primary":"text-muted-foreground"),children:ge.sent}),s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"font-medium",children:"Отправлен студенту"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:X(new Date(d.sent_at),"d MMM yyyy, HH:mm",{locale:Y})})]})]}),d.viewed_at&&s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"mt-1 "+(["viewed","paid"].includes(d.status)?"text-primary":"text-muted-foreground"),children:ge.viewed}),s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"font-medium",children:"Просмотрен студентом"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:X(new Date(d.viewed_at),"d MMM yyyy, HH:mm",{locale:Y})})]})]}),d.paid_at&&s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"mt-1 text-green-600",children:ge.paid}),s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"font-medium text-green-600",children:"Оплачен"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:X(new Date(d.paid_at),"d MMM yyyy, HH:mm",{locale:Y})})]})]}),d.cancelled_at&&s.jsxs("div",{className:"flex items-start gap-3",children:[s.jsx("div",{className:"mt-1 text-red-600",children:ge.cancelled}),s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"font-medium text-red-600",children:"Отменён"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:X(new Date(d.cancelled_at),"d MMM yyyy, HH:mm",{locale:Y})})]})]})]})]})]}),s.jsxs(I,{className:"flex-col sm:flex-row gap-2",children:[_&&s.jsxs(r,{type:"button",onClick:()=>w(!0),disabled:D,children:[s.jsx(ie,{className:"h-4 w-4 mr-2"}),"Отправить"]}),S&&s.jsxs(r,{type:"button",variant:"destructive",onClick:()=>v(!0),disabled:D,children:[s.jsx(G,{className:"h-4 w-4 mr-2"}),"Отменить"]}),C&&s.jsxs(r,{type:"button",variant:"destructive",onClick:()=>h(!0),disabled:D,children:[s.jsx(ne,{className:"h-4 w-4 mr-2"}),"Удалить"]}),s.jsx(r,{type:"button",variant:"outline",onClick:()=>c(!1),disabled:D,children:"Закрыть"})]})]})}),s.jsx(Q,{open:b,onOpenChange:w,children:s.jsxs(q,{children:[s.jsxs(L,{children:[s.jsx(K,{children:"Отправить счёт?"}),s.jsxs(O,{children:["Счёт будет отправлен студенту ",d.student.full_name,". После отправки вы не сможете изменить или удалить счёт."]})]}),s.jsxs(E,{children:[s.jsx(H,{disabled:o.isPending,children:"Отмена"}),s.jsx(T,{onClick:async()=>{try{await o.mutateAsync(d.id),w(!1)}catch(e){}},disabled:o.isPending,children:o.isPending?s.jsxs(s.Fragment,{children:[s.jsx(ae,{className:"mr-2 h-4 w-4 animate-spin"}),"Отправка..."]}):"Отправить"})]})]})}),s.jsx(Q,{open:j,onOpenChange:v,children:s.jsxs(q,{children:[s.jsxs(L,{children:[s.jsx(K,{children:"Отменить счёт?"}),s.jsx(O,{children:"Счёт будет отменён и больше не будет доступен студенту для оплаты. Это действие нельзя отменить."})]}),s.jsxs(E,{children:[s.jsx(H,{disabled:u.isPending,children:"Назад"}),s.jsx(T,{onClick:async()=>{try{await u.mutateAsync(d.id),v(!1)}catch(e){}},disabled:u.isPending,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:u.isPending?s.jsxs(s.Fragment,{children:[s.jsx(ae,{className:"mr-2 h-4 w-4 animate-spin"}),"Отмена..."]}):"Отменить счёт"})]})]})}),s.jsx(Q,{open:x,onOpenChange:h,children:s.jsxs(q,{children:[s.jsxs(L,{children:[s.jsx(K,{children:"Удалить счёт?"}),s.jsx(O,{children:"Счёт будет удалён без возможности восстановления. Это действие нельзя отменить."})]}),s.jsxs(E,{children:[s.jsx(H,{disabled:m.isPending,children:"Отмена"}),s.jsx(T,{onClick:async()=>{try{await m.mutateAsync(d.id),h(!1),c(!1)}catch(e){}},disabled:m.isPending,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:m.isPending?s.jsxs(s.Fragment,{children:[s.jsx(ae,{className:"mr-2 h-4 w-4 animate-spin"}),"Удаление..."]}):"Удалить"})]})]})})]})};function fe(){const{invoices:d,isLoading:l,error:c,filters:o,setStatus:u,setDateRange:m,setSort:x,clearFilters:h,page:j,setPage:v,totalPages:p,totalCount:g}=(s=>{const{toast:n}=t(),r=W(),d="-created_at",[l,c]=e.useState({status:[],dateFrom:void 0,dateTo:void 0,ordering:d}),[o,u]=e.useState(0);e.useEffect(()=>(a.debug("[useInvoicesList] Connecting to invoice WebSocket"),B.connect({onInvoiceCreated:e=>{a.info("[useInvoicesList] New invoice created:",e.invoice_id),r.invalidateQueries({queryKey:["invoices","tutor"]})},onStatusUpdate:e=>{a.info("[useInvoicesList] Invoice status updated:",e.invoice_id,e.old_status,"→",e.new_status),r.invalidateQueries({queryKey:["invoices","tutor"]})},onInvoicePaid:e=>{a.info("[useInvoicesList] Invoice paid:",e.invoice_id),r.invalidateQueries({queryKey:["invoices","tutor"]}),n({title:"Счёт оплачен",description:"Родитель оплатил счёт"})},onError:e=>{a.error("[useInvoicesList] WebSocket error:",e)}}),()=>{a.debug("[useInvoicesList] Disconnecting from invoice WebSocket"),B.disconnect()}),[r,n]);const{data:m,isLoading:x,error:h,refetch:j}=z({queryKey:["invoices","tutor",l,o],queryFn:async()=>{a.debug("[useInvoicesList] Fetching invoices:",{filters:l,page:o});const e=await i.getTutorInvoices({status:l.status.length>0?l.status:void 0,date_from:l.dateFrom,date_to:l.dateTo,ordering:l.ordering,limit:20,offset:20*o});return a.debug("[useInvoicesList] Received:",e),e},staleTime:6e4,refetchOnWindowFocus:!1,refetchOnMount:!0,refetchInterval:null==s?void 0:s.refetchInterval}),v=e.useMemo(()=>(null==m?void 0:m.results)||[],[m]),p=(null==m?void 0:m.count)||0,g=Math.ceil(p/20),y=e.useCallback(e=>{c(s=>({...s,status:e})),u(0)},[]),f=e.useCallback((e,s)=>{c(t=>({...t,dateFrom:e,dateTo:s})),u(0)},[]),N=e.useCallback(e=>{c(s=>({...s,ordering:e})),u(0)},[]),b=e.useCallback(()=>{c({status:[],dateFrom:void 0,dateTo:void 0,ordering:d}),u(0)},[d]);return{invoices:v,totalCount:p,totalPages:g,currentPage:o,isLoading:x,error:(null==h?void 0:h.message)||null,filters:l,setStatus:y,setDateRange:f,setSort:N,clearFilters:b,setPage:u,itemsPerPage:20,refetch:j}})(),[y,f]=e.useState(!1),[N,b]=e.useState(null),[w,_]=e.useState(!1),{on:C,off:S}=Z(),D=W(),{toast:I}=t();e.useEffect(()=>{const e=e=>{D.invalidateQueries({queryKey:["invoices"]}),I({title:"Новый счёт создан",description:`Счёт #${e.invoice_id} успешно создан`})},s=e=>{if(D.invalidateQueries({queryKey:["invoices"]}),"viewed"===e.new_status||"paid"===e.new_status){const s="viewed"===e.new_status?"просмотрен":"оплачен";I({title:"Счёт обновлён",description:`Счёт #${e.invoice_id} ${s}`})}},t=e=>{D.invalidateQueries({queryKey:["invoices"]}),I({title:"Счёт оплачен!",description:`Счёт #${e.invoice_id} успешно оплачен`})};return C("onInvoiceCreated",e),C("onStatusUpdate",s),C("onInvoicePaid",t),()=>{S("onInvoiceCreated",e),S("onStatusUpdate",s),S("onInvoicePaid",t)}},[C,S,D,I]);const k={total:g,draft:d.filter(e=>"draft"===e.status).length,sent:d.filter(e=>"sent"===e.status).length,paid:d.filter(e=>"paid"===e.status).length,totalAmount:d.reduce((e,s)=>e+parseFloat(s.amount),0)};return s.jsxs(A,{children:[s.jsxs("div",{className:"flex min-h-screen w-full",children:[s.jsx(U,{}),s.jsxs($,{children:[s.jsxs("header",{className:"sticky top-0 z-10 flex h-16 items-center justify-between gap-4 border-b bg-background px-6",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx(R,{}),s.jsx("h1",{className:"text-2xl font-bold",children:"Счета"})]}),s.jsxs(r,{type:"button",onClick:()=>f(!0),children:[s.jsx(oe,{className:"h-4 w-4 mr-2"}),"Создать счёт"]})]}),s.jsx("main",{className:"p-6",children:s.jsxs("div",{className:"space-y-6",children:[s.jsx("div",{children:s.jsx("p",{className:"text-muted-foreground",children:"Создавайте и отправляйте счета своим студентам, отслеживайте статус оплаты"})}),s.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center",children:s.jsx(J,{className:"w-6 h-6 text-primary"})}),s.jsxs("div",{children:[s.jsx("div",{className:"text-2xl font-bold",children:k.total}),s.jsx("div",{className:"text-sm text-muted-foreground",children:"Всего счетов"})]})]})}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center",children:s.jsx(ce,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})}),s.jsxs("div",{children:[s.jsx("div",{className:"text-2xl font-bold",children:k.draft}),s.jsx("div",{className:"text-sm text-muted-foreground",children:"Черновиков"})]})]})}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-12 h-12 bg-yellow-100 dark:bg-yellow-900/20 rounded-lg flex items-center justify-center",children:s.jsx(J,{className:"w-6 h-6 text-yellow-600 dark:text-yellow-400"})}),s.jsxs("div",{children:[s.jsx("div",{className:"text-2xl font-bold",children:k.sent}),s.jsx("div",{className:"text-sm text-muted-foreground",children:"Отправлено"})]})]})}),s.jsx(n,{className:"p-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center",children:s.jsx(de,{className:"w-6 h-6 text-green-600 dark:text-green-400"})}),s.jsxs("div",{children:[s.jsx("div",{className:"text-2xl font-bold",children:k.paid}),s.jsx("div",{className:"text-sm text-muted-foreground",children:"Оплачено"})]})]})})]}),k.totalAmount>0&&s.jsx(n,{className:"p-6 bg-gradient-to-br from-primary/5 to-primary/10",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Общая сумма на текущей странице"}),s.jsxs("p",{className:"text-3xl font-bold",children:[k.totalAmount.toLocaleString("ru-RU")," ₽"]})]}),s.jsx(ue,{className:"h-12 w-12 text-primary/30"})]})}),s.jsx(he,{invoices:d,isLoading:l,onInvoiceClick:e=>{b(e),_(!0)},selectedStatuses:o.status,onStatusChange:u,dateFrom:o.dateFrom,dateTo:o.dateTo,onDateRangeChange:m,ordering:o.ordering,onOrderingChange:x,currentPage:j,totalPages:p,onPageChange:v,onClearFilters:h}),c&&s.jsx(n,{className:"p-4 border-red-500",children:s.jsxs("p",{className:"text-red-600 dark:text-red-400",children:["Ошибка загрузки счетов: ",c]})})]})})]})]}),s.jsx(je,{open:y,onOpenChange:f}),s.jsx(ye,{invoice:N,open:w,onOpenChange:e=>{_(e),e||b(null)}})]})}export{fe as default};
